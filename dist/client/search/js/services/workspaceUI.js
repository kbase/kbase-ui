app.service("modals",function(){var a=this;this.createWS=function(a){var b=$('<form class="form-horizontal" role="form"><div class="form-group"><label class="col-sm-4 control-label">Workspace Name</label><div class="col-sm-6"><div class="input-group"><span class="input-group-addon">'+USER_ID+':</span><input type="text" class="form-control create-id focusedInput"></div></div>                          </div>                          <div class="form-group">                            <label class="col-sm-4 control-label">Global Permission</label>                            <div class="col-sm-3">'+kb.ui.globalPermDropDown("n")+'</div></div><div class="form-group"><label class="col-sm-4 control-label">Description</label><div class="col-sm-7"><textarea class="form-control create-descript" rows="3"></textarea></div></div></div>'),c=$("<div>").kbasePrompt({title:"Create Workspace",body:b,modalClass:"",controls:[{name:"Cancel",callback:function(b,c){c.closePrompt(),a.cancel_cb&&a.cancel_cb()}},{name:"Create",type:"primary",callback:function(b,c){var d=$(".create-id").val(),e=$(".create-permission option:selected").val(),f=$(".create-descript").val();if(""===d)return c.addAlert("must enter a workspace name"),void $(".create-id").focus();var g,h=d.split(":");if(h.length>1)if(h[0]==USER_ID){USER_ID+":"+h[1]}else g="Only your username ("+USER_ID+") may be used before a colon";else var i=USER_ID+":"+d;if(g)c.addCover(g,"danger");else{var j={workspace:i,globalread:e,description:f},k=kb.ws.create_workspace(j);c.data("dialogModal").find(".modal-body").loading(),$.when(k).done(function(){a.submit_cb&&a.submit_cb(),kb.ui.notify("Created workspace: "+d,"success"),c.closePrompt()}).fail(function(a){c.data("dialogModal").find(".modal-body").rmLoading(),c.addCover(a.error.message,"danger")})}}}]});c.openPrompt()},this.copyWS=function(a){var b=a.ws,c=$('<form class="form-horizontal" role="form"><div class="form-group"><label class="col-sm-5 control-label">New Workspace Name</label><div class="col-sm-6"><div class="input-group"><span class="input-group-addon">'+USER_ID+':</span><input type="text" class="form-control new-ws-id focusedInput"></div></div></div><div class="form-group"><label class="col-sm-5 control-label">Global Permission</label><div class="col-sm-3"><select class="form-control create-permission" data-value="n"><option value="n" selected="selected">none</option><option value="r">read</option></select></div></div></div>'),d=$("<div>").kbasePrompt({title:"Copy Workspace <i>"+b+"</i>",body:c,modalClass:"",controls:[{name:"Cancel",type:"default",callback:function(b,c){c.closePrompt(),a.cancel_cb&&a.cancel_cb()}},{name:"Copy",type:"primary",callback:function(c,d){var e=$(".new-ws-id").val(),f=$(".create-permission option:selected").val();if(""===e)return d.addAlert("must enter a workspace name"),void $(".new-ws-id").focus();var g,h=e.split(":");if(h.length>1)if(h[0]==USER_ID){USER_ID+":"+h[1]}else g="Only your username ("+USER_ID+") may be used before a colon";else var e=USER_ID+":"+e;if(g)d.addCover(g,"danger");else{var i={wsi:{workspace:b},workspace:e,globalread:f},j=kb.ws.clone_workspace(i);d.addCover(),d.getCover().loading(),$.when(j).done(function(){d.closePrompt(),a.submit_cb&&a.submit_cb(),d.closePrompt()}).fail(function(){d.addCover("This workspace name already exists.","danger")})}}}]});d.openPrompt()},this.deleteWS=function(a){var b=a.ws,c=$('<div style="text-align: center;">Are you sure you want to delete this workspace?<h3>'+b+"</h3>This action is irreversible.</div>"),d=$("<div>").kbasePrompt({title:"Delete Workspace",body:c,modalClass:"",controls:[{name:"No",type:"default",callback:function(b,c){c.closePrompt(),a.cancel_cb&&a.cancel_cb()}},{name:"Yes",type:"primary",callback:function(c,d){var e={workspace:b},f=kb.ws.delete_workspace(e);d.addCover(),d.getCover().loading(),$.when(f).done(function(){a.submit_cb(),d.closePrompt()}).fail(function(){d.addCover("Could not delete workspace.","danger")})}}]});d.openPrompt(),d.addAlert("<strong>Warning</strong> All objects in the workspace will be deleted!")},this.manageWS=function(b){function c(a){var a=$('<form role="form">                       <div class="form-group">                        <textarea rows="4" class="form-control" placeholder="Description">'+a+"</textarea>                      </div>                      </form>");return a}function d(a){var b=$('<table class="table table-bordered perm-table"></table>'),c=Object.keys(a).length;if(1>=c||2==c&&"*"in a){var d=$("<tr><td>(None)</td></tr>");return b.append(d),b}for(var e in a)if("*"!=e&&e!=USER_ID&&"n"!=a[e]){var d=$('<tr><td class="perm-user" data-user="'+e+'">'+e+'</td><td class="perm-value" data-value="'+a[e]+'">'+j[a[e]]+"</td></tr>");b.append(d)}return b}function e(a){function b(b,e){var f='<tr><td><input class="form-control perm-user" value="'+b+'"></input></td>                        <td class="perm-value">'+g(a[d],e)+'</td>                        <td><button onclick="$(this).closest(&#39;tr&#39).remove();" class="form-control">                        <span class="glyphicon glyphicon-trash"></span></button></tr>';c.find("tr:last").before(f)}var c=$('<table class="table table-bordered edit-perm-table"></table>');for(var d in a)if("*"!=d&&d!=USER_ID&&"n"!=a[d]){var e=$('<tr><td><input type="text" class="form-control perm-user" value="'+d+'"></input></td>                    <td class="perm-value">'+g(a[d])+'</td>                    <td><button class="form-control rm-perm" data-user="'+d+'">                    <span class="glyphicon glyphicon-trash"></span></button></tr>');e.find(".rm-perm").click(function(){$(this).closest("tr").remove()}),c.append(e)}var f=Object.keys(a).length;if(2==f){var e=$("<tr>None</tr>");c.append(e)}var h='<tr class="perm-row"><td><input type="text" class="form-control perm-user" placeholder="Username"></td><td>'+g(a[d])+"</td></tr>",e=$(h),i=$('<td><button type="button" class="form-control add-perm">                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button></td>');return e.append(i),c.append(e),c.find(".add-perm").click(function(){var a=$(this).parents("tr").find(".perm-user").val(),d=$(this).parents("tr").find(".create-permission option:selected").val();b(a,d),$(this).parents("tr").find(".perm-user").val(""),0==c.find("tr").length&&c.append("<tr>None</tr>")}),c}function f(a){var b={},c=$(".edit-perm-table");c.find("tr").each(function(){var a=$(this).find(".perm-user").val(),c=$(this).find("option:selected").val();a&&(b[a]=c)});var d=[];for(var e in b)if("*"!=e&&e!=USER_ID&&!(e in h&&b[e]==h[e])){var f={workspace:a,new_permission:b[e],users:[e]},g=kb.ws.set_permissions(f);d.push(g)}var i=[];for(var j in h)if("*"!=j&&j!=USER_ID&&!(j in b)){var f={workspace:a,new_permission:"n",users:[j]},g=kb.ws.set_permissions(f);d.push(g),i.push(j)}return $.when.apply($,d)}function g(a){var b=$('<select class="form-control create-permission" data-value="n">                            <option value="r">read</option>                            <option value="w">write</option>                            <option value="a">admin</option></select>                          </div>');return"a"==a?b.find("option[value='a']").attr("selected","selected"):"w"==a?b.find("option[value='w']").attr("selected","selected"):b.find("option[value='r']").attr("selected","selected"),$("<div>").append(b).html()}var h,i=b.ws,j={a:"Admin",r:"Read",w:"Write",o:"Owner",n:"None"},k=$("<div>"),l=$("<div>").kbasePrompt({title:"Manage Workspace "+(USER_ID?'<a class="btn btn-primary btn-xs btn-edit">Edit <span class="glyphicon glyphicon-pencil"></span></a>':""),body:k,modalClass:"",controls:[{name:"Close",type:"default",callback:function(a,b){b.closePrompt()}},{name:"Save",type:"primary",callback:function(c,d){d.addCover(),d.getCover().loading();var e=f(i);prompt=d,$.when(e).done(function(){var c=$(".descript-container textarea").val(),d=kb.ws.set_workspace_description({workspace:i,description:c});$.when(d).done(function(){var c=$(".btn-global-perm option:selected").val(),d=kb.ws.set_global_permission({workspace:i,new_permission:c});$.when(d).done(function(){prompt.addCover("Saved."),prompt.closePrompt(),a.manageWS(b)}).fail(function(a){prompt.addCover(a.error.message,"danger")})}).fail(function(a){prompt.addCover(a.error.message,"danger")})}).fail(function(a){prompt.addCover(a.error.message,"danger")})}}]});l.openPrompt();var m=l.data("dialogModal").find(".modal-dialog");m.css("width","500px");var n=m.find(".modal-body"),o=m.find(".modal-footer"),p=o.find(".btn-primary");p.attr("disabled",!0);var q=$('<button class="btn btn-link pull-left">Copy</button>');q.click(function(){l.closePrompt(),a.copyWS({ws:i,cancel_cb:function(){a.manageWS(b)},submit_cb:function(){b.copy_cb()}})});var r=$('<button class="btn btn-link pull-right">Delete</button>');r.click(function(){l.closePrompt(),a.deleteWS({ws:i,cancel_cb:function(){a.manageWS(b)},submit_cb:function(){b.delete_cb()}})}),kb.ws.get_workspace_info({workspace:i}).done(function(a){if("a"==a[5]);else;for(var b=$('<table class="table table-bordered table-condensed table-striped manage-table">'),c=[["Name",a[1]],["Objects","~ "+a[4]],["Owner",a[2]],["Your Permission",j[a[5]]]],f=0;f<c.length;f++){var g=$("<tr>");g.append("<td><strong>"+c[f][0]+"</strong></td><td>"+c[f][1]+"</td>"),b.append(g)}k.append('<div class="ws-description">                                <h5>Description</h5>                                <div class="descript-container"></div>                           </div>                           <div class="ws-info">                                <h5>Info</h5>                           </div>'+(USER_ID&&"n"!=a[5]?'<div class="ws-perms">                                <h5>Other User Permissions</h5>                                <div class="perm-container"></div>                           </div>':""));var l=a[6],g=$("<tr>");g.append('<td><strong>Global Permission</strong></td><td class="btn-global-perm">'+j[l]+"</td>"),b.append(g),$(".btn-edit").click(function(){$(this).hasClass("editable")?$(".btn-global-perm").html(kb.ui.globalPermDropDown(l)):($(".btn-global-perm").html(""),$(".btn-global-perm").text(j[l]))}),n.append(q),n.append(r),n.find(".ws-info").append(b);var m=kb.ws.get_permissions({workspace:i}),o=$("<div>").loading();n.append(o),$.when(m).done(function(a){h=a,o.rmLoading(),perm_container=n.find(".perm-container");var b=d(a);perm_container.append(b),$(".btn-edit").click(function(){$(this).hasClass("editable")?(b.remove(),b=e(a),perm_container.html(b)):(b.remove(),b=d(a),perm_container.html(b))})}).fail(function(a){o.rmLoading(),n.append('<div class="alert alert-danger"><b>Error:</b> Can not fetch WS permissions: '+a.error.message+"</div>")})}).fail(function(a){n.append('<div class="alert alert-danger"><b>Error</b> Can not fetch WS info: '+a.error.message+"</div>")}),$(".btn-edit").click(function(){$(this).toggleClass("editable"),$(this).hasClass("editable")?(p.attr("disabled",!1),$(this).html("Cancel")):(p.attr("disabled",!0),$(this).html("Edit"))});var s=kb.ws.get_workspace_description({workspace:i});$.when(s).done(function(a){var b=(a?a:"(none)")+"<br>";n.find(".descript-container").append(b),$(".btn-edit").click(function(){if($(this).hasClass("editable")){var b=c(a);$(".descript-container").html(b)}else $(".descript-container").html(a)})}).fail(function(a){n.append('<div class="alert alert-danger"><b>Error</b> Can not fetch description: '+a.error.message+"</div>")})}});