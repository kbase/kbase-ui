angular.module("modeling-directives",[]),angular.module("modeling-directives").directive("pathways",function(a,b,c,d){return{link:function(a,e,f){function g(){n.find(".pathway-link").unbind("click"),n.find(".pathway-link").click(function(){var a=$(this).data("map_id"),b=$(this).text(),c=$('<div id="path-'+a+'">');c.loading(),p.addTab({name:b,removable:!0,content:c}),h(a,c)}),n.find(".pathway-link").tooltip({title:"Open path tab",placement:"right",delay:{show:1e3}})}function h(a,b){b.rmLoading(),b.kbasePathway({model_ws:d.ws,model_name:d.id,map_ws:m,map_name:a,editable:!0})}function i(){var c=kb.ws.list_objects({workspaces:[m],includeMetadata:1});$.when(c).done(function(c){var d={sPaginationType:"bootstrap",iDisplayLength:10,aaData:c,fnDrawCallback:g,aaSorting:[[1,"asc"]],aoColumns:[{sTitle:"Name",mData:function(a){return'<a class="pathway-link" data-map_id="'+a[1]+'">'+a[10].name+"</a>"}},{sTitle:"Map ID",mData:1},{sTitle:"Rxn Count",sWidth:"10%",mData:function(a){return"reaction_ids"in a[10]?a[10].reaction_ids.split(",").length:"N/A"}},{sTitle:"Cpd Count",sWidth:"10%",mData:function(a){return"compound_ids"in a[10]?a[10].compound_ids.split(",").length:"N/A"}},{sTitle:"Source",sWidth:"10%",mData:function(a){return"KEGG"}}],oLanguage:{sEmptyTable:"No objects in workspace",sSearch:"Search:"}},e=o.dataTable(d);if(b(e)(a),self.default_map&&"list"!=self.default_map)for(var f in q)map_obj=q[f],map_obj.id==self.default_map&&(new_map_tab(self.default_map,map_obj.name),self.loadMap(self.default_map))}).fail(function(a){n.prepend('<div class="alert alert-danger">'+a.error.message+"</div>")})}function j(b,d){if($("#path-list").remove(),d)var f=kb.get_fba(b,d);else var f;var g=kb.get_model(a.selected[0].workspace,a.selected[0].name);$.when(g,f).done(function(b,d){var f=[b[0].data],d=d?[d[0].data]:null;c.org_name=b[0].data.name,a.$apply(),$(e).rmLoading(),$(e).pathways({modelData:f,fbaData:d,ws:m,defaultMap:a.defaultMap,scope:a}),$(e).find(".pathway-tabs").append('<div class="label label-primary pull-right">'+m+"</div>")}).fail(function(a){$(e).append('<div class="alert alert-danger">'+a.error.message+"</div>")})}function k(a){var b=$('<select class="form-control fba-selector">');for(var c in a){var d=a[c];b.append('<option value="'+d.name+"+"+d.ws+'" >'+d.name+" | "+d.ws+" | "+d.date+"</option>")}var e=$('<div class="col-xs-5">');e.append(b);var f=$('<div class="row pathway-options">');return f.append(e),b.find("select").change(function(){var a=$('<div id="loading pull-right">');a.loading(),$(".pathway-options").append(a);var b=l();j(b.ws,b.name)}),f}function l(){var a=$(".fba-selector").val(),b=a.split("+")[0],c=a.split("+")[1];return{ws:c,name:b}}var m=(a.type,"nconrad:paths");console.log("default map",d.map);var n=e,o=$('<table cellpadding="0" cellspacing="0" border="0"                 class="table table-bordered table-striped">'),p=n.kbTabs({tabs:[{name:"Selection",content:o,active:!0}]}),q=[];i(),$.fn.pathways=function(a){self.models=a.modelData,self.fbas=a.fbaData,self.ws=a.ws,self.default_map=a.defaultMap;var b=$(this);b.append('<div class="tab-content" style="margin-top:15px;">                                      <div class="tab-pane active" style="margin-top:15px;" id="path-list"></div>                                  </div>'),self.loadMap=function(a){$(".tab").removeClass("active"),$("#path-tab-"+a).addClass("active"),$(".tab-pane").removeClass("active"),$("#path-"+a).addClass("active"),$("#path-"+a).loading();var c=kb.ws.get_objects([{workspace:self.ws,name:a}]);$.when(c).done(function(b){$("#path-"+a).rmLoading();var b=b[0].data;$("#path-"+a).kbasePathway({ws:self.ws,mapID:a,mapData:b,editable:!0,modelData:self.models,fbaData:self.fbas})}).fail(function(a){b.prepend('<div class="alert alert-danger">'+a.error.message+"</div>")})}},$(e).loading(),$.when(a.ref_obj_prom).done(function(){if(a.fba_refs.length){var b=k(a.fba_refs);$(".pathway-tabs").prepend(b),j(a.fba_refs[0].ws,a.fba_refs[0].name)}else j(a.selected[0].workspace)}).fail(function(){$(e).html("<h5>There are currently no FBA                                     results associated with this model.                                      You may want to FBA analysis.</h5>")}),$("#pathway-selection").click(function(){$(".pathway-tab").removeClass("active"),$(this).addClass("active"),$(".tab-pane").removeClass("active"),$("#path-list").addClass("active")})}}}).directive("fvaviewer",function(a){return{link:function(a,b,c){$(b).loading()}}}).directive("cddviewer",function(a){return{link:function(a,b,c){function d(a){var b=a.featuredomains,c=[];for(var d in b)if(b[d].domains){var e=b[d].domains;c.push(e)}}function e(){u.select(".x.axis").call(s),u.selectAll(".cdd-box").attr("x",function(a){var b=d3.select(this).data()[0].start;d3.select(this).data()[0].end;return r(b)}).attr("width",function(){var a=d3.select(this).data()[0].start,b=d3.select(this).data()[0].end;return r(b)-r(a)})}function f(a,b,c){u.append("rect").data([{start:a,end:b}]).attr("class","cdd-box").attr("x",r(0)).attr("y",0).attr("width",r(0)-r(0)).attr("height",k).transition().duration(1e3).ease("elastic").attr("x",r(a)).attr("y",c).attr("width",r(b)-r(a)).each("end",g)}function g(){d3.select(this).on("mouseover",function(a){var b=d3.select(this),c=b.data()[0].start,d=b.data()[0].end,e=r(c),f=r(d);b.transition().duration(200).style("fill","steelblue"),u.append("line").attr("class","grid-line").attr("x1",e).attr("y1",0).attr("x2",e).attr("y2",i).attr("stroke-dasharray","5,5"),u.append("line").attr("class","grid-line").attr("x1",f).attr("y1",0).attr("x2",f).attr("y2",i).attr("stroke-dasharray","5,5"),u.append("text").attr("class","grid-label").text(c).attr("x",e-20).attr("y",i-10),u.append("text").attr("class","grid-label").text(d).attr("x",f+2).attr("y",i-10)}).on("mouseout",function(a){d3.selectAll(".cdd-box").transition().duration(200).style("fill","lightsteelblue"),d3.selectAll(".grid-line").remove(),d3.selectAll(".grid-label").remove()}),u.on("mousemove",function(){coordinates=d3.mouse(this);coordinates[0],coordinates[1]})}$.when(a.prom).done(function(){a.drawChart()}),a.drawChart=function(){var c=[];for(var e in a.favs){var f=a.favs[e].ws,g=a.favs[e].id,h=kb.req("ws","get_objects",[{workspace:f,name:g}]);c.push(h)}$.when.apply($,c).done(function(){$(b).rmLoading();var a=arguments[0][0].data;d(a)})};var h=600,i=300;padding_bottom=50;for(var j=200,k=10,l=100,m=10,n=[],o=0;l>o;o++){var p=Math.floor(Math.random()*(j-m)+1),q=Math.floor(Math.random()*m+1);n.push([p,p+q])}$(b).append('<div id="cdd-chart"></div>');var r=d3.scale.linear().domain([0,j]).range([20,h-20]),s=d3.svg.axis().scale(r).orient("bottom"),t=d3.behavior.zoom().x(r).scaleExtent([1,10]).on("zoom",e),u=d3.select("#cdd-chart").append("svg").attr("width",h).attr("height",i).attr("transform","translate(0,0)").call(t);u.append("rect").attr("class","overlay").attr("width",h).attr("height",i);for(var v=(u.append("g").attr("class","x axis").attr("transform","translate(0,"+(i-padding_bottom)+")").call(s),20),w=25,x={},o=1;w>=o;o++)x[o]=i-padding_bottom-v-2*(o-1)*k;for(var y={},o=1;w>=o;o++)y[o]=[];for(var o in n){var z=n[o][0],A=n[o][1],B=0;for(var C in y){var D=y[C],E=!0;for(var F in D){var G=D[F][0],H=D[F][1];if(!(z>H||G>A)){E=!1;break}}if(E){B=C,D.push([z,A]);break}}B?f(z,A,x[B]):console.error("did not find a place for ",z,A)}}}}).directive("deleterxn",function(a){return{link:function(a,b,c){console.log("here"),$(b).kbaseModelEditor({ws:a.ws,id:a.id})}}}).directive("etcviewer",function(a){return{link:function(a,b,c){function d(a){var a=a[0].data,b=f(a);$.when(b).done(function(a){var b=group_data(b);e(b,a)})}function e(a,c){var d=800,e=600;$(b).append('<div id="etc-viewer">');var f=d3.select("#etc-viewer").append("svg").attr("width",d).attr("height",e),g=100,h=20,i=200,j=200;for(var k in a.pathways){for(var l=a.pathways[k],m=l.electron_acceptor,n=l.steps,o=0;o<n.length;o++){n[o].reactions;f.append("rect").attr("class","etc-step-box").attr("x",i+o*g).attr("y",j+k*h).attr("width",g).attr("height",h);var p=c[n[o].substrates.compound_refs[0]].name;f.append("text").attr("class","etc-step-text").attr("x",i+o*g+2).attr("y",j+k*h+h/2+3).text(p)}f.append("text").attr("class","etc-step-text").attr("x",i+n.length*g+2).attr("y",j+k*h+h/2+3).text(m)}}function f(a){cpd_ids=[];for(var b in a.pathways)for(var c=a.pathways[b],d=c.steps,e=0;e<d.length;e++){var f=d[e].substrates.compound_refs;for(var g in f)-1==cpd_ids.indexOf(f[g])&&cpd_ids.push(f[g])}var h=kb.fba.get_compounds({compounds:cpd_ids}),i=$.when(h).then(function(a){var b={};for(var c in a)b[a[c].id]=a[c];return b});return i}var g=kb.ws.get_objects([{workspace:a.ws,name:a.id}]);$.when(g).done(d)}}}).directive("provenance",function(a){return{link:function(a,b,c){var d={nodes:[{name:"Myriel",group:1},{name:"Napoleon",group:1},{name:"Mlle.Baptistine",group:1},{name:"Mme.Magloire",group:1},{name:"CountessdeLo",group:1},{name:"Geborand",group:1},{name:"Champtercier",group:1},{name:"Cravatte",group:1},{name:"Count",group:1},{name:"OldMan",group:1},{name:"Labarre",group:2},{name:"Valjean",group:2},{name:"Marguerite",group:3},{name:"Mme.deR",group:2},{name:"Isabeau",group:2},{name:"Gervais",group:2},{name:"Tholomyes",group:3},{name:"Listolier",group:3},{name:"Fameuil",group:3},{name:"Blacheville",group:3},{name:"Favourite",group:3},{name:"Dahlia",group:3},{name:"Zephine",group:3},{name:"Fantine",group:3},{name:"Mme.Thenardier",group:4},{name:"Thenardier",group:4},{name:"Cosette",group:5},{name:"Javert",group:4},{name:"Fauchelevent",group:0},{name:"Bamatabois",group:2},{name:"Perpetue",group:3},{name:"Simplice",group:2},{name:"Scaufflaire",group:2},{name:"Woman1",group:2},{name:"Judge",group:2},{name:"Champmathieu",group:2},{name:"Brevet",group:2},{name:"Chenildieu",group:2},{name:"Cochepaille",group:2},{name:"Pontmercy",group:4},{name:"Boulatruelle",group:6},{name:"Eponine",group:4},{name:"Anzelma",group:4},{name:"Woman2",group:5},{name:"MotherInnocent",group:0},{name:"Gribier",group:0},{name:"Jondrette",group:7},{name:"Mme.Burgon",group:7},{name:"Gavroche",group:8},{name:"Gillenormand",group:5},{name:"Magnon",group:5},{name:"Mlle.Gillenormand",group:5},{name:"Mme.Pontmercy",group:5},{name:"Mlle.Vaubois",group:5},{name:"Lt.Gillenormand",group:5},{name:"Marius",group:8},{name:"BaronessT",group:5},{name:"Mabeuf",group:8},{name:"Enjolras",group:8},{name:"Combeferre",group:8},{name:"Prouvaire",group:8},{name:"Feuilly",group:8},{name:"Courfeyrac",group:8},{name:"Bahorel",group:8},{name:"Bossuet",group:8},{name:"Joly",group:8},{name:"Grantaire",group:8},{name:"MotherPlutarch",group:9},{name:"Gueulemer",group:4},{name:"Babet",group:4},{name:"Claquesous",group:4},{name:"Montparnasse",group:4},{name:"Toussaint",group:5},{name:"Child1",group:10},{name:"Child2",group:10},{name:"Brujon",group:4},{name:"Mme.Hucheloup",group:8}],links:[{source:1,target:0,value:1},{source:2,target:0,value:8},{source:3,target:0,value:10},{source:3,target:2,value:6},{source:4,target:0,value:1},{source:5,target:0,value:1},{source:6,target:0,value:1},{source:7,target:0,value:1},{source:8,target:0,value:2},{source:9,target:0,value:1},{source:11,target:10,value:1},{source:11,target:3,value:3},{source:11,target:2,value:3},{source:11,target:0,value:5},{source:12,target:11,value:1},{source:13,target:11,value:1},{source:14,target:11,value:1},{source:15,target:11,value:1},{source:17,target:16,value:4},{source:18,target:16,value:4},{source:18,target:17,value:4},{source:19,target:16,value:4},{source:19,target:17,value:4},{source:19,target:18,value:4},{source:20,target:16,value:3},{source:20,target:17,value:3},{source:20,target:18,value:3},{source:20,target:19,value:4},{source:21,target:16,value:3},{source:21,target:17,value:3},{source:21,target:18,value:3},{source:21,target:19,value:3},{source:21,target:20,value:5},{source:22,target:16,value:3},{source:22,target:17,value:3},{source:22,target:18,value:3},{source:22,target:19,value:3},{source:22,target:20,value:4},{source:22,target:21,value:4},{source:23,target:16,value:3},{source:23,target:17,value:3},{source:23,target:18,value:3},{source:23,target:19,value:3},{source:23,target:20,value:4},{source:23,target:21,value:4},{source:23,target:22,value:4},{source:23,target:12,value:2},{source:23,target:11,value:9},{source:24,target:23,value:2},{source:24,target:11,value:7},{source:25,target:24,value:13},{source:25,target:23,value:1},{source:25,target:11,value:12},{source:26,target:24,value:4},{source:26,target:11,value:31},{source:26,target:16,value:1},{source:26,target:25,value:1},{source:27,target:11,value:17},{source:27,target:23,value:5},{source:27,target:25,value:5},{source:27,target:24,value:1},{source:27,target:26,value:1},{source:28,target:11,value:8},{source:28,target:27,value:1},{source:29,target:23,value:1},{source:29,target:27,value:1},{source:29,target:11,value:2},{source:30,target:23,value:1},{source:31,target:30,value:2},{source:31,target:11,value:3},{source:31,target:23,value:2},{source:31,target:27,value:1},{source:32,target:11,value:1},{source:33,target:11,value:2},{source:33,target:27,value:1},{source:34,target:11,value:3},{source:34,target:29,value:2},{source:35,target:11,value:3},{source:35,target:34,value:3},{source:35,target:29,value:2},{source:36,target:34,value:2},{source:36,target:35,value:2},{source:36,target:11,value:2},{source:36,target:29,value:1},{source:37,target:34,value:2},{source:37,target:35,value:2},{source:37,target:36,value:2},{source:37,target:11,value:2},{source:37,target:29,value:1},{source:38,target:34,value:2},{source:38,target:35,value:2},{source:38,target:36,value:2},{source:38,target:37,value:2},{source:38,target:11,value:2},{source:38,target:29,value:1},{source:39,target:25,value:1},{source:40,target:25,value:1},{source:41,target:24,value:2},{source:41,target:25,value:3},{source:42,target:41,value:2},{source:42,target:25,value:2},{source:42,target:24,value:1},{source:43,target:11,value:3},{source:43,target:26,value:1},{source:43,target:27,value:1},{source:44,target:28,value:3},{source:44,target:11,value:1},{source:45,target:28,value:2},{source:47,target:46,value:1},{source:48,target:47,value:2},{source:48,target:25,value:1},{source:48,target:27,value:1},{source:48,target:11,value:1},{source:49,target:26,value:3},{source:49,target:11,value:2},{source:50,target:49,value:1},{source:50,target:24,value:1},{source:51,target:49,value:9},{source:51,target:26,value:2},{source:51,target:11,value:2},{source:52,target:51,value:1},{source:52,target:39,value:1},{source:53,target:51,value:1},{source:54,target:51,value:2},{source:54,target:49,value:1},{source:54,target:26,value:1},{source:55,target:51,value:6},{source:55,target:49,value:12},{source:55,target:39,value:1},{source:55,target:54,value:1},{source:55,target:26,value:21},{source:55,target:11,value:19},{source:55,target:16,value:1},{source:55,target:25,value:2},{source:55,target:41,value:5},{source:55,target:48,value:4},{source:56,target:49,value:1},{source:56,target:55,value:1},{source:57,target:55,value:1},{source:57,target:41,value:1},{source:57,target:48,value:1},{source:58,target:55,value:7},{source:58,target:48,value:7},{source:58,target:27,value:6},{source:58,target:57,value:1},{source:58,target:11,value:4},{source:59,target:58,value:15},{source:59,target:55,value:5},{source:59,target:48,value:6},{source:59,target:57,value:2},{source:60,target:48,value:1},{source:60,target:58,value:4},{source:60,target:59,value:2},{source:61,target:48,value:2},{source:61,target:58,value:6},{source:61,target:60,value:2},{source:61,target:59,value:5},{source:61,target:57,value:1},{source:61,target:55,value:1},{source:62,target:55,value:9},{source:62,target:58,value:17},{source:62,target:59,value:13},{source:62,target:48,value:7},{source:62,target:57,value:2},{source:62,target:41,value:1},{source:62,target:61,value:6},{source:62,target:60,value:3},{source:63,target:59,value:5},{source:63,target:48,value:5},{source:63,target:62,value:6},{source:63,target:57,value:2},{source:63,target:58,value:4},{source:63,target:61,value:3},{source:63,target:60,value:2},{source:63,target:55,value:1},{source:64,target:55,value:5},{source:64,target:62,value:12},{source:64,target:48,value:5},{source:64,target:63,value:4},{source:64,target:58,value:10},{source:64,target:61,value:6},{source:64,target:60,value:2},{source:64,target:59,value:9},{source:64,target:57,value:1},{source:64,target:11,value:1},{source:65,target:63,value:5},{source:65,target:64,value:7},{source:65,target:48,value:3},{source:65,target:62,value:5},{source:65,target:58,value:5},{source:65,target:61,value:5},{source:65,target:60,value:2},{source:65,target:59,value:5},{source:65,target:57,value:1},{source:65,target:55,value:2},{source:66,target:64,value:3},{source:66,target:58,value:3},{source:66,target:59,value:1},{source:66,target:62,value:2},{source:66,target:65,value:2},{source:66,target:48,value:1},{source:66,target:63,value:1},{source:66,target:61,value:1},{source:66,target:60,value:1},{source:67,target:57,value:3},{source:68,target:25,value:5},{source:68,target:11,value:1},{source:68,target:24,value:1},{source:68,target:27,value:1},{source:68,target:48,value:1},{source:68,target:41,value:1},{source:69,target:25,value:6},{source:69,target:68,value:6},{source:69,target:11,value:1},{source:69,target:24,value:1},{source:69,target:27,value:2},{source:69,target:48,value:1},{source:69,target:41,value:1},{source:70,target:25,value:4},{source:70,target:69,value:4},{source:70,target:68,value:4},{source:70,target:11,value:1},{source:70,target:24,value:1},{source:70,target:27,value:1},{source:70,target:41,value:1},{source:70,target:58,value:1},{source:71,target:27,value:1},{source:71,target:69,value:2},{source:71,target:68,value:2},{source:71,target:70,value:2},{source:71,target:11,value:1},{source:71,target:48,value:1},{source:71,target:41,value:1},{source:71,target:25,value:1},{source:72,target:26,value:2},{source:72,target:27,value:1},{source:72,target:11,value:1},{source:73,target:48,value:2},{source:74,target:48,value:2},{source:74,target:73,value:3},{source:75,target:69,value:3},{source:75,target:68,value:3},{source:75,target:25,value:3},{source:75,target:48,value:1},{source:75,target:41,value:1},{source:75,target:70,value:1},{source:75,target:71,value:1},{source:76,target:64,value:1},{source:76,target:65,value:1},{source:76,target:66,value:1},{source:76,target:63,value:1},{source:76,target:62,value:1},{source:76,target:48,value:1},{source:76,target:58,value:1}]},e=500,f=500;$(b).append('<div id="provenance-viewer">');var g=d3.scale.category20(),h=d3.layout.force().charge(-120).linkDistance(30).size([e,f]),i=d3.select("#provenance-viewer").append("svg").attr("width",e).attr("height",f);h.nodes(d.nodes).links(d.links).start();var j=i.selectAll(".link").data(d.links).enter().append("line").attr("class","link").style("stroke-width",function(a){return Math.sqrt(a.value)}),k=i.selectAll(".node").data(d.nodes).enter().append("circle").attr("class","node").attr("r",5).style("fill",function(a){return g(a.group)}).call(h.drag);k.append("title").text(function(a){return a.name}),h.on("tick",function(){j.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),k.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}}});