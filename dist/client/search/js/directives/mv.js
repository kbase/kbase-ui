angular.module("mv-directives",[]),angular.module("mv-directives").directive("mvmodelcore",function(a){return{link:function(b,c,d){var e=b.ws,f=b.ids;if(console.log("argumenets",e,f),f){$(c).loading("loading fba...");var g=[];for(var h in f){var i=f[h],j=e[h],k=kb.req("fba","get_fbas",{fbas:[i],workspaces:[j]});g.push(k)}$.when.apply($,g).done(function(){var d=[].concat.apply([],arguments),g=[];for(var h in d){var i=d[h].model_workspace,j=d[h].model,k=kb.req("fba","get_models",{models:[j],workspaces:[i]});g.push(k)}$(c).loading("loading model..."),$.when.apply($,g).done(function(){var g=[].concat.apply([],arguments);$(c).kbaseModelCore({ids:f,workspaces:e,modelsData:g,fbasData:d}),$(c).rmLoading(),$(document).on("coreRxnClick",function(c,d){$(".popover").each(function(){$(this).remove()});var e="/rxns/"+d.ids.join("&");b.$apply(a.path(e))})})})}}}}).directive("selectedobjs",function(){return{templateUrl:"views/mv/selected-objects.html",link:function(a,b,c){$(b).hide()}}}).directive("heatmap",function(a){return{link:function(a,b,c){function d(a){var b=[];for(var c in a){var d=a[c].reactions;for(var e in d)model_rxn=d[e].reaction,-1==b.indexOf(model_rxn)&&b.push(model_rxn)}return b}function e(a,b){for(var c=a.length,d=a[0].length,e=[],f=0;c>f;f++)for(var g=0;d>g;g++){for(var h=b[g],i=[],j=0;c>j;j++){var k=a[j][g].color;"white"!=k&&i.push(k)}i.length==c-f&&e.push(h)}return e}function f(a,b,c,d){var d=!0,e=[];for(var f in a){var g=a[f];rxn_list=g.reactions;var j=!1;for(var m in b)if(b[m].model==g.id){e.push(b[m]),j=!0;break}j||e.push([])}var n=[];for(var o in a){var p=h(a[o]),r=e[o].reactionFluxes,t=i(a[o]),u=[];for(var v in c){var w={},x=!1;for(var m in r){var y=r[m];if(y[0].slice(0,y[0].indexOf("_"))==c[v]){x=!0;var z=y[1];w.value=c[v],w.flux=z;break}}x&d?w.color=k(z,!0):x?w.color=k(z,!1):-1!=p.indexOf(c[v])?w.color=s:w.color="white";for(var A in t){var B=t[A];if(B.reaction==c[v]){w.hover=l(B,z),B.gapfilled&&(w.stroke=q);break}}u.push(w)}n.push(u)}return n}function g(a,b){var c=[],d=[],e=[];for(var f in a){var g=0;for(var h in a[f])a[f][h].color==s&&g++;e.push(g)}e.sort().reverse();for(var f in a){var g=0;for(var i in a[f])a[f][i].color==s&&g++;for(var h in e){var j=e[h];if(g==j){c.push(a[f]),d.push(b[f]+"  ("+g+" reactions)");break}}}return{org_names:d,rows:c}}function h(a){var b=[];for(var c in a.reactions)b.push(a.reactions[c].reaction);return b}function i(a){var b=[];for(var c in a.reactions)b.push(a.reactions[c]);return b}function j(a,b,c){var d=d3.select(".heatmap-view").append("svg").attr("width",2e4).attr("height",500),e=12,f=15;y_widths=[];for(var g in b){var h=d.append("text").attr("y",j+g*f+f-2).text(b[g]).attr("font-size","12px");y_widths.push(h.node().getBBox().width)}$("text").remove();for(var i=Math.max.apply(Math,y_widths)+5,j=100,g=0;g<b.length;g++){var k=d.append("text").attr("y",j+g*f+f-2).text(b[g]).attr("font-size","12px").on("mouseover",function(){d3.select(this).attr("fill","black")}).on("mouseout",function(){d3.select(this).attr("fill","#333")}),l=k.node().getBBox();k.attr("transform","translate("+String(i-l.width-4)+",0)");for(var m=0;m<a.length;m++){if(0==g){var n=i+m*e+e;d.append("text").attr("x",n).attr("y",j-5).text(a[m]).attr("font-size","10px").attr("transform","rotate(-45,"+n+","+j+")").on("mouseover",function(){d3.select(this).attr("fill","black"),d3.select(this).attr("font-weight","700")}).on("mouseout",function(){d3.select(this).attr("fill","#333"),d3.select(this).attr("font-weight","none")})}var o=c[g][m],p=d.append("rect").attr("x",i+m*e).attr("y",j+g*f).attr("width",e).attr("height",f).attr("fill",o.color).attr("stroke",function(){return o.stroke?o.stroke:r}).attr("data-value",o.value).attr("class","model-rxn");$(p.node()).popover({content:o.hover,title:b[g],trigger:"hover",html:!0,container:"body",placement:"bottom"})}}}function k(a,b){if(b)if(a>100)var c=o[0];else if(a>50)var c=o[1];else if(a>10)var c=o[2];else if(a>5)var c=o[3];else if(a>.01)var c=o[4];else if(-100>a)var c=p[0];else if(-50>a)var c=p[1];else if(-10>a)var c=p[2];else if(-5>a)var c=p[3];else if(-.01>a)var c=p[4];else var c=s;else if(Math.abs(a)>100)var c=o[0];else if(Math.abs(a)>50)var c=o[1];else if(Math.abs(a)>10)var c=o[2];else if(Math.abs(a)>5)var c=o[3];else if(Math.abs(a)>.01)var c=o[4];else var c=s;return c}function l(a,b){var c="";return c+="<b>Rxn:</b> "+a.reaction+"<br>",c+="<b>Eq:</b> "+a.definition+"<br>",c+="<b>Flux Value:</b> "+b+"<br><br>"}$(b).append('<div class="heatmap-view"></div>');var m=a.ws,n=a.ids;if(n){var o=["#731d1d","#8a2424","#b35050","#d05060","#f28e8e"],p=["#4f4f04","#7c7c07","#8b8d08","#acc474","#dded00"],q="#f000ff",r="#777",s="#8bc7e5";$(b).loading("loading fba...");var t=[];for(var u in n){var v=n[u],w=m[u],x=kb.req("fba","get_fbas",{fbas:[v],workspaces:[w]});t.push(x)}$.when.apply($,t).done(function(){var a=[].concat.apply([],arguments),c=[];for(var h in a){var i=a[h].model_workspace,k=a[h].model,l=kb.req("fba","get_models",{models:[k],workspaces:[i]});c.push(l)}$(b).loading("loading model..."),$.when.apply($,c).done(function(){var c=[].concat.apply([],arguments);$(b).rmLoading();var h=[];for(var i in c)h.push(c[i].name);all_rxns=d(c),all_rxns.sort(),rows=f(c,a,all_rxns),all_rxns=e(rows,all_rxns),rows=f(c,a,all_rxns);var k=g(rows,h);rows=k.rows,h=k.org_names,j(all_rxns,h,rows)})})}}}});