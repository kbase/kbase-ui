var kbaseNarrativeManager=angular.module("NarrativeManager",[]);kbaseNarrativeManager.factory("NarrativeManager",function(){return kbaseNarrativeManager()});var searchApp=angular.module("search",["ui.router","ui.bootstrap","NarrativeManager"]);searchApp.config(function(a,b,c){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"],b.state("search",{url:"/search/?q&category&page&itemsPerPage&sort&facets",templateUrl:"views/search/search.html",controller:"searchController"}).state("search.recent",{url:"/recent/",templateUrl:"views/search/recent.html",controller:"searchController"}).state("search.favorites",{url:"/favorites/",templateUrl:"views/search/favorites.html",controller:"searchController"}),c.decorator("$rootScope",["$delegate",function(a){return Object.defineProperty(a.constructor.prototype,"$bus",{get:function(){var a=this;return{subscribe:function(){var b=postal.subscribe.apply(postal,arguments);a.$on("$destroy",function(){b.unsubscribe()})},channel:postal.channel,publish:postal.publish}},enumerable:!1}),a}]),$(document).ajaxStop($.unblockUI())}),searchApp.factory("require",function(a){function b(b,c,d){c=c||angular.noop,d=d||angular.noop,require(b||[],function(){var b=arguments;a.$apply(function(){c.apply(this,b)})},function(){var b=arguments;a.$apply(function(){d.apply(this,b)})})}return b}),searchApp.service("searchCategoryLoadService",function(a,b,c){return{getCategoryInfo:function(){var d=a.defer();return b.get(c.kb.search_url+"categories").then(function(a){this.categoriesJSON=a.data,d.resolve(a)}),d.promise}}}),searchApp.service("searchKBaseClientsService",function(a,b,c){return{getWorkspaceClient:function(a){return new Workspace(c.kb.ws_url,{token:a})},getNarrativeManager:function(a){return new NarrativeManager({ws_url:c.kb.ws_url,nms_url:c.kb.nms_url},a)}}}),searchApp.service("searchOptionsService",function(){var a="KBasePublicGenomesV4",b="KBasePublicRichGenomesV4",c="wilke:Data",d=$.KBaseSessionSync.getKBaseSession();d||(d={token:null,user_id:null,name:null});var e={token:d.token,user_id:d.user_id,name:d.name,selectAll:{},selectedWorkspace:null,viewType:"compact",breadcrumbs:{},displayWorkspaces:!1,set:{genomes:!0,features:!0,metagenomes:!0,models:!1,models_fba:!0,models_media:!1},data_cart:{size:0,all:!1,data:{},types:{genomes:{all:!1,size:0,markers:{}},features:{all:!1,size:0,markers:{}},metagenomes:{all:!1,size:0,markers:{}},models:{size:0,subtypes:{models_fba:{all:!1,size:0,markers:{}},models_media:{all:!1,size:0,markers:{}}}}}},transfer_cart:{size:0,items:{}},version:.6},f={workspaces:null,version:.6};(!sessionStorage.hasOwnProperty("searchUserState")||!sessionStorage.searchUserState.version||sessionStorage.searchUserState.version<e.version)&&sessionStorage.setItem("searchUserState",JSON.stringify(e));for(var g in e)e.hasOwnProperty(g)&&!sessionStorage.searchUserState.hasOwnProperty(g)&&(sessionStorage.searchUserState[g]=e[g]);(!localStorage.hasOwnProperty("searchUserState")||!localStorage.searchUserState.version||localStorage.searchUserState.version<f.version)&&localStorage.setItem("searchUserState",JSON.stringify(f));for(var g in f)f.hasOwnProperty(g)&&!localStorage.searchUserState.hasOwnProperty(g)&&(localStorage.searchUserState[g]=f[g]);return{categoryInfo:{},categoryTemplates:{},categoryGroups:{},searchCategories:{},categoryRelationships:{},expandedCategories:{genomes:!0,features:!0,metagenomes:!0,models_media:!0,models_fba:!0},related:{},numPageLinks:10,defaultSearchOptions:{general:{itemsPerPage:10},perCategory:{}},categoryCounts:{},searchOptions:this.defaultSearchOptions,defaultMessage:"KBase is processing your request...",userState:{longterm:JSON.parse(localStorage.searchUserState),session:JSON.parse(sessionStorage.searchUserState)},publicWorkspaces:{search_genome:b,genomes:a,features:a,metagenomes:c},landingPagePrefix:"/#/dataview/",iconMapping:{metagenomes:"<span class='fa-stack'><i class='fa fa-circle fa-stack-2x' style='color: rgb(255, 193, 7);'></i><i class='icon fa-inverse fa-stack-1x icon-metagenome kb-data-icon-dnudge'></i></span>",genomes:"<span class='fa-stack'><i class='fa fa-circle fa-stack-2x' style='color: rgb(63, 81, 181);'></i><i class='icon fa-inverse fa-stack-1x icon-genome kb-data-icon-dnudge'></i></span>",features:"<span class='fa-stack'><i class='fa fa-circle fa-stack-2x' style='color: rgb(63, 81, 181);'></i><i class='icon fa-inverse fa-stack-1x icon-genome kb-data-icon-dnudge'></i></span>",models_fba:"<span class='fa-stack'><i class='fa fa-circle fa-stack-2x' style='color: rgb(0, 96, 100);'></i><i class='icon fa-inverse fa-stack-1x icon-metabolism kb-data-icon-dnudge'></i></span>",models_media:"<span class='fa-stack'><i class='fa fa-circle fa-stack-2x' style='color: rgb(244, 67, 54);'></i><i class='fa fa-inverse fa-stack-1x fa-flask'></i></span>",models:"<span class='fa-stack'><i class='fa fa-circle fa-stack-2x' style='color: rgb(0, 96, 100);'></i><i class='icon fa-inverse fa-stack-1x icon-metabolism kb-data-icon-dnudge'></i></span>",all:"<span class='fa-stack'><img id='logo' src='assets/navbar/images/kbase_logo.png' width='46'></span>"},resultJSON:{},objectCopyInfo:null,resultsAvailable:!1,countsAvailable:!1,transferring:!1,objectsTransferred:0,transferSize:0,selectedCategory:null,pageLinksRange:[],facets:null,active_facets:{},active_sorts:{},open_facet_panels:{},data_tabs:{},duplicates:{},reset:function(){this.categoryCounts={},this.resultJSON={},this.objectCopyInfo=null,this.resultsAvailable=!1,this.countsAvailable=!1,this.transferring=!1,this.objectsTransferred=0,this.transferSize=0,this.selectedCategory=null,this.pageLinksRange=[],this.facets=null,this.active_facets={},this.active_sorts={},this.open_facet_panels={},this.data_tabs={},this.duplicates={},this.searchOptions=this.defaultSearchOptions,this.userState={longterm:JSON.parse(localStorage.searchUserState),session:JSON.parse(sessionStorage.searchUserState)}}}}),searchApp.filter("highlight",function(a){return function(b,c){if(0==c.length||1==c.length&&"*"==c[0])return b;if(b){console.log(c);var d=new RegExp("("+c.join("|")+")","ig");return console.log(d.string),console.log(b.replace(d,'<span class="search-result-highlight">$&</span>')),a.trustAsHtml(b.replace(d,'<span class="search-result-highlight">$&</span>'))}return b}}),searchApp.controller("searchBarController",function(a,b,c){b.$on("queryChange",function(a,c){b.query=c}),b.newSearch=function(){b.query&&b.query.length>0?c.go("search",{q:b.query}):c.go("search",{q:"*"})}}),searchApp.controller("searchController",function(a,b,c,d,e,f,g,h,j,k,l){b.options=j,b.workspace_service,b.narrative_manager,b.$on("$stateChangeSuccess",function(a,c,d,e,f){"search"===c.name&&b.startSearch()}),b.$bus.subscribe({channel:"session",topic:"login.success",callback:function(a){var c=a.getKBaseSession();b.options.userState.session.token=c.token,b.options.userState.session.user_id=c.token,b.options.userState.session.name=c.token}}),b.login=function(){postal.channel("loginwidget").publish("login.prompt")},b.logout=function(){g={},postal.channel("session").publish("logout.request")},b.setNavbarTitle=function(a){l(["kb.widget.navbar"],function(c){b.navbar=c,b.navbar.clearMenu(),b.navbar.addDefaultMenu({search:!1}),b.navbar.clearTitle(),b.navbar.clearButtons(),b.navbar.setTitle(a)})},b.saveUserState=function(){localStorage.setItem("searchUserState",JSON.stringify(b.options.userState.longterm)),sessionStorage.setItem("searchUserState",JSON.stringify(b.options.userState.session))},b.loadCategories=function(){var a=function(c){if(c.hasOwnProperty("category")&&b.options.categoryInfo.categories.hasOwnProperty(c.category)&&(b.options.searchCategories[c.category]={category:c.category,label:c.label}),c.hasOwnProperty("children"))for(var d=0;d<c.children.length;d++)a(c.children[d])};for(var c in b.options.categoryInfo.displayTree)b.options.categoryInfo.displayTree.hasOwnProperty(c)&&a(b.options.categoryInfo.displayTree[c]);var d=function(a,c){if(a.hasOwnProperty("category")){if(b.options.categoryRelationships[a.category]={parent:c,children:[]},a.hasOwnProperty("children"))for(var e=0;e<a.children.length;e++)a.children[e].hasOwnProperty("category")&&(b.options.categoryRelationships[a.category].children.push(a.children[e].category),d(a.children[e],a.category))}else if(a.hasOwnProperty("children"))for(var e=0;e<a.children.length;e++)d(a.children[e],c)};d(b.options.categoryInfo.displayTree.unauthenticated,null);var e=function(a,b){var c=[a.split("_"),b.split("_")];if(c[0][0]!==c[1][0])return!1;if(c[0].length<c[1].length){if(1===c[0].length)return!0;for(var d=0;d<c[0].length;d++)if(c[0][d]!==c[1][d])return!1;return!0}if(1===c[1].length)return!0;for(var d=0;d<c[1].length;d++)if(c[1][d]!==c[0][d])return!1;return!0};for(var c in b.options.categoryRelationships)if(b.options.categoryRelationships.hasOwnProperty(c)){b.options.related[c]={};for(var f in b.options.categoryRelationships)b.options.related[c][f]=e(c,f)}b.options.templates={};for(var c in b.options.searchCategories)b.options.searchCategories.hasOwnProperty(c)&&"models"!==c&&(b.options.templates[c]={},b.options.templates[c].root="views/search/searchCategory.html",b.options.templates[c].header="views/search/categories/"+c+"/"+c+"_header.html",b.options.templates[c].rows="views/search/categories/"+c+"/"+c+"_rows.html",b.options.templates[c].expanded="views/search/categories/"+c+"/"+c+"_expanded.html"),b.options.searchCategories.hasOwnProperty(c)&&"models"===c&&(b.options.templates[c]={},b.options.templates[c].root="views/search/categories/models.html")},b.sanitizeFacets=function(a){for(var b,c="",d=a.split(","),e=0;e<d.length;e++)b=d[e].split(":"),c+=b[1].indexOf('"')<0?b[0]+':"'+b[1]+'",':b[0]+":"+b[1]+",";return c.substring(0,c.length-1)},b.getCount=function(c,d){var f={};angular.copy(c,f),f.page=1,f.itemsPerPage=0,f.category=d,f.hasOwnProperty("facets")&&f.facets&&(f.facets=b.sanitizeFacets(c.facets)),b.options.userState.session.hasOwnProperty("ajax_requests")&&b.options.userState.session.ajax_requests||(b.options.userState.session.ajax_requests=[]),b.options.userState.session.ajax_requests.push(e({method:"GET",url:a.kb.search_url+"getResults",params:f,responseType:"json"}).then(function(a){void 0===a.data.totalResults?b.options.categoryCounts[d]=0:b.options.categoryCounts[d]=a.data.totalResults,b.options.selectedCategory&&d===b.options.selectedCategory&&(countsAvailable=!0)},function(a){console.log(a),b.options.categoryCounts[d]=0},function(a){console.log(a)}))},b.getTotalCount=function(){var a=0;for(var c in b.options.categoryCounts)b.options.categoryCounts.hasOwnProperty(c)&&(a+=b.options.categoryCounts[c]);return a},b.getResults=function(d,h){var i={};if(b.options.userState.session.hasOwnProperty("ajax_requests")&&b.options.userState.session.ajax_requests||(b.options.userState.session.ajax_requests=[]),null===d||void 0===d){i={q:h.general.q},$("#loading_message_text").html(h.defaultMessage),$.blockUI({message:$("#loading_message")});for(var j in b.options.searchCategories)b.options.searchCategories.hasOwnProperty(j)&&null!==b.options.searchCategories[j].category?(b.options.searchCategories[j].category===b.options.selectedCategory&&h.perCategory[j].hasOwnProperty("facets")&&h.perCategory[j].facets&&(i.facets=b.sanitizeFacets(h.perCategory[j].facets)),b.getCount(i,b.options.searchCategories[j].category),i={q:h.general.q}):b.options.categoryCounts[d]=0;return b.options.countsAvailable=!0,void c.all(b.options.userState.session.ajax_requests).then(function(){$.unblockUI(),b.options.userState.session.ajax_requests=[],b.searchActive=!1})}i.category=d;for(var k in h)if("general"===k){for(var l in h.general)h.general.hasOwnProperty(l)&&(i[l]=h.general[l]);i.hasOwnProperty("token")&&delete i.token}else if("perCategory"===k)for(var m in h.perCategory[d])h.perCategory[d].hasOwnProperty(m)&&(i[m]=h.perCategory[d][m]);i.hasOwnProperty("facets")&&i.facets&&(i.facets=b.sanitizeFacets(i.facets)),$("#loading_message_text").html(h.defaultMessage),$.blockUI({message:$("#loading_message")}),e({method:"GET",url:a.kb.search_url+"getResults",params:i,responseType:"json"}).then(function(a){for(var c=0;c<a.data.items.length;c++)a.data.items[c].position=(a.data.currentPage-1)*a.data.itemsPerPage+c+1,a.data.items[c].hasOwnProperty("object_id")?a.data.items[c].row_id=a.data.items[c].object_id.replace(/\||\./g,"_"):a.data.items[c].hasOwnProperty("feature_id")?a.data.items[c].row_id=a.data.items[c].feature_id.replace(/\||\./g,"_"):a.data.items[c].hasOwnProperty("genome_id")&&(a.data.items[c].row_id=a.data.items[c].genome_id.replace(/\||\./g,"_")),a.data.items[c].hasOwnProperty("taxonomy")&&(a.data.items[c].taxonomy=a.data.items[c].taxonomy.join("; "));if(b.options.resultJSON=a.data,b.options.resultsAvailable=!0,b.options.pageLinksRange=[],b.options.facets=null,b.options.resultJSON.hasOwnProperty("facets")){b.options.facets=[];for(var d in b.options.resultJSON.facets)if(b.options.resultJSON.facets.hasOwnProperty(d)){for(var e=[],h=0,c=0;c<b.options.resultJSON.facets[d].length-1;c+=2)e.push({key:b.options.resultJSON.facets[d][c],value:b.options.resultJSON.facets[d][c+1]}),h+=b.options.resultJSON.facets[d][c+1];b.options.facets.push({key:d,value:e,count:h})}}var i,j=b.options.resultJSON.currentPage%b.options.numPageLinks;i=0===j?b.options.resultJSON.currentPage-b.options.numPageLinks+1:b.options.resultJSON.currentPage-j+1;for(var k=i+b.options.numPageLinks,d=i;k>d&&(d-1)*b.options.resultJSON.itemsPerPage<b.options.resultJSON.totalResults;d++)b.options.pageLinksRange.push(d);b.options.resultJSON.items.length>0?b.options.currentItemRange=b.options.resultJSON.items[0].position+"-"+b.options.resultJSON.items[b.options.resultJSON.items.length-1].position:console.log(b.options),b.options.currentURL=f.href("search",g,{absolute:!0}),console.log(b.options.resultJSON),$.unblockUI()},function(a){console.log("getResults threw an error!"),console.log(a),b.options.resultsAvailable=!1,$.unblockUI()},function(a){console.log(a)})},b.newSearch=function(){b.options.searchOptions.general.q&&b.options.searchOptions.general.q.length>0&&(b.saveUserState(),b.options.selectedCategory?(b.getCount({q:b.options.searchOptions.general.q},b.options.selectedCategory),f.go("search",{q:b.options.searchOptions.general.q,category:b.options.selectedCategory,page:1,sort:null,facets:null})):f.go("search",{q:b.options.searchOptions.general.q}))},b.startSearch=function(){b.searchActive=!0,b.options.tokens=[];var a=function(){return h.getCategoryInfo().then(function(a){b.options.categoryInfo=a.data,b.loadCategories()})},c=function(){if(void 0===b.options.searchOptions&&b.options.reset(),void 0!==g.q&&null!==g.q&&""!==g.q?(b.options.searchOptions.general.q=g.q,b.options.tokens=g.q.split(" "),console.log(b.options.tokens)):b.options.reset(),null!==g.category&&g.category in b.options.searchCategories?(b.options.selectedCategory=g.category,b.setNavbarTitle("Search <span class='search-navbar-title'>"+b.options.iconMapping[b.options.selectedCategory]+b.options.searchCategories[g.category].label+"</span>"),b.options.selectedCategory&&!b.options.searchOptions.perCategory.hasOwnProperty(b.options.selectedCategory)&&(b.options.searchOptions.perCategory[b.options.selectedCategory]={page:1}),void 0!==g.page&&null!==g.page?b.setCurrentPage(g.page,!1):b.setCurrentPage(1,!1),null!==g.itemsPerPage&&g.itemsPerPage>0&&g.itemsPerPage<=100?b.options.searchOptions.general.itemsPerPage=g.itemsPerPage:b.options.searchOptions.general.itemsPerPage=10):(b.setNavbarTitle("Search <span class='search-navbar-title'>All Data Categories<span>"),b.options.reset()),null!==g.facets){delete b.options.searchOptions.perCategory[b.options.selectedCategory].facets,b.options.active_facets[b.options.selectedCategory]={};for(var a=g.facets.split(","),c=[],d=0;d<a.length;d++)c=a[d].split(":"),b.addFacet(c[0],c[1].replace("*",",").replace("^",":"),!1)}else b.options.facets=null,b.options.selectedCategory&&b.options.searchOptions.perCategory[b.options.selectedCategory].hasOwnProperty("facets")&&(delete b.options.searchOptions.perCategory[b.options.selectedCategory].facets,b.options.active_facets[b.options.selectedCategory]={});if(null!==g.sort){b.options.searchOptions.perCategory[b.options.selectedCategory].sort="",b.options.active_sorts[b.options.selectedCategory]={count:0,sorts:{}};for(var e=g.sort.split(","),f=[],d=0;d<e.length;d++)f=e[d].split(" "),b.addSort(b.options.selectedCategory,f[0],f[1],!1)}else b.options.active_sorts[b.options.selectedCategory]={count:0,sorts:{}},b.options.selectedCategory&&b.options.searchOptions.perCategory[b.options.selectedCategory].hasOwnProperty("sort")&&delete b.options.searchOptions.perCategory[b.options.selectedCategory].sort};if(b.options.categoryInfo.hasOwnProperty("displayTree")){c();var d={q:b.options.searchOptions.general.q};b.options.selectedCategory&&(b.options.searchOptions.perCategory[b.options.selectedCategory].hasOwnProperty("facets")&&(d.facets=b.options.searchOptions.perCategory[b.options.selectedCategory].facets),b.options.searchOptions.perCategory[b.options.selectedCategory].hasOwnProperty("sort")&&(d.sort=b.options.searchOptions.perCategory[b.options.selectedCategory].sort)),b.options.selectedCategory&&b.getCount(d,b.options.selectedCategory),b.getResults(b.options.selectedCategory,b.options.searchOptions)}else a().then(function(){c(),b.getResults(null,b.options.searchOptions),b.getResults(b.options.selectedCategory,b.options.searchOptions)})},b.selectCategory=function(a){b.options.selectedCategory=a,b.saveUserState(),null===a||"null"===a?(b.options.reset(),f.go("search",{category:null,page:null,itemsPerPage:null,facets:null,sort:null})):(b.options.searchOptions.perCategory.hasOwnProperty(a)||(b.options.searchOptions.perCategory[a]={page:1}),f.go("search",{category:b.options.selectedCategory,itemsPerPage:null,facets:null,sort:null}))},b.isInActiveCategoryTree=function(a){return b.options.related[a][b.options.selectedCategory]},b.removeSearchFilter=function(a,c,d,e){if(b.options.searchOptions.perCategory[a].hasOwnProperty(c)){var f;"sort"===c?f=b.options.searchOptions.perCategory[a][c].indexOf(d):"facets"===c&&(f=b.options.searchOptions.perCategory[a][c].indexOf(d+":"+e.replace(",","*").replace(":","^")));var g=b.options.searchOptions.perCategory[a][c].indexOf(",");f>-1&&(0===f&&0>g?b.options.searchOptions.perCategory[a][c]="":0===f&&g>f?b.options.searchOptions.perCategory[a][c]=b.options.searchOptions.perCategory[a][c].substring(g+1,b.options.searchOptions.perCategory[a][c].length):f>0&&(g=b.options.searchOptions.perCategory[a][c].indexOf(",",f),0>g?b.options.searchOptions.perCategory[a][c]=b.options.searchOptions.perCategory[a][c].substring(0,f-1):b.options.searchOptions.perCategory[a][c]=b.options.searchOptions.perCategory[a][c].substring(0,f-1)+b.options.searchOptions.perCategory[a][c].substring(g,b.options.searchOptions.perCategory[a][c].length))),0===b.options.searchOptions.perCategory[a][c].length&&delete b.options.searchOptions.perCategory[a][c]}},b.setResultsPerPage=function(a){b.options.searchOptions.general.itemsPerPage=parseInt(a),b.saveUserState(),f.go("search",{itemsPerPage:b.options.searchOptions.general.itemsPerPage,page:1})},b.addSort=function(a,c,d,e){b.options.searchOptions.perCategory[a].hasOwnProperty("sort")?(b.removeSort(a,c,!1),b.options.searchOptions.perCategory[a].hasOwnProperty("sort")?b.options.searchOptions.perCategory[a].sort.length>0?b.options.searchOptions.perCategory[a].sort+=","+c+" "+d:b.options.searchOptions.perCategory[a].sort+=c+" "+d:b.options.searchOptions.perCategory[a].sort=c+" "+d):b.options.searchOptions.perCategory[a].sort=c+" "+d,b.options.active_sorts[a].count=b.options.active_sorts[a].count+1,b.options.active_sorts[a].sorts[c]={order:b.options.active_sorts[a].count,direction:d},(void 0===e||e===!0)&&(b.saveUserState(),f.go("search",{sort:b.options.searchOptions.perCategory[a].sort,page:1}))},b.removeSort=function(a,c,d){if(b.removeSearchFilter(a,"sort",c,null),b.options.active_sorts.hasOwnProperty(a)&&b.options.active_sorts[a].sorts.hasOwnProperty(c)){if(b.options.active_sorts[a].sorts.hasOwnProperty(c)&&b.options.active_sorts[a].count-1>b.options.active_sorts[a].sorts[c].order)for(var e in b.options.active_sorts[a].sorts)b.options.active_sorts[a].sorts.hasOwnProperty(e)&&b.options.active_sorts[a].sorts[e].order>b.options.active_sorts[a].sorts[c].order&&(b.options.active_sorts[a].sorts[e].order-=1);b.options.active_sorts[a].count-=1,delete b.options.active_sorts[a].sorts[c]}(void 0===d||d===!0)&&(b.saveUserState(),f.go("search",{sort:b.options.searchOptions.perCategory[a].sort,page:1}))},b.setCurrentPage=function(a,c){try{b.options.searchOptions.perCategory[b.options.selectedCategory].page=parseInt(a)}catch(d){b.options.searchOptions.perCategory[b.options.selectedCategory]={page:parseInt(a)}}b.saveUserState(),(void 0===c||c===!0)&&f.go("search",{page:b.options.searchOptions.perCategory[b.options.selectedCategory].page})},b.toggleFacet=function(a,c,d){b.options.searchOptions.perCategory[b.options.selectedCategory].page=1,d?b.removeFacet(a,c):b.addFacet(a,c,!0),b.toggleFacetPanel(a)},b.toggleFacetPanel=function(a){b.options.open_facet_panels.hasOwnProperty(b.options.selectedCategory)?b.options.open_facet_panels[b.options.selectedCategory].hasOwnProperty(a)?b.options.open_facet_panels[b.options.selectedCategory][a]===!1?b.options.open_facet_panels[b.options.selectedCategory][a]=!0:b.options.open_facet_panels[b.options.selectedCategory][a]=!1:b.options.open_facet_panels[b.options.selectedCategory][a]=!0:(b.options.open_facet_panels[b.options.selectedCategory]={},b.options.open_facet_panels[b.options.selectedCategory][a]=!0)},b.isFacetPanelCollapsed=function(a){return!angular.element("#"+a+"_panel").hasClass("in")},b.addFacet=function(a,c,d){b.options.searchOptions.perCategory[b.options.selectedCategory].hasOwnProperty("facets")?b.options.searchOptions.perCategory[b.options.selectedCategory].facets+=","+a+":"+c.replace(",","*").replace(":","^"):b.options.searchOptions.perCategory[b.options.selectedCategory].facets=a+":"+c.replace(",","*").replace(":","^"),b.options.active_facets.hasOwnProperty(b.options.selectedCategory)||(b.options.active_facets[b.options.selectedCategory]={}),b.options.active_facets[b.options.selectedCategory].hasOwnProperty(a)||(b.options.active_facets[b.options.selectedCategory][a]={}),b.options.active_facets[b.options.selectedCategory][a][c]=!0,(void 0===d||d===!0)&&(b.getCount({q:b.options.searchOptions.general.q,facets:b.options.searchOptions.perCategory[b.options.selectedCategory].facets},b.options.selectedCategory),f.go("search",{category:b.options.selectedCategory,facets:b.options.searchOptions.perCategory[b.options.selectedCategory].facets,page:1}))},b.removeFacet=function(a,c,d){b.removeSearchFilter(b.options.selectedCategory,"facets",a,c),delete b.options.active_facets[b.options.selectedCategory][a][c],$.isEmptyObject(b.options.active_facets[b.options.selectedCategory][a])&&delete b.options.active_facets[b.options.selectedCategory][a],b.options.searchOptions.perCategory[b.options.selectedCategory].hasOwnProperty("facets")||(b.options.active_facets[b.options.selectedCategory]={}),(void 0===d||d===!0)&&(b.getCount({q:b.options.searchOptions.general.q,facets:b.options.searchOptions.perCategory[b.options.selectedCategory].facets},b.options.selectedCategory),f.go("search",{category:b.options.selectedCategory,facets:b.options.searchOptions.perCategory[b.options.selectedCategory].facets,page:1}))},b.removeAllFacets=function(){var a=!1;for(var c in b.options.active_facets[b.options.selectedCategory])if(b.options.active_facets[b.options.selectedCategory].hasOwnProperty(c)){for(var d in b.options.active_facets[b.options.selectedCategory][c])b.options.active_facets[b.options.selectedCategory][c].hasOwnProperty(d)&&(b.removeSearchFilter(b.options.selectedCategory,"facets",c,d),a=!0);delete b.options.active_facets[b.options.selectedCategory][c],b.options.searchOptions.perCategory[b.options.selectedCategory].hasOwnProperty("facets")||(b.options.active_facets[b.options.selectedCategory]={})}a&&(b.getCount({q:b.options.searchOptions.general.q,facets:b.options.searchOptions.perCategory[b.options.selectedCategory].facets},b.options.selectedCategory),f.go("search",{category:b.options.selectedCategory,facets:b.options.searchOptions.perCategory[b.options.selectedCategory].facets,page:1}))},b.setView=function(a){b.options.userState.session.viewType=a},b.listWorkspaces=function(){try{b.options.userState.session.displayWorkspaces=!0,b.workspace_service=k.getWorkspaceClient(b.options.userState.session.token),b.options.userState.longterm.workspaces=[],$(".blockMsg").addClass("search-block-element"),$("#loading_message_text").html("Looking for workspaces you can copy to..."),$("#workspace-area").block({message:$("#loading_message")}),b.workspace_service.list_workspace_info({perm:"w"}).then(function(a,c,d){b.$apply(function(){for(var c=[],d=0;d<a.length;d++){var e=a[d][8].narrative_nice_name;null!=e&&c.push(a[d])}a=c,b.options.userState.longterm.workspaces=a.sort(function(a,b){var c=a[8].narrative_nice_name,d=b[8].narrative_nice_name;return c.toLowerCase()<d.toLowerCase()?-1:c.toLowerCase()>d.toLowerCase()?1:0})}),$("#workspace-area").unblock(),$(".blockMsg").removeClass("search-block-element")},function(a,b,c){console.log([a,b,c]),$("#workspace-area").unblock(),$(".blockMsg").removeClass("search-block-element")})}catch(a){a.message&&a.name?console.log(a.name+" : "+a.message):console.log(a)}},b.selectWorkspace=function(a){10===a.length?(console.log("Workspace info has length of 10 : "+a),b.options.userState.session.selectedWorkspaceName=a[9].narrative_nice_name,b.options.userState.session.selectedWorkspace=a[2]):(b.options.userState.session.selectedWorkspaceName=a[8].narrative_nice_name,b.options.userState.session.selectedWorkspace=a[1]),angular.element(".workspace-chosen").removeClass("workspace-chosen"),angular.element("#"+a[1].replace(":","_")+"_"+a[4]).addClass("workspace-chosen"),b.options.objectsTransferred=0,b.options.transferRequests=0,b.options.transferSize=0,b.options.duplicates={},b.options.userState.session.displayWorkspaces=!1},b.copyGenome=function(a){return b.workspace_service.get_object_info([{name:b.options.userState.session.data_cart.data[a].genome_id,workspace:b.options.userState.session.data_cart.data[a].workspace_name.split("Rich").join("")}]).fail(function(a,b,c){console.log(a),console.log(b),console.log(c)}).done(function(c,d,e){function f(c){b.$apply(function(){b.options.objectsTransferred+=1,b.options.duplicates[a]={},b.options.objectsTransferred===b.options.transferSize&&b.completeTransfer()})}function g(c){h>i?(i+=1,console.log("Failed save, number of retries : "+(i-1)),j()):(console.log(e),console.log(d),console.log(g),console.log(feature_obj)),console.log("Object failed to copy"),console.log(c),b.transferError(b.options.userState.session.data_cart.data[a].object_name,b.options.userState.session.data_cart.data[a].object_id,c)}setTimeout(function(){},200);var h=10,i=0,j=function(){b.workspace_service.copy_object({from:{workspace:b.options.userState.session.data_cart.data[a].workspace_name.split("Rich").join(""),name:c[0][1]},to:{workspace:b.options.userState.session.selectedWorkspace,name:c[0][1]}},f,g)};b.options.transferRequests+=1,j()})},b.copyGenomeSet=function(a){},b.copyMetagenome=function(a){return b.workspace_service.get_object_info([{name:b.options.userState.session.data_cart.data[a].object_name,workspace:b.options.publicWorkspaces.metagenomes}]).fail(function(a,b,c){console.log(a),console.log(b),console.log(c)}).done(function(c,d,e){function f(c){b.$apply(function(){b.options.objectsTransferred+=1,b.options.duplicates[a]={},b.options.objectsTransferred===b.options.transferSize&&b.completeTransfer()})}function g(c){console.log("Object failed to copy"),console.log(c),b.transferError(b.options.userState.session.data_cart.data[a].object_name,b.options.userState.session.data_cart.data[a].object_id,c)}b.options.transferRequests+=1,b.workspace_service.copy_object({from:{workspace:b.options.publicWorkspaces.metagenomes,name:c[0][1]},to:{workspace:b.options.userState.session.selectedWorkspace,name:b.options.userState.session.data_cart.data[a].object_name}},f,g)})},b.copyFeature=function(a){var c=b.options.userState.session.data_cart.data[a].object_id.split("/");return b.workspace_service.get_object_subset([{name:b.options.userState.session.data_cart.data[a].genome_id+".featureset",workspace:b.options.userState.session.data_cart.data[a].workspace_name.split("Rich").join(""),included:["/features/"+c[2]]}]).fail(function(a,b,c){console.log(a),console.log(b),console.log(c)}).done(function(c,d,e){setTimeout(function(){},100),b.options.transferRequests+=1;var f,g={};try{f=c[0].data.features[b.options.userState.session.data_cart.data[a].feature_id].data;for(var h in f)if(f.hasOwnProperty(h))if("feature_id"===h)g.id=angular.copy(f[h]);else if("feature_type"===h)g.type=angular.copy(f[h]);else if("location"===h){var i=f[h].sort(function(a,b){return a[4]<b[4]?-1:a[4]>b[4]?1:0});g[h]=[];for(var j=i.length-1;j>=0;j--)g[h].unshift(i[j].slice(0,4))}else if("aliases"===h){g[h]=[];for(var k in f[h])f[h].hasOwnProperty(k)&&g[h].push(k+":"+f[h][k])}else f[h]&&(g[h]=angular.copy(f[h]))}catch(l){console.log(a),console.log(l)}var m=10,n=0,o=function(){b.workspace_service.save_objects({workspace:b.options.userState.session.selectedWorkspace,objects:[{data:g,type:"KBaseGenomes.Feature",name:f.feature_id,provenance:[{time:(new Date).toISOString().split(".")[0]+"+0000",service:"KBase Search",description:"Created from a Public Genome Feature",input_ws_objects:[]}],meta:{}}]}).fail(function(a,b,c){return m>n?(n+=1,console.log("Failed save, number of retries : "+(n-1)),o(),void 0):(console.log(a),console.log(b),console.log(c),console.log(g),c)}).done(function(c,d,e){return console.log("Save successful, object info : "+c),b.$apply(function(){b.options.objectsTransferred+=1,b.options.duplicates[a]={},b.options.objectsTransferred===b.options.transferSize&&b.completeTransfer()}),c})};o()})},b.copyTypedObject=function(a,c,d,e,f){function g(d){console.log("Object "+c+" copied successfully from "+e+" to "+f+" ."),b.$apply(function(){b.options.objectsTransferred+=1,b.options.duplicates[a]={},b.options.objectsTransferred===b.options.transferSize&&b.completeTransfer()})}function h(a){console.log("Object "+c+" failed to copy from "+e+" to "+f+" ."),console.log(a),b.transferError(c,d,a)}return b.options.transferRequests+=1,void 0===d||null===d?(console.log("no object ref for name "+c),b.workspace_service.copy_object({from:{workspace:e,name:c},to:{workspace:f,name:c}},g,h)):(console.log("had object ref "+d),b.workspace_service.copy_object({from:{ref:d},to:{workspace:f,name:c}},g,h))},b.addAllObjects=function(){if(!b.options.userState.session.selectedWorkspace)return void console.log("select a Narrative first");b.workspace_service=k.getWorkspaceClient(b.options.userState.session.token);var a=[],d=10,e={};b.options.transferSize=b.options.userState.session.transfer_cart.size,b.options.transferring=!0,b.options.transferRequests=0;var f=function(a){for(var d=[],f=0;f<a.length;f++)if(b.options.userState.session.data_cart.data[a[f]].object_type.indexOf("KBaseSearch.Genome")>-1)d.push(b.copyGenome(a[f]).then(function(){})),e.hasOwnProperty("genomes")||(e.genomes=!0);else if(b.options.userState.session.data_cart.data[a[f]].object_type.indexOf("KBaseSearch.Feature")>-1)d.push(b.copyFeature(a[f]).then(function(){})),e.hasOwnProperty("features")||(e.features=!0);else if(b.options.userState.session.data_cart.data[a[f]].object_type.indexOf("Communities.Metagenome")>-1)d.push(b.copyMetagenome(a[f]).then(function(){})),e.hasOwnProperty("metagenomes")||(e.metagenomes=!0);else if((b.options.userState.session.data_cart.data[a[f]].object_type.indexOf("KBaseFBA")>-1||b.options.userState.session.data_cart.data[a[f]].object_type.indexOf("KBaseBiochem")>-1)&&(e.hasOwnProperty("models")||(e.models=!0)),b.options.userState.session.data_cart.data[a[f]].object_type.indexOf("KBaseGwas")>-1&&(e.hasOwnProperty("gwas")||(e.gwas=!0)),
b.options.userState.session.data_cart.data[a[f]].hasOwnProperty("object_name")===!0)d.push(b.copyTypedObject(a[f],b.options.userState.session.data_cart.data[a[f]].object_name,b.options.userState.session.data_cart.data[a[f]].object_id,b.options.userState.session.data_cart.data[a[f]].workspace_name,b.options.userState.session.selectedWorkspace).then(function(){}));else{if(b.options.userState.session.data_cart.data[a[f]].hasOwnProperty("object_id")!==!0)return void console.log("no object reference found");console.log(b.options.userState.session.data_cart.data[a[f]]),b.workspace_service.get_object_info([{name:b.options.userState.session.data_cart.data[a[f]].object_id,workspace:b.options.userState.session.data_cart.data[a[f]].workspace_name}]).fail(function(a,b,c){console.log(a),console.log(b),console.log(c)}).done(function(c,e,g){d.push(b.copyTypedObject(a[f],c[0][1],b.options.userState.session.data_cart.data[a[f]].object_id,b.options.userState.session.data_cart.data[a[f]].workspace_name,b.options.userState.session.selectedWorkspace).then(function(){}))})}c.all(d).then(function(a){return b.workspace_service.get_workspace_info({workspace:b.options.userState.session.selectedWorkspace}).then(function(a){for(var c=b.options.userState.longterm.workspaces.length-1;c>=0;c--)if(b.options.userState.longterm.workspaces[c][1]===b.options.userState.session.selectedWorkspace){b.$apply(function(){b.options.userState.longterm.workspaces[c][4]=a[4]});break}},function(a){console.log(a)}),a},function(a){return a})};console.log("Copying objects...");for(var g in b.options.userState.session.data_cart.data)b.options.userState.session.data_cart.data.hasOwnProperty(g)&&a.push(g),a.length===d&&(f(a),a=[]);a.length>0&&(f(a),a=[]);for(var h in e)if(e.hasOwnProperty(h)&&b.options.userState.session.data_cart.types[h].hasOwnProperty("all"))b.options.userState.session.data_cart.types[h].all=!1;else if(e.hasOwnProperty(h)&&b.options.userState.session.data_cart.types[h].hasOwnProperty("subtypes"))for(var i in b.options.userState.session.data_cart.types[h].subtypes)b.options.userState.session.data_cart.types[h].subtypes.hasOwnProperty(i)&&(b.options.userState.session.data_cart.types[h].subtypes[i].all=!1)},b.addSet=function(){if(!b.options.userState.session.selectedWorkspace)return void console.log("select a Narrative first");b.workspace_service=k.getWorkspaceClient(b.options.userState.session.token);var a=[],d={};b.options.transferSize=b.options.userState.session.transfer_cart.size,b.options.transferring=!0,b.options.transferRequests=0,console.log("Copying objects..."),b.options.userState.session.data_cart.data[ws_objects[i]].object_type.indexOf("KBaseSearch.GenomeSet")>-1?(a.push(b.copyGenomeSet(ws_objects[i]).then(function(){})),d.hasOwnProperty("genomes")||(d.genomes=!0)):b.options.userState.session.data_cart.data[ws_objects[i]].object_type.indexOf("KBaseSearch.FeatureSet")>-1?(a.push(b.copyFeatureSet(ws_objects[i]).then(function(){})),d.hasOwnProperty("features")||(d.features=!0)):b.options.userState.session.data_cart.data[ws_objects[i]].object_type.indexOf("Communities.MetagenomeSet")>-1?(a.push(b.copyMetagenomeSet(ws_objects[i]).then(function(){})),d.hasOwnProperty("metagenomes")||(d.metagenomes=!0)):b.options.userState.session.data_cart.data[ws_objects[i]].object_type.indexOf("KBaseFBA.FBAModelSet")>-1&&(a.push(b.copyFBAModelSet(ws_objects[i]).then(function(){})),d.hasOwnProperty("models")||(d.models=!0)),c.all(a).then(function(a){return b.workspace_service.get_workspace_info({workspace:b.options.userState.session.selectedWorkspace}).then(function(a){for(var c=b.options.userState.longterm.workspaces.length-1;c>=0;c--)if(b.options.userState.longterm.workspaces[c][1]===b.options.userState.session.selectedWorkspace){b.$apply(function(){b.options.userState.longterm.workspaces[c][4]=a[4]});break}},function(a){console.log(a)}),a},function(a){return a});for(var e in d)if(d.hasOwnProperty(e)&&b.options.userState.session.data_cart.types[e].hasOwnProperty("all"))b.options.userState.session.data_cart.types[e].all=!1;else if(d.hasOwnProperty(e)&&b.options.userState.session.data_cart.types[e].hasOwnProperty("subtypes"))for(var f in b.options.userState.session.data_cart.types[e].subtypes)b.options.userState.session.data_cart.types[e].subtypes.hasOwnProperty(f)&&(b.options.userState.session.data_cart.types[e].subtypes[f].all=!1)},b.copySet=function(a){b.toggleAllDataCart(a),b.addSet(a),b.toggleAllDataCart(),b.emptyTransfers()},b.copyData=function(a){b.toggleAllDataCart(a),b.addAllObjects(a),b.toggleAllDataCart(),b.emptyTransfers()},b.hideTransferCartCheckboxes=function(){angular.element("input .search-data-cart-checkbox").addClass("hidden")},b.showTransferCartCheckboxes=function(){angular.element("input.search-data-cart-checkbox").removeClass("hidden")},b.completeTransfer=function(){b.options.transferSize===b.options.objectsTransferred&&(b.options.transferring=!1,b.showTransferCartCheckboxes())},b.removeSelection=function(a){if(a.object_type.indexOf(".Genome")>-1)delete b.options.userState.session.data_cart.types.genomes.markers[a.row_id],b.options.userState.session.data_cart.types.genomes.size-=1;else if(a.object_type.indexOf(".Feature")>-1)delete b.options.userState.session.data_cart.types.features.markers[a.row_id],b.options.userState.session.data_cart.types.features.size-=1;else if(a.object_type.indexOf(".Metagenome")>-1)delete b.options.userState.session.data_cart.types.metagenomes.markers[a.row_id],b.options.userState.session.data_cart.types.metagenomes.size-=1;else if(a.object_type.indexOf(".FBAModel")>-1||a.object_type.indexOf(".Media")>-1)delete b.options.userState.session.data_cart.types.models.markers[a.row_id],b.options.userState.session.data_cart.types.models.size-=1;else{if(!(a.object_type.indexOf("KBaseGwas")>-1))throw Error("Trying to delete unknown type!");delete b.options.userState.session.data_cart.types.gwas.markers[a.row_id],b.options.userState.session.data_cart.types.gwas.size-=1}delete b.options.userState.session.data_cart.data[a.row_id],b.options.userState.session.data_cart.size-=1},b.emptyCart=function(){b.options.userState.session.selectAll={},b.options.userState.session.data_cart={all:!1,size:0,data:{},types:{genomes:{all:!1,size:0,markers:{}},features:{all:!1,size:0,markers:{}},metagenomes:{all:!1,size:0,markers:{}},models:{size:0,subtypes:{models_fba:{all:!1,size:0,markers:{}},models_media:{all:!1,size:0,markers:{}}}}}}},b.emptyTransfers=function(){b.options.objectsTransferred=0,b.saveUserState()},b.transferError=function(a,c,d){b.options.userState.session.transferErrors||(b.options.userState.session.transferErrors={}),b.options.userState.session.transferErrors[a]={error:d}},b.toggleCheckbox=function(a,c){b.options.userState.session.data_cart.data.hasOwnProperty(a)?b.deselectCheckbox(a,c):b.selectCheckbox(a,c),b.saveUserState()},b.selectCheckbox=function(a,c){if(!b.options.userState.session.data_cart.data.hasOwnProperty(a))if(c.object_type.indexOf(".Genome")>-1)b.options.userState.session.data_cart.size+=1,b.options.userState.session.data_cart.data[a]={workspace_name:c.workspace_name,object_type:c.object_type,object_id:c.object_id,row_id:c.row_id,genome_id:c.genome_id,scientific_name:c.scientific_name,domain:c.domain,gc_content:c.gc_content,num_contigs:c.num_contigs,num_cds:c.num_cds,genome_dna_size:c.genome_dna_size,cart_selected:!1},b.options.userState.session.data_cart.types.genomes.markers[a]={},b.options.userState.session.data_cart.types.genomes.size+=1;else if(c.object_type.indexOf(".Feature")>-1)b.options.userState.session.data_cart.size+=1,b.options.userState.session.data_cart.data[a]={workspace_name:c.workspace_name,object_id:c.object_id,object_type:c.object_type,row_id:c.row_id,genome_id:c.genome_id,feature_id:c.feature_id,feature_source_id:c.feature_source_id,scientific_name:c.scientific_name,feature_type:c.feature_type,dna_sequence_length:c.dna_sequence_length,protein_translation_length:c.protein_translation_length,"function":c["function"],cart_selected:!1},b.options.userState.session.data_cart.types.features.markers[a]={},b.options.userState.session.data_cart.types.features.size+=1;else if(c.object_type.indexOf(".Metagenome")>-1)b.options.userState.session.data_cart.size+=1,b.options.userState.session.data_cart.data[a]={workspace_name:c.workspace_name,object_id:c.object_id,object_name:c.object_name,object_type:c.object_type,row_id:c.row_id,metagenome_id:c.metagenome_id,metagenome_name:c.metagenome_name,project_name:c.project_name,sample_name:c.sample_name,cart_selected:!1},b.options.userState.session.data_cart.types.metagenomes.markers[a]={},b.options.userState.session.data_cart.types.metagenomes.size+=1;else{if(!(c.object_type.indexOf("KBaseFBA")>-1||c.object_type.indexOf("KBaseBiochem")>-1))throw Error("Trying to add unknown type!");if(c.object_type.indexOf(".FBAModel")>-1)b.options.userState.session.data_cart.types.models.subtypes.models_fba.markers[a]={},b.options.userState.session.data_cart.types.models.subtypes.models_fba.size+=1,b.options.userState.session.data_cart.types.models.size+=1,b.options.userState.session.data_cart.data[a]={workspace_name:c.workspace_name,object_id:c.object_id,object_name:c.object_name,object_type:c.object_type,row_id:c.row_id,fba_model_id:c.fba_model_id,scientific_name:c.scientific_name,number_of_features:c.number_of_features,number_of_reactions:c.number_of_reactions,number_of_gapfillings:c.number_of_gapfillings,cart_selected:!1};else{if(!(c.object_type.indexOf(".Media")>-1))throw Error("Unknown Model type : "+c.object_type);b.options.userState.session.data_cart.types.models.subtypes.models_media.markers[a]={},b.options.userState.session.data_cart.types.models.subtypes.models_media.size+=1,b.options.userState.session.data_cart.types.models.size+=1,b.options.userState.session.data_cart.data[a]={workspace_name:c.workspace_name,object_id:c.object_id,object_name:c.object_name,object_type:c.object_type,row_id:c.row_id,media_id:c.media_id,media_name:c.media_name,media_type:c.media_type,number_of_compounds:c.number_of_compounds,is_defined:c.is_defined,is_minimal:c.is_minimal,cart_selected:!1}}b.options.userState.session.data_cart.size+=1}},b.deselectCheckbox=function(a,c){if(b.options.userState.session.data_cart.data.hasOwnProperty(a))if(delete b.options.userState.session.data_cart.data[a],b.options.userState.session.data_cart.size-=1,c.object_type.indexOf(".Genome")>-1)delete b.options.userState.session.data_cart.types.genomes.markers[a],b.options.userState.session.data_cart.types.genomes.size-=1;else if(c.object_type.indexOf(".Feature")>-1)delete b.options.userState.session.data_cart.types.features.markers[a],b.options.userState.session.data_cart.types.features.size-=1;else if(c.object_type.indexOf(".Metagenome")>-1)delete b.options.userState.session.data_cart.types.metagenomes.markers[a],b.options.userState.session.data_cart.types.metagenomes.size-=1;else{if(!(c.object_type.indexOf("KBaseFBA")>-1||c.object_type.indexOf("KBaseBiochem")>-1))throw Error("Trying to delete unknown type!");c.object_type.indexOf(".FBAModel")>-1?(delete b.options.userState.session.data_cart.types.models.subtypes.models_fba.markers[a],b.options.userState.session.data_cart.types.models.subtypes.models_fba.size-=1,b.options.userState.session.data_cart.types.models.size-=1):c.object_type.indexOf(".Media")>-1&&(delete b.options.userState.session.data_cart.types.models.subtypes.models_media.markers[a],b.options.userState.session.data_cart.types.models.subtypes.models_media.size-=1,b.options.userState.session.data_cart.types.models.size-=1)}},b.toggleAll=function(a){var c;if(b.options.userState.session.selectAll.hasOwnProperty(b.options.currentURL))if(b.options.userState.session.selectAll[b.options.currentURL].hasOwnProperty(b.options.currentItemRange)&&b.options.userState.session.selectAll[b.options.currentURL][b.options.currentItemRange])for(b.options.userState.session.selectAll[b.options.currentURL][b.options.currentItemRange]=!1,c=a.length-1;c>-1;c--)b.deselectCheckbox(a[c].row_id,a[c]);else for(b.options.userState.session.selectAll[b.options.currentURL][b.options.currentItemRange]=!0,c=a.length-1;c>-1;c--)b.selectCheckbox(a[c].row_id,a[c]);else for(b.options.userState.session.selectAll[b.options.currentURL]={},b.options.userState.session.selectAll[b.options.currentURL][b.options.currentItemRange]=!0,c=a.length-1;c>-1;c--)b.selectCheckbox(a[c].row_id,a[c]);b.saveUserState()},b.toggleAllDataCart=function(a){console.log("toggleAllDataCart : "+a);var c;if(a){if(!b.options.userState.session.data_cart.types.hasOwnProperty(a)){for(var d in b.options.userState.session.data_cart.types)if(b.options.userState.session.data_cart.types.hasOwnProperty(d)&&b.options.userState.session.data_cart.types[d].hasOwnProperty("subtypes")&&b.options.userState.session.data_cart.types[d].subtypes.hasOwnProperty(a)){if(b.options.userState.session.data_cart.types[d].subtypes[a].all){for(c in b.options.userState.session.data_cart.types[d].subtypes[a].markers)b.options.userState.session.data_cart.types[d].subtypes[a].markers.hasOwnProperty(c)&&(b.options.userState.session.data_cart.data[c].cart_selected=!1);return void b.emptyTransferCart()}for(c in b.options.userState.session.data_cart.types[d].subtypes[a].markers)b.options.userState.session.data_cart.types[d].subtypes[a].markers.hasOwnProperty(c)&&(b.options.userState.session.data_cart.data[c].cart_selected=!0);return b.addSelectedToTransferCart(),void b.isCartInWorkspace()}throw Error("Unrecognized type : "+a)}if(b.options.userState.session.data_cart.types[a].all){for(c in b.options.userState.session.data_cart.types[a].markers)b.options.userState.session.data_cart.types[a].markers.hasOwnProperty(c)&&(b.options.userState.session.data_cart.data[c].cart_selected=!1);b.emptyTransferCart()}else{for(c in b.options.userState.session.data_cart.types[a].markers)b.options.userState.session.data_cart.types[a].markers.hasOwnProperty(c)&&(b.options.userState.session.data_cart.data[c].cart_selected=!0);b.addSelectedToTransferCart(),b.isCartInWorkspace()}}else if(b.options.userState.session.data_cart.all){for(c in b.options.userState.session.data_cart.data)b.options.userState.session.data_cart.data.hasOwnProperty(c)&&(b.options.userState.session.data_cart.data[c].cart_selected=!0);b.addSelectedToTransferCart(),b.isCartInWorkspace()}else{for(c in b.options.userState.session.data_cart.data)b.options.userState.session.data_cart.data.hasOwnProperty(c)&&(b.options.userState.session.data_cart.data[c].cart_selected=!1);b.emptyTransferCart()}},b.toggleInCart=function(a){b.options.userState.session.data_cart.data[a].cart_selected?(b.options.userState.session.data_cart.data[a].cart_selected=!1,b.removeFromTransferCart(a)):(b.options.userState.session.data_cart.data[a].cart_selected=!0,b.addToTransferCart(a),b.isObjectInWorkspace(a))},b.addSelectedToTransferCart=function(){for(var a in b.options.userState.session.data_cart.data)b.options.userState.session.data_cart.data.hasOwnProperty(a)&&b.options.userState.session.data_cart.data[a].cart_selected&&!b.options.userState.session.transfer_cart.items.hasOwnProperty(a)&&b.addToTransferCart(a)},b.removeSelectedFromTransferCart=function(){for(var a in b.options.userState.session.data_cart.data)b.options.userState.session.data_cart.data.hasOwnProperty(a)&&b.options.userState.session.data_cart.data[a].cart_selected&&b.removeFromTransferCart(a)},b.addToTransferCart=function(a){console.log("Adding to cart : "+a),b.options.userState.session.transfer_cart.items.hasOwnProperty(a)||(b.options.userState.session.transfer_cart.items[a]={},b.options.userState.session.transfer_cart.size+=1)},b.removeFromTransferCart=function(a){b.options.userState.session.transfer_cart.items.hasOwnProperty(a)&&(delete b.options.userState.session.transfer_cart.items[a],b.options.userState.session.transfer_cart.size-=1)},b.emptyTransferCart=function(){b.options.userState.session.transfer_cart.items={},b.options.userState.session.transfer_cart.size=0},b.removeCartSelected=function(){for(var a in b.options.userState.session.data_cart.data)b.options.userState.session.data_cart.data.hasOwnProperty(a)&&b.options.userState.session.data_cart.data[a].cart_selected&&(b.removeFromTransferCart(a),b.removeSelection(b.options.userState.session.data_cart.data[a]))},b.getSearchbarTooltipText=function(){return b.options.selectedCategory?"Type here to perform a search on "+b.options.searchCategories[b.options.selectedCategory].label+".":"Type here to perform a search on all data categories."},b.isCartInWorkspace=function(){b.workspace_service=k.getWorkspaceClient(b.options.userState.session.token);var a=[],c=[],d=0;for(var e in b.options.userState.session.data_cart.data)b.options.userState.session.data_cart.data[e].object_type.indexOf(".Genome")>-1?a.push({workspace:b.options.userState.session.selectedWorkspace,name:b.options.userState.session.data_cart.data[e].genome_id}):b.options.userState.session.data_cart.data[e].object_type.indexOf(".Feature")>-1?a.push({workspace:b.options.userState.session.selectedWorkspace,name:b.options.userState.session.data_cart.data[e].feature_id}):a.push({workspace:b.options.userState.session.selectedWorkspace,name:b.options.userState.session.data_cart.data[e].object_name}),c[d]=e,d+=1;return b.workspace_service.get_object_info_new({objects:a,ignoreErrors:1}).then(function(a){b.$apply(function(){for(var d=c.length-1;d>-1;d--)null!==a[d]?b.options.duplicates[c[d]]={}:delete b.options.duplicates[c[d]]})},function(a){console.log(a)})},b.isObjectInWorkspace=function(a){b.workspace_service=k.getWorkspaceClient(b.options.userState.session.token);var c;return c=b.options.userState.session.data_cart.data[a].object_type.indexOf(".Genome")>-1?{workspace:b.options.userState.session.selectedWorkspace,name:b.options.userState.session.data_cart.data[a].genome_id}:b.options.userState.session.data_cart.data[a].object_type.indexOf(".Feature")>-1?{workspace:b.options.userState.session.selectedWorkspace,name:b.options.userState.session.data_cart.data[a].feature_id}:{workspace:b.options.userState.session.selectedWorkspace,name:b.options.userState.session.data_cart.data[a].object_name},b.workspace_service.get_object_info_new({objects:[c],ignoreErrors:1}).then(function(c){console.log(c),b.$apply(function(){null!==c[0]?b.options.duplicates[a]={}:delete b.options.duplicates[a]})},function(a){console.log(a)})}});