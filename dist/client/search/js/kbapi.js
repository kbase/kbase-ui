function KBCacheClient(a){var b=this,c={};c.token=a;var d=null;"undefined"!=typeof configJSON&&configJSON.setup?(d=configJSON[configJSON.setup],fba_url=d.fba_url,ws_url=d.workspace_url,search_url=d.search_url):(fba_url="http://kbase.us/services/KBaseFBAModeling/",ws_url="https://kbase.us/services/ws/",search_url="http://dev07.berkeley.kbase.us/search/"),b.urls=d;var e=new fbaModelServices(fba_url,c),f=new Workspace(ws_url,c),g=new Cache;b.fba=e,b.ws=f,b.nar=new ProjectAPI(ws_url,a),b.ws_url=ws_url,b.search_url=search_url,b.token=a,b.nar_type="KBaseNarrative.Narrative",b.metagenome_url="./communities/metagenome.html?metagenome=",b.ui=new UIUtils,b.req=function(a,b,c){var d=g.get(a,b,c);if(d)return d.prom;var h=void 0;if("fba"==a){console.log("Making request:","fba."+b+"("+JSON.stringify(c)+")");var h=e[b](c)}else if("ws"==a){console.log("Making request:","kbws."+b+"("+JSON.stringify(c)+")");var h=f[b](c)}return g.put(a,b,c,h),h},b.narrative_prom=void 0,b.my_narratives=!1,b.shared_narratives=!1,b.public_narratives=!1,this.getNarratives=function(){var a=kb.ws.list_workspace_info({}),c=$.when(a).then(function(a){var b=[],c=[],d=[];for(var e in a){var f=a[e],g=f[1],h=f[2],i=f[5],j=f[6];h==USER_ID&&b.push(g),"a"!=i&&"w"!=i||h==USER_ID||c.push(g),"r"==j&&d.push(g)}return[b,c,d]}),d=$.when(c).then(function(a){function c(a,b,c){return c.indexOf(a)===b}var d=a[0],e=a[1],f=a[2],g=kb.ws.list_objects({workspaces:d,type:b.nar_type,showHidden:1}),h=kb.ws.list_objects({workspaces:e,type:b.nar_type,showHidden:1}),i=kb.ws.list_objects({workspaces:f,type:b.nar_type,showHidden:1}),j=$.when(g,h,i).then(function(a,b,d){var e=[];for(var f in a)e.push(a[f][7]);var g=e.filter(c),h=[];for(var f in b)h.push(b[f][7]);var i=h.filter(c);return g.concat(i)}),k=$.when(j).then(function(a){a=a;var b=[];if(USER_ID)for(var c in a){var d=kb.ws.get_permissions({workspace:a[c]});b.push(d)}var e=[g,h,i].concat(b),f=$.when.apply($,e).then(function(){for(var b=arguments[0],c=arguments[1],d=arguments[2],e={},f=0;f<a.length;f++)e[a[f]]=arguments[3+f];$(".my-nar-count").addClass("badge").text(b.length),$(".shared-nar-count").addClass("badge").text(c.length),$(".public-nar-count").addClass("badge").text(d.length);var g={my_narratives:b,shared_narratives:c,public_narratives:d,perms:e};return g});return f});return k});return b.narrative_prom=d,d},b.getNarrativeDeps=function(a){var c=a.ws,d=a.name,e=b.ws.get_object_info([{workspace:c,name:d}],1).then(function(a){var b=JSON.parse(a[0][10].data_dependencies),c=[];for(var d in b){var e={},f=b[d].split(" ");e.type=f[0],e.name=f[1],c.push(e)}return c});return e};new WSCache;b.get_fba=function(a,c){if(-1!=a.indexOf("/"))var d=b.ws.get_objects([{ref:a}]);else var d=b.ws.get_objects([{workspace:a,name:c}]);var e=$.when(d).then(function(a){var c=a[0].data.fbamodel_ref,d=b.get_model(c).then(function(c){var d=c[0].data.modelreactions,e=c[0].data.modelcompounds,f=b.createEQs(e,d,"modelReactionReagents"),g=a[0].data.FBAReactionVariables;for(var h in g){var i=g[h],j=i.modelreaction_ref.split("/")[5];i.eq=f[j]}return a[0].org_name=c[0].data.name,a});return d});return e},b.get_model=function(a,c){if(a&&-1!=a.indexOf("/"))var d=b.ws.get_objects([{ref:a}]);else var d=b.ws.get_objects([{workspace:a,name:c}]);var e=$.when(d).then(function(a){console.log("model",a);var c=a[0].data,d=c.modelreactions,e=c.modelcompounds,f=b.createEQs(e,d,"modelReactionReagents"),g=c.modelreactions;for(var h in g){var i=g[h];i.eq=f[i.id]}var j=c.biomasses,f=b.createEQs(e,j,"biomasscompounds");for(var h in j){var i=j[h];i.eq=f[i.id]}return a});return e},b.createEQs=function(a,b,c){var d={};for(var e in a)d[a[e].id.split("_")[0]]=a[e].name.split("_")[0];var f={};for(var e in b){var g=b[e],h=g.id,i=g[c],j=g.direction,k=[],l=[];for(var m in i){var n=i[m],o=n.coefficient,p=n.modelcompound_ref,q=p.split("/")[3].split("_")[0],r=d[q],s=p.split("_")[1];0>o?k.push(-1==o?r+"["+s+"]":"("+-1*o+")"+r+"["+s+"]"):l.push(1==o?r+"["+s+"]":"("+o+")"+r+"["+s+"]")}var t;("="===j||"<=>"===j)&&(t=" <=> "),("<"===j||"<="===j)&&(t=" <= "),(">"===j||"=>"===j)&&(t=" => ");var u=k.join(" + ")+t+l.join(" + ");f[h]=u}return f},b.getRoute=function(a){switch(a){case"FBA":return"ws.fbas";case"FBAModel":return"ws.models";case"Media":return"ws.media";case"MetabolicMap":return"ws.maps";case"Media":return"ws.media";case"PromConstraint":return"ws.promconstraint";case"Regulome":return"ws.regulome";case"ExpressionSeries":return"ws.expression_series";case"PhenotypeSet":return"ws.phenotype";case"PhenotypeSimulationSet":return"ws.simulation";case"Pangenome":return"ws.pangenome";case"Genome":return"genomesbyid";case"MAKResult":return"mak";case"FloatDataTable":return"floatdatatable";case"Metagenome":return"ws.metagenome";case"Collection":return"ws.collection";case"Profile":return"ws.profile"}},b.getWorkspaceSelector=function(a){if(a)var c=b.ws.list_workspace_info({});else var c=b.ws.list_workspace_info({perm:"w"});var d=$.when(c).then(function(a){function b(a,b){var c=kb.ui.getTimestamp(b[3]),d=kb.ui.getTimestamp(a[3]);return d>c?-1:c>d?1:0}var a=a.sort(b),c=$('<form class="form-horizontal" role="form"><div class="form-group"><label class="col-sm-5 control-label">Workspace</label><div class="input-group col-sm-5"><input type="text" class="select-ws-input form-control focusedInput" placeholder="search"><span class="input-group-btn"><button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown"><span class="caret"></span></button></span></div></div>'),d=$('<ul class="dropdown-menu select-ws-dd" role="menu">');for(var e in a)d.append("<li><a>"+a[e][1]+"</a></li>");c.find(".input-group-btn").append(d);var f=c.find(".select-ws-dd"),g=c.find("input"),h=$('<li class="select-ws-dd-not-found"><a><b>Not Found</b></a></li>');return f.append(h),g.keyup(function(){f.find("li").show(),c.find(".input-group-btn").addClass("open");var a=$(this).val();f.find("li").each(function(){return-1!=$(this).text().toLowerCase().indexOf(a.toLowerCase())?!0:void $(this).hide()}),1==f.find("li").is(":visible")?h.hide():h.show()}),f.find("li").click(function(){if(f.find("li").removeClass("active"),!$(this).hasClass("select-ws-dd-not-found")){$(this).addClass("active");var a=$(this).text();g.val(a)}}),c});return d}}function UIUtils(){this.notify=function(a,b,c){var d=$('<div id="notification-container"><div id="notification" class="'+b+'">'+(c?' <small><div class="close"><span class="glyphicon glyphicon-remove pull-right"></span></div></small>':"")+a+"</div></div>");$(d).find(".close").click(function(){$("#notification").animate({top:0},200,"linear")}),$("body").append(d),$("#notification").delay(200).animate({top:50},400,"linear",function(){c||$("#notification").delay(2e3).animate({top:0},200,"linear",function(){$(this).remove()})})};var a=6e4,b=60*a,c=24*b,d={0:"Sun",1:"Mon",2:"Tues",3:"Wed",4:"Thurs",5:"Fri",6:"Sat"},e={0:"Jan",1:"Feb",2:"March",3:"April",4:"May",5:"June",6:"July",7:"Aug",8:"Sept",9:"Oct",10:"Nov",11:"Dec"};this.formateDate=function(f){var g=new Date,h=g.getTime()-f,i=Math.floor(h/c);h-=i*c;var j=Math.floor(h/b);h-=j*b;var k=Math.floor(h/a);h-=k*a;var l=Math.floor(h/1e3);if(0==i&&0==j&&0==k)return l+" secs ago";if(0==i&&0==j)return 1==k?"1 min ago":k+" mins ago";if(0==i)return 1==j?"1 hour ago":j+" hours ago";if(1==i){var m=new Date(f),n=m.toLocaleTimeString().split(":");return"yesterday at "+n[0]+":"+n[1]+" "+n[2].split(" ")[1]}if(7>i){var m=new Date(f),o=d[m.getDay()],n=m.toLocaleTimeString().split(":");return o+" at "+n[0]+":"+n[1]+" "+n[2].split(" ")[1]}var m=new Date(f);return e[m.getMonth()]+" "+m.getDate()+", "+m.getFullYear()},this.getTimestamp=function(a){if(a){var b=a.split("T")[0].split("-"),c=a.split("T")[1].split(":");return c[2]=c[2].split("+")[0],Date.UTC(b[0],b[1]-1,b[2],c[0],c[1],c[2])}},this.readableSize=function(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Bytes";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,c),2)+" "+b[c]},this.objTable=function(a){var b=a.obj,c=a.keys;if(a.keysAsLabels){var d=[];for(var e in c){var f=c[e].key.replace(/(id|Id)/g,"ID"),g=f.split(/_/g);for(var h in g)g[h]=g[h].charAt(0).toUpperCase()+g[h].slice(1);var i=g.join(" ");d.push(i)}}else if("labels"in a)var d=a.labels;else for(var e in c){var j=c[e];"label"in j?d.push(j.label):d.push(j.key)}var k=$('<table class="table table-striped table-bordered">');for(var e in c){var l=c[e],m=$("<tr>");if(a.bold)var n=$("<td><b>"+d[e]+"</b></td>");else var n=$("<td>"+d[e]+"</td>");var o=$("<td>");if("format"in l){var p=l.format(b);o.append(p)}else"bool"==l.type?o.append(1==b[l.key]?"True":"False"):o.append(b[l.key]);m.append(n,o),k.append(m)}return k},this.listTable=function(a){var b=a.array,c=a.labels,d=a.bold?!0:!1,e=$('<table class="table table-striped table-bordered"                               style="margin-left: auto; margin-right: auto;"></table>');for(var f in c)e.append("<tr><td>"+(d?"<b>"+c[f]+"</b>":c[f])+"</td>                           <td>"+b[f]+"</td></tr>");return e},this.translateRefs=function(a,b){var c=[];for(var d in a)c.push({ref:a[d]});var e=kb.ws.get_object_info(c),f=$.when(e).then(function(b){for(var c={},d=0;d<b.length;d++){var e,f=b[d],g=f[2],h=(g.split(".")[0],g.slice(g.indexOf(".")+1)),i=h.split("-")[0],j=f[7]+"/"+f[1];switch(i){case"FBA":sub="fbas/";break;case"FBAModel":sub="models/";break;case"Media":e="media/";break;case"Genome":e="genomes/";break;case"MetabolicMap":e="maps/";break;case"PhenotypeSet":e="phenotype/"}var k='<a href="#/'+e+j+'">'+j+"</a>";c[a[d]]={link:k,label:j}}return c});return f},this.refsToJson=function(a){var b=[];for(var c in a)b.push({ref:a[c]});var d={},e=kb.ws.get_object_info(b),f=$.when(e).then(function(a){for(var b=0;b<a.length;b++){var c=a[b],e=c[2],f=(e.split(".")[0],e.slice(e.indexOf(".")+1)),g=f.split("-")[0],h=c[7]+"/"+c[1];g in d||(d[g]=[]),d[g].push(h)}return d});return f},this.formatUsers=function(a,b){var c=[];for(var d in a)d!=USER_ID||b||"*"in a?d!=USER_ID&&c.push(d):c.push("You");if(0==c.length)return"Nobody";var e=3,f="";return c.length>e?f=c.slice(0,e).join(", ")+',  <a class="btn-share-with" data-users="'+c+'">+'+c.slice(e).length+" user</a>":c.length>0&&c.length<=e&&(f=c.slice(0,e).join(", ")),f},this.globalPermDropDown=function(a){var b=$('<select class="form-control create-permission" data-value="n">                        <option value="n">None</option>                        <option value="r">Read</option>                    </select>');return"n"==a?b.find("option[value='n']").attr("selected","selected"):"r"==a?b.find("option[value='r']").attr("selected","selected"):b.find("option[value='n']").attr("selected","selected"),$("<div>").append(b).html()},$.fn.loading=function(a,b){return $(this).rmLoading(),b?"undefined"!=typeof a?$(this).append('<p class="text-center text-muted loader"><br><img src="assets/img/ajax-loader-big.gif"> '+a+"</p>"):$(this).append('<p class="text-center text-muted loader"><br><img src="assets/img/ajax-loader-big.gif"> loading...</p>'):"undefined"!=typeof a?$(this).append('<p class="text-muted loader"><img src="assets/img/ajax-loader.gif"> '+a+"</p>"):$(this).append('<p class="text-muted loader"><img src="assets/img/ajax-loader.gif"> loading...</p>'),this},$.fn.rmLoading=function(){$(this).find(".loader").remove()}}function Cache(){var a=[];this.get=function(b,c,d){for(var e in a){var f=a[e];if(b==f.service&&c==f.method&&angular.equals(f.params,d))return f}},this.put=function(b,c,d,e){var f={};f.service=b,f.method=c,f.prom=e,f.params=d,a.push(f)}}function WSCache(){var a={};this.get=function(b){if(b.ref)return a[b.ref];var c=b.ws,d=b.type,e=b.name;return c in a&&d in a[c]&&e in a[c][d]?a[c][d][e]:void 0},this.put=function(b){if(b.ref)return b.ref in a?!1:(a[b.ref]=b.prom,!0);var c=b.ws,d=b.name,e=b.type;return c in a&&e in a[c]&&d in a[c][e]?!1:(c in a||(a[c]={}),e in a[c]||(a[c][e]={}),a[c][e][d]=b.prom,!0)}}function getBio(a,b,c){var d=new fbaModelServices("https://kbase.us/services/fba_model_services/");new Workspace("http://kbase.us/services/ws");b.append('<div class="progress">          <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 3%;">          </div>        </div>');var e=d.get_biochemistry({}),f=250;k=1,$.when(e).done(function(b){if("cpds"==a)var e=b.compounds;else if("rxns"==a)var e=b.reactions;for(var g=e.length,h=parseInt(g/f),i=[],j=0;h>j;j++){var l=e.slice(j*f,(j+1)*f-1);if("cpds"==a)var m=d.get_compounds({compounds:l});else if("rxns"==a)var m=d.get_reactions({reactions:l});$.when(m).done(function(a){k+=1,i=i.concat(a);var b=i.length/g*100+"%";$(".progress-bar").css("width",b),k==h&&($(".progress").remove(),c(i))})}})}function ProjectAPI(a,b){var c=this,d={};d.token=b;var e=new Workspace(a,d),f=/^ws\.(\d+)\.obj\.(\d+)$/;obj_meta_fields=["id","type","moddate","instance","command","lastmodifier","owner","workspace","ref","chsum","metadata","objid"];var g=function(a){return a.reduce(function(a,b,c){return a[obj_meta_fields[c]]=b,a},{})};obj_meta_fields2=["id","type","moddate","instance","command","lastmodifier","owner","workspace","ref","chsum","metadata"];var h={project:"_project"},i="KBaseNarrative.Metadata",j="KBaseNarrative.Narrative",k={type:j,data:{nbformat:3,nbformat_minor:0,metadata:{format:"ipynb",creator:"",ws_name:"",name:"",type:"Narrative",description:"",data_dependencies:[]},worksheets:[{cells:[{collapsed:!1,input:"",outputs:[],language:"python",metadata:{},cell_type:"code"}],metadata:{}}]}},l=({id:h.project,type:i,data:{description:"Tag! You're a project!"},workspace:void 0,metadata:{},auth:void 0},{name:h.project,type:i,data:{description:""},workspace:void 0,meta:{},provenance:[],hidden:1});this.ensure_home_project=function(a){alert("ensure_home_project has been removed!")},this.get_projects=function(a){var b=e.list_objects({type:"KBaseNarrative.Metadata",showHidden:1});return b},this.get_project=function(a){var b={callback:void 0,workspace_id:void 0},c=$.extend(b,a),d=e.list_workspace_objects({workspace:c.workspace_id});$.when(d).then(function(a){var b={};$.each(a,function(a,c){var d=g(c);b[c[0]]=d}),c.callback(b)})},this.get_object=function(a){var b={callback:void 0,workspace_id:void 0,object_id:void 0,error_callback:error_handler},c=$.extend(b,a),d=e.get_object({type:c.type,workspace:c.workspace,id:c.object_id});$.when(d).then(c.callback,c.error_callback)},this.delete_object=function(a){console.error("project.delete_object was removed since due to redundancy . use set_workspace_permissions in workspace api")},this.new_project=function(a){function b(){var b=$.extend(!0,{},l);b.data.description=a.description;var c={objects:[b]};c.workspace=d.project_id;var f=e.save_objects(c);return f}var c={project_id:void 0,def_perm:"n",description:""},d=$.extend(c,a),f=e.get_workspacemeta({workspace:d.project_id}),g=$.when(f).then(b,function(){var a=e.create_workspace({workspace:d.project_id,globalread:d.def_perm}),c=$.when(a).done(function(){return b()});return c});return g},this.get_project_description=function(a){var b=e.get_object({type:i,workspace:a,id:h.project}),c=$.when(b).then(function(a){return a.data.description});return c},this.set_project_description=function(a,b){var c=$.extend({},l);c.data.description=b;var d=e.save_objects({workspace:a,objects:[c]});return d},this.delete_project=function(a){var b={callback:void 0,project_id:void 0,error_callback:error_handler},c=$.extend(b,a),d=e.delete_workspace({workspace:c.project_id});$.when(d).then(c.callback,c.error_callback)},this.get_project_perms=function(a){var b={callback:void 0,project_id:void 0,error_callback:error_handler},c=$.extend(b,a),d=e.get_permissions({workspace:c.project_id});return $.when(d).fail(function(){c.error_callback})},this.set_project_perms=function(a){console.error("set_project_perms was removed since due to redundancy . use set_workspace_permissions in workspace api")},this.get_narratives=function(a){function b(b){if(a.showOnlyDeleted)var c=e.list_objects({workspaces:b,type:a.type,showHidden:1});else var c=e.list_objects({workspaces:b,type:a.type,showHidden:1});return c}var a=$.extend(a,{project_ids:void 0});if(a.project_ids)return b(a.project_ids);var d=c.get_projects().then(function(a){for(var c=[],d=0;d<a.length;d++)c.push(a[d][7]);return b(c)});return d},this._parse_object_id_string=function(a){if(void 0!=a.fq_id){var b=a.fq_id.match(f);b?(a.project_id=b[1],a.narrative_id=b[2]):a.error_callback("Cannot parse fq_id: "+a.fq_id)}},this.copy_narrative=function(a){var b={project_id:void 0,narrative_id:void 0,fq_id:void 0,callback:void 0,error_callback:error_handler},c=$.extend(b,a);this._parse_object_id_string(c);var d=this,f=e.get_object_info([{wsid:c.project_id,objid:c.narrative_id}],1);$.when(f).then(function(a){if(1!=a.length)c.error_callback("Error: narrative ws."+c.project_id+".obj."+c.narrative_id+" not found");else{var b=a[0],f=b[1],g=USER_ID+":home";d._get_narrative_deps_from_obj_info({obj_info:b,callback:function(a){var h=function(a){d._copy_one_object(b[6],b[1],b[4],g,a,function(a){var b="ws."+a[6]+".obj."+a[0];c.callback({fq_id:b})},c.error_callback)},i=d._get_time_stamp();$.when(e.get_object_info([{workspace:g,name:f}],0,function(a){h(f+"-"+i)},function(a){/^No object with .+ exists in workspace [:\w]+$/.test(a.error.message)||c.error_callback(a.error.message),h(f)})),$.each(a.deps,function(e,f){var h=a.deps[e].overwrite?a.deps[e].name+"-"+i:a.deps[e].name;d._copy_one_object(b[6],e,null,g,h,function(){},c.error_callback)})}})}})},this._copy_one_object=function(a,b,c,d,f,g,h){if(null==c){var i=e.get_object_info([{ref:a+"/"+b}],0);$.when(i).done(function(i){1!=i.length?h("Error: narrative ws."+p.project_id+".obj."+p.narrative_id+" not found"):(c=i[0][4],a=i[0][6],b=i[0][0],e.copy_object({from:{ref:a+"/"+b+"/"+c},to:{ref:d+"/"+f}},g,function(a){h(a.error.message)}))}),$.when(i).fail(function(a){h(a.error.message)})}else e.copy_object({from:{ref:a+"/"+b+"/"+c},to:{ref:d+"/"+f}},g,function(a){h(a.error.message)})},this._get_time_stamp=function(){var a=new Date,b=function(a){return 1==a.length?"0"+a:a};return a.getUTCFullYear().toString()+b((a.getUTCMonth()+1).toString())+b(a.getUTCDate().toString())+b(a.getUTCHours().toString())+b(a.getUTCMinutes().toString())+b(a.getUTCSeconds().toString())},this.get_narrative_deps=function(a){var b={callback:void 0,project_id:void 0,narrative_id:void 0,fq_id:void 0,callback:void 0,error_callback:error_handler},c=$.extend(b,a);this._parse_object_id_string(c);var d=this,f=e.get_object_info([{wsid:c.project_id,objid:c.narrative_id}],1);$.when(f).then(function(a){if(1!=a.length)c.error_callback("Error: narrative ws."+c.project_id+".obj."+c.narrative_id+" not found");else{var b={obj_info:a[0],callback:c.callback};d._get_narrative_deps_from_obj_info(b)}})},this._get_narrative_deps_from_obj_info=function(a){var b={},c=a.obj_info,d=c[10];b.fq_id="ws."+c[6]+".obj."+c[0],b.description=d.description,b.name=d.name;var f=$.parseJSON(d.data_dependencies),g=f.reduce(function(a,b,c){var d=b.split(" ");return a[d[1]]={},a[d[1]].type=d[0],a[d[1]].name=d[1],a[d[1]].overwrite=!1,a},{}),h=USER_ID+":home",i=[];$.each(g,function(a,b){i.push(e.get_object_info([{workspace:h,name:a}],0,function(b){g[a].overwrite=!0},function(a){console.log(a.error.message),!/^No object with .+ exists in workspace [:\w]+$/.test(a.error.message)}))}),i=$.map(i,function(a){var b=$.Deferred();return a.always(function(){b.resolve()}),b.promise()}),b.deps=g,$.when.apply($,i).done(function(){a.callback(b)})},this.new_narrative=function(a){var b={project_id:USER_ID+":home",narrative_id:void 0,description:"A KBase narrative"},c=$.extend(b,a),d=$.extend(!0,{},k);d.data.metadata.ws_name=c.project_id,d.name=c.narrative_id,d.data.metadata.name=c.narrative_id,d.data.metadata.creator=USER_ID;var f=e.save_objects({workspace:c.project_id,objects:[d]});return $.when(f).then(function(a){return g(a)})}}