define(["kb.widget.base","kb.session","jquery","postal","q","kb.appstate","kb.utils","kb.user_profile"],function(a,b,c,d,e,f,g,h){"use strict";var i=Object.create(a,{init:{value:function(a){a.name="LoginWidget",a.title="Login Widget",this.BaseWidget_init(a),d.channel("app").subscribe("location.change",function(){this.render()}.bind(this));var b=this;return this.container.on("submit",'[data-dialog="login-dialog"] form',function(a){a.preventDefault();var c=b.container.find('form [name="username"]').val(),d=b.container.find('form [name="password"]').val();b.login(c,d)}),this}},getUserLabel:{value:function(a){return a?g.getProp(a,"user.realname")+'<br><i style="font-size=90%;">'+g.getProp(a,"user.username")+"</i>":this.sessionObject?g.getProp("user_id"):""}},showErrorMessage:{value:function(a){var b=this.container.find('[data-alert="login-error"]');b.html(data.error.message),b.removeClass("hidden")}},hideErrorMessage:{value:function(){var a=this.container.find('[data-alert="login-error"]');a.addClass("hidden")}},createTemplateContext:{value:function(){return{isLoggedIn:b.isLoggedIn(),username:b.getUsername(),realname:b.getRealname()}}},renderAvatar:{value:function(a){var b=a.getProfile();this.container.find('[data-element="user-label"]').html(this.getUserLabel(b));var c=a.getAvatarURL({size:40,rating:"pg"});this.container.find('[data-element="avatar"]').attr("src",c)}},render:{value:function(){return b.isLoggedIn()?(this.container.html(this.renderTemplate("loggedin")),f.whenItem("userprofile").then(function(a){this.renderAvatar(a)}.bind(this)).done(),this.container.find('[data-menu-item="logout"]').on("click",function(a){a.preventDefault(),d.channel("session").publish("logout.request")})):/^#\/login\//.test(window.location.hash)?this.container.empty():(this.container.html(this.renderTemplate("loggedout")),this.container.find('[data-button="signin"]').on("click",function(){d.channel("loginwidget").publish("login.prompt")})),this}},showLoginDialog:{value:function(){var a=this.container.find('[data-dialog="login-dialog"]');a&&a.modal("show")}},closeLoginDialog:{value:function(){var a=this.container.find('[data-dialog="login-dialog"]');a&&a.modal("hide")}},login:{value:function(a,c){b.login({username:a,password:c}).then(function(a){a.status=1,a.success=1,d.channel("session").publish("login.success",{session:a})})["catch"](function(a){var b={status:0,success:0,message:a};d.channel("session").publish("login.failure",{error:b})}).done()}}});return i});