define(["nunjucks","jquery","q","kb.session","kb.utils","postal","json!config.json"],function(a,b,c,d,e,f,g){"use strict";var h=Object.create({},{BaseWidget_init:{value:function(b){return this._generatedId=0,this.globalConfig=g[g.setup],this.localConfig={},this.initConfig=b||{},this.setupConfig(),this.params={},e.isBlank(b.userId)?d.isLoggedIn()&&(this.params.userId=d.getUsername()):this.params.userId=b.userId,this.setupAuth(),this.setupCoreApp(),this.setup(),this.messages=[],this.error=null,this.state={},this.stateMeta={status:"none",timestamp:new Date},this.templates={},this.templates.env=new a.Environment(new a.WebLoader("src/widgets/"+this.widgetName+"/templates"),{autoescape:!1}),this.templates.env.addFilter("kbmarkup",function(a){return a&&(a=a.replace(/\n/g,"<br>")),a}),this.templates.cache={},this.context={},this.context.env={widgetTitle:this.widgetTitle,widgetName:this.widgetName},this.context.state=this.state,this.context.params=this.params,f.channel("session").subscribe("login.success",function(a){this.onLoggedIn(a.session)}.bind(this)),f.channel("session").subscribe("logout.success",function(){this.onLoggedOut()}.bind(this)),this}},setupConfig:{value:function(){if(this.configs=[{},this.initConfig,this.localConfig,this.globalConfig],!this.hasConfig("container"))throw"A container is required by this Widget, but was not provided.";if(!this.hasConfig("name"))throw"Widget name is required";if(!this.hasConfig("title"))throw"Widget title is required"}},setupCoreApp:{value:function(){this.container=this.getConfig("container"),"string"==typeof this.container&&(this.container=b(this.container)),this.widgetName=this.getConfig("name"),this.widgetTitle=this.getConfig("title"),this.instanceId=this.genId()}},setupAuth:{value:function(){d.refreshSession()}},start:{value:function(){this.setupUI(),this.renderWaitingView(),this.setInitialState().then(function(){return this.refresh()}.bind(this))["catch"](function(a){this.setError(a)}.bind(this)).done()}},setup:{value:function(){return this}},setupUI:{value:function(){return this.loadCSS(),this.renderLayout(),this}},stop:{value:function(){}},destroy:{value:function(){}},getConfig:{value:function(a,b){for(var c=0;c<this.configs.length;c++)if(void 0!==e.getProp(this.configs[c],a))return e.getProp(this.configs[c],a);return b}},setConfig:{value:function(a,b){e.setProp(this.configs[0],a,b)}},hasConfig:{value:function(a){for(var b=0;b<this.configs.length;b++)if(void 0!==e.getProp(this.configs[b],a))return!0;return!1}},setParam:{value:function(a,b){e.setProp(this.params,a,b),this.refresh().done()}},recalcState:{value:function(){this.setInitialState().then(function(){return this.refresh()}.bind(this))["catch"](function(a){this.setError(a)}.bind(this)).done()}},refresh:{value:function(){return c.Promise(function(a,b,c){this.refreshTimer||(this.refreshTimer=window.setTimeout(function(){this.refreshTimer=null,this.render(),a()}.bind(this),0))}.bind(this))}},setState:{value:function(a,b,c){e.setProp(this.state,a,b),c||this.refresh().done()}},setError:{value:function(a){if(a){var b;"string"==typeof a?b=a:"object"==typeof a&&(b=a.message?a.message:""+error),this.error={message:b,original:a},this.refresh().done()}}},checkState:{value:function(a){return this.stateMeta.status===a?!0:!1}},promise:{value:function(a,b,d){var e=c.defer();return a[b](d,function(a){e.resolve(a)},function(a){e.reject(a)}),e.promise}},setInitialState:{value:function(a){return c.Promise(function(a,b,c){a()})}},onLoggedIn:{value:function(a,b){this.setupAuth(),this.setup(),this.setInitialState({force:!0}).then(function(){this.refresh()}.bind(this))}},onLoggedOut:{value:function(a,b){this.setupAuth(),this.setup(),this.setInitialState({force:!0}).then(function(){this.refresh()}.bind(this))}},getTemplate:{value:function(a){return void 0===this.templates.cache[a]&&(this.templates.cache[a]=this.templates.env.getTemplate(a+".html")),this.templates.cache[a]}},createTemplateContext:{value:function(a){if(this.context.env.loggedIn=d.isLoggedIn(),d.isLoggedIn()?this.context.env.loggedInUser=d.getUsername():delete this.context.env.loggedInUser,this.context.env.instanceId=this.instanceId,this.context.env.isOwner=this.isOwner(),a){var b=e.merge({},this.context);return e.merge(b,a)}return this.context}},renderTemplate:{value:function(a,b){var c=this.getTemplate(a);if(!c)throw"Template "+a+" not found";var b=b?b:this.createTemplateContext();return c.render(b)}},genId:{value:function(){return"gen_"+this.widgetName+"_"+this._generatedId++}},renderError:{value:function(){var a=this.createTemplateContext({error:{message:e.getProp(this.error,"message")}});this.places.content.html(this.getTemplate("error").render(a))}},renderErrorView:{value:function(a){if(a){var b;"string"==typeof a?b=a:"object"==typeof a&&(a instanceof Error?b=a.message:a=""+a)}var c=this.createTemplateContext({error:b});this.places.content.html(this.getTemplate("error").render(c))}},niceElapsedTime:{value:function(a){var b=/(\d\d\d\d)-(\d\d)-(\d\d)T(\d\d):(\d\d):(\d\d)([\+\-])(\d\d\d\d)/,c=b.exec(a);if(!c)return"** Invalid Date Format **";if("0000"!==c[8])return"** Invalid Date TZ Offset "+c[8]+" **";var d=c[1]+"-"+c[2]+"-"+c[3]+"T"+c[4]+":"+c[5]+":"+c[6],e=new Date(d),f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],g="",h=e.getMinutes();return 10>h&&(h="0"+h),g=e.getHours()>=12?12!=e.getHours()?e.getHours()-12+":"+h+"pm":"12:"+h+"pm":e.getHours()+":"+h+"am",f[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()+" at "+g}},isOwner:{value:function(a){return a=a?a:"userId",d.isLoggedIn()&&d.getUsername()===this.params[a]?!0:!1}},render:{value:function(){return this.error?this.renderError():d.isLoggedIn()?(this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate("authorized"))):(this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate("unauthorized"))),this}},renderLayout:{value:function(){this.container.html(this.getTemplate("layout").render(this.createTemplateContext())),this.places={title:this.container.find('[data-placeholder="title"]'),alert:this.container.find('[data-placeholder="alert"]'),content:this.container.find('[data-placeholder="content"]')}}},renderWaitingView:{value:function(){this.places.content.html('<img src="assets/img/ajax-loader.gif"></img>')}},loadCSS:{value:function(){b("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href","src/widgets/"+this.widgetName+"/style.css")}},renderMessages:{value:function(){if(this.places.alert){this.places.alert.empty();for(var a=0;a<this.messages.length;a++){var b=this.messages[a],c="default";switch(b.type){case"success":c="success";break;case"info":c="info";break;case"warning":c="warning";break;case"danger":case"error":c="danger"}this.places.alert.append('<div class="alert alert-dismissible alert-'+c+'" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><strong>'+b.title+"</strong> "+b.message+"</div>")}}}},clearMessages:{value:function(){this.messages=[],this.renderMessages()}},addSuccessMessage:{value:function(a,b){void 0===b&&(b=a,a=""),this.messages.push({type:"success",title:a,message:b}),this.renderMessages()}},addWarningMessage:{value:function(a,b){void 0===b&&(b=a,a=""),this.messages.push({type:"warning",title:a,message:b}),this.renderMessages()}},addErrorMessage:{value:function(a,b){void 0===b&&(b=a,a=""),this.messages.push({type:"error",title:a,message:b}),this.renderMessages()}},logNotice:{value:function(a,b){console.log("NOTICE: ["+a+"] "+b)}},logDeprecation:{value:function(a,b){console.log("DEPRECATION: ["+a+"] "+b)}},logWarning:{value:function(a,b){console.log("WARNING: ["+a+"] "+b)}},logError:{value:function(a,b){console.log("ERROR: ["+a+"] "+b)}}});return h});