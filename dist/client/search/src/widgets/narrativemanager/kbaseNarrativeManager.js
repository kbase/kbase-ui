!function(a,b){a.KBWidget({name:"kbaseNarrativeManager",parent:"kbaseAuthenticatedWidget",version:"1.0.0",dontRedirect:!1,options:{loadingImage:"assets/img/ajax-loader.gif",nms_url:"https://kbase.us/services/narrative_method_store/rpc",ws_url:"https://kbase.us/services/ws",params:null},manager:null,ws_name:null,nar_name:null,$mainPanel:null,$newNarrativeLink:null,$errorPanel:null,init:function(b){if(this._super(b),!this.authToken()){var c,d=window.location.hash;return d&&d.length>0&&(c=d.substr(1)),console.log(encodeURIComponent(c)),window.location.replace("#/login/?nextPath="+encodeURIComponent(c)),this}return this.$errorPanel=a("<div>"),this.$elem.append(this.$errorPanel),this.$mainPanel=a("<div>").css({height:"300px"}).append("<img src="+this.options.loadingImage+"> loading..."),this.$elem.append(this.$mainPanel),this.manager=new NarrativeManager({ws_url:this.options.ws_url,nms_url:this.options.nms_url},this._attributes.auth),this.determineActionAndDoIt(),this},showError:function(b){var c=this;console.error(b);var d;d="string"==typeof b?b:b.message,c.$errorPanel.append(a("<div>").addClass("alert alert-danger alert-dismissible").attr("role","alert").append(d).append(a("<button>").addClass("close").attr("type","button").attr("data-dismiss","alert").attr("aria-label","Close").append(a("<span>").attr("aria-hidden","true").append("&times;"))))},determineActionAndDoIt:function(){var a=this;return null==a.options.params?void showError({message:"Recieved no parameter info - cannot proceed."}):void("start"===a.options.params.action?a.startOrCreateEmptyNarrative():"new"===a.options.params.action?a.createNewNarrative(a.options.params):a.showError('action "'+a.options.params.action+'" not supported; only "start" or "new" accepted.'))},createNewNarrative:function(a){var b=this;if(a.app&&a.method)return void b.showError("Must provide no more than one of the app or method params");var c=null;a.copydata&&(c=a.copydata.split(";"));var d=null;if(a.appparam)for(var e=a.appparam.split(";"),d=[],f=0;f<e.length;f++){if(d[f]=e[f].split(","),3!=d[f].length)return void b.showError("Illegal app parameter set, expected 3 parameters separated by commas: "+e[f]);if(d[f][0]=parseInt(d[f][0]),isNaN(d[f][0])||d[f][0]<1)return void b.showError("Illegal app parameter set, first item in set must be an integer > 0: "+e[f])}var g=[];a.app?g=[{app:a.app}]:a.method&&(g=[{method:a.method}]),b.manager.createTempNarrative({cells:g,parameters:d,importData:c},function(a){b.redirect(a.nar_info[6],a.nar_info[0])},function(a){b.showError(a)})},startOrCreateEmptyNarrative:function(){var a=this;a.manager.detectStartSettings(function(b){console.log(b),b.last_narrative?a.redirect(b.last_narrative.ws_info[0],b.last_narrative.nar_info[0]):a.manager.createTempNarrative({cells:[],parameters:[],importData:[]},function(b){a.redirect(b.nar_info[6],b.nar_info[0])},function(b){a.showError(b)})},function(b){a.showError(b)})},redirect:function(a,b){var c=this;c.$mainPanel.html('redirecting to <a href="/narrative/ws.'+a+".obj."+b+'">/narrative/ws.'+a+".obj."+b+"</a>"),c.dontRedirect||window.location.replace("/narrative/ws."+a+".obj."+b)}})}(jQuery);