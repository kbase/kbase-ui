var NarrativeManager=function(a,b,c){if(!a)return void console.error("NarrativeManager: options must be defined.");this.config={},this.config.ws_url=null,this.config.nms_url=null,a.ws_url?this.config.ws_url=a.ws_url:window.kbconfig&&window.kbconfig.urls&&(this.config.ws_url=window.kbconfig.urls.workspace),a.nms_url?this.config.nms_url=a.nms_url:window.kbconfig&&window.kbconfig.urls&&(this.config.nms_url=window.kbconfig.urls.narrative_method_store),("string"!=typeof this.config.ws_url||0===this.config.ws_url.trim().length)&&(this.config.ws_url="https://kbase.us/services/ws"),("string"!=typeof this.config.nms_url||0===this.config.nms_url.trim().length)&&(this.config.nms_url="https://kbase.us/services/narrative_method_store/rpc"),this.config.auth=b?b:{token:"",user_id:""},b.user_id||b.token&&(this.config.auth.user_id=b.token.split("|")[0].split("=")[1]),this.user_id=this.config.auth.user_id,this.config.auth_cb=c,this.ws=new Workspace(this.config.ws_url,this.config.auth,this.config.auth_cb),this.nms=new NarrativeMethodStore(this.config.nms_url,this.config.auth,this.config.auth_cb),this.createTempNarrative=function(a,b,c){var d=this,e=(new Date).getTime(),f=this.user_id+":"+e,g="Narrative."+e;console.log("creating "+g),console.log(a),d.ws.create_workspace({workspace:f,description:""},function(e){console.log("workspace created:"),console.log(e);d._buildNarrativeObjects(f,a.cells,a.parameters,function(h,i){d.ws.save_objects({workspace:f,objects:[{type:"KBaseNarrative.Narrative",data:h,name:g,meta:i,provenance:[{script:"NarrativeManager.js",description:"Created new Workspace/Narrative bundle."}],hidden:0}]},function(f){console.log("saved narrative:"),console.log(f[0]);var g={ws_info:e,nar_info:f[0]};d._complete_new_narrative(e[0],f[0][0],a.importData,function(){b(g)},c)},function(a){console.error(a),c&&c(a.error)})},c)},function(a){console.error(a),c&&c(a.error)})},this._complete_new_narrative=function(a,b,c,d,e){var f=this;f.ws.alter_workspace_metadata({wsi:{id:a},"new":{narrative:b+"",is_temporary:"true"}},function(){f._copy_to_narrative(a,c,d,e)},function(a){console.error(a),e&&e(a.error)})},this._copy_to_narrative=function(a,b,c,d){var e=this;if(null!=b&&0!=b){for(var f=[],g=0;g<b.length;g++)f.push({ref:b[g]});e.ws.get_object_info(f,0,function(f){for(var g=[],h=0;h<f.length;h++)g.push(e.ws.copy_object({from:{ref:b[h]},to:{wsid:a,name:f[h][1]}},function(a){console.log("copied"),console.log(a)},function(a){d&&d(a.error)}));$.when.apply($,g).done(function(){c()})},function(a){console.error(a),d&&d(a.error)})}else c()},this.detectStartSettings=function(a,b){var c=this,d={last_narrative:null};c.ws.list_workspace_info({owners:[c.user_id]},function(e){for(var f=[],g=0;g<e.length;g++)e[g][8]&&e[g][8].narrative&&f.push(e[g]);f.length>0?(f.sort(function(a,b){return a[3]>b[3]?-1:a[3]<b[3]?1:0}),c._findRecentValidNarrative(f,0,a,b)):a(d)},function(a){b&&b(a.error),console.error(a)})},this._findRecentValidNarrative=function(a,b,c,d){var e=this;if(b>=a.length)return void c({last_narrative:null});var f=a[b][0]+"/"+a[b][8].narrative;e.ws.get_object_info_new({objects:[{ref:f}],includeMetadata:1,ignoreErrors:1},function(f){return null==f[0]?e._findRecentValidNarrative(a,b+1,c,d):void c({last_narrative:{ws_info:a[b],nar_info:f[0]}})},function(a){d(a.error)})},this.discardTempNarrative=function(a,b,c){},this.cleanTempNarratives=function(a,b,c){},this._buildNarrativeObjects=function(a,b,c,d,e){var f=this;f._getSpecs(b,function(){var g={job_ids:{methods:[],apps:[],job_usage:{queue_time:0,run_time:0}},format:"ipynb",creator:f.user_id,ws_name:a,name:"Untitled",type:"KBaseNarrative.Narrative",description:"",data_dependencies:[]},h=[];if(b)if(b.length>0)for(var i=0;i<b.length;i++)if(b[i].app){var j=f._buildAppCell(h.length,f._specMapping.apps[b[i].app],c);h.push(j)}else if(b[i].method){var k=f._buildMethodCell(h.length,f._specMapping.methods[b[i].method],c);h.push(k)}else b[i].markdown?h.push({cell_type:"markdown",source:b[i].markdown,metadata:{}}):(console.error("cannot add cell "+i+", unrecognized cell content"),console.error(b[i]),e&&e({message:"cannot add cell "+i+", unrecognized cell content"}));else h.push({cell_type:"markdown",source:f.introText,metadata:{}});var l={nbformat_minor:0,worksheets:[{cells:h,metadata:{}}],metadata:g,nbformat:3},m={};for(var n in g)g.hasOwnProperty(n)&&("string"==typeof g[n]?m[n]=g[n]:m[n]=JSON.stringify(g[n]));d(l,m)},e)},this._buildAppCell=function(a,b,c){var d="kb-cell-"+a+"-"+this._uuidgen(),e={cell_type:"markdown",source:"<div id='"+d+"'></div>\n<script>$('#"+d+"').kbaseNarrativeAppCell({'appSpec' : '"+this._safeJSONStringify(b)+"', 'cellId' : '"+d+"'});</script>",metadata:{}},f={};f[this.KB_TYPE]=this.KB_APP_CELL,f.app=b;var g=[];if(c){for(var h={},i=0;i<c.length;i++){var j="step_"+c[i][0];j in h||(h[j]={},h[j].inputState={}),h[j].inputState[c[i][1]]=c[i][2]}var k={state:{step:h}};g.push(k)}return f[this.KB_STATE]=g,e.metadata[this.KB_CELL]=f,e},this._buildMethodCell=function(a,b,c){var d="kb-cell-"+a+"-"+this._uuidgen(),e={cell_type:"markdown",source:"<div id='"+d+"'></div>\n<script>$('#"+d+"').kbaseNarrativeMethodCell({'method' : '"+this._safeJSONStringify(b)+"'});</script>",metadata:{}},f={};f[this.KB_TYPE]=this.KB_FUNCTION_CELL,f.method=b;var g=[];if(c){for(var h={},i=0;i<c.length;i++)h[c[i][1]]=c[i][2];var j={state:h};g.push(j)}return f[this.KB_STATE]=g,f.widget=b.widgets.input,e.metadata[this.KB_CELL]=f,e},this._specMapping={apps:{},methods:{}},this._getSpecs=function(a,b,c){var d=this;if(a){var e=[],f=[];this._specMapping={apps:{},methods:{}};for(var g=0;g<a.length;g++)a[g].app?e.push(a[g].app):a[g].method&&f.push(a[g].method);var h=[];e.length>0&&h.push(d.nms.get_app_spec({ids:e},function(a){for(var b=0;b<a.length;b++)d._specMapping.apps[e[b]]=a[b]},function(a){console.error("error getting app specs:"),console.error(a),c&&c(a.error)})),f.length>0&&h.push(d.nms.get_method_spec({ids:f},function(a){for(var b=0;b<a.length;b++)d._specMapping.methods[f[b]]=a[b]},function(a){console.error("error getting method specs:"),console.error(a),c&&c(a.error)})),h.length>0?$.when.apply($,h).done(function(){b()}):b()}else b()},this._safeJSONStringify=function(a){var b=function(a){return a.replace(/'/g,"&apos;").replace(/"/g,"&quot;")};return JSON.stringify(a,function(a,c){return"string"==typeof c?b(c):c})},this._uuidgen=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},this.KB_CELL="kb-cell",this.KB_TYPE="type",this.KB_APP_CELL="kb_app",this.KB_FUNCTION_CELL="function_input",this.KB_OUTPUT_CELL="function_output",this.KB_ERROR_CELL="kb_error",this.KB_CODE_CELL="kb_code",this.KB_STATE="widget_state";var d=function(){var a="";return a+="![KBase Logo](<%= docBaseUrl %>/wp-content/uploads/2014/11/kbase-logo-web.png)\n",a+="Welcome to the Narrative Interface!\n",a+="===\n",a+="\n",a+="What's a Narrative?\n",a+="---\n",a+="\n",a+="Design and carry out collaborative computational experiments while\n",a+="creating Narratives: interactive, shareable, and reproducible records\n",a+="of your data, computational steps, and thought processes.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide">learn more...</a>\n',a+="\n",a+="\n",a+="Get Some Data\n",a+="---\n",a+="\n",a+="Click the Add Data button in the Data Panel to browse for KBase data or\n",a+="upload your own. Mouse over a data object to add it to your Narrative, and\n",a+="check out more details once the data appears in your list.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide/explore-data">learn more...</a>\n',a+="\n",a+="\n",a+="Analyze It\n",a+="---\n",a+="\n",a+="Browse available analyses that can be run using KBase apps or methods\n",a+="(apps are just multi-step methods that make some common analyses more\n",a+="convenient). Select an analysis, fill in the fields, and click Run.\n",a+="Output will be generated, and new data objects will be created and added\n",a+="to your data list. Add to your results by running follow-on apps or methods.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide/browse-apps-and-methods">learn more...</a>\n',a+="\n",a+="\n",a+="Save and Share Your Narrative\n",a+="---\n",a+="\n",a+="Be sure to save your Narrative frequently. When you're ready, click\n",a+="the share button above to let collaborators view your analysis steps\n",a+="and results. Or better yet, make your Narrative public and help expand\n",a+="the social web that KBase is building to make systems biology research\n",a+="open, collaborative, and more effective.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide/share-narratives/">learn more...</a>\n',a+="\n",a+="Find Documentation and Help\n",a+="---\n",a+="\n",a+="For more information, please see the\n",a+='<a href="<%= docBaseUrl %>/narrative-guide">Narrative Interface User Guide</a>\n',a+='or the <a href="<%= docBaseUrl %>/tutorials">app/method tutorials</a>.\n',a+="\n",a+='Questions? <a href="<%= docBaseUrl %>/contact-us">Contact us</a>!\n',a+="\n",a+="Ready to begin adding to your Narrative? You can keep this Welcome cell or\n",a+="delete it with the trash icon in the top right corner."}(),e=kb.urls?kb.urls.docsite.baseUrl:"http://kbase.us";this.introText=_.template(d)({docBaseUrl:e})};