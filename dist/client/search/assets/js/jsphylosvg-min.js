Smits={},Smits.Common={nodeIdIncrement:0,activeNode:0,roundFloat:function(a,b){for(var c=0,d=1;b>c;)d*=10,c++;return Math.round(a*d)/d},apply:function(a,b){if(a&&"object"==typeof b)for(var c in b)a[c]=b[c];return a},addRaphEventHandler:function(a,b,c,d){try{a[b](function(a,b){return function(c){b.e=c,a(b)}}(c,d))}catch(e){}},isInteger:function(a){return!isNaN(parseInt(a))},isXMLSerializerAvailable:function(){return"function"==typeof XMLSerializer?!0:!1},createSvgEl:function(a,b){if(a=document.createElementNS("http://www.w3.org/2000/svg",a),b)for(var c in b)b.hasOwnProperty(c)&&a.setAttribute(c,String(b[c]));return a},createGradientEl:function(a,b,c){if("radialGradient"!=b.type)return!1;if(a=Smits.Common.createSvgEl("radialGradient",{id:a,gradientUnits:"userSpaceOnUse",cx:c[0],cy:c[1],r:c[2],fx:c[0],fy:c[1]}),b.stop)for(b=b.stop,c=0;c<b.length;c++){var d=b[c];d["@attributes"]?a.appendChild(Smits.Common.createSvgEl("stop",d["@attributes"])):(d._attributes&&delete d._attributes,d._children&&delete d._children,d.__proto__&&delete d.__proto__,a.appendChild(Smits.Common.createSvgEl("stop",d)))}return a},setCssStyle:function(a,b){var c=document.styleSheets[0];c.addRule?c.addRule(a,b):c.insertRule&&c.insertRule(a+" { "+b+" }",c.cssRules.length)}},Smits.PhyloCanvas=function(){var a,b,c,d;return function(e,f,g,h,i){if(this.getNewickObject=function(){},this.clear=function(){},this.scale=function(a){c.svg.scale(a)},this.getSvg=function(){return c},this.getPhylogram=function(){return a},this.getSvgSource=function(){return Raphael.svg&&Smits.Common.isXMLSerializerAvailable()?(new XMLSerializer).serializeToString(c.svg.canvas):!1},"object"==typeof e)if(e.xml){var j=e.fileSource?e.xml:XMLObjectifier.textToXML(e.xml),j=XMLObjectifier.xmlToJSON(j);d=new Smits.PhyloCanvas.PhyloxmlParse(j)}else e.phyloxml?(j=e.fileSource?e.phyloxml:XMLObjectifier.textToXML(e.phyloxml),j=XMLObjectifier.xmlToJSON(j),d=new Smits.PhyloCanvas.PhyloxmlParse(j)):e.nexml?(j=e.fileSource?e.nexml:XMLObjectifier.textToXML(e.nexml),j=XMLObjectifier.xmlToJSON(j),d=new Smits.PhyloCanvas.NexmlParse(j,e)):e.json?d=new Smits.PhyloCanvas.PhyloxmlParse(e.json):e.newick?d=new Smits.PhyloCanvas.NewickParse(e.newick):e.nexmlJson?d=new Smits.PhyloCanvas.NexmlJsonParse(e):alert("Please set the format of input data");else d=new Smits.PhyloCanvas.NewickParse(e);b=f,c=new Smits.PhyloCanvas.Render.SVG(b,g,h),a="circular"==i?new Smits.PhyloCanvas.Render.CircularPhylogram(c,d):new Smits.PhyloCanvas.Render.Phylogram(c,d)}}(),Smits.PhyloCanvas.prototype={},Smits.PhyloCanvas.Node=function(){return function(a,b){this.id=Smits.Common.nodeIdIncrement+=1,this.newickLen=this.len=this.level=0,this.type=this.name="",this.chart={},this.img=[],a&&Smits.Common.apply(this,a),this._midBranchPosition=this._countImmediateChildren=this._countAllChildren=!1,this.children=[],b&&b.children.push(this)}}(),Smits.PhyloCanvas.Node.prototype={getCountAllChildren:function(){if(this._countAllChildren!==!1)return this._countAllChildren;var a,b=0;for(a in this.children)if(Smits.Common.isInteger(a)){var c=this.children[a];c.children&&c.children.length>0?b+=c.getCountAllChildren():b++}return this._countAllChildren=b},getCountImmediateChildren:function(){if(this._countImmediateChildren!==!1)return this._countImmediateChildren;var a,b=0;for(a in this.children)b+=this.children[a].length;return this._countImmediateChildren=b},getMidbranchPosition:function(a){if(this._midBranchPosition!==!1)return this._midBranchPosition;for(var b=[0,0],c=0;c<this.children.length;c++){var d=this.children[c];d.children&&d.children.length>0?0==c&&a?(b[0]=d.getMidbranchPosition(!0),b[1]+=d.getCountAllChildren()-1):0==c?(b[0]=d.getMidbranchPosition(),b[1]+=d.getCountAllChildren()):b[1]+=c==this.children.length-1?d.getMidbranchPosition():d.getCountAllChildren():0==c&&a?b[0]=0:(0==c&&(b[0]=1),b[1]+=1)}return this._midBranchPosition=b[1]>=b[0]?(b[1]+b[0])/2:b[0]}},Smits.PhyloCanvas.NewickParse=function(){var a,b,c,d,e=0,f=0,g=function(a){for(var c=new Smits.PhyloCanvas.Node;")"!==b&&","!==b;)if(":"===b)j(),c.len=Smits.Common.roundFloat(i(),4),0==c.len&&(c.len=1e-4);else if("'"===b||'"'===b){c.type="label";for(var d=c,e=b,f="";b!==e;)f+=b,j();d.name=f}else c.type="label",c.name=i();return c.level=a.level+1,c},h=function(a){var c=new Smits.PhyloCanvas.Node;for(a&&(c.level=a.level+1);")"!==b;)j(),"("===b?c.children.push(h(c)):c.children.push(g(c));return j(),":"!==b&&")"!==b&&","!==b&&";"!==b&&(c.type="label",c.name=i()),":"===b&&(j(),c.len=Smits.Common.roundFloat(i(),4),0==c.len&&(c.len=1e-4),c.type="stem"),c},i=function(){for(var a="";":"!==b&&")"!==b&&","!==b&&";"!==b;)a+=b,j();return a},j=function(){return b=a.charAt(c),c+=1,b},k=function(a){if(a.children&&a.children.length)for(var b=0;b<a.children.length;b++){var c=a.children[b];0===c.len&&(c.len=1),c.newickLen=Smits.Common.roundFloat(c.len+a.newickLen,4),c.level>e&&(e=c.level),c.newickLen>f&&(f=c.newickLen),c.children.length>0&&k(c,a)}return a};return function(b){this.getRoot=function(){return d},this.getLevels=function(){return e},this.getNewickLen=function(){return f},this.getValidate=function(){},f=e=0,a=b,c=0,j(),d=h(),d=k(d)}}(),Smits.PhyloCanvas.NewickParse.prototype={},Smits.PhyloCanvas.PhyloxmlParse=function(){var a,b,c=0,d=0,e=function(a,c){var d=new Smits.PhyloCanvas.Node;if(c&&(d.level=c.level+1),a.clade&&a.clade.length)for(var f=0;f<a.clade.length;f++)d.children.push(e(a.clade[f],d));if(a.branch_length&&("object"==typeof a.branch_length&&(a.branch_length=a.branch_length[0].Text),d.len=Smits.Common.roundFloat(a.branch_length,4),0==d.len&&(d.len=1e-4)),a.name?(d.type="label",d.name=a.name[0].Text,a.name[0]&&a.name[0].style&&(d.style=a.name[0].style),a.name[0]&&a.name[0].bgStyle&&(d.bgStyle=a.name[0].bgStyle)):a.confidence&&(d.name=a.confidence[0].Text),a.sequence&&a.sequence[0]&&a.sequence[0].name&&a.sequence[0].name[0]&&a.sequence[0].name[0].Text&&(d.sequenceName=a.sequence[0].name[0].Text),a.taxonomy&&a.taxonomy[0]&&(a.taxonomy[0].scientific_name&&a.taxonomy[0].scientific_name[0]&&a.taxonomy[0].scientific_name[0].Text&&(d.taxonomyScientificName=a.taxonomy[0].scientific_name[0].Text),a.taxonomy[0].common_name&&a.taxonomy[0].common_name[0]&&a.taxonomy[0].common_name[0].Text&&(d.taxonomyCommonName=a.taxonomy[0].common_name[0].Text)),a.sequence&&a.sequence[0]&&a.sequence[0].accession&&a.sequence[0].accession[0]&&a.sequence[0].accession[0].Text&&(d.sequenceAccession=a.sequence[0].accession[0].Text),a.point&&(d.LatLong=[a.point[0].lat[0].Text,a.point[0]["long"][0].Text]),d.name||(d.sequenceName?d.name=d.sequenceName:d.taxonomyScientificName?d.name=d.taxonomyScientificName:d.taxonomyCommonName?d.name=d.taxonomyCommonName:d.sequenceAccession&&(d.name=d.sequenceAccession),d.name&&(d.type="label")),a.annotation&&(a.annotation[0]&&a.annotation[0].desc&&a.annotation[0].desc[0]&&a.annotation[0].desc[0].Text&&(d.description=a.annotation[0].desc[0].Text),a.annotation[0]&&a.annotation[0].uri&&a.annotation[0].uri[0]&&a.annotation[0].uri[0].Text&&(d.uri=a.annotation[0].uri[0].Text),a.annotation[0]&&a.annotation[0].img))for(f in a.annotation[0].img)Smits.Common.isInteger(f)&&(d.img[f]=a.annotation[0].img[f].Text);if(a.chart&&a.chart[0])for(f in a.chart[0])"Text"!=f&&"_children"!=f&&(d.chart[f]=a.chart[0][f][0].Text);return d&&d.level>1&&(d.len||(b="Error. Please include Branch Lengths - we only draw rooted phylogenetic trees.")),d},f=function(a){if(a.children&&a.children.length)for(var b=0;b<a.children.length;b++){var e=a.children[b];e.newickLen=Math.round(1e4*(e.len+a.newickLen))/1e4,e.level>c&&(c=e.level),e.newickLen>d&&(d=e.newickLen),e.children.length>0&&f(e,a)}return a},g=function(a,b){for(var c in a)"_children"!=c&&"Text"!=c&&("rectangular"==c||"circular"==c?g(a[c][0],c):(Smits.PhyloCanvas.Render.Parameters[c]||(Smits.PhyloCanvas.Render.Parameters[c]={}),Smits.PhyloCanvas.Render.Parameters.set(c,a[c][0].Text,b)))};return function(h){if(this.getRoot=function(){return a},this.getLevels=function(){return c},this.getNewickLen=function(){return d},this.getValidate=function(){return b},h.phylogeny&&h.phylogeny[0]&&h.phylogeny[0].clade&&(a=e(h.phylogeny[0].clade[0])),h.phylogeny&&h.phylogeny[0]&&h.phylogeny[0].render&&h.phylogeny[0].render[0]){if((h=h.phylogeny[0].render[0])&&h.styles){var i,j=h.styles[0];for(i in j)if("_children"!=i&&"Text"!=i)if(j[i][0].type&&"radialGradient"==j[i][0].type&&Raphael.svg)j[i][0].name=i,Smits.PhyloCanvas.Render.Style[i]=j[i][0],Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList||(Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList=[]),Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList.push(i);else for(var k in Smits.PhyloCanvas.Render.Style[i]||(Smits.PhyloCanvas.Render.Style[i]={}),j[i][0])"_attributes"!=k&&"_children"!=k&&"type"!=k&&(Smits.PhyloCanvas.Render.Style[i][k.replace("_","-")]=j[i][0][k])}if(h&&h.parameters&&g(h.parameters[0]),h&&h.charts)for(i in h=h.charts[0])if("_children"!=i&&"Text"!=i)for(k in h[i])"binary"==h[i][k].type?(h[i][k].chart=i,Smits.PhyloCanvas.Render.Parameters.binaryCharts.push(h[i][k])):"integratedBinary"==h[i][k].type?(h[i][k].chart=i,Smits.PhyloCanvas.Render.Parameters.integratedBinaryCharts.push(h[i][k])):"bar"==h[i][k].type&&(h[i][k].chart=i,Smits.PhyloCanvas.Render.Parameters.barCharts.push(h[i][k]))}a=f(a)}}(),Smits.PhyloCanvas.PhyloxmlParse.prototype={},Smits.PhyloCanvas.NexmlParse=function(){var a,b,c,d,e=0,f=0,g=function(a,b,e){var f=new Smits.PhyloCanvas.Node;for(e&&(f.level=e.level+1),e=0;e<c.length;e++)if(c[e].source==a.id)for(var h=0;h<d.length;h++)c[e].target==d[h].id&&f.children.push(g(d[h],c[e].length,f));return f&&f.level>0&&!f.len&&(f.len=1),b&&(f.len=Smits.Common.roundFloat(b,4),0==f.len)&&(f.len=1e-4),a.label&&(f.type="label",f.name=a.label,a.style)&&(f.style=a.style),f},h=function(a){if(a.children&&a.children.length)for(var b=0;b<a.children.length;b++){var c=a.children[b];c.newickLen=Math.round(1e4*(c.len+a.newickLen))/1e4,c.level>e&&(e=c.level),c.newickLen>f&&(f=c.newickLen),c.children.length>0&&h(c,a)}return a};return function(i,j){this.getRoot=function(){return a},this.getLevels=function(){return e},this.getNewickLen=function(){return f},this.getValidate=function(){return b},j.tree&&i.trees[0]&&i.trees[0].tree[j.tree-1]?(c=i.trees[0].tree[j.tree-1].edge,d=i.trees[0].tree[j.tree-1].node):(c=i.trees[0].tree[0].edge,d=i.trees[0].tree[0].node);for(var k=0;k<d.length;k++){var l=0;if(d[k].root&&"true"==d[k].root){a=d[k];break}for(var m=0;m<c.length;m++)c[m].target==d[k].id&&l++;if(0==l){a=d[k];break}}a?(a=g(a),a=h(a)):b="Error. Currently, only rooted NeXML trees are supported."}}(),Smits.PhyloCanvas.NexmlParse.prototype={},Smits.PhyloCanvas.NexmlJsonParse=function(){var a,b,c=0,d=0,e=[],f=[],g=function(a,c,d){var h=new Smits.PhyloCanvas.Node;for(d&&(h.level=d.level+1),d=0;d<e.length;d++)if(e[d].source==a.id)for(var i=0;i<f.length;i++)e[d].target==f[i].id&&h.children.push(g(f[i],e[d].length,h));return c&&(h.len=Smits.Common.roundFloat(c,4),0==h.len)&&(h.len=1e-4),a.label&&(h.type="label",h.name=a.label,a.accession&&(h.accession=a.accession),a.style&&(h.style=a.style),a.bgStyle&&(h.bgStyle=a.bgStyle)),a.chart&&(h.chart=a.chart),h&&h.level>1&&(h.len||(b="Error. Please include Branch Lengths - we only draw rooted phylogenetic trees.")),h},h=function(a){if(a.children&&a.children.length)for(var b=0;b<a.children.length;b++){var e=a.children[b];e.newickLen=Math.round(1e4*(e.len+a.newickLen))/1e4,e.level>c&&(c=e.level),e.newickLen>d&&(d=e.newickLen),e.children.length>0&&h(e,a)}return a},i=function(a,b){for(var c in a)"_children"!=c&&"Text"!=c&&("rectangular"==c||"circular"==c?i(a[c],c):(Smits.PhyloCanvas.Render.Parameters[c]||(Smits.PhyloCanvas.Render.Parameters[c]={}),Smits.PhyloCanvas.Render.Parameters.set(c,a[c],b)))};return function(j){this.getRoot=function(){return a},this.getLevels=function(){return c},this.getNewickLen=function(){return d},this.getValidate=function(){return b};var k=j.nexmlJson.nexml,l=k.render;if(l&&l.styles){var m,n=l.styles;for(m in n)if("_children"!=m&&"Text"!=m)if(n[m]["@attributes"].type&&"radialGradient"==n[m]["@attributes"].type&&Raphael.svg)n[m].name=m,n[m].type=n[m]["@attributes"].type,Smits.PhyloCanvas.Render.Style[m]=n[m],Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList||(Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList=[]),Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList.push(m);else for(var o in Smits.PhyloCanvas.Render.Style[m]||(Smits.PhyloCanvas.Render.Style[m]={}),n[m]["@attributes"])"_attributes"!=o&&"_children"!=o&&"type"!=o&&(Smits.PhyloCanvas.Render.Style[m][o.replace("_","-")]=n[m]["@attributes"][o])}if(l&&l.parameters&&i(l.parameters),l&&l.charts)for(m in l=l.charts)l[m]["@attributes"].chart=m,"binary"==l[m]["@attributes"].type?Smits.PhyloCanvas.Render.Parameters.binaryCharts.push(l[m]["@attributes"]):"integratedBinary"==l[m]["@attributes"].type?Smits.PhyloCanvas.Render.Parameters.integratedBinaryCharts.push(l[m]["@attributes"]):"bar"==l[m]["@attributes"].type&&Smits.PhyloCanvas.Render.Parameters.barCharts.push(l[m]["@attributes"]);if(j.tree&&k.trees[0]&&k.trees[0].tree[j.tree-1])e=k.trees[0].tree[j.tree-1].edge,f=k.trees[0].tree[j.tree-1].node;else{for(m=0;m<k.trees.tree.edge.length;m++)e.push(k.trees.tree.edge[m]["@attributes"]);for(m=0;m<k.trees.tree.node.length;m++)j=k.trees.tree.node[m]["@attributes"],j.label&&(j.chart=k.trees.tree.node[m].chart),f.push(j)}for(m=0;m<f.length;m++)f[m].root&&"true"==f[m].root&&(a=f[m]);a?(a=g(a),a=h(a)):b="Error. Currently, only rooted NeXML trees are supported."}}(),Smits.PhyloCanvas.NexmlParse.prototype={},Smits.PhyloCanvas.Render={},Smits.PhyloCanvas.Render.Style={line:{stroke:"rgb(0,0,0)","stroke-width":1},text:{"font-family":"Verdana","font-size":12,"text-anchor":"start"},path:{stroke:"rgb(0,0,0)","stroke-width":1},connectedDash:{stroke:"rgb(200,200,200)","stroke-dasharray":". "},textSecantBg:{fill:"#EEE",stroke:"#DDD"},highlightedEdgeCircle:{fill:"red"},barChart:{fill:"#003300",stroke:"#DDD"},getStyle:function(a,b){return this[a]?this[a]:this[b]}},Smits.PhyloCanvas.Render.Parameters={jsOverride:0,Rectangular:{bufferX:200,paddingX:10,paddingY:20,bufferInnerLabels:10,bufferOuterLabels:5,minHeightBetweenLeaves:10,alignPadding:0,alignRight:!1,showScaleBar:!1},Circular:{bufferRadius:.33,bufferAngle:20,initStartAngle:160,innerCircleRadius:0,minHeightBetweenLeaves:5,bufferInnerLabels:2,bufferOuterLabels:5},binaryCharts:[],integratedBinaryCharts:[],barCharts:[],binaryChartBufferInner:5,binaryChartBufferSiblings:.01,binaryChartThickness:15,binaryChartDisjointed:!1,barChartBufferInner:3,barChartHeight:50,barChartWidth:.5,mouseRollOver:function(a){if(a.node.edgeCircleHighlight)a.node.edgeCircleHighlight.show();else{var b=a.svg.draw(new Smits.PhyloCanvas.Render.Circle(a.x,a.y,5,{attr:Smits.PhyloCanvas.Render.Style.highlightedEdgeCircle}));a.node.edgeCircleHighlight=b[0]}a.textEl.attr({fill:"red"})},mouseRollOut:function(a){a.node.edgeCircleHighlight.hide(),a.textEl.attr({fill:"#000"})},set:function(a,b,c){this.jsOverride||(c?"circular"==c?this.Circular[a]=parseFloat(b):"rectangular"==c&&(this.Rectangular[a]=parseFloat(b)):this[a]=parseFloat(b))}},Smits.PhyloCanvas.Render.Line=function(){return function(a,b,c,d,e){this.type="line",this.attr=Smits.PhyloCanvas.Render.Style.line,this.x1=a,this.x2=b,this.y1=c,this.y2=d,e&&(Smits.Common.apply(this,e),e.attr)&&(this.attr=e.attr)}}(),Smits.PhyloCanvas.Render.Text=function(){return function(a,b,c,d){this.type="text",this.attr=Smits.PhyloCanvas.Render.Style.text,this.x=a,this.y=b,this.text=c,d&&(Smits.Common.apply(this,d),d.attr)&&(this.attr=d.attr)}}(),Smits.PhyloCanvas.Render.Path=function(){return function(a,b){this.type="path",this.attr=Smits.PhyloCanvas.Render.Style.path,this.path=a,b&&(Smits.Common.apply(this,b),b.attr)&&(this.attr=b.attr)}}(),Smits.PhyloCanvas.Render.Circle=function(){return function(a,b,c,d){this.type="circle",this.x=a,this.y=b,this.radius=c,d&&(Smits.Common.apply(this,d),d.attr)&&(this.attr=d.attr)}}(),Smits.PhyloCanvas.Render.SVG=function(){return function(a,b,c){this.canvasSize=[b,c],this.svg=Raphael(a,this.canvasSize[0],this.canvasSize[1])}}(),Smits.PhyloCanvas.Render.SVG.prototype={render:function(){var a=this.phylogramObject.getDrawInstructs();console.log("render",this.phylogramObject.getDrawInstructs());for(var b=0;b<a.length;b++)if("line"==a[b].type)this.svg.path(["M",a[b].x1,a[b].y1,"L",a[b].x2,a[b].y2]).attr(Smits.PhyloCanvas.Render.Style.line);else if("path"==a[b].type)this.svg.path(a[b].path).attr(a[b].attr);else if("circle"==a[b].type)this.svg.circle(a[b].x,a[b].y,a[b].radius).attr({stroke:"red"});else{var c=this.svg.text(a[b].x,a[b].y,a[b].text).attr(Smits.PhyloCanvas.Render.Style.text);a[b].attr&&c.attr(a[b].attr),a[b].rotate&&c.rotate(a[b].rotate),c.getBBox()}},draw:function(a){var b,c;return"line"==a.type?b=this.svg.path(["M",a.x1,a.y1,"L",a.x2,a.y2]).attr(Smits.PhyloCanvas.Render.Style.line):"path"==a.type?b=this.svg.path(a.path).attr(a.attr):"circle"==a.type?b=this.svg.circle(a.x,a.y,a.radius).attr({stroke:"red"}):"text"==a.type&&(b=this.svg.text(a.x,a.y,a.text).attr(Smits.PhyloCanvas.Render.Style.text),a.attr&&b.attr(a.attr),a.rotate&&b.rotate(a.rotate),a=b.getBBox(),c=Math.sqrt(a.height*a.height+a.width*a.width)),[b,c]}},Smits.PhyloCanvas.Render.Phylogram=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=Smits.PhyloCanvas.Render.Parameters.Rectangular,n=!0,o=0,p=0,q=[],r=function(b,c){if(b.len&&0==n&&0==b.children.length&&(o=Smits.Common.roundFloat(o+e,4)),b.children.length>0){var g,h,i,j,k=[];if(b.len&&(g=c,h=c=Smits.Common.roundFloat(c+d*b.len,4),j=i=o+b.getMidbranchPosition(n)*e,a.draw(new Smits.PhyloCanvas.Render.Line(g,h,i,j))),b.name){g={},g=Smits.PhyloCanvas.Render.Style.getStyle("bootstrap","text"),b.uri&&(g.href=b.uri),b.description&&(g.title=b.description);var l=0==b.level?o+b.getMidbranchPosition(n)*e:j;a.draw(new Smits.PhyloCanvas.Render.Text((h||c)+5,l,b.name,{attr:g}))}if(b.children&&b.children.length)for(g=0;g<b.children.length;g++)k.push(r(b.children[g],c));for(h=[],g=0;g<k.length;g++)k[g][0]&&h.push(k[g][0]),k[g][1]&&h.push(k[g][1]);k=Math.min.apply(null,h),h=Math.max.apply(null,h),a.draw(new Smits.PhyloCanvas.Render.Path(["M",c+1e-4,k,"L",c,k,"L",c,h,"L",c+1e-4,h],{attr:Smits.PhyloCanvas.Render.Style.line}))}else g=c,h=Smits.Common.roundFloat(c+d*b.len,2),j=i=o,b.y=o,q.push(b),a.draw(new Smits.PhyloCanvas.Render.Line(g,h,i,j)),m.alignRight&&a.draw(new Smits.PhyloCanvas.Render.Path(["M",h,i,"L",m.alignPadding+f,j],{attr:Smits.PhyloCanvas.Render.Style.connectedDash})),b.name&&(g={},b.style&&(g=Smits.PhyloCanvas.Render.Style.getStyle(b.style,"text")),g["text-anchor"]="start",b.uri&&(g.href=b.uri),b.description&&(g.title=b.description),k=a.draw(new Smits.PhyloCanvas.Render.Text(m.alignRight?f+m.bufferInnerLabels+m.alignPadding:h+m.bufferInnerLabels,j,b.name,{attr:g})),p=Math.max(k[1],p),Smits.PhyloCanvas.Render.Parameters.mouseRollOver&&Smits.Common.addRaphEventHandler(k[0],"mouseover",Smits.PhyloCanvas.Render.Parameters.mouseRollOver,{svg:a,node:b,x:h,y:j,textEl:k[0]}),Smits.PhyloCanvas.Render.Parameters.mouseRollOut&&Smits.Common.addRaphEventHandler(k[0],"mouseout",Smits.PhyloCanvas.Render.Parameters.mouseRollOut,{svg:a,node:b,x:h,y:j,textEl:k[0]}),Smits.PhyloCanvas.Render.Parameters.onClickAction&&Smits.Common.addRaphEventHandler(k[0],"click",Smits.PhyloCanvas.Render.Parameters.onClickAction,{svg:a,node:b,x:h,y:j,textEl:k[0]})),n&&(n=!1);return[i,j]},s=function(b,c,d){for(var f=(d&&d.bufferInner?d.bufferInner:0)|Smits.PhyloCanvas.Render.Parameters.binaryChartBufferInner,g=(d&&d.bufferSiblings?d.bufferSiblings*e:0)|(Smits.PhyloCanvas.Render.Parameters.binaryChartBufferSiblings<1?e*Smits.PhyloCanvas.Render.Parameters.binaryChartBufferSiblings:Smits.PhyloCanvas.Render.Parameters.binaryChartBufferSiblings),d=(d&&d.thickness?d.thickness:0)|Smits.PhyloCanvas.Render.Parameters.binaryChartThickness,h=0;h<q.length;h++){var i=q[h];a.draw(new Smits.PhyloCanvas.Render.Path(["M",b+f,i.y-e/2+g/2,"L",b+f+d,i.y-e/2+g/2,"L",b+f+d,i.y+e/2-g/2,"L",b+f,i.y+e/2-g/2,"Z"],{attr:Smits.PhyloCanvas.Render.Style.getStyle(i.chart[c],"textSecantBg")}))}return b+f+d},t=function(b,c,d){for(var f=[],g=d&&d.bufferInner?d.bufferInner:0|Smits.PhyloCanvas.Render.Parameters.barChartBufferInner,h=d&&d.height?d.height:0|Smits.PhyloCanvas.Render.Parameters.barChartHeight,d=d&&d.width?d.width<1?e*d.width:d.width:0|(Smits.PhyloCanvas.Render.Parameters.barChartWidth<1?e*Smits.PhyloCanvas.Render.Parameters.barChartWidth:Smits.PhyloCanvas.Render.Parameters.barChartWidth),i=0,j=0;j<q.length;j++)f.push(q[j].chart[c]);for(f=Math.max.apply(null,f),i=Smits.Common.roundFloat(h/f,4),j=0;j<q.length;j++)f=q[j],a.draw(new Smits.PhyloCanvas.Render.Path(["M",b+g,f.y-d/2,"L",b+g+i*f.chart[c],f.y-d/2,"L",b+g+i*f.chart[c],f.y+d/2,"L",b+g,f.y+d/2,"Z"],{attr:Smits.PhyloCanvas.Render.Style.getStyle(f.chart[c],"barChart")}));return b+g+h};return function(n,q){this.getCanvasSize=function(){return[b,c]},this.getRoot=function(){return q.getRoot()},q.getValidate()&&a.draw(0,0,q.getValidate()),a=n;var u=q.getRoot(),v=q.getNewickLen();if(b=a.canvasSize[0],c=a.canvasSize[1],j=m.bufferX,k=m.paddingX,l=m.paddingY,g=m.minHeightBetweenLeaves,o=l,d=Math.round((b-j-2*k)/v),e=Math.round((c-2*l)/(m.showScaleBar?u.getCountAllChildren():u.getCountAllChildren()-1)),g>e&&(e=g),f=Math.round(b-j-2*k),(Smits.PhyloCanvas.Render.Parameters.binaryCharts.length||Smits.PhyloCanvas.Render.Parameters.barCharts.length)&&(m.alignRight=!0),r(u,k),m.showScaleBar&&(y=o+e,i=m.showScaleBar*d,a.draw(new Smits.PhyloCanvas.Render.Line(0,i,y,y)),a.draw(new Smits.PhyloCanvas.Render.Text((0+i)/2,y-8,m.showScaleBar))),h=f+p+m.bufferInnerLabels,Smits.PhyloCanvas.Render.Parameters.binaryCharts.length){var w,u=Smits.PhyloCanvas.Render.Parameters.binaryCharts;for(w in u)h=s(h,u[w].chart,u[w])}if(Smits.PhyloCanvas.Render.Parameters.barCharts.length)for(w in u=Smits.PhyloCanvas.Render.Parameters.barCharts)t(h,u[w].chart,u[w])}}(),Smits.PhyloCanvas.Render.Phylogram.prototype={},Smits.PhyloCanvas.Render.CircularPhylogram=function(){function a(a,b){return b+=x,[Smits.Common.roundFloat(s+a*Math.sin(b*E),4),Smits.Common.roundFloat(t+a*Math.cos(b*E),4)]}function b(a){if(a=e(90-a-x),a>90&&270>a){a+=180;var b="end"}else b="start";return[a,b]}function c(b,c,d,f){var g=a(b,c),h=a(b,d),i=[],j=0,c=Math.abs(e(d-c))>180?1:-1;return f&&f.invertSecant&&(c*=-1,j=1),(!f||!f.noMove)&&i.push("M"),i.push(g[0],g[1],"A",b,b,0,1>c?0:1,j,h[0],h[1]),i}function d(b,c,d,e){var f=[],c=a(c,b),b=a(d,b);return(!e||!e.noMove)&&f.push("M"),f.push(c[0],c[1],"L",b[0],b[1]),f}function e(a){for(;a>360||0>a;)a>360?a-=360:0>a&&(a+=360);return a}function f(a,b,d,e){return!b&&a.length>1&&(e=a[3],d=a[2],b=a[1],a=a[0]),h("M",c(a,d,e,{noMove:1,invertSecant:0}),"L",c(b,e,d,{noMove:1,invertSecant:1}),"Z")}function g(e,f){if(e.len&&(z?A=v||1:0==e.children.length&&(A=Smits.Common.roundFloat(A+q,4))),e.children.length>0){var i,j,k,m=[];if(i=f,j=f+=Smits.Common.roundFloat(p*e.len,4),e.children&&e.children.length)for(var n=0;n<e.children.length;n++){var o=g(e.children[n],f);o>0&&m.push(o)}n=Smits.Common.roundFloat(Math.min.apply(null,m),4),m=Smits.Common.roundFloat(Math.max.apply(null,m),4),0!=e.level&&l.draw(new Smits.PhyloCanvas.Render.Path(h("M",a(f+.01,n),"L",c(f,n,m,{noMove:!0}),"L",a(f+.01,m)))),e.len&&(k=Smits.Common.roundFloat(n+(m-n)/2,4),l.draw(new Smits.PhyloCanvas.Render.Path(d(k,i,j))))}else e.y=A,B.push(e),i=f,j=Smits.Common.roundFloat(f+p*e.len),k=A,l.draw(new Smits.PhyloCanvas.Render.Path(d(k,i,j))),l.draw(new Smits.PhyloCanvas.Render.Path(d(k,j,u),{attr:Smits.PhyloCanvas.Render.Style.connectedDash})),e.name&&(i=a(u+y.bufferInnerLabels,k),n=b(k),m=n[0],n=n[1],o={},e.style&&Smits.Common.apply(o,Smits.PhyloCanvas.Render.Style.getStyle(e.style,"text")),o["text-anchor"]=n,e.uri&&(o.href=e.uri),e.description&&(o.title=e.description),m=l.draw(new Smits.PhyloCanvas.Render.Text(i[0],i[1],e.name,{attr:o,rotate:[m,i[0],i[1]]})),e.bgStyle&&C.push([e.bgStyle,k]),i=a(j,k),Smits.PhyloCanvas.Render.Parameters.mouseRollOver&&Smits.Common.addRaphEventHandler(m[0],"mouseover",Smits.PhyloCanvas.Render.Parameters.mouseRollOver,{svg:l,node:e,x:i[0],y:i[1],textEl:m[0]}),Smits.PhyloCanvas.Render.Parameters.mouseRollOut&&Smits.Common.addRaphEventHandler(m[0],"mouseout",Smits.PhyloCanvas.Render.Parameters.mouseRollOut,{svg:l,node:e,x:i[0],y:i[1],textEl:m[0]}),Smits.PhyloCanvas.Render.Parameters.onClickAction&&Smits.Common.addRaphEventHandler(m[0],"click",Smits.PhyloCanvas.Render.Parameters.onClickAction,{svg:l,node:e,x:i[0],y:i[1],textEl:m[0]}),D=Math.max(m[1],D));return z&&(z=!1),k}function h(a){for(var b=a,c=1;c<arguments.length;c++)b=b.concat(arguments[c]);return b}function i(){var a=[];if(C.length>0){if(Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList)for(var b=0;b<Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList.length;b++){var c=Smits.PhyloCanvas.Render.Style.jsphylosvgGradientList[b],c=Smits.Common.createGradientEl(c,Smits.PhyloCanvas.Render.Style[c],[s,t,u+D+y.bufferOuterLabels]);l.svg.defs.appendChild(c)}for(b=0;b<C.length;b++)b!=C.length-1&&C[b][0]==C[b+1][0]?C[b+1][2]=C[b][2]?C[b][2]:C[b][1]:(a=f(u,u+D+y.bufferOuterLabels,C[b][2]?C[b][2]-q/2:C[b][1]-q/2,C[b][1]+q/2),c=Smits.PhyloCanvas.Render.Style.getStyle(C[b][0],"textSecantBg"),a=l.draw(new Smits.PhyloCanvas.Render.Path(a,{attr:c.type?{}:c})),c.type&&"radialGradient"==c.type&&a[0].node.setAttribute("fill","url(#"+c.name+")"),c.type&&"radialGradient"==c.type&&a[0].node.setAttribute("stroke","none"),a[0].toBack())}return a=f(u,u+D+y.bufferOuterLabels,(v||1)-q/2,360-q/2),a=l.draw(new Smits.PhyloCanvas.Render.Path(a,{attr:Smits.PhyloCanvas.Render.Style.textSecantBg})),a[0].toBack(),u+D+y.bufferOuterLabels}function j(c,d,g){for(var h,i=g&&g.bufferInner?parseFloat(g.bufferInner):Smits.PhyloCanvas.Render.Parameters.binaryChartBufferInner,j=(g&&g.bufferSiblings?g.bufferSiblings*q:0)|(Smits.PhyloCanvas.Render.Parameters.binaryChartBufferSiblings<1?q*Smits.PhyloCanvas.Render.Parameters.binaryChartBufferSiblings:Smits.PhyloCanvas.Render.Parameters.binaryChartBufferSiblings),k=g&&g.thickness?parseFloat(g.thickness):Smits.PhyloCanvas.Render.Parameters.binaryChartThickness,m=(g&&g.disjointed?g.disjointed:0)|Smits.PhyloCanvas.Render.Parameters.binaryChartDisjointed,g=g&&g.isInternal?g.isInternal:!1,n=!0,o=0;o<B.length;o++){var p=B[o];if(B[o+1]&&p.chart[d]===B[o+1].chart[d]&&!m||"none"==p.chart[d])h||(h=p.y),"none"==p.chart[d]&&(h=0);else{var r=Smits.PhyloCanvas.Render.Style.getStyle(p.chart[d],"textSecantBg");if(h=g?[u-i-k,u-i,(h?h:p.y)-q/2+(n&&!m?0:j/2),p.y+q/2-(o!=B.length-1||m?j/2:0)]:[c+i,c+i+k,(h?h:p.y)-q/2+(n&&!m?0:j/2),p.y+q/2-(o!=B.length-1||m?j/2:0)],r.label){var n=Smits.PhyloCanvas.Render.Style.getStyle(r.labelStyle,"text"),p=a((h[0]+h[1])/2,(h[2]+h[3])/2),s=b((h[2]+h[3])/2),s=e(s[0]+(n.rotate?parseFloat(n.rotate):0)),t=e(90-(h[2]+h[3])/2-x);t>90&&270>t&&(s+=180),n["text-anchor"]||(n["text-anchor"]="middle"),l.draw(new Smits.PhyloCanvas.Render.Text(p[0],p[1],r.label,{attr:n,rotate:s}))[0].toBack()}r.borderStyle&&(n=Smits.PhyloCanvas.Render.Style.getStyle(r.borderStyle,"textSecantBg"),l.draw(new Smits.PhyloCanvas.Render.Path(f([u,n.fullsize?h[1]:h[0],h[2],h[3]]),{attr:n}))[0].toBack()),l.draw(new Smits.PhyloCanvas.Render.Path(f(h),{attr:r}))[0].toBack(),h=0}n=!1}return g?c:c+i+k}function k(a,b,c){for(var d=[],e=c&&c.bufferInner?parseFloat(c.bufferInner):Smits.PhyloCanvas.Render.Parameters.barChartBufferInner,g=c&&c.height?parseFloat(c.height):Smits.PhyloCanvas.Render.Parameters.barChartHeight?Smits.PhyloCanvas.Render.Parameters.barChartHeight:0,c=c&&c.width?parseFloat(c.width)<1?q*parseFloat(c.width):parseFloat(c.width):0|(Smits.PhyloCanvas.Render.Parameters.barChartWidth<1?q*Smits.PhyloCanvas.Render.Parameters.barChartWidth:Smits.PhyloCanvas.Render.Parameters.barChartWidth),h=0,i=0;i<B.length;i++)d.push(B[i].chart[b]);for(d=Math.max.apply(null,d),h=Smits.Common.roundFloat(g/d,4),i=0;i<B.length;i++)d=B[i],d.chart[b]>0&&l.draw(new Smits.PhyloCanvas.Render.Path(f(a+e,a+e+h*d.chart[b],d.y-c/2,d.y+c/2),{attr:Smits.PhyloCanvas.Render.Style.getStyle(d.chart[b],"barChart")}));return a+e+g}var l,m,n,o,p,q,r,s,t,u,v,w,x,y=Smits.PhyloCanvas.Render.Parameters.Circular,z=!0,A=0,B=[],C=[],D=0,E=Math.PI/180;return function(a,b,c){if(this.getCanvasSize=function(){return[m,n]},this.getRoot=function(){return b.getRoot()},b.getValidate())a.draw({type:"text",x:0,y:a.canvasSize[1]/3,text:b.getValidate()});else{l=a;var a=b.getRoot(),d=b.getNewickLen();if(m=l.canvasSize[0],n=l.canvasSize[1],s=m/2,t=n/2,o=Math.min.apply(null,[m,n]),c=y.bufferRadius>1?y.bufferRadius:Smits.Common.roundFloat(o*y.bufferRadius,4),v=y.bufferAngle,r=y.innerCircleRadius,x=y.initStartAngle,u=Math.round((o-c-r)/2),p=(u-r)/d,q=Smits.Common.roundFloat((360-v)/a.getCountAllChildren(),4),g(a,r),w=u+D+y.bufferOuterLabels,Smits.PhyloCanvas.Render.Parameters.integratedBinaryCharts.length){var e,c=Smits.PhyloCanvas.Render.Parameters.integratedBinaryCharts;for(e in c)w=j(w-(c[e].thickness?c[e].thickness:Smits.PhyloCanvas.Render.Parameters.binaryChartThickness)-(c[e].bufferInner?c[e].bufferInner:Smits.PhyloCanvas.Render.Parameters.binaryChartBufferInner),c[e].chart,c[e])}if(w=i(),Smits.PhyloCanvas.Render.Parameters.binaryCharts.length)for(e in c=Smits.PhyloCanvas.Render.Parameters.binaryCharts)w=j(w,c[e].chart,c[e]);if(Smits.PhyloCanvas.Render.Parameters.barCharts.length)for(e in c=Smits.PhyloCanvas.Render.Parameters.barCharts)w=k(w,c[e].chart,c[e])}}}(),Smits.PhyloCanvas.Render.CircularPhylogram.prototype={};var XMLObjectifier=function(){var a=function(a){var b="";return a&&"string"==typeof a&&(b=a),/^((-)?([0-9]*)((\.{0,1})([0-9]+))?$)/.test(b)};return{xmlToJSON:function(b){try{if(!b)return null;var c={typeOf:"JSXBObject"},d=9==b.nodeType?b.documentElement:b;if(c.RootName=d.nodeName||"",3==b.nodeType||4==b.nodeType)return b.nodeValue;var e=function(a){return a.replace(/^\s+|\s+$/gm,"")},f=function(a,b){if(b.attributes.length>0){var c,d=b.attributes.length-1;a._attributes=[];do c=String(String(b.attributes[d].name).replace(/-/g,"_")),a._attributes.push(c),a[c]=e(b.attributes[d].value);while(d--)}};!function(){return{activate:function(){var a=[];return a.getNodesByAttribute=function(b,c){if(a&&a.length>0){var d,e=[],f=a.length-1;try{do d=a[f],d[b]===c&&e.push(d);while(f--);return e.reverse(),e}catch(g){}return null}},a.getNodeByAttribute=function(b,c){if(a&&a.length>0){var d,e=a.length-1;try{do if(d=a[e],d[b]===c)return d;while(e--)}catch(f){}return null}},a.getNodesByValue=function(b){if(a&&a.length>0){var c,d=[],e=a.length-1;try{do c=a[e],c.Text&&c.Text===b&&d.push(c);while(e--);return d}catch(f){}return null}},a.contains=function(b,c){if(a&&a.length>0){var d=a.length-1;try{do if(a[d][b]===c)return!0;while(d--)}catch(e){}return!1}},a.indexOf=function(b,c){var d=-1;if(a&&a.length>0){var e=a.length-1;try{do a[e][b]===c&&(d=e);while(e--)}catch(f){return-1}return d}},a.SortByAttribute=function(b,c){if(a&&a.length>0){var d=function(a,b){var c=a[b];return c=bam.validation.isNumeric(c)?parseFloat(c):c};a.sort(function(a,e){var f,g;return f=d(a,b),g=d(e,b),f=g>f?-1:f>g?1:0,c&&(f="DESC"===c.toUpperCase()?0-f:f),f})}},a.SortByValue=function(b){if(a&&a.length>0){var c=function(a){return a=a.Text,a=bam.validation.isNumeric(a)?parseFloat(a):a};a.sort(function(a,d){var e,f;return e=c(a),f=c(d),e=f>e?-1:e>f?1:0,b&&(e="DESC"===b.toUpperCase()?0-e:e),e})}},a.SortByNode=function(b,c){if(a&&a.length>0){var d=function(a,b){var c=a[b][0].Text;return c=bam.validation.isNumeric(c)?parseFloat(c):c};a.sort(function(a,e){var f,g;return f=d(a,b),g=d(e,b),f=g>f?-1:f>g?1:0,c&&(f="DESC"===c.toUpperCase()?0-f:f),f})}},a}}}();var g=function(b){b.getNodeByAttribute=function(a,b){if(this.length>0){var c,d=this.length-1;try{do if(c=this[d],c[a]==b)return c;while(d--)}catch(e){}return!1}},b.contains=function(a,b){if(this.length>0){var c=this.length-1;try{do if(this[c][a]==b)return!0;while(c--)}catch(d){}return!1}},b.indexOf=function(a,b){var c=-1;if(this.length>0){var d=this.length-1;try{do this[d][a]==b&&(c=d);while(d--);
}catch(e){return-1}return c}},b.SortByAttribute=function(b,c){if(this.length){var d=function(b,c){var d=b[c];return d=a(d)?parseFloat(d):d};this.sort(function(a,e){var f,g,h=0;return f=d(a,b),g=d(e,b),g>f?h=-1:f>g&&(h=1),c&&(h="DESC"==c.toUpperCase()?0-h:h),h})}},b.SortByValue=function(b){if(this.length){var c=function(b){return b=b.Text,b=a(b)?parseFloat(b):b};this.sort(function(a,d){var e,f,g=0;return e=c(a),f=c(d),f>e?g=-1:e>f&&(g=1),b&&(g="DESC"==b.toUpperCase()?0-g:g),g})}},b.SortByNode=function(b,c){if(this.length){var d=function(b,c){var d=b[c][0].Text;return d=a(d)?parseFloat(d):d};this.sort(function(a,e){var f,g,h=0;return f=d(a,b),g=d(e,b),g>f?h=-1:f>g&&(h=1),c&&(h="DESC"==c.toUpperCase()?0-h:h),h})}}},h=function(a,b){var c,d,i,j="";if(!b)return null;if(b.attributes.length>0&&f(a,b),a.Text="",b.hasChildNodes()){var k=b.childNodes.length-1,l=0;do switch(d=b.childNodes[l],d.nodeType){case 1:a._children=[],c=d.localName?d.localName:d.baseName,c=String(c).replace(/-/g,"_"),j!=c&&a._children.push(c),a[c]||(a[c]=[]),i={},a[c].push(i),d.attributes.length>0&&f(i,d),a[c].contains||g(a[c]),j=c,d.hasChildNodes()&&h(i,d);break;case 3:a.Text+=e(d.nodeValue);break;case 4:a.Text+=e(d.text?d.text:d.nodeValue)}while(l++<k)}};return h(c,d),d=b=null,c}catch(i){return null}},textToXML:function(a){var b=null;try{b=document.all?new ActiveXObject("Microsoft.XMLDOM"):new DOMParser,b.async=!1}catch(c){throw Error("XML Parser could not be instantiated")}var d;try{d=document.all?b.loadXML(a)?b:!1:b.parseFromString(a,"text/xml")}catch(e){throw Error("Error parsing XML string")}return d}}}();