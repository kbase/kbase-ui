"use strict";function isObject(a){return a===Object(a)}function makeStackTraceLong(a,b){if(hasStacks&&b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var c=[],d=b;d&&handlers.get(d);d=handlers.get(d).became)d.stack&&c.unshift(d.stack);c.unshift(a.stack);var e=c.join("\n"+STACK_JUMP_SEPARATOR+"\n");a.stack=filterStackString(e)}}function filterStackString(a){if(Q.isIntrospective)return a;for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var e=b[d];isInternalFrame(e)||isNodeFrame(e)||!e||c.push(e)}return c.join("\n")}function isNodeFrame(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function getFileNameAndLineNumber(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b)return[b[1],Number(b[2])];var c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a);if(c)return[c[1],Number(c[2])];var d=/.*@(.+):(\d+)$/.exec(a);return d?[d[1],Number(d[2])]:void 0}function isInternalFrame(a){var b=getFileNameAndLineNumber(a);if(!b)return!1;var c=b[0],d=b[1];return c===qFileName&&d>=qStartingLine&&qEndingLine>=d}function captureLine(){if(hasStacks)try{throw new Error}catch(a){var b=a.stack.split("\n"),c=b[0].indexOf("@")>0?b[1]:b[2],d=getFileNameAndLineNumber(c);if(!d)return;return qFileName=d[0],d[1]}}function deprecate(a,b,c){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&(c?console.warn(b+" is deprecated, use "+c+" instead.",new Error("").stack):console.warn(b+" is deprecated.",new Error("").stack)),a.apply(this,arguments)}}function Q_getHandler(a){var b=handlers.get(a);return b&&b.became?(b=follow(b),handlers.set(a,b),b):b}function follow(a){return a.became?(a.became=follow(a.became),a.became):a}function Q(a){return Q_isPromise(a)?a:isThenable(a)?(thenables.has(a)||thenables.set(a,new Promise(new Thenable(a))),thenables.get(a)):new Promise(new Fulfilled(a))}function Q_reject(a){return new Promise(new Rejected(a))}function defer(){var a=new Pending,b=new Promise(a),c=new Deferred(b);if(Q.longStackSupport&&hasStacks)try{throw new Error}catch(d){b.stack=d.stack.substring(d.stack.indexOf("\n")+1)}return c}function Q_all(a){function b(){h=-(1/0);for(var a=0;a<g.length;a++)g[a]>h&&(h=g[a])}if(Q_isPromise(a))return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("Q.all no longer directly unwraps a promise. Use Q(array).all()"),Q(a).all();var c,d=0,e=defer(),f=Array(a.length),g=[],h=-(1/0);return Array.prototype.forEach.call(a,function(i,j){var k;Q_isPromise(i)&&"fulfilled"===(k=Q_getHandler(i)).state?f[j]=k.value:(++d,i=Q(i),i.then(function(a){f[j]=a,0===--d&&e.resolve(f)},e.reject),i.observeEstimate(function(d){var f=g[j];g[j]=d,d>h?h=d:f===h&&h>=d&&b(),g.length===a.length&&h!==c&&(e.setEstimate(h),c=h)}))}),0===d&&e.resolve(f),e.promise}function Q_allSettled(a){return Q_isPromise(a)?("undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("Q.allSettled no longer directly unwraps a promise. Use Q(array).allSettled()"),Q(a).allSettled()):Q_all(a.map(function(a){function b(){return a.inspect()}return a=Q(a),a.then(b,b)}))}function Q_spread(a,b,c){return Q(a).spread(b,c)}function Q_race(a){return new Promise(function(b){a.forEach(function(a){Q(a).then(b.resolve,b.reject)})})}function Promise_function(a){return function(){for(var b=new Array(arguments.length),c=0;c<arguments.length;c++)b[c]=arguments[c];return Q(a).apply(this,b)}}function Q_async(a){return function(){function b(a,b){var f;try{f=c[a](b)}catch(g){return Q_reject(g)}return f.done?Q(f.value):Q(f.value).then(d,e)}var c=a.apply(this,arguments),d=b.bind(b,"next"),e=b.bind(b,"throw");return d()}}function Q_spawn(a){Q_async(a)().done()}function Promise(a){if(!(this instanceof Promise))return new Promise(a);if("function"==typeof a){var b=a,c=defer();a=Q_getHandler(c.promise);try{b(c.resolve,c.reject,c.setEstimate)}catch(d){c.reject(d)}}handlers.set(this,a)}function Promise_resolve(a){return Q(a)}function Q_isPromise(a){return isObject(a)&&!!handlers.get(a)}function isThenable(a){return isObject(a)&&"function"==typeof a.then}function Promise_rethrow(a){throw a}function Deferred(a){this.promise=a,promises.set(this,a);var b=this,c=this.resolve;this.resolve=function(a){c.call(b,a)};var d=this.reject;this.reject=function(a){d.call(b,a)}}function Fulfilled(a){this.value=a,this.estimate=Date.now()}function Rejected(a){this.reason=a,this.estimate=1/0}function Pending(){this.messages=[],this.observers=[],this.estimate=1/0}function Thenable(a){this.thenable=a,this.became=null,this.estimate=1/0}function Passed(a){this.promise=a}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qStartingLine=captureLine(),qFileName;require("collections/shim");var WeakMap=require("collections/weak-map"),Iterator=require("collections/iterator"),asap=require("asap"),STACK_JUMP_SEPARATOR="From previous event:",handlers=new WeakMap,theViciousCycleError=new Error("Can't resolve a promise with itself"),theViciousCycleRejection=Q_reject(theViciousCycleError),theViciousCycle=Q_getHandler(theViciousCycleRejection),thenables=new WeakMap;module.exports=Q,Q.longStackSupport=!1,Q.reject=Q_reject,Q.defer=defer,Q.when=function(a,b,c,d){return Q(a).then(b,c,d)},Q.all=Q_all,Q.allSettled=Q_allSettled,Q.delay=function(a,b){return void 0===b&&(b=a,a=void 0),Q(a).delay(b)},Q.timeout=function(a,b,c){return Q(a).timeout(b,c)},Q.spread=Q_spread,Q.join=function(a,b){return Q.spread([a,b],function(a,b){if(a===b)return a;throw new Error("Can't join: not the same: "+a+" "+b)})},Q.race=Q_race,Q["try"]=function(a){return Q(a).dispatch("call",[[]])},Q["function"]=Promise_function,Q.promised=function(a){return function(){for(var b=new Array(arguments.length),c=0;c<arguments.length;c++)b[c]=arguments[c];return Q_spread([this,Q_all(b)],function(b,c){return a.apply(b,c)})}},Q.passByCopy=Q.push=function(a){return Object(a)!==a||Q_isPromise(a)||passByCopies.set(a,!0),a},Q.isPortable=function(a){return Object(a)===a&&passByCopies.has(a)};var passByCopies=new WeakMap;Q.async=Q_async,Q.spawn=Q_spawn,Q.Promise=Promise,Promise.all=Q_all,Promise.race=Q_race,Promise.resolve=Promise_resolve,Promise.reject=Q_reject,Q.isPromise=Q_isPromise,Promise.prototype.inspect=function(){return Q_getHandler(this).inspect()},Promise.prototype.isPending=function(){return"pending"===Q_getHandler(this).state},Promise.prototype.isFulfilled=function(){return"fulfilled"===Q_getHandler(this).state},Promise.prototype.isRejected=function(){return"rejected"===Q_getHandler(this).state},Promise.prototype.toBePassed=function(){return"passed"===Q_getHandler(this).state},Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(a,b,c){var d,e=this,f=defer();d="function"==typeof a?function(b){try{f.resolve(a.call(void 0,b))}catch(c){f.reject(c)}}:f.resolve;var g;if(g="function"==typeof b?function(a){try{f.resolve(b.call(void 0,a))}catch(c){f.reject(c)}}:f.reject,this.done(d,g),void 0!==c){var h=function(){f.setEstimate(e.getEstimate()+c)};this.observeEstimate(h),h()}return f.promise},Promise.prototype.done=function(a,b){var c=this,d=!1;asap(function(){var e;"function"==typeof a&&(e=Q.onerror?function(b){if(!d){d=!0;try{a.call(void 0,b)}catch(c){(Q.onerror||Promise_rethrow)(c)}}}:function(b){d||(d=!0,a.call(void 0,b))});var f;f="function"==typeof b&&Q.onerror?function(a){if(!d){d=!0,makeStackTraceLong(a,c);try{b.call(void 0,a)}catch(e){(Q.onerror||Promise_rethrow)(e)}}}:"function"==typeof b?function(a){d||(d=!0,makeStackTraceLong(a,c),b.call(void 0,a))}:Q.onerror||Promise_rethrow,"object"==typeof process&&process.domain&&(f=process.domain.bind(f)),Q_getHandler(c).dispatch(e,"then",[f])})},Promise.prototype.thenResolve=function(a){return a=Q(a),Q_all([this,a]).then(function(){return a},null,0)},Promise.prototype.thenReject=function(a){return this.then(function(){throw a},null,0)},Promise.prototype.all=function(){return this.then(Q_all)},Promise.prototype.allSettled=function(){return this.then(Q_allSettled)},Promise.prototype["catch"]=function(a){return this.then(void 0,a)},Promise.prototype["finally"]=function(a,b){return a?(a=Q(a),this.then(function(b){return a.call().then(function(){return b})},function(b){return a.call().then(function(){throw b})},b)):this},Promise.prototype.observeEstimate=function(a){return this.rawDispatch(null,"estimate",[a]),this},Promise.prototype.getEstimate=function(){return Q_getHandler(this).estimate},Promise.prototype.dispatch=function(a,b){var c=defer();return this.rawDispatch(c.resolve,a,b),c.promise},Promise.prototype.rawDispatch=function(a,b,c){var d=this;asap(function(){Q_getHandler(d).dispatch(a,b,c)})},Promise.prototype.get=function(a){return this.dispatch("get",[a])},Promise.prototype.invoke=function(a){for(var b=new Array(arguments.length-1),c=1;c<arguments.length;c++)b[c-1]=arguments[c];return this.dispatch("invoke",[a,b])},Promise.prototype.apply=function(a,b){return this.dispatch("call",[b,a])},Promise.prototype.call=function(a){for(var b=new Array(Math.max(0,arguments.length-1)),c=1;c<arguments.length;c++)b[c-1]=arguments[c];return this.dispatch("call",[b,a])},Promise.prototype.bind=function(a){for(var b=this,c=new Array(Math.max(0,arguments.length-1)),d=1;d<arguments.length;d++)c[d-1]=arguments[d];return function(){for(var d=c.slice(),e=0;e<arguments.length;e++)d[d.length]=arguments[e];return b.dispatch("call",[d,a])}},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Promise.prototype.iterate=function(){return this.dispatch("iterate",[])},Promise.prototype.spread=function(a,b,c){return this.all().then(function(b){return a.apply(void 0,b)},b,c)},Promise.prototype.timeout=function(a,b){var c=defer(),d=setTimeout(function(){c.reject(new Error(b||"Timed out after "+a+" ms"))},a);return this.then(function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)}),c.promise},Promise.prototype.delay=function(a){return this.then(function(b){var c=defer();return c.setEstimate(Date.now()+a),setTimeout(function(){c.resolve(b)},a),c.promise},null,a)},Promise.prototype.pull=function(){return this.dispatch("pull",[])},Promise.prototype.pass=function(){return this.toBePassed()?this:new Promise(new Passed(this))};var promises=new WeakMap;Deferred.prototype.resolve=function(a){var b=Q_getHandler(promises.get(this));b.messages&&b.become(Q(a))},Deferred.prototype.reject=function(a){var b=Q_getHandler(promises.get(this));b.messages&&b.become(Q_reject(a))},Deferred.prototype.setEstimate=function(a){if(a=+a,a!==a&&(a=1/0),1e12>a&&a!==-(1/0))throw new Error("Estimate values should be a number of miliseconds in the future");var b=Q_getHandler(promises.get(this));b.setEstimate&&b.setEstimate(a)},Fulfilled.prototype.state="fulfilled",Fulfilled.prototype.inspect=function(){return{state:"fulfilled",value:this.value}},Fulfilled.prototype.dispatch=function(a,b,c){var d;if("then"===b||"get"===b||"call"===b||"invoke"===b||"keys"===b||"iterate"===b||"pull"===b)try{d=this[b].apply(this,c)}catch(e){d=Q_reject(e)}else if("estimate"===b)c[0].call(void 0,this.estimate);else{var f=new Error("Fulfilled promises do not support the "+b+" operator");d=Q_reject(f)}a&&a(d)},Fulfilled.prototype.then=function(){return this.value},Fulfilled.prototype.get=function(a){return this.value[a]},Fulfilled.prototype.call=function(a,b){return this.callInvoke(this.value,a,b)},Fulfilled.prototype.invoke=function(a,b){return this.callInvoke(this.value[a],b,this.value)},Fulfilled.prototype.callInvoke=function(a,b,c){for(var d,e=0;e<b.length;e++)Q_isPromise(b[e])&&b[e].toBePassed()&&(d=d||[],d.push(b[e]));if(d){var f=this;return Q_all(d).then(function(){return f.callInvoke(a,b.map(function(a){return Q_isPromise(a)&&a.toBePassed()?a.inspect().value:a}),c)})}return a.apply(c,b)},Fulfilled.prototype.keys=function(){return Object.keys(this.value)},Fulfilled.prototype.iterate=function(){return new Iterator(this.value)},Fulfilled.prototype.pull=function(){var a;if(Object(this.value)===this.value){a=Array.isArray(this.value)?[]:{};for(var b in this.value)a[b]=this.value[b]}else a=this.value;return Q.push(a)},Rejected.prototype.state="rejected",Rejected.prototype.inspect=function(){return{state:"rejected",reason:this.reason}},Rejected.prototype.dispatch=function(a,b,c){var d;d="then"===b?this.then(a,c[0]):this,a&&a(d)},Rejected.prototype.then=function(a,b){return b?b(this.reason):this},Pending.prototype.state="pending",Pending.prototype.inspect=function(){return{state:"pending"}},Pending.prototype.dispatch=function(a,b,c){if(this.messages.push([a,b,c]),"estimate"===b){this.observers.push(c[0]);var d=this;asap(function(){c[0].call(void 0,d.estimate)})}},Pending.prototype.become=function(a){this.became=theViciousCycle;var b=Q_getHandler(a);this.became=b,handlers.set(a,b),this.promise=void 0,this.messages.forEach(function(b){asap(function(){var c=Q_getHandler(a);c.dispatch.apply(c,b)})}),this.messages=void 0,this.observers=void 0},Pending.prototype.setEstimate=function(a){if(this.observers){var b=this;b.estimate=a,this.observers.forEach(function(b){asap(function(){b.call(void 0,a)})})}},Thenable.prototype.state="thenable",Thenable.prototype.inspect=function(){return{state:"pending"}},Thenable.prototype.cast=function(){if(!this.became){var a=defer(),b=this.thenable;asap(function(){try{b.then(a.resolve,a.reject)}catch(c){a.reject(c)}}),this.became=Q_getHandler(a.promise)}return this.became},Thenable.prototype.dispatch=function(a,b,c){this.cast().dispatch(a,b,c)},Passed.prototype.state="passed",Passed.prototype.inspect=function(){return this.promise.inspect()},Passed.prototype.dispatch=function(a,b,c){return this.promise.rawDispatch(a,b,c)},Q.ninvoke=function(a,b){for(var c=new Array(Math.max(0,arguments.length-1)),d=2;d<arguments.length;d++)c[d-2]=arguments[d];var e=Q.defer();return c[d-2]=e.makeNodeResolver(),Q(a).dispatch("invoke",[b,c])["catch"](e.reject),e.promise},Promise.prototype.ninvoke=function(a){for(var b=new Array(arguments.length),c=1;c<arguments.length;c++)b[c-1]=arguments[c];var d=Q.defer();return b[c-1]=d.makeNodeResolver(),this.dispatch("invoke",[a,b])["catch"](d.reject),d.promise},Q.denodeify=function(a,b){return function(){for(var c=new Array(arguments.length+1),d=0;d<arguments.length;d++)c[d]=arguments[d];var e=Q.defer();return c[d]=e.makeNodeResolver(b),Q(a).apply(this,c)["catch"](e.reject),e.promise}},Deferred.prototype.makeNodeResolver=function(a){var b=this.resolve;return a===!0?function(a){if(a)b(Q_reject(a));else{for(var c=new Array(Math.max(0,arguments.length-1)),d=1;d<arguments.length;d++)c[d-1]=arguments[d];b(c)}}:a?function(c){if(c)b(Q_reject(c));else{var d={};for(var e in a)d[a[e]]=arguments[e+1];b(d)}}:function(a,c){b(a?Q_reject(a):c)}},Promise.prototype.nodeify=function(a){return a?void this.done(function(b){a(null,b)},a):this},Q.nextTick=deprecate(asap,"nextTick","asap package"),Q.resolve=deprecate(Q,"resolve","Q"),Q.fulfill=deprecate(Q,"fulfill","Q"),Q.isPromiseAlike=deprecate(isThenable,"isPromiseAlike","(not supported)"),Q.fail=deprecate(function(a,b){return Q(a)["catch"](b)},"Q.fail","Q(value).catch"),Q.fin=deprecate(function(a,b){return Q(a)["finally"](b)},"Q.fin","Q(value).finally"),Q.progress=deprecate(function(a){return a},"Q.progress","no longer supported"),Q.thenResolve=deprecate(function(a,b){return Q(a).thenResolve(b)},"thenResolve","Q(value).thenResolve"),Q.thenReject=deprecate(function(a,b){return Q(a).thenResolve(b)},"thenResolve","Q(value).thenResolve"),Q.isPending=deprecate(function(a){return Q(a).isPending()},"isPending","Q(value).isPending"),Q.isFulfilled=deprecate(function(a){return Q(a).isFulfilled()},"isFulfilled","Q(value).isFulfilled"),Q.isRejected=deprecate(function(a){return Q(a).isRejected()},"isRejected","Q(value).isRejected"),Q.master=deprecate(function(a){return a},"master","no longer necessary"),Q.makePromise=function(){throw new Error("makePromise is no longer supported")},Q.dispatch=deprecate(function(a,b,c){return Q(a).dispatch(b,c)},"dispatch","Q(value).dispatch"),Q.get=deprecate(function(a,b){return Q(a).get(b)},"get","Q(value).get"),Q.keys=deprecate(function(a){return Q(a).keys()},"keys","Q(value).keys"),Q.post=deprecate(function(a,b,c){return Q(a).post(b,c)},"post","Q(value).invoke (spread arguments)"),Q.mapply=deprecate(function(a,b,c){return Q(a).post(b,c)},"post","Q(value).invoke (spread arguments)"),Q.send=deprecate(function(a,b){return Q(a).post(b,Array.prototype.slice.call(arguments,2))},"send","Q(value).invoke"),Q.set=function(){throw new Error("Q.set no longer supported")},Q["delete"]=function(){throw new Error("Q.delete no longer supported")},Q.nearer=deprecate(function(a){return Q_isPromise(a)&&a.isFulfilled()?a.inspect().value:a},"nearer","inspect().value (+nuances)"),Q.fapply=deprecate(function(a,b){return Q(a).dispatch("call",[b])},"fapply","Q(callback).apply(thisp, args)"),Q.fcall=deprecate(function(a){return Q(a).dispatch("call",[Array.prototype.slice.call(arguments,1)])},"fcall","Q(callback).call(thisp, ...args)"),Q.fbind=deprecate(function(a){var b=Q(a),c=Array.prototype.slice.call(arguments,1);return function(){return b.dispatch("call",[c.concat(Array.prototype.slice.call(arguments)),this])}},"fbind","bind with thisp"),Q.promise=deprecate(Promise,"promise","Promise"),Promise.prototype.fapply=deprecate(function(a){return this.dispatch("call",[a])},"fapply","apply with thisp"),Promise.prototype.fcall=deprecate(function(){return this.dispatch("call",[Array.prototype.slice.call(arguments)])},"fcall","try or call with thisp"),Promise.prototype.fail=deprecate(function(a){return this["catch"](a)},"fail","catch"),Promise.prototype.fin=deprecate(function(a){return this["finally"](a)},"fin","finally"),Promise.prototype.set=function(){throw new Error("Promise set no longer supported")},Promise.prototype["delete"]=function(){throw new Error("Promise delete no longer supported")},Deferred.prototype.notify=deprecate(function(){},"notify","no longer supported"),Promise.prototype.progress=deprecate(function(){return this},"progress","no longer supported"),Promise.prototype.mapply=deprecate(function(a,b){return this.dispatch("invoke",[a,b])},"mapply","invoke"),Promise.prototype.fbind=deprecate(function(){return Q.fbind.apply(Q,[void 0].concat(Array.prototype.slice.call(arguments)))},"fbind","bind(thisp, ...args)"),Promise.prototype.send=deprecate(function(){return this.dispatch("invoke",[name,Array.prototype.slice.call(arguments,1)])},"send","invoke"),Promise.prototype.mcall=deprecate(function(){return this.dispatch("invoke",[name,Array.prototype.slice.call(arguments,1)])},"mcall","invoke"),Promise.prototype.passByCopy=deprecate(function(a){return a},"passByCopy","Q.passByCopy"),Q.nfapply=deprecate(function(a,b){var c=Q.defer(),d=Array.prototype.slice.call(b);return d.push(c.makeNodeResolver()),Q(a).apply(this,d)["catch"](c.reject),c.promise},"nfapply"),Promise.prototype.nfapply=deprecate(function(a){return Q.nfapply(this,a)},"nfapply"),Q.nfcall=deprecate(function(a){var b=Array.prototype.slice.call(arguments,1);return Q.nfapply(a,b)},"nfcall"),Promise.prototype.nfcall=deprecate(function(){for(var a=new Array(arguments.length),b=0;b<arguments.length;b++)a[b]=arguments[b];return Q.nfapply(this,a)},"nfcall"),Q.nfbind=deprecate(function(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=b.concat(Array.prototype.slice.call(arguments)),d=Q.defer();return c.push(d.makeNodeResolver()),Q(a).apply(this,c)["catch"](d.reject),d.promise}},"nfbind","denodeify (with caveats)"),Promise.prototype.nfbind=deprecate(function(){for(var a=new Array(arguments.length),b=0;b<arguments.length;b++)a[b]=arguments[b];return Q.nfbind(this,a)},"nfbind","denodeify (with caveats)"),Q.nbind=deprecate(function(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){function d(){return a.apply(b,arguments)}var e=c.concat(Array.prototype.slice.call(arguments)),f=Q.defer();return e.push(f.makeNodeResolver()),Q(d).apply(this,e)["catch"](f.reject),f.promise}},"nbind","denodeify (with caveats)"),Q.npost=deprecate(function(a,b,c){var d=Q.defer();return c.push(d.makeNodeResolver()),Q(a).dispatch("invoke",[b,c])["catch"](d.reject),d.promise},"npost","ninvoke (with spread arguments)"),Promise.prototype.npost=deprecate(function(a,b){return Q.npost(this,a,b)},"npost","Q.ninvoke (with caveats)"),Q.nmapply=deprecate(Q.nmapply,"nmapply","q/node nmapply"),Promise.prototype.nmapply=deprecate(Promise.prototype.npost,"nmapply","Q.nmapply"),Q.nsend=deprecate(Q.ninvoke,"nsend","q/node ninvoke"),Q.nmcall=deprecate(Q.ninvoke,"nmcall","q/node ninvoke"),Promise.prototype.nsend=deprecate(Promise.prototype.ninvoke,"nsend","q/node ninvoke"),Promise.prototype.nmcall=deprecate(Promise.prototype.ninvoke,"nmcall","q/node ninvoke");var qEndingLine=captureLine();