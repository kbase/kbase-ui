define(["jquery","underscore","bluebird","kb/service/client/workspace","kb/service/client/NarrativeMethodStore","kb/service/utils"],function(a,b,c,d,e,f){"use strict";function g(a){var b=function(a){return a.replace(/'/g,"&apos;").replace(/"/g,"&quot;")};return JSON.stringify(a,function(a,c){return"string"==typeof c?b(c):c})}function h(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})}function i(a){function i(a,b){return c["try"](function(){if(b){var d=b.map(function(a){return{ref:a}});return x.get_object_info_new({objects:d,includeMetadata:0}).then(function(b){return b.map(function(b){var c=f.object_info_to_object(b);return x.copy_object({from:{ref:c.ref},to:{wsid:a,name:c.name}})})}).then(function(a){return c.all(a)})}})}function o(a,b,c){return x.alter_workspace_metadata({wsi:{id:a},"new":{narrative:String(b),is_temporary:"true"}}).then(function(){return i(a,c)})}function p(){return x.list_workspace_info({owners:[w.service("session").getUsername()]}).then(function(a){var b=a.map(function(a){return f.workspaceInfoToObject(a)}).filter(function(a){return a.metadata&&a.metadata.narrative?!0:!1});if(0===b.length)return null;b.sort(function(a,b){return a.moddate>b.moddate?-1:a.moddate<b.moddate?1:0});var c=b[0],d=[c.id,c.metadata.narrative].join("/");return x.get_object_info_new({objects:[{ref:d}],includeMetadata:1,ignoreErrors:1}).then(function(a){return{workspaceInfo:c,narrativeInfo:f.objectInfoToObject(a[0])}})})}function q(a,b,c){var d="kb-cell-"+a+"-"+h(),e={cell_type:"markdown",source:"<div id='"+d+"'></div>\n<script>$('#"+d+"').kbaseNarrativeAppCell({'appSpec' : '"+g(b)+"', 'cellId' : '"+d+"'});</script>",metadata:{}},f={},i=[];if(f[k]=l,f.app=b,c){for(var m={},o=0;o<c.length;o++){var p="step_"+c[o][0];p in m||(m[p]={},m[p].inputState={}),m[p].inputState[c[o][1]]=c[o][2]}var q={state:{step:m}};i.push(q)}return f[n]=i,e.metadata[j]=f,e}function r(a,b,c){var d="kb-cell-"+a+"-"+h(),e={cell_type:"markdown",source:"<div id='"+d+"'></div>\n<script>$('#"+d+"').kbaseNarrativeMethodCell({'method' : '"+g(b)+"'});</script>",metadata:{}},f={method:b,widget:b.widgets.input};f[k]=m;var i=[];if(c){var l={};c.forEach(function(a){l[a[1]]=a[2]}),i.push({state:l})}return f[n]=i,e.metadata[j]=f,e}function s(a,b,c){var d=[],e=0;return a&&a.length>0?a.forEach(function(f){if(e+=1,f.app)d.push(q(d.length,b.apps[f.app],c));else if(f.method)d.push(r(d.length,b.methods[a.method],c));else{if(!f.markdown)throw{message:"cannot add cell #"+String(e-1)+", unrecognized cell content"};d.push({cell_type:"markdown",source:f.markdown,metadata:{}})}}):d.push({cell_type:"markdown",source:A,metadata:{}}),d}function t(a){return c["try"](function(){if(!a)return{};var b=[],c=[],d={apps:{},methods:{}};return a.forEach(function(a){a.app?b.push(a.app):a.method&&c.push(a.method)}),y.get_app_spec({ids:b}).then(function(a){return a.forEach(function(a){var c=b.shift();d.apps[c]=a}),y.get_method_spec({ids:c})}).then(function(a){return a.forEach(function(a){var b=c.shift();d.methods[b]=a}),d})})}function u(a,b,c){return t(b).then(function(d){var e={job_ids:{methods:[],apps:[],job_usage:{queue_time:0,run_time:0}},format:"ipynb",creator:w.service("session").getUsername(),ws_name:a,name:"Untitled",type:"KBaseNarrative.Narrative",description:"",data_dependencies:[]},f=s(b,d,c),g={nbformat_minor:0,worksheets:[{cells:f,metadata:{}}],metadata:e,nbformat:3},h={};return Object.keys(e).forEach(function(a){"string"==typeof e[a]?h[a]=e[a]:h[a]=JSON.stringify(e[a])}),[g,h]})}function q(a,b,c){var d="kb-cell-"+a+"-"+h(),e={cell_type:"markdown",source:"<div id='"+d+"'></div>\n<script>$('#"+d+"').kbaseNarrativeAppCell({'appSpec' : '"+g(b)+"', 'cellId' : '"+d+"'});</script>",metadata:{}},f={},i=[];if(f[k]=l,f.app=b,c){for(var m={},o=0;o<c.length;o++){var p="step_"+c[o][0];p in m||(m[p]={},m[p].inputState={}),m[p].inputState[c[o][1]]=c[o][2]}var q={state:{step:m}};i.push(q)}return f[n]=i,e.metadata[j]=f,e}function r(a,b,c){var d="kb-cell-"+a+"-"+h(),e={cell_type:"markdown",source:"<div id='"+d+"'></div>\n<script>$('#"+d+"').kbaseNarrativeMethodCell({'method' : '"+g(b)+"'});</script>",metadata:{}},f={};f[k]=m,f.method=b;var i=[];if(c){var l={};c.forEach(function(a){l[a[1]]=a[2]});var o={state:l};i.push(o)}return f[n]=i,f.widget=b.widgets.input,e.metadata[j]=f,e}function v(a){return c["try"](function(){var b,c,d=(new Date).getTime(),e=w.service("session").getUsername()+":"+d,g="Narrative."+d;return x.create_workspace({workspace:e,description:""}).then(function(c){return b=f.workspaceInfoToObject(c),u(e,a.cells,a.parameters)}).then(function(a){var b=a[0],c=a[1];return x.save_objects({workspace:e,objects:[{type:"KBaseNarrative.Narrative",data:b,name:g,meta:c,provenance:[{script:"NarrativeManager.js",description:"Created new Workspace/Narrative bundle."}],hidden:0}]})}).then(function(d){var e=f.objectInfoToObject(d[0]);return c={workspaceInfo:b,narrativeInfo:e},o(b.id,e.id,a.importData)}).then(function(){return c})})}var w=a.runtime,x=new d(w.getConfig("services.workspace.url"),{token:w.service("session").getAuthToken()}),y=new e(w.getConfig("services.narrative_method_store.url"),{token:w.service("session").getAuthToken()}),z=function(){var a="";return a+="![KBase Logo](<%= docBaseUrl %>/wp-content/uploads/2014/11/kbase-logo-web.png)\n",a+="Welcome to the Narrative Interface!\n",a+="===\n",a+="\n",a+="What's a Narrative?\n",a+="---\n",a+="\n",a+="Design and carry out collaborative computational experiments while  \n",a+="creating Narratives: interactive, shareable, and reproducible records \n",a+="of your data, computational steps, and thought processes.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide">learn more...</a>\n',a+="\n",a+="\n",a+="Get Some Data\n",a+="---\n",a+="\n",a+="Click the Add Data button in the Data Panel to browse for KBase data or \n",a+="upload your own. Mouse over a data object to add it to your Narrative, and  \n",a+="check out more details once the data appears in your list.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide/explore-data">learn more...</a>\n',a+="\n",a+="\n",a+="Analyze It\n",a+="---\n",a+="\n",a+="Browse available analyses that can be run using KBase apps or methods \n",a+="(apps are just multi-step methods that make some common analyses more \n",a+="convenient). Select an analysis, fill in the fields, and click Run. \n",a+="Output will be generated, and new data objects will be created and added \n",a+="to your data list. Add to your results by running follow-on apps or methods.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide/browse-apps-and-methods">learn more...</a>\n',a+="\n",a+="\n",a+="Save and Share Your Narrative\n",a+="---\n",a+="\n",a+="Be sure to save your Narrative frequently. When you're ready, click  \n",a+="the share button above to let collaborators view your analysis steps \n",a+="and results. Or better yet, make your Narrative public and help expand \n",a+="the social web that KBase is building to make systems biology research \n",a+="open, collaborative, and more effective.\n",a+="\n",a+='<a href="<%= docBaseUrl %>/narrative-guide/share-narratives/">learn more...</a>\n',a+="\n",a+="Find Documentation and Help\n",a+="---\n",a+="\n",a+="For more information, please see the \n",a+='<a href="<%= docBaseUrl %>/narrative-guide">Narrative Interface User Guide</a> \n',a+='or the <a href="<%= docBaseUrl %>/tutorials">app/method tutorials</a>.\n',a+="\n",a+='Questions? <a href="<%= docBaseUrl %>/contact-us">Contact us</a>!\n',a+="\n",a+="Ready to begin adding to your Narrative? You can keep this Welcome cell or \n",a+="delete it with the trash icon in the top right corner."}(),A=b.template(z)({docBaseUrl:w.getConfig("docsite.baseUrl")});return{createTempNarrative:v,getMostRecentNarrative:p}}var j="kb-cell",k="type",l="kb_app",m="function_input",n="widget_state";return i});