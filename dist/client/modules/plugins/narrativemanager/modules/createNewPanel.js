define(["bluebird","kb/common/html","kb/common/dom","kb_narrativeManager_narrativeManagerService"],function(a,b,c,d){"use strict";function e(e){function f(a,b){return n.getConfig("services.narrative.url")+"/narrative/ws."+a+".obj."+b}function g(b){return a["try"](function(){if(b=b||{},b.app&&b.method)throw"Must provide no more than one of the app or method params";var a,c,d,e,g;if(b.copydata&&(a=b.copydata.split(";")),b.appparam)for(d=b.appparam.split(";"),c=[],e=0;e<d.length;e+=1){if(c[e]=d[e].split(","),3!==c[e].length)throw new Error("Illegal app parameter set, expected 3 parameters separated by commas: "+d[e]);if(c[e][0]=parseInt(c[e][0],10),isNaN(c[e][0])||c[e][0]<1)throw new Error("Illegal app parameter set, first item in set must be an integer > 0: "+d[e])}return b.app?g=[{app:b.app}]:b.method&&(g=[{method:b.method}]),o.createTempNarrative({cells:g,parameters:c,importData:a}).then(function(a){var b=a.narrativeInfo.wsid,c=a.narrativeInfo.id,d=f(b,c);return{redirect:{url:d,newWindow:!1}}})})}function h(a){l=a,m=c.createElement("div"),l.appendChild(m)}function i(c){var d=b.tag("div"),e=b.tag("a"),f=b.tag("p");return m.innerHTML=b.loading("Creating a new Narrative for you..."),new a(function(a,b){g(c).then(function(b){m.innerHTML=d([f("Should have created and opened a new narrative."),f("If it did not happen, use this link:"),f(e({href:b.redirect.url,target:"_blank"},["Open Your New Narrative: ",b.redirect.url]))]),n.send("app","redirect",{url:b.redirect.url,new_window:!1}),a()})["catch"](function(a){m.innerHTML="ERROR creating and opening a new narrative",console.log("ERROR creating and opening a new narrative"),console.log(a),b(a)})})}function j(){}function k(){l.removeChild(m),m.innerHTML="",m=null}var l,m,n=e.runtime,o=d({runtime:n});return{attach:h,start:i,stop:j,detach:k}}return{make:function(a){return e(a)}}});