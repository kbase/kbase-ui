define(["bluebird","kb/common/html","kb/common/dom","kb_narrativeManager_narrativeManagerService"],function(a,b,c,d){"use strict";function e(e){function f(a){return m.getConfig("services.narrative.url")+"/narrative/"+a.obj_id}function g(){return n.getMostRecentNarrative().then(function(a){return a?{redirect:{url:f(a.narrativeInfo),new_window:!1}}:n.createTempNarrative({cells:[],parameters:[],importData:[]}).then(function(a){return{redirect:{url:f(a.narrativeInfo),new_window:!1}}})})}function h(a){k=a,l=c.createElement("div"),k.appendChild(l)}function i(c){var d=b.tag("div"),e=b.tag("a"),f=b.tag("p");return l.innerHTML=b.loading("Starting or Creating a Narrative for you..."),new a(function(a,b){g(c).then(function(b){l.innerHTML=d([f("Should have opened your narrative."),f("If it did not happen, use this link:"),f(e({href:b.redirect.url,target:"_blank"},["Open Your New Narrative: ",b.redirect.url]))]),m.send("app","redirect",{url:b.redirect.url,new_window:!1}),a()})["catch"](function(a){l.innerHTML="ERROR creating and opening a new narrative",console.log("ERROR creating and opening a new narrative"),console.log(a),b(a)})})}function j(){l&&k.removeChild(l),l.innerHTML="",l=null}var k,l,m=e.runtime,n=d({runtime:m});return{attach:h,start:i,detach:j}}return{make:function(a){return e(a)}}});