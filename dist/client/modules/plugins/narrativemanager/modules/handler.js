define(["bluebird","kb/common/html","kb_narrativeManager_narrativeManagerService"],function(a,b,c){"use strict";function d(a,b){return R.getConfig("services.narrative.url")+"/narrative/ws."+a+".obj."+b}function e(){return new a(function(a,b){g.detectStartSettings(function(c){if(c.last_narrative){var e=c.last_narrative.ws_info[0],f=c.last_narrative.nar_info[0],h=d(e,f);a({redirect:{url:h,new_window:!1}})}else g.createTempNarrative({cells:[],parameters:[],importData:[]},function(b){var c=b.nar_info[6],e=b.nar_info[0],f=d(c,e);a({redirect:{url:f,new_window:!1}})},function(a){b(a)})},function(a){b(a)})})}function f(b){return new a(function(a,c){if(b=b||{},b.app&&b.method)return void c("Must provide no more than one of the app or method params");var e=null;b.copydata&&(e=b.copydata.split(";"));var f=null;if(b.appparam){var h=b.appparam.split(";");f=[];for(var i=0;i<h.length;i+=1){if(f[i]=h[i].split(","),3!==f[i].length)return void c("Illegal app parameter set, expected 3 parameters separated by commas: "+h[i]);if(f[i][0]=parseInt(f[i][0]),isNaN(f[i][0])||f[i][0]<1)return void c("Illegal app parameter set, first item in set must be an integer > 0: "+h[i])}}var j=[];b.app?j=[{app:b.app}]:b.method&&(j=[{method:b.method}]),g.createTempNarrative({cells:j,parameters:f,importData:e},function(b){var c=b.nar_info[6],e=b.nar_info[0],f=d(c,e);a({redirect:{url:f,new_window:!1}})},function(a){c(a)})})}var g=c();return{createNewNarrative:f,startOrCreateEmptyNarrative:e}});