define(["nunjucks","jquery","bluebird","kb/common/utils","kb_userProfile_widget_base","kb/service/userProfile"],function(a,b,c,d,e,f){"use strict";var g=Object.create(e,{init:{value:function(a){return a.name="UserProfile",a.title="User Profile",this.SocialWidget_init(a),this._generatedId=0,this.templates.env.addFilter("roleLabel",function(a){return this.listMaps.userRoles[a]?this.listMaps.userRoles[a].label:a}.bind(this)),this.templates.env.addFilter("userClassLabel",function(a){return this.listMaps.userClasses[a]?this.listMaps.userClasses[a].label:a}.bind(this)),this.templates.env.addFilter("titleLabel",function(a){return this.listMaps.userTitles[a]?this.listMaps.userTitles[a].label:a}.bind(this)),this}},setup:{value:function(){return null}},go:{value:function(){return this.setupUI(),this.renderWaitingView(),this.setInitialState().then(function(){return this.refresh()}.bind(this))["catch"](function(a){this.renderErrorView(a)}.bind(this)),this}},resetState:{value:function(){this.userProfile=null}},setInitialState:{value:function(a){return new c(function(a,b,c){this.runtime.service("session").isLoggedIn()?(this.userProfile=Object.create(f).init({runtime:this.runtime,username:this.params.userId}),this.userProfile.loadProfile().then(function(){a()})["catch"](function(a){b(a)})):(this.userProfile=null,a())}.bind(this))}},createTemplateContext:{value:function(){return this.runtime.service("session").isLoggedIn()&&this.userProfile?d.merge(d.merge({},this.context),{env:{root:this.getConfig("root"),lists:this.lists,isOwner:this.isOwner(),profileCompletion:this.calcProfileCompletion()},userRecord:this.userProfile.userRecord}):d.merge(d.merge({},this.context),{env:{profileCompletion:"notloggedin"}})}},calcProfileCompletion:{value:function(){if(this.runtime.service("session").isLoggedIn()){var a=this.userProfile.calcProfileCompletion(),b=this.userProfile.nthHistory(1);return"complete"===a.status&&(!b||b&&b.completionStatus===a.status)?null:a}return"notloggedin"}},formToObject:{value:function(a){var c=(this.places.content.find.form,[]),d=[],e=Object.create({},{init:{value:function(a){return"string"==typeof a.container?this.container=b(a.container):this.container=a.container,this.currentPath=[],this.jsonRoot=Object.create(null),this.currentJsonNode=this.jsonRoot,this.fieldValidationErrors=a.fieldValidationErrors,this.objectValidationErrors=a.objectValidationErrors,this}},getFieldValue:{value:function(a){var c=this.container.find('[data-field="'+a+'"]');if(c&&0!==c.length){var d=c.find("input, textarea, select");if(d&&0!==d.length)switch(d.prop("tagName").toLowerCase()){case"input":switch(d.attr("type")){case"checkbox":return d.map(function(){var a=b(this);return a.prop("checked")?a.val():null}).get();case"radio":var e=d.map(function(){var a=b(this);return a.prop("checked")?a.val():null}).get();return 1===e.length?e[0]:null;default:var e=d.val();return e&&e.length>0?e:null}case"textarea":var e=d.val();return e&&0===e.length&&(e=null),e;case"select":var e=d.val();return e&&0===e.length&&(e=null),e}}}},parseObject:{value:function(a){for(var b={},c=Object.getOwnPropertyNames(a.properties),d=0;d<c.length;d++){var e=c[d],f=a.properties[e];switch(f.type){case"object":;this.currentPath.push(e);var g=this.parseObject(f);g&&(b[e]=g),this.currentPath.pop();break;case"array":this.currentPath.push(e);var g=this.parseArray(f);g&&(b[e]=g),this.currentPath.pop();break;case"string":this.currentPath.push(e);var g=this.parseString(f),h=this.validateString(g,f);h&&this.addFieldError({propPath:this.currentPath.join("."),message:h}),void 0!==g&&(b[e]=g),this.currentPath.pop();break;case"integer":this.currentPath.push(e);var g=this.parseInteger(f);void 0!==g&&(b[e]=g),this.currentPath.pop();break;case"boolean":break;case"null":}}if(a.required)for(var d=0;d<a.required.length;d++){var i=a.required[d];if(void 0===b[i]||null===b[i]){this.currentPath.push(i);var j=this.currentPath.join(".");this.addFieldError({propPath:j,message:"This field is required"}),this.currentPath.pop()}}return b}},parseArray:{value:function(a){var f=a.items,g=this.currentPath.join(".");switch(f.type){case"string":return this.getFieldValue(g);case"object":var h=this.container.find('[data-field="'+g+'"] fieldset').map(function(a){var g=Object.create(e).init({container:b(this),fieldValidationErrors:c,objectValidationErrors:d}).parseObject(f);return g}).get();return h;default:throw"Can't make array out of "+f.type+" yet."}}},validateString:{value:function(a,b){if(a)switch(b.format){case"email":var c=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(!c.test(a))return"Invalid email format"}return!1}},parseString:{value:function(a){var b=this.currentPath.join(".");return this.getFieldValue(b)}},addFieldError:{value:function(a){a.container=this.container,this.fieldValidationErrors.push(a)}},parseInteger:{value:function(a){var b=this.currentPath.join("."),c=this.getFieldValue(b);if(c){if(c.length>0){var d=parseInt(c);if(isNaN(d))return void this.addFieldError({propPath:b,message:"Not a valid integer"});var e=!1;return a.minimum&&(a.minimumExclusive?d<=a.minimum&&(e=!0,this.addFieldError({propPath:b,message:"The integer value is below or at the minimum of "+a.minimum})):d<a.minimum&&(e=!0,this.addFieldError({propPath:b,message:"The integer value is below the minimum of "+a.minimum}))),a.maximum&&(a.maximumExclusive?d>=a.maximum&&(e=!0,this.addFieldError({propPath:b,message:"The integer value is above or at the maximum of "+a.maximum})):d>a.maximum&&(e=!0,this.addFieldError({propPath:b,message:"The integer value is above the maximum of "+a.maximum}))),e?void 0:d}}else;}}}),f=e.init({container:this.places.content,fieldValidationErrors:c,objectValidationErrors:d}).parseObject(a),g=!1;if(c.length>0&&(g=!0,this.showFieldValidationErrors(c)),d.length>0&&(g=!0),g)throw"Validation errors processing the form";return f}},showFieldValidationErrors:{value:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.showFieldError(c.container,c.propPath,c.message)}}},getUserProfileFormSchema:{value:function(){return{type:"object",properties:{user:{type:"object",title:"User",properties:{realname:{type:"string",title:"Real Name",maxLength:100},thumbnail:{type:"string"}},required:["realname"]},profile:{type:"object",properties:{userdata:{type:"object",properties:{title:{type:"string",title:"Title"},suffix:{type:"string",title:"Suffix"},location:{type:"string",title:"Geographic Location",maxLength:25},email:{type:"string",title:"E-Mail Address",format:"email"},personal_statement:{type:"string",title:"Personal Statement"},user_class:{type:"string",title:"User Type"},roles:{type:"array",title:"Roles",items:{type:"string"}},avatar:{type:"object",properties:{gravatar_default:{type:"string",title:"Gravatar Default Setting"}}},affiliations:{type:"array",title:"Affiliation",items:{type:"object",properties:{title:{type:"string",title:"Title"},institution:{type:"string",title:"Institution"},start_year:{type:"integer",title:"Start Year",minimum:1900,maximum:2100},end_year:{type:"integer",title:"End Year",minimum:1900,maximum:2100}},required:["title","institution","start_year"]}}},required:["email","user_class","roles","location"]}}}}}}},updateUserProfileFromForm:{value:function(){this.clearErrors();var a=this.getUserProfileFormSchema();try{var b=this.formToObject(a)}catch(c){return this.addErrorMessage("Error","There was an error processing the form: "+c+". Please check the form for errors, correct them, and try saving again."),!1}return this.formHasError?(this.addErrorMessage("Not Saved","Your changes cannot be saved due to one or more errors. Please review the form, make the required corrections, and try again."),!1):(this.userProfile.updateProfile(b),!0)}},renderErrorView:{value:function(a){"string"==typeof a?a={title:"Error",message:a}:"object"==typeof a&&a.status&&a.error?(a.title="KBase API Error",a.message=a.error.message):(a.title||(a.title="Error"),a.message||(a.message="unknown error")),this.renderLayout(),this.places.title.html(a.title),this.places.content.html(this.renderTemplate("error",a))}},getFieldValue:{value:function(a){var c=this.places.content.find('[data-field="'+a+'"]');if(c&&0!==c.length){var d=c.find("input, textarea, select"),e=d.prop("tagName").toLowerCase();switch(e){case"input":var f=d.attr("type");switch(f){case"checkbox":return d.map(function(){var a=b(this);return a.prop("checked")?a.val():null}).get();case"radio":var g=d.map(function(){var a=b(this);return a.prop("checked")?a.val():null}).get();return 1===g.length?g[0]:null;default:var g=d.val();return g&&g.length>0?g:null}case"textarea":var g=d.val();return g&&0===g.length&&(g=null),g;case"select":var g=d.val();return g&&0===g.length&&(g=null),g}}}},getProfileStatus:{value:function(){return this.runtime.service("session").isLoggedIn()?this.userProfile.getProfileStatus():"notloggedin"}},render:{value:function(){var a=this.getProfileStatus();switch(a){case"notloggedin":this.renderLayout(),this.places.title.html("Unauthorized"),this.places.content.html(this.renderTemplate("unauthorized"));break;case"profile":var c=this.userProfile.getProp("user.realname");b(document).find("head title").text("User Profile for "+c+" | KBase"),this.renderViewEditLayout(),this.renderInfoView();break;case"stub":var c=this.userProfile.getProp("user.realname");b(document).find("head title").text("User Profile for "+c+" | KBase"),this.renderViewEditLayout(),this.renderMessages(),this.renderStubProfileView();break;case"error":this.renderLayout(),this.renderErrorView("Profile is in error state");break;case"none":this.renderLayout(),this.places.title.html("User Not Found"),this.renderPicture(),this.places.content.html(this.renderTemplate("no_user"));break;default:this.renderLayout(),this.renderErrorView('Invalid profile state "'+a+'"')}return this.renderMessages(),this}},renderInfoView:{value:function(){var a=this;if(this.isOwner())this.places.title.html("You - "+this.userProfile.getProp("user.realname")+" ("+this.userProfile.getProp("user.username")+")"),this.runtime.send("ui","clearButtons"),this.runtime.send("ui","setTitle","Viewing your profile"),this.runtime.send("ui","addButton",{name:"account",label:"Account",style:"default",icon:"wrench",callback:function(){this.runtime.send("app","redirect",{url:"https://gologin.kbase.us/Dashboard",new_window:!0})}.bind(this)}),this.runtime.send("ui","addButton",{name:"edit",label:"Edit Profile",style:"primary",icon:"edit",callback:function(){a.clearMessages(),a.renderEditView()}.bind(this)});else{var b=this.userProfile.getProp("user.realname")+" ("+this.userProfile.getProp("user.username")+")";this.places.title.html(b),this.runtime.send("ui","setTitle","Viewing profile for "+b)}this.renderPicture(),this.places.content.html(this.renderTemplate("view"))}},deleteProfile:{value:function(){this.userProfile.deleteUserdata().then(function(){this.runtime.send("session","profile.saved"),this.addSuccessMessage("Your profile has been successfully removed."),this.render()}.bind(this))["catch"](function(a){this.renderErrorView(a)}.bind(this))}},showFieldError:{value:function(a,b,c){"string"==typeof b&&(b=a.find('[data-field="'+b+'"]')),b.addClass("has-error");var d=b.find('[data-element="message"]');c&&d.html(c),this.formHasError=!0}},renderEditView:{value:function(){var a=this;this.runtime.send("ui","setTitle",{title:"Editing your profile"}),this.runtime.send("ui","clearButtons"),this.runtime.send("ui","addButton",{name:"save",label:"Save",style:"primary",icon:"save",disabled:!0,callback:function(){a.updateUserProfileFromForm()&&a.userProfile.saveProfile().then(function(){a.changed=!1,a.renderViewEditLayout(),a.addSuccessMessage("Success!","Your user profile has been updated."),a.renderInfoView(),a.runtime.send("session","profile.saved")})["catch"](function(b){a.renderErrorView(b)})}}),this.runtime.send("ui","addButton",{name:"cancel",label:"Cancel",style:"default",icon:"ban",callback:function(){var c=a.changed;if(c){var d=b('.UserProfileWidget [data-widget-modal="confirm-cancel"]').modal("show");d.find('[data-widget-modal-control="confirm-cancel"]').on("click",function(b){d.modal("hide").on("hidden.bs.modal",function(b){a.changed=!1,a.clearMessages(),a.renderInfoView()})})}else a.clearMessages(),a.renderInfoView()}}),this.places.content.html(this.renderTemplate("edit"));var c=this;this.places.content.find('[data-button="add-affiliation"]').on("click",function(a){var b=this.places.content.find('[data-field="profile.userdata.affiliations"]'),d=this.renderTemplate("new_affiliation",{generatedId:this.genId()});b.append(d),c.changed=!0,this.runtime.send("ui","enableButton",{name:"save"})}.bind(this)),this.places.content.find('[data-field="profile.userdata.affiliations"]').on("click",'[data-button="remove"]',function(a){b(this).closest('[data-field-group="affiliation"]').remove(),c.changed=!0,this.runtime.send("ui","enableButton",{name:"save"})}),this.places.content.find('[data-field="profile.userdata.affiliations"]').on("keyup","input",function(a){var c=b(this).closest('[data-field-group="affiliation"]'),d=c.find('[data-field="title"] input').val(),e=c.find('[data-field="institution"] input').val(),f=c.find('[data-field="start_year"] input').val(),g=c.find('[data-field="end_year"] input').val();g=g?g:"present",c.find(".panel-title").html(d+" @ "+e+", "+f+"-"+g)}),this.places.content.find("form").on("input change",function(b){c.changed=!0,a.runtime.send("ui","enableButton",{name:"save"})})}},renderStubProfileView:{value:function(){this.renderPicture(),this.places.title.html(this.userProfile.userRecord.user.realname+" ("+this.userProfile.userRecord.user.username+")"),this.places.content.html(this.renderTemplate("stub_profile"));var a=this;this.isOwner()&&b('[data-button="create-profile"]').on("click",function(b){a.userProfile.createProfile().then(function(){this.runtime.send("session","profile.saved"),a.clearMessages(),a.addSuccessMessage("Success!","Your user profile has been created."),a.render()})["catch"](function(b){a.renderErrorView(b)})})}},clearErrors:{value:function(){this.clearMessages(),this.clearFieldMessages(),this.places.content.find(".has-error").removeClass("has-error"),this.places.content.find(".error-message").removeClass("error-message"),this.formHasError=!1}},clearFieldMessages:{value:function(){b("[data-field-message]").empty()}},renderPicture:{value:function(){this.container.find('[data-placeholder="picture"]').html(this.renderTemplate("picture"))}},renderViewEditLayout:{value:function(){if(this.isOwner())this.runtime.send("ui","setTitle","Viewing your profile");else{var b=this.userProfile.getProp("user.realname")+" ("+this.userProfile.getProp("user.username")+")";this.places.title.html(b),this.runtime.send("ui","setTitle","Viewing profile for "+b)}a.configure({autoescape:!0}),this.container.html(this.renderTemplate("view_edit_layout")),this.places={title:this.container.find('[data-placeholder="title"]'),alert:this.container.find('[data-placeholder="alert"]'),content:this.container.find('[data-placeholder="content"]')}}},renderLayout:{value:function(){a.configure({autoescape:!0}),this.container.html(this.renderTemplate("layout")),this.places={title:this.container.find('[data-placeholder="title"]'),content:this.container.find('[data-placeholder="content"]')}}}});return g});