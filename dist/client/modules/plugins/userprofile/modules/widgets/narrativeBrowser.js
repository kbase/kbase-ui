define(["bluebird","kb_userProfile_widget_base","kb/service/client/workspace"],function(a,b,c){"use strict";var d=Object.create(b,{init:{value:function(a){return a.name="BrowseNarratives",a.title="Browse Narratives",this.SocialWidget_init(a),this.templates.env.addFilter("dateFormat",function(a){return this.niceElapsedTime(a)}.bind(this)),this.params.limit=10,this}},setup:{value:function(){if(this.runtime.service("session").isLoggedIn()){if(!this.runtime.hasConfig("services.workspace.url"))throw new Error("The workspace client url is not defined");this.workspaceClient=new c(this.runtime.getConfig("services.workspace.url"),{token:this.runtime.service("session").getAuthToken()})}else this.workspaceClient=null}},go:{value:function(){return this.start(),this}},render:{value:function(){return this.error?this.renderError():this.runtime.service("session").isLoggedIn()?(this.places.title.html(this.renderTemplate("authorized_title")),this.places.content.html(this.renderTemplate("authorized"))):(this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate("unauthorized"))),this}},setInitialState:{value:function(b){return a["try"](function(){return this.runtime.service("session").isLoggedIn()?a.resolve(this.workspaceClient.list_workspace_info({showDeleted:0,owners:[this.params.userId]})).then(function(a){var b,c,d=[];for(b=0;b<a.length;b+=1)c=this.workspace_metadata_to_object(a[b]),c.metadata.narrative&&"true"!==c.metadata.is_temporary&&d.push({obj_id:this.makeWorkspaceObjectId(c.id,c.metadata.narrative),title:c.metadata.narrative_nice_name,description:c.metadata.narrative_description,moddate:c.moddate});return d.sort(function(a,b){var c=new Date(a.moddate),d=new Date(b.moddate);return d>c?1:c>d?-1:0}),this.setState("narratives",d),null}.bind(this)):void 0}.bind(this))}}});return d});