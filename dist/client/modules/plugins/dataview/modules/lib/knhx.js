define(["kb_dataview_canvastext","kb_dataview_popit"],function(a,b){"use strict";function c(){return{parent:null,child:[],name:"",meta:"",d:-1,hl:!1,hidden:!1}}function d(a,b,d,e){var f,g,h,i=0;for(g=c(),h=b,f=b;h<a.length&&","!==a.charAt(h)&&")"!==a.charAt(h);++h){var j=a.charAt(h);if("["===j){var k=h;0===i&&(i=h);do++h;while(h<a.length&&"]"!==a.charAt(h));if(h===a.length){d.error|=4;break}g.meta=a.substr(k,h-k+1)}else if(":"===j){0===i&&(i=h);var l;for(l=++h;h<a.length;++h){var m=a.charAt(h);if(("0">m||m>"9")&&"e"!==m&&"E"!==m&&"+"!==m&&"-"!==m&&"."!==m)break}g.d=parseFloat(a.substr(l,h-l)),--h}else"!">j&&j>"~"&&0===i&&(i=h)}return 0===i&&(i=h),i>f&&(g.name=a.substr(f,i-f)),d.node.push(g),h}function e(a){var b=new Array,c={};c.error=c.n_tips=0,c.node=[];var e;for(e=0;e<a.length;e+=0){for(;e<a.length&&(a.charAt(e)<"!"||a.charAt(e)>"~");)++e;if(e===a.length)break;var f=a.charAt(e);if(","===f)++e;else if("("===f)b.push(-1),++e;else if(")"===f){var g,h,i;for(g=c.node.length,i=b.length-1;i>=0&&!(b[i]<0);--i);if(0>i){c.error|=1;break}for(h=b.length-1-i,e=d(a,e+1,c,h),i=b.length-1,h-=1;h>=0;--h,--i)c.node[g].child[h]=c.node[b[i]],c.node[b[i]].parent=c.node[g];b.length=i,b.push(g)}else++c.n_tips,b.push(c.node.length),e=d(a,e,c,0)}return b.length>1&&(c.error|=2),c.root=c.node[c.node.length-1],c}function f(a){a.node[a.node.length-1].depth=0;var b,c;for(b=a.node.length-2;b>=0;--b){var d=a.node[b];d.depth=d.parent.depth+1}var e="",f=0,g=1;for(b=0;b<a.node.length;++b){var d=a.node[b],h=d.depth-f;if(h>0)for(g?g=0:e+=",\n",c=0;h>c;++c)e+="(";else e+=0>h?"\n)":",\n";d.name&&(e+=String(d.name)),d.d>=0&&(e+=":"+d.d),d.meta&&(e+=d.meta),f=d.depth}return e+="\n"}function g(a){var b,c;for(b=[],c=[],c.push({p:a,i:0});;){for(;c[c.length-1].i!==c[c.length-1].p.child.length&&!c[c.length-1].p.hidden;){var d=c[c.length-1];c.push({p:d.p.child[d.i],i:0})}if(b.push(c.pop().p),!(c.length>0))break;++c[c.length-1].i}return b}function h(a){a.n_tips=0;var b;for(b=0;b<a.node.length;++b)(0===a.node[b].child.length||a.node[b].hidden)&&++a.n_tips;return a.n_tips}function i(a,b){var d=a.node[a.node.length-1];if(b!==d){var e=c();e.child.push(d),d.parent=e;var f,g=b.parent;if(2===g.child.length){var h,i=g.parent;for(f=g.child[0]===b?0:1,h=g.child[1-f],h.d+=g.d,h.parent=i,f=0;f<i.child.length&&i.child[f]!==g;++f);i.child[f]=h,g.parent=null}else{var j,k;for(f=0;f<g.child.length&&g.child[f]!==b;++f);for(j=k=0;j<g.child.length;++j)g.node[k]=g.node[j],j!==f&&++k;--g.child.length}return d=e.child[0],d.parent=null,d}}function l(a,b,d){var e=a.node[a.node.length-1];if(b===e)return null;for(var f=d;f.parent;f=f.parent)if(f===b)return null;e=i(a,b);var g=c();g.child.push(e),e.parent=g;var h,f=d.parent;for(h=0;h<f.child.length&&f.child[h]!==d;++h);var j=c();return j.parent=f,f.child[h]=j,d.d>=0&&(j.d=d.d/2,d.d/=2),j.child.push(b),b.parent=j,j.child.push(d),d.parent=j,e=g.child[0],e.parent=null,e}function m(a,b,d){var e,f,g,h,i,l,m,n;if(b===a)return a;for((0>d||d>b.d)&&(d=b.d/2),g=b.d,i=n=c(),i.child[0]=b,i.child[0].d=d,h=b.parent,i.child[0].parent=i,e=0;e<h.child.length&&h.child[e]!==b;++e);for(i.child[1]=h,f=h.d,h.d=g-d,l=h.parent,h.parent=i;null!==l;){for(m=l.parent,h.child[e]=l,e=0;e<l.child.length&&l.child[e]!==h;++e);l.parent=h,g=l.d,l.d=f,f=g,i=h,h=l,l=m}if(2===h.child.length){for(l=h.child[1-e],e=0;e<i.child.length&&i.child[e]!==h;++e);l.d+=h.d,l.parent=i,i.child[e]=l}else{for(j=k=0;j<h.child.length;++j)h.child[k]=h.child[j],j!==e&&++k;--h.child.length}return n}function n(a){var b,c,d,e,f;if(0!==a.child.length&&a.parent){for(c=a.parent,b=0;b<c.child.length&&c.child[b]!==a;++b);for(d=b,e=c.child.length-d-1,f=c.child.length,c.child.length+=a.child.length-1,b=0;e>b;++b)c.child[c.child.length-1-b]=c.child[f-1-b];for(b=0;b<a.child.length;++b)a.child[b].parent=c,a.child[b].d>=0&&a.d>=0&&(a.child[b].d+=a.d),c.child[b+d]=a.child[b]}}function p(a){sort_leaf=function(a,b){return a.depth<b.depth?1:a.depth>b.depth?-1:String(a.name)<String(b.name)?-1:String(a.name)>String(b.name)?1:0},sort_weight=function(a,b){return a.weight/a.n_tips-b.weight/b.n_tips};var b,c=new Array,d=g(a);for(d[d.length-1].depth=0,b=d.length-2;b>=0;--b){var e=d[b];e.depth=e.parent.depth+1,0===e.child.length&&c.push(e)}for(c.sort(sort_leaf),b=0;b<c.length;++b)c[b].weight=b,c[b].n_tips=1;for(b=0;b<d.length;++b){var e=d[b];if(e.child.length){var f,h=0,i=0;for(f=0;f<e.child.length;++f)h+=e.child[f].n_tips,i+=e.child[f].weight;e.n_tips=h,e.weight=i}}for(b=0;b<d.length;++b)d[b].child.length>=2&&d[b].child.sort(sort_weight)}function q(a,b){var c,d,e;for(e=a.n_tips-1,c=d=0;c<a.node.length;++c){var f=a.node[c];f.y=f.child.length&&!f.hidden?(f.child[0].y+f.child[f.child.length-1].y)/2:d++/e,0===f.child.length?f.miny=f.maxy=f.y:(f.miny=f.child[0].miny,f.maxy=f.child[f.child.length-1].maxy)}if(b){var g=a.node[a.node.length-1];for(e=g.x=g.d>=0?g.d:0,c=a.node.length-2;c>=0;--c){var f=a.node[c];f.x=f.parent.x+(f.d>=0?f.d:0),f.x>e&&(e=f.x)}0==e&&(b=!1)}if(!b){for(e=a.node[a.node.length-1].x=1,c=a.node.length-2;c>=0;--c){var f=a.node[c];f.x=f.parent.x+1,f.x>e&&(e=f.x)}for(c=0;c<a.node.length-1;++c)0===a.node[c].child.length&&(a.node[c].x=e)}for(c=0;c<a.node.length;++c)a.node[c].x/=e;return b}function r(a,b,c,d){if(b.is_circular)for(var e=0;e<a.node.length;++e){var f=a.node[e],g=Math.floor(b.width/2+f.x*b.real_r*Math.cos(f.y*b.full_arc)+.999),h=Math.floor(b.height/2+f.x*b.real_r*Math.sin(f.y*b.full_arc)+.999),i=2;if(c>=g-i&&g+i>=c&&d>=h-i&&h+i>=d)return e}else for(var e=0;e<a.node.length;++e){var g=a.node[e].x*b.real_x+b.shift_x,h=a.node[e].y*b.real_y+b.shift_y,i=.6*b.box_width;if(c>=g-i&&g+i>=c&&d>=h-i&&h+i>=d)return e}return a.node.length}function s(b,c,d){if(d.is_circular)return void t(b,c,d);var e=b.getContext("2d");e.strokeStyle=e.fillStyle="white",e.fillRect(0,0,d.width,d.height),a.enable(e);var f,g;for(g=0,f=0;g<c.node.length;++g)if(!c.node[g].child.length){var h=e.measureText(d.font,d.fontsize,c.node[g].name);h>f&&(f=h)}var i,j,k,l;for(d.real_x=i=d.width-2*d.xmargin-f,d.real_y=j=d.height-2*d.ymargin-d.fontsize,d.shift_x=k=d.xmargin,d.shift_y=l=d.ymargin+d.fontsize/2,g=c.node.length-1;g>=0;--g)if(c.node[g].box){var m=c.node[g],n=m.x*i+k-d.box_width/2;e.strokeStyle=e.fillStyle=c.node[g].box,e.fillRect(n,m.miny*j+l-d.yskip/2,d.width-d.xmargin-n,(m.maxy-m.miny)*j+d.yskip)}for(e.strokeStyle=d.c_ext,e.fillStyle=d.c_hl,g=0;g<c.node.length;++g){var m=c.node[g];if(0===m.child.length||m.hidden){if(m.hl){var h=e.measureText(d.font,d.fontsize,c.node[g].name);e.fillRect(m.x*i+2*d.xskip+k,m.y*j+l-.8*d.fontsize,h,1.5*d.fontsize)}e.drawText(d.font,d.fontsize,m.x*i+2*d.xskip+k,m.y*j+l+d.fontsize/3,m.name)}}for(e.strokeStyle=d.c_int,g=0;g<c.node.length;++g){var m=c.node[g];if(m.child.length&&m.name.length>0&&!m.hidden){var o=e.measureText(d.font,d.fontsize,m.name);e.drawText(d.font,d.fontsize,m.x*i-d.xskip+k-o,m.y*j+l-d.fontsize/3,m.name)}}if(d.regex&&d.regex.indexOf("(")>=0){var p=new RegExp(d.regex);if(p)for(e.strokeStyle=d.c_regex,g=0;g<c.node.length;++g){var m=c.node[g];if(m.child.length&&m.meta){var q=p.exec(m.meta);if(q.length>1){var o=e.measureText(d.font,d.fontsize,q[1]);e.drawText(d.font,d.fontsize,m.x*i-d.xskip+k-o,m.y*j+l+1.33*d.fontsize,q[1])}}}}var r;for(e.strokeStyle=d.c_line,e.beginPath(),r=c.node[c.node.length-1].y*j+l,e.moveTo(k,r),e.lineTo(c.node[c.node.length-1].x*i+k,r),g=0;g<c.node.length-1;++g){var m=c.node[g];r=m.y*j+l,e.moveTo(m.parent.x*i+k,r),e.lineTo(m.x*i+k,r)}var n;for(g=0;g<c.node.length;++g){var m=c.node[g];0===m.child.length||m.hidden||(n=m.x*i+k,e.moveTo(n,m.child[0].y*j+l),e.lineTo(n,m.child[m.child.length-1].y*j+l))}for(e.stroke(),e.closePath(),g=0;g<c.node.length;++g){var s,u,v,m=c.node[g];s=m.x*i+k,u=m.y*j+l,v=d.box_width/2,m.hidden?e.fillStyle=d.c_hidden:d.show_dup&&/:D=Y/i.test(m.meta)?e.fillStyle=d.c_dup:e.fillStyle=d.c_node,e.fillRect(s-v,u-v,d.box_width,d.box_width)}}function t(b,c,d){var e=b.getContext("2d");e.strokeStyle=e.fillStyle="white",e.fillRect(0,0,d.width,d.height),a.enable(e);var f,g,h;for(h=0,f=g=0;h<c.node.length;++h)if(!c.node[h].child.length){var i=e.measureText(d.font,d.fontsize,c.node[h].name);i>f&&(f=i)}var j,k,l=2*Math.PI*(350/360);for(k=(d.width/2-d.xmargin-1*c.n_tips/l)/(f/d.fontsize+c.n_tips/l),k>d.fontsize&&(k=d.fontsize),f*=k/d.fontsize,d.real_r=j=d.width/2-d.xmargin-f,d.full_arc=l,e.save(),e.translate(d.width/2,d.height/2),h=c.node.length-1;h>=0;--h)if(c.node[h].box){var m,n,o=c.node[h],p=(o.parent?(o.parent.x+o.x)/2:0)*j;e.strokeStyle=e.fillStyle=c.node[h].box,e.beginPath(),m=o.miny-1/c.n_tips/2,n=o.maxy+1/c.n_tips/2,e.moveTo(p*Math.cos(m*l),p*Math.sin(m*l)),e.arc(0,0,p,m*l,n*l,!1),e.lineTo(p*Math.cos(n*l),p*Math.sin(n*l)),e.arc(0,0,j,n*l,m*l,!0),e.closePath(),e.fill()}for(e.strokeStyle=d.c_ext,e.fillStyle=d.c_hl,h=0;h<c.node.length;++h){var o=c.node[h];if(!o.child.length){e.save();var i;o.hl&&(i=e.measureText(d.font,k,c.node[h].name)),o.y*l>.5*Math.PI&&o.y*l<1.5*Math.PI?(e.rotate(o.y*l-Math.PI),o.hl&&e.fillRect(-(j+k/2),.8*-k,-i,1.5*k),e.drawTextRight(d.font,k,-(j+k/2),k/3,o.name)):(e.rotate(o.y*l),o.hl&&e.fillRect(j+k/2,.8*-k,i,1.5*k),e.drawText(d.font,k,j+k/2,k/3,o.name)),e.restore()}}e.strokeStyle="black",e.beginPath();var q=c.node[c.node.length-1];for(e.moveTo(0,0),e.lineTo(q.x*j*Math.cos(q.y*l),q.x*j*Math.sin(q.y*l)),h=0;h<c.node.length-1;++h){var o=c.node[h],r=Math.cos(o.y*l),s=Math.sin(o.y*l);e.moveTo(o.parent.x*j*r,o.parent.x*j*s),e.lineTo(o.x*j*r,o.x*j*s)}for(e.stroke(),e.closePath(),e.strokeStyle="lightgray",e.beginPath(),h=0;h<c.node.length-1;++h){var o=c.node[h];if(!o.child.length){var r=Math.cos(o.y*l),s=Math.sin(o.y*l);e.moveTo(o.x*j*r,o.x*j*s),e.lineTo(j*r,j*s)}}for(e.stroke(),e.closePath(),e.strokeStyle="black",e.beginPath(),h=0;h<c.node.length;++h){var o=c.node[h];if(0!==o.child.length&&!o.hidden){var t=o.x*j;e.moveTo(t*Math.cos(o.child[0].y*l),t*Math.sin(o.child[0].y*l)),e.arc(0,0,t,o.child[0].y*l,o.child[o.child.length-1].y*l,!1)}}e.stroke(),e.closePath(),e.restore()}function u(a,b,c){var d=e(b);return d.error?d:(c.is_real=q(d,c.is_real),c.height=c.is_circular?c.width:2*c.ymargin+d.n_tips*c.yskip,a.width=c.width,a.height=c.height,s(a,d,c),d)}function v(a,b,c,d){function k(b,c){if(null!==b.active_node&&b.active_node<b.node.length){var d=b.node[b.active_node];b.active_node=null;var e=a.getContext("2d");e.fillStyle=c.show_dup&&/:D=Y/i.test(d.meta)?c.c_dup:c.c_node,e.fillRect(d.x*c.real_x+c.shift_x-c.box_width/2,d.y*c.real_y+c.shift_y-c.box_width/2,c.box_width,c.box_width)}}var t,v=this;this.set_id=function(a){t=a},this.plot=function(b){var e=(new Date).getTime();if(b){var f=u(a,b,c);1&f.error?alert("Parsing ERROR: missing left parenthesis!"):2&f.error?alert("Parsing ERROR: missing right parenthesis!"):4&f.error&&alert("Parsing ERROR: missing brackets!"),d=f}else s(a,d,c);c.runtime=((new Date).getTime()-e)/1e3},this.plot_str=function(){this.plot(b.value)},this.undo_redo=function(){var f=c.old_nh;c.old_nh=b.value,b.value=f,d=e(b.value),c.is_real=q(d,c.is_real),s(a,d,c)};var w=function(a,c){a.old_nh=b.value,b.value=c};return this.get=function(a,b){var e=r(d,c,a,b);return e>=0&&e<d.node.length?e:-1},this.swap=function(){var b=d,e=c,h=t;if(h<b.node.length&&b.node[h].child.length){var i=b.node[h],k=i.child[0];for(j=0;j<i.child.length-1;++j)i.child[j]=i.child[j+1];i.child[i.child.length-1]=k,b.node=g(b.node[b.node.length-1]),e.is_real=q(b,e.is_real),d=b,c=e,s(a,b,e),w(e,f(b))}},this.sort=function(){var b=d,e=c,h=t;h<b.node.length&&b.node[h].child.length&&(p(b.node[h]),b.node=g(b.node[b.node.length-1]),e.is_real=q(b,e.is_real),d=b,c=e,s(a,b,e),w(e,f(b)))},this.reroot=function(){var b=d,e=c,h=t;if(h<b.node.length){var i=m(b.node[b.node.length-1],b.node[h],-1);b.node=g(i),d=b,e.is_real=q(b,e.is_real),s(a,b,e),w(e,f(b))}},this.collapse=function(){var b=d,e=c,f=t;if(f<b.node.length&&b.node[f].child.length){b.node[f].hidden=!b.node[f].hidden;b.node.length;b.node=g(b.node[b.node.length-1]),h(b),e.is_real=q(b,e.is_real),d=b,c=e,s(a,b,e)}},this.remove=function(){var b=d,e=c,j=t;if(j<b.node.length){var k=i(b,b.node[j]);b.node=g(k),h(b),d=b,e.is_real=q(b,e.is_real),s(a,b,e),w(e,f(b))}},this.multifurcate=function(){var b=d,e=c,h=t;h<b.node.length&&b.node[h].child.length&&(n(b.node[h]),b.node=g(b.node[b.node.length-1]),e.is_real=q(b,e.is_real),d=b,c=e,s(a,b,e),w(e,f(b)))},this.move=function(){var b=d,e=c,h=t;if(h<b.node.length)if(null!==b.active_node&&b.active_node<b.node.length){if(b.node[b.active_node].parent===b.node[h])alert("Error: cannot move a child to its parent!");else{var i=l(b,b.node[b.active_node],b.node[h]);i?(b.node=g(i),d=b,e.is_real=q(b,e.is_real),s(a,b,e),w(e,f(b))):alert("Error: Invalid move!")}k(b,e)}else{b.active_node=h;var j=b.node[h],m=e.box_width-2,n=v.canvas.getContext("2d");n.fillStyle=e.c_active_node,n.fillRect(j.x*e.real_x+e.shift_x-m/2,j.y*e.real_y+e.shift_y-m/2,m,m)}else k(b,e)},this.highlight=function(e){var f=d,g=c,h=t,i={white:"#FFFFFF",red:"#FFD8D0",green:"#D8FFC0",blue:"#C0D8FF",yellow:"#FFFFC8",pink:"#FFD8FF",cyan:"#D8FFFF",none:"none"};if(i[e]&&(e=i[e]),h<f.node.length){var j=((new Date).getTime(),e);"none"===j&&(j=null),j!==f.node[h].box&&(f.node[h].box=j,d=f,c=g,s(a,f,g));var k,l;if(o=b,0===f.node[h].child.length)k=o.value.indexOf(f.node[h].name),l=k+f.node[h].name.length;else{var m,n,p=o.value;for(m=f.node[h],n=0;m.child.length;)++n,m=m.child[0];for(k=p.indexOf(m.name),--k;k>=0&&("("===p.charAt(k)&&--n,0!==n);--k);var q,r;for(q=f.node[h],r=0;q.child.length;)++r,q=q.child[q.child.length-1];for(l=p.indexOf(q.name)+q.name.length;l<p.length&&(")"===p.charAt(l)&&--r,0!==r);++l);++l}if(o.setSelectionRange){var u,v,w=o.clientHeight/o.rows,p=o.value.substr(0,k);for(u=v=0;k>u&&u<p.length;++u)"\n"===p.charAt(u)&&++v;o.scrollTop=v*w,o.setSelectionRange(k,l)}else{var u,v,x=o.createTextRange(),p=o.value.substr(0,l);for(u=v=0;k>u;++u)"\n"===p.charAt(u)&&++v;for(k-=v;l>u;++u)"\n"===p.charAt(u)&&++v;l-=v,x.collapse(!0),x.moveEnd("character",l),x.moveStart("character",k),x.select()}}},this}var w=function(a,c,d,e){function f(a){if(a.layerX||0===a.layerX?(a._x=a.layerX,a._y=a.layerY):(a.offsetX||0===a.offsetX)&&(a._x=a.offsetX,a._y=a.offsetY),"Microsoft Internet Explorer"===navigator.appName){var c=document.body,d=document.getElementById("canvasContainer");a._x=a.clientX-(d.offsetLeft-c.scrollLeft)-3,a._y=a.clientY-(d.offsetTop-c.scrollTop)-3}if(e){var f=i.get(a._x,a._y);console.log(f),f>=0&&(i.set_id(f),null===e.active_node?(console.log("i want to pop"),b.show(a,j,"98px",function(a){console.log("clicked!")})):i.move())}}var g=document.getElementById(a),h=document.getElementById(c),i=new v(g,h,d,e),j='<h4>Actions</h4><div id="knhx_action_menu_'+a+'"><a href="javascript:void(0);" xonClick="kn_actions.swap();">Swap</a><br><a href="javascript:void(0);" xonClick="kn_actions.sort();">Ladderize</a><br><a href="javascript:void(0);" xonClick="kn_actions.collapse();">Collapse</a><br><a href="javascript:void(0);" xonClick="kn_actions.reroot();">Reroot</a><br><a href="javascript:void(0);" xonClick="kn_actions.move();">Move</a><br><a href="javascript:void(0);" xonClick="kn_actions.multifurcate();">Multifurcate</a><br><a href="javascript:void(0);" xonClick="kn_actions.remove();">Remove</a><br><a href="javascript:void(0);" xonClick="kn_actions.highlight(\'none\');" class="alt">&nbsp;</a><a href="javascript:void(0);" xclass="alt" xonClick="kn_actions.highlight(\'red\');" style="background-color:#FFD8D0;">&nbsp;</a><a href="javascript:void(0);" class="alt" xonClick="kn_actions.highlight(\'green\');" style="background-color:#D0FFC0;">&nbsp;</a><a href="javascript:void(0);" xonClick="kn_actions.highlight(\'blue\');" class="alt" style="background-color:#C0D8FF;">&nbsp;</a><a href="javascript:void(0);" xonClick="kn_actions.highlight(\'yellow\');" class="alt" style="background-color:#FFFFC8;">&nbsp;</a><a href="javascript:void(0);" xonClick="kn_actions.highlight(\'cyan\');" class="alt" style="background-color:#D8FFFF;">&nbsp;</a></div>';return g.addEventListener?g.addEventListener("click",f,!1):g.attachEvent("onclick",f),this};return{kn_parse:e,kn_plot_core:s,kn_count_tips:h,kn_calxy:q,kn_get_node:r,knhx_init:w}});