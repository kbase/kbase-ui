define(["jquery","underscore","bluebird","kb.runtime","kb.html","kb.service.workspace","kb.utils.api","kb_types"],function(a,b,c,d,e,f,g,h){"use strict";function i(a,b){var c=h.getViewer({type:a});if(c&&b.sub&&b.subid){if(!c.sub)throw new Error("Sub was specified, but config has no sub handler, sub:"+b.sub);if(!c.sub.hasOwnProperty(b.sub))throw new Error("Sub was specified, but config has no correct sub handler, sub:"+b.sub+"config:");c=c.sub[b.sub]}return c}function j(a){return a.objectVersion=a.ver,a.workspaceURL=d.getConfig("services.workspace.url"),a.authToken=d.getAuthToken(),new c(function(b,c){var e=new f(d.getConfig("services.workspace.url"),{token:d.getAuthToken()});e.getObject(a.workspaceId,a.objectId).then(function(d){var e=g.parseTypeId(d.type),f=i(e,a);if(!f)return void c("Not Found","Sorry, cannot find widget for "+e.module+"."+e.name);a.objectName=d.name,a.workspaceName=d.ws,a.objectVersion=d.version,a.objectType=d.type;var h={};f.options?f.options.forEach(function(b){var c=a[b.from];if(!c&&b.optional!==!0)throw"Missing param, from "+b.from+", to "+b.to;h[b.to]=c}):h=a;var e=f.type||"kbwidget";switch(e){case"kbwidget":var j=KBWidgetAdapter.make({module:f.module,jquery_object:f.jquery_object});b(j);break;default:c("Invalid type "+e+" in widget mapping")}})["catch"](function(a){c(a)})})}function k(b,c){var d=e.genId(),f=e.tag("div"),g=e.tag("span");return b.html(f({"class":"panel panel-default "},[f({"class":"panel-heading"},[g({"class":"panel-title"},c)]),f({"class":"panel-body"},[f({id:d})])])),a("#"+d)}function l(e){function f(){return new c(function(a){require([r],function(){a()})})}function g(b){return new c(function(c,d){o=b,p=document.createElement("div"),o.appendChild(p),q=t?k(a(p),u):a(p),void 0===q[s]?d("Sorry, cannot find jquery widget "+s):c()})}function h(f){return new c(function(c){j(f).then(function(a){});var g=(e.module,e.jquery_object),h=(e.panel,e.title,b.extendOwn({},f,{wsNameOrId:f.workspaceId,objNameOrId:f.objectId,ws_url:d.getConfig("services.workspace.url"),token:d.getAuthToken()}));a(p)[g](h),c()})}function i(a){return new c(function(a){a()})}function l(){return new c(function(a){a()})}function m(){return new c(function(a){a()})}function n(){return new c(function(a){a()})}var o,p,q,r=e.module,s=e.jquery_object,t=e.panel,u=e.title;return{init:f,attach:g,start:h,run:i,stop:l,detach:m,destroy:n}}return{make:function(a){return l(a)}}});