define(["jquery","kb/common/html","kb/service/client/cdmi","kb/service/client/cdmiEntity","kb/service/client/workspace","kb/widget/legacy/widget"],function(a,b,c,d,e){"use strict";a.KBWidget({name:"KBaseGenomeOverview",parent:"kbaseWidget",version:"1.0.0",options:{genomeID:null,workspaceID:null,isInCard:!1,genomeInfo:null},$infoTable:null,noContigs:"No Contigs",init:function(b){return this._super(b),this.$messagePane=a("<div/>").hide(),this.$elem.append(this.$messagePane),this.render(),null===this.options.workspaceID?this.renderCentralStore():this.renderWorkspace(),this},render:function(){this.$infoPanel=a("<div>"),this.$infoTable=a("<table>").addClass("table table-striped table-bordered"),this.$infoPanel.append(a("<div>").css("overflow","auto").append(this.$infoTable)),this.$contigSelect=a("<select>").addClass("form-control").css({width:"60%","margin-right":"5px"}).append(a("<option>").attr("id",this.noContigs).append(this.noContigs)),this.$infoPanel.hide(),this.$elem.append(this.$infoPanel)},addInfoRow:function(a,b){return"<tr><th>"+a+"</th><td>"+b+"</td></tr>"},renderCentralStore:function(){this.cdmiClient=new c(this.runtime.getConfig("services.cdmi.url")),this.entityClient=new d(this.runtime.getConfig("services.cdmi.url")),this.$infoPanel.hide(),this.showMessage(b.loading("loading..."));var e=this;this.entityClient.get_entity_Genome([this.options.genomeID],["id","scientific_name","domain","complete","dna_size","source_id","contigs","gc_content","pegs","rnas"],a.proxy(function(b){return b=b[this.options.genomeID],this.genome=b,b?(e.pubmedQuery=b.scientific_name,this.$infoTable.empty().append(this.addInfoRow("ID",b.id)).append(this.addInfoRow("Name",b.scientific_name)).append(this.addInfoRow("Domain",b.domain)).append(this.addInfoRow("DNA Length",b.dna_size)).append(this.addInfoRow("Source ID",b.source_id)).append(this.addInfoRow("Number of Contigs",b.contigs)).append(this.addInfoRow("GC Content",Number(b.gc_content).toFixed(2)+" %")).append(this.addInfoRow("Protein Encoding Genes",b.pegs)).append(this.addInfoRow("RNAs",b.rnas)),this.options.isInCard&&this.cdmiClient.genomes_to_contigs([this.options.genomeID],a.proxy(function(b){this.cdmiClient.contigs_to_lengths(b[this.options.genomeID],a.proxy(function(a){this.populateContigSelector(a)},this),this.renderError)},this),this.renderError),this.hideMessage(),void this.$infoPanel.show()):void this.renderError("Genome '"+this.options.genomeID+"' not found in the KBase Central Store.")},this),this.renderError)},populateContigSelector:function(b){this.$contigSelect.empty(),b&&0!==b.length||this.$contigSelect.append(a("<option>").attr("id",this.noContigs).append(this.noContigs));for(var c in b)this.$contigSelect.append(a("<option>").attr("id",c).append(c+" - "+b[c]+" bp"))},alreadyRenderedTable:!1,renderWorkspace:function(){var a=this;if(this.showMessage(b.loading("loading...")),this.$infoPanel.hide(),a.options.genomeInfo)a.showData(a.options.genomeInfo.data);else{var c=this.buildObjectIdentity(this.options.workspaceID,this.options.genomeID),d=new e(this.runtime.getConfig("services.workspace.url"),{token:this.runtime.service("session").getAuthToken()});d.get_objects([c]).then(function(b){a.showData(b[0].data)})["catch"](function(b){a.renderError(b)})}},showData:function(a){var b=this;b.pubmedQuery=a.scientific_name;var c=function(a){return"number"==typeof a&&a%1===0},d="Unknown",e="Unknown";a.dna_size&&0!==a.dna_size?(e=a.dna_size,a.gc_content&&(d=Number(a.gc_content),c(d)?e&&(d=(d/e*100).toFixed(2)+" %"):d=Number(100*d).toFixed(2)+" %")):Number(a.gc_content)<1&&(d=Number(100*a.gc_content).toFixed(2)+" %");var f=0;a.features&&(f=a.features.length),this.$infoTable.empty().append(this.addInfoRow("Name",a.scientific_name)).append(this.addInfoRow("KBase Genome ID",a.id)).append(this.addInfoRow("Domain",a.domain)).append(this.addInfoRow("DNA Length",e)).append(this.addInfoRow("Source ID",a.source+": "+a.source_id)).append(this.addInfoRow("Number of Contigs",a.contig_ids?a.contig_ids.length:0)).append(this.addInfoRow("GC Content",d)).append(this.addInfoRow("Genetic Code",a.genetic_code)).append(this.addInfoRow("Number of features",f)),b.alreadyRenderedTable=!0;var g={};if(a.contig_ids&&a.contig_ids.length>0)for(var h=0;h<a.contig_ids.length;h++){var i="Unknown";a.contig_lengths&&a.contig_lengths[h]&&(i=a.contig_lengths[h]),g[a.contig_ids[h]]=i}else if(a.features&&a.features.length>0)for(var h=0;h<a.features.length;h++){var j=a.features[h];j.location&&j.location[0][0]&&(g[j.location[0][0]]="Unknown")}this.hideMessage(),this.$infoPanel.show()},getData:function(){return{type:"Genome",id:this.options.genomeID,workspace:this.options.workspaceID,title:"Genome Overview"}},showMessage:function(b){var c=a("<span/>").append(b);this.$messagePane.empty().append(c).show()},hideMessage:function(){this.$messagePane.hide()},buildObjectIdentity:function(a,b){var c={};return/^\d+$/.exec(a)?c.wsid=a:c.workspace=a,/^\d+$/.exec(b)?c.objid=b:c.name=b,c},renderError:function(b){errString="Sorry, an unknown error occurred","string"==typeof b?errString=b:b.error&&b.error.message&&(errString=b.error.message);var c=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+errString);this.$elem.empty(),this.$elem.append(c)}})});