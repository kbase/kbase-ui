!function(a,b){a.KBWidget({name:"KBaseGeneDomains",parent:"kbaseWidget",version:"1.0.1",options:{featureID:null,embedInCard:!1,auth:null,loadingImage:"assets/img/loading.gif",genomeID:null,workspaceID:null,kbCache:null,maxDescriptionLength:100},init:function(a){return this._super(a),this.wsClient=this.options.kbCache.ws,this.render(),this},render:function(){var b=this;b.$elem.append(a('<div id="mainview">').css("overflow","auto"));var c=b.$elem.find("#mainview");c.append('<table cellpadding="0" cellspacing="0" border="0" id="ref-table"                             class="table table-bordered table-striped" style="width: 100%; margin-left: 0px; margin-right: 0px;"/>'),this.processDomainAnnotationObjects()},processDomainAnnotationObjects:function(){var b=this,c=b.buildObjectIdentity(b.options.workspaceID,b.options.genomeID);b.wsClient.list_referencing_objects([c],function(c){for(var d={},e=c[0],f=0;f<e.length;f++){var g=e[f][2];if(/.DomainAnnotation-/.exec(g)){var h=e[f][6],i=e[f][0],j=(e[f][4],h+"/"+i);d[j]=e[f]}}a.isEmptyObject(d)||b.processContigIndexElements(d)})},processContigIndexElements:function(a){var c=this,d=[],e={};for(var f in a)d.push({ref:f,included:["/feature_to_contig_and_index/"+c.options.featureID,"/used_dms_ref"]});var g=[];c.wsClient.get_object_subset(d,function(a){for(var d=0;d<a.length;d++){var f=a[d].data.feature_to_contig_and_index,h=a[d].info[6],i=a[d].info[0],j=(a[d].info[4],a[d].data.used_dms_ref);j!=b&&(e[j]=j);for(var k in f)g.push({annObjectRef:h+"/"+i,contigId:f[k][0],geneIndex:f[k][1]})}g.length>0&&c.processDomainAnnotations(g,e)})},processDomainAnnotations:function(a,c){for(var d=this,e=[],f=0;f<a.length;f++){var g=a[f];e.push({ref:g.annObjectRef,included:["/data/"+g.contigId+"/"+g.geneIndex]})}var h={},i=[];d.wsClient.get_object_subset(e,function(a){for(var e=0;e<a.length;e++){var f=a[e].info[6],g=a[e].info[0],j=a[e].info[4];for(var k in a[e].data.data)for(var l=a[e].data.data[k],m=0;m<l.length;m++){var n=l[m][0],o=l[m][1],p=l[m][2],q=l[m][4];for(var r in q)for(var s=q[r],t=0;t<s.length;t++){var u=s[t][0],v=s[t][1],w=s[t][2],x=r+"_"+u+"_"+v;if(h[x]==b){h[x]="";var y=100*(v-u)/(p-o),z=100*u/(p-o);i.push({wsId:f,objId:g,objVer:j,objRef:f+"/"+g+"/"+j,contigId:k,geneId:n,geneStart:o,geneEnd:p,domainId:r,domainDescription:"",domainStart:u,domainEnd:v,eValue:w,image:'<div style="position:relative; border: 1px solid gray; width:100%; height:2px;"><div style="position:relative; left: '+z+"%; width:"+y+'%; top: -5px; height:10px; background-color:red;"/></div>'})}}}}i.length>0&&d.processDomainDescirptions(i,c)})},processDomainDescirptions:function(a,c){for(var d=this,e={},f=0;f<a.length;f++)e[a[f].domainId]="";var g=[];for(var h in c){var i=[];for(var j in e)i.push("/domain_accession_to_description/"+j);g.push({ref:h,included:i})}var k={},l={};d.wsClient.get_object_subset(g,function(c){for(var e=0;e<c.length;e++){var f=c[e].data.domain_accession_to_description;if(f!=b)for(var g in f)k[g]=f[g],l[g]=f[g],l[g].length>d.options.maxDescriptionLength&&(l[g]=l[g].substring(0,d.options.maxDescriptionLength)+"&#8230;")}for(var e=0;e<a.length;e++){var h=l[a[e].domainId];h!=b&&(a[e].domainDescription=h,a[e].shortDomainDescription=h,a[e].longDomainDescription=k[a[e].domainId])}a.length>0&&d.bindDomainData(a)})},bindDomainData:function(c){var d=this,e="t<fip>";c.length<=10&&(e="tfi");var f={iDisplayLength:10,sDom:e,aoColumns:[{sTitle:"Domain",mData:"domainId"},{sTitle:"Description",mData:"domainDescription",sWidth:"30%"},{sTitle:"Location",mData:"image"},{sTitle:"Start",mData:"domainStart"},{sTitle:"End",mData:"domainEnd"},{sTitle:"eValue",mData:"eValue"},{sTitle:"DomainAnnotation object",mData:"objRef"}],aaData:c},g=d.$elem.find("#ref-table").dataTable(f),h=[];a("#ref-table tbody td").click(function(a){var d=g.fnGetPosition(a.target)[0];h[d]==b&&(h[d]=0),h[d]=1-h[d],1==h[d]?g.fnUpdate(c[d].longDomainDescription,d,1):g.fnUpdate(c[d].shortDomainDescription,d,1)})},buildObjectIdentity:function(a,b){var c={};return/^\d+$/.exec(a)?c.wsid=a:c.workspace=a,/^\d+$/.exec(b)?c.objid=b:c.name=b,c},getData:function(){return{type:"Feature",id:this.options.featureID,workspace:this.options.workspaceID,title:"Gene Domains"}},showMessage:function(b){var c=a("<span/>").append(b);this.$messagePane.empty().append(c).removeClass("kbwidget-hide-message")},hideMessage:function(){this.$messagePane.addClass("kbwidget-hide-message")},renderError:function(b){errString="Sorry, an unknown error occurred","string"==typeof b?errString=b:b.error&&b.error.message&&(errString=b.error.message);var c=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+errString);this.$elem.empty(),this.$elem.append(c)}})}(jQuery);