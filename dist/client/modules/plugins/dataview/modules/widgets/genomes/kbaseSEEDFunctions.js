define(["jquery","d3","kb/service/client/workspace","kb_plugin_dataview","kb/widget/legacy/widget"],function(a,b,c,d){"use strict";a.KBWidget({name:"KBaseSEEDFunctions",parent:"kbaseAuthenticatedWidget",version:"1.0.0",options:{objNameOrId:null,wsNameOrId:null,objVer:null,width:900,genomeInfo:null},SEEDTree:{},subsysToGeneMap:[],maxCount:0,margin:{top:30,right:20,bottom:30,left:20},width:920,barHeight:20,barWidth:400,stepSize:8,svg:null,i:0,duration:400,root:null,tree:null,objName:"",wsName:"",init:function(a){return this._super(a),this.SEEDTree={name:"Functional Categories",count:0,children:[],size:0,x0:0,y0:0},this.subsysToGeneMap=[],this.maxCount=0,this.runtime.service("session").isLoggedIn()||this.render(),this},loadSEEDHierarchy:function(){var c=this,e=4,f={},g=c.SEEDTree,h=c.subsysToGeneMap,i=[];b.text(d.plugin.path+"/data/subsys.txt",function(d){var j,k,l,m,n,o,p,q=b.tsv.parseRows(d),r=0;for(j=0;j<q.length;j+=1)for(l=0,m="",n="Functional Categories",void 0===h[q[j][3]]||(l=h[q[j][3]].length,r+=h[q[j][3]].length),k=0;e>k;k+=1)q[j][k]=""===q[j][k]?"--- "+q[j][k-1]+" ---":q[j][k],m=n+":"+q[j][k],0===k?(void 0===f[m]&&(o={name:q[j][k],size:0,children:[]},g.children.push(o),f[m]=o,i[q[j][k]]=0),i[q[j][k]]+=l):void 0===f[m]&&(o={name:q[j][k],size:0,children:[]},f[n].children.push(o),f[m]=o,k===e-1&&void 0!==h[q[j][k]]&&h[q[j][k]].forEach(function(a){p={name:a,size:""},o.children.push(p)})),f[m].size+=l,n=m;if(100>r)c.$elem.find("#mainview").prepend("<b>No Functional Categories assigned, you can add them using the Narrative.</b>");else{var s;for(s in i)c.maxCount=c.maxCount>i[s]?c.maxCount:i[s];a.when(c.SEEDTree.children.forEach(function(a){c.collapse(a)})).done(c.update(c.root=c.SEEDTree))}})},update:function(c){var d=this,e=d.tree.nodes(d.SEEDTree),f=b.scale.linear().domain([0,this.maxCount]).range([0,275]),g=Math.max(500,e.length*d.barHeight+d.margin.top+d.margin.bottom);d.i;b.selectAll("#mainview").select("svg").transition().duration(d.duration).attr("height",g),b.select(d.frameElement).transition().duration(d.duration).style("height",g+"px"),e.forEach(function(a,b){a.x=b*d.barHeight});var h=d.svg.selectAll("g.KBSnode").data(e,function(a){return a.id||(a.id=++d.i)}),i=h.enter().append("g").attr("class","KBSnode").attr("transform",function(a){return"translate("+c.y0+","+c.x0+")"}).style("opacity",1e-6).on("mouseover",function(a){b.select(this).selectAll("text, rect").style("font-weight","bold").style("font-size","90%").style("stroke-width","3px")}).on("mouseout",function(a){b.select(this).selectAll("text, rect").style("font-weight","normal").style("font-size","80%").style("stroke-width","1.5px")});i.append("rect").attr("y",-d.barHeight/2).attr("x",300).attr("height",d.barHeight).attr("width",d.barWidth).style("fill",d.color).on("click",a.proxy(function(a){d.click(a)},d)),i.append("text").attr("dy",3.5).attr("dx",305.5).text(function(a){return a.name}),i.append("rect").attr("y",-d.barHeight/2).attr("x",function(a){return 275-f(a.size)-a.depth*d.stepSize}).attr("height",d.barHeight).attr("width",function(a){return f(a.size)}).style("fill",d.color).on("click",a.proxy(function(a){d.click(a)},d)),i.append("text").attr("dy",3.5).attr("x",278).text(function(a){return"Functional Categories"===a.name?"":a.size}),i.transition().duration(d.duration).attr("transform",function(a){return"translate("+a.y+","+a.x+")"}).style("opacity",1),h.transition().duration(d.duration).attr("transform",function(a){return"translate("+a.y+","+a.x+")"}).style("opacity",1).select("rect").style("fill",d.color),h.exit().transition().duration(d.duration).attr("transform",function(a){return"translate("+c.y+","+c.x+")"}).style("opacity",1e-6).remove(),e.forEach(function(a){a.x0=a.x,a.y0=a.y})},click:function(a){(void 0===a.children||null===a._children&&null===a.children)&&window.open("#genes/"+this.options.wsNameOrId+"/"+this.options.objNameOrId+"/"+a.name),a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null),this.update(a)},color:function(a){return a._children?"#c6dbef":a.children?"#3399ff":"#ffffff"},collapse:function(a){var b=this;a.children&&(a._children=a.children,a._children.forEach(function(a){b.collapse(a)}),a.children=null)},getData:function(){return{title:"Functional Categories ",id:this.options.objNameOrId,workspace:this.options.wsNameOrId}},render:function(){var b=this;if(b.options.genomeInfo)return void b.showData(b.options.genomeInfo.data);var c,d={ref:this.options.wsNameOrId+"/"+this.options.objNameOrId};c=this.options.kbCache?this.options.kbCache.req("ws","get_objects",[d]):this.wsClient.get_objects([d]),a.when(c).fail(a.proxy(function(a){console.log(a)},this)),a.when(c).done(a.proxy(function(a){b.showData(a[0].data)},this))},showData:function(c){var d=this.margin,e=this.width,f=this.$elem,g=this.SEEDTree,h=this.subsysToGeneMap;f.empty();var i=c.domain;if("Eukaryota"===i)return f.prepend("<b>Functional Categories not yet available for "+i+"</b>"),this;this.tree=b.layout.tree().nodeSize([0,this.stepSize]);var j=a('<div id="mainview">').css({"overflow-x":"scroll"});f.append(j),this.svg=b.select(j[0]).append("svg").attr("width",e+d.left+d.right).append("g").attr("transform","translate("+d.left+","+d.top+")"),c.features.forEach(function(a){void 0===h[a["function"]]&&(h[a["function"]]=[]),h[a["function"]].push(a.id),g.count+=1}),this.loadSEEDHierarchy()},loggedInCallback:function(a,b){return this.authToken=b,this.wsClient=new c(this.runtime.getConfig("services.workspace.url"),{token:this.runtime.service("session").getAuthToken()}),this.render(),this},loggedOutCallback:function(a,b){return this.authToken=null,this.wsClient=null,this}})});