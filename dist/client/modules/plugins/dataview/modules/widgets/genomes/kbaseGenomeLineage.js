define(["jquery","kb/common/html","kb/service/client/cdmi","kb/service/client/cdmiEntity","kb/service/client/workspace","kb/service/client/trees","kb/widget/legacy/authenticatedWidget"],function(a,b,c,d,e,f){"use strict";a.KBWidget({name:"KBaseGenomeLineage",parent:"kbaseAuthenticatedWidget",version:"1.0.0",options:{genomeID:null,workspaceID:null,objVer:null,width:600,genomeInfo:null},token:null,$infoTable:null,pref:null,init:function(b){return this._super(b),null!==this.options.genomeID?(this.pref=this.uuid(),this.$messagePane=a("<div/>").hide(),this.$elem.append(this.$messagePane),this.render(),null===this.options.workspaceID?this.renderCentralStore():this.renderWorkspace(),this):void 0},render:function(){this.$infoPanel=a("<div>"),this.$infoTable=a("<table>").addClass("table table-striped table-bordered"),this.$infoPanel.append(a("<div>").append(this.$infoTable)),this.$infoPanel.hide(),this.$elem.append(this.$infoPanel)},renderCentralStore:function(){var e=this;this.cdmiClient=new c(this.runtime.config("services.cdmi.url")),this.entityClient=new d(this.runtime.config("services.cdmi.url")),this.$infoPanel.hide(),this.showMessage(b.loading("loading...")),this.entityClient.get_entity_Genome([this.options.genomeID],["id","scientific_name","domain","taxonomy"],a.proxy(function(a){a=a[0].data,e.showData(a)},this),this.renderError)},renderWorkspace:function(){var a=this;if(this.showMessage(b.loading("loading...")),this.$infoPanel.hide(),a.options.genomeInfo)a.showData(a.options.genomeInfo.data);else{var c=this.getObjectIdentity(this.options.workspaceID,this.options.genomeID);c.included=["/taxonomy","/scientific_name"];var d=new e(this.runtime.config("services.workspace.url"),{token:this.runtime.service("session").getAuthToken()});d.get_object_subset([c],function(b){if(b[0]){var c=b[0].data;a.showData(c)}},function(b){var c=a.buildObjectIdentity(a.options.workspaceID,a.options.genomeID);c.included=["/scientific_name"],d.get_object_subset([c],function(b){if(b[0]){var c=b[0].data;a.showData(c)}},function(b){a.renderError(b)})})}},showData:function(a){var b=this;this.$infoTable.empty().append(this.addInfoRow("Name",a.scientific_name)).append('<tr><th>Taxonomic Lineage</th><td id="tax_td_'+this.pref+'"/></tr>'),b.hideMessage(),this.$infoPanel.show(),this.showLinage(a.taxonomy)},showLinage:function(b){var c=this,d="",e=null!==this.options.workspaceID;if(b){var f=b.replace("/ /g","");f=f.split(";"),f.length>=2&&(e=!1),d+="<pre>";var g,h,i,j,k;for(g=0;g<f.length;g+=1){for(i="",h=0;g>h;h+=1)i+=" ";j=f[g].replace("/ /g","+"),k=i+'<a href="http://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?name='+j+'" target="_blank">'+f[g]+"</a><br>",d+=k}d+="</pre>"}else d+="No taxonomic data for this genome.";e&&(d+='<button id="guess_btn_'+this.pref+'">Search by similarity</button>');var l=a("#tax_td_"+c.pref);l.html(d),e&&a("#guess_btn_"+this.pref).click(function(){c.guessLinage()})},guessLinage:function(){var c=this,d=a("#tax_td_"+c.pref);d.html(b.loading("loading..."));var e=new f(this.runtime.config("services.trees.url"),{token:this.runtime.service("session").getAuthToken()}),g=this.options.workspaceID+"/"+this.options.genomeID;e.guess_taxonomy_path({query_genome:g},function(a){c.showLinage(a)},function(a){d.html("Error accessing [trees] service: "+a.error.message)})},getData:function(){return{title:"Taxonomic lineage for :",id:this.options.genomeID,workspace:this.options.workspaceID}},getObjectIdentity:function(a,b,c){return c?{ref:a+"/"+b+"/"+c}:{ref:a+"/"+b}},showMessage:function(b){var c=a("<span/>").append(b);this.$messagePane.empty().append(c).show()},hideMessage:function(){this.$messagePane.hide()},renderError:function(b){var c="Sorry, an unknown error occurred";"string"==typeof b?c=b:b.error&&b.error.message&&(c=b.error.message);var d=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+c);this.$elem.empty(),this.$elem.append(d)},addInfoRow:function(a,b){return"<tr><th>"+a+"</th><td>"+b+"</td></tr>"},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})}})});