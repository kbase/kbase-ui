define(["jquery","underscore","d3","kb/common/html","kb/widget/legacy/widget","datatables_bootstrap"],function(a,b,c,d){"use strict";a.KBWidget({name:"KBaseLitWidget",parent:"kbaseWidget",version:"1.0.0",options:{genomeID:null,workspaceID:null,isInCard:!1,width:600,height:700,maxPubCount:50},init:function(a){return this._super(a),null!==this.options.row?this.render():void 0},addInfoRow:function(a,b){return"<tr><td>"+a+"</td><td>"+b+"</td></tr>"},xmlToJson:function(a){var b=this,c={};if(1===a.nodeType){if(a.attributes.length>0){c["@attributes"]={};for(var d=0;d<a.attributes.length;d++){var e=a.attributes.item(d);c["@attributes"][e.nodeName]=e.value}}}else 3===a.nodeType&&(c=a.nodeValue);if(a.hasChildNodes())for(var f=0;f<a.childNodes.length;f++){var g=a.childNodes.item(f),h=g.nodeName;if("undefined"==typeof c[h])c[h]=b.xmlToJson(g);else{if("undefined"==typeof c[h].push){var i=c[h];c[h]=[],c[h].push(i)}c[h].push(b.xmlToJson(g))}}return c},render:function(e){function f(c){j.show(),a.ajax({async:!0,url:"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+g.options.maxPubCount+"&sort=pub+date&term="+c.replace(/\s+/g,"+"),type:"GET",success:function(c){var d=g.xmlToJson(c),e="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=",f="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&rettype=abstract&id=";if("0"===d.eSearchResult[1].Count["#text"]){var i={iDisplayLength:4,sDom:"t<flip>",aaSorting:[[3,"desc"]],aoColumns:[{sTitle:"Journal",mData:"source"},{sTitle:"Authors",mData:"author"},{sTitle:"Title",mData:"title"},{sTitle:"Date",mData:"date"}],aaData:[]};return j.hide(),void(h=g.$elem.find("#literature-table").dataTable(i))}if(b.isArray(d.eSearchResult[1].IdList.Id)){var k;for(k=0;k<d.eSearchResult[1].IdList.Id.length;k++)e+=d.eSearchResult[1].IdList.Id[k]["#text"],f+=d.eSearchResult[1].IdList.Id[k]["#text"],k!==d.eSearchResult[1].IdList.Id.length-1&&(e+=",",f+=",")}else e+=d.eSearchResult[1].IdList.Id["#text"],f+=d.eSearchResult[1].IdList.Id["#text"];var l=[],m={};a.when(a.ajax({async:!0,url:f,type:"GET"})).then(function(c){d=g.xmlToJson(c);var f=d.PubmedArticleSet[1].PubmedArticle;if(b.isArray(f)){var i;for(i in f){var k=f[i].MedlineCitation,n=k.PMID["#text"];if("undefined"!=typeof k.Article.Abstract)var o=k.Article.Abstract.AbstractText["#text"];else var o="No abstract found for this article.";m[n]=o}}else{var k=f.MedlineCitation,n=k.PMID["#text"];if("undefined"!=typeof k.Article.Abstract)var o=k.Article.Abstract.AbstractText["#text"];else var o="No abstract found for this article.";m[n]=o}a.when(a.ajax({async:!0,url:e,type:"GET"})).then(function(c){d=g.xmlToJson(c);var e,f=d.eSummaryResult[1].DocSum;if(b.isArray(f)){e=[];for(k in f)e.push(f[k])}else e=[f];var i,k,n,o,p=[];for(i in e){k=e[i].Item;var q={},r=!1;for(n in k){if(o=k[n],"PubDate"===o["@attributes"].Name&&(q.date=o["#text"].substring(0,4)),"Source"===o["@attributes"].Name&&(q.source=o["#text"]),"Title"===o["@attributes"].Name&&(q.title="<a href=https://www.ncbi.nlm.nih.gov/pubmed/"+e[i].Id["#text"]+" target=_blank>"+o["#text"]+"</a>",q["abstract"]=e[i].Id["#text"],p.push(e[i].Id["#text"])),"AuthorList"===o["@attributes"].Name){var s="";if("#text"in o)if(b.isArray(o.Item)){var t,u,v=1;for(t in o.Item)u=o.Item[t],0===v?s+=", ":v--,s+=u["#text"]}else s=o.Item["#text"];else s="No authors found for this article.";q.author=s}if("PubTypeList"===o["@attributes"].Name&&"#text"in o)if(b.isArray(o.Item)){var w;for(w in o.Item)"Journal Article"===o.Item[w]["#text"]&&(r=!0)}else"Journal Article"===o.Item["#text"]&&(r=!0)}r&&l.push(q)}var x="t<flip>";l.length<=10&&(x="tfi");var y={iDisplayLength:4,sDom:x,aaSorting:[],aoColumns:[{sTitle:"Journal",mData:"source"},{sTitle:"Authors",mData:"author"},{sTitle:"Title",mData:"title"},{sTitle:"Date",mData:"date"}],aaData:l,fnRowCallback:function(a,b,c){a.setAttribute("id",b["abstract"])}};j.hide(),h=g.$elem.find("#literature-table").dataTable(y),g.$elem.find("#literature-table tbody").on("mouseover","tr",function(){return g.tooltip=g.tooltip.text(m[a(this).attr("id")]),g.tooltip.style("visibility","visible")}).on("mouseout",function(){return g.tooltip.style("visibility","hidden")}).on("mousemove",function(a){return g.tooltip.style("top",a.pageY+15+"px").style("left",a.pageX-10+"px")})},function(){j.hide(),g.$elem.append("<br><b>Failed to retrieve literature search results. Try again later.</b>")})})}})}var g=this;g.tooltip=c.select("body").append("div").classed("kbcb-tooltip",!0);var h,i=g.options.literature,j=a(d.loading()),k=a("<div>").append('<table cellpadding="0" cellspacing="0" border="0" id="literature-table"                             class="table table-bordered table-striped" style="width: 100%; margin-left: 0px; margin-right: 0px;"/>'),l=a("<div>").append("<input type='text' id='lit-query-box'>"),m=a("<input type='button' id='lit-search-button' value='Update Search'>").on("click",function(){i=g.$elem.find("#lit-query-box").val(),n=[],h.fnDestroy(),f(i)}),n=[];return g.$elem.append(l.append(m)).append(j).append(k),g.$elem.find("#lit-query-box").val(i),g.$elem.find("#lit-query-box").css({width:"300px"}),f(i),this},getData:function(){return{type:"LitWidget",id:this.options.genomeID,workspace:this.options.workspaceID,title:"Literature"}}})});