!function(a,b){a.KBWidget({name:"KBaseGeneStructureMatches",parent:"kbaseWidget",version:"1.0.0",options:{featureID:null,embedInCard:!1,auth:null,loadingImage:"assets/img/ajax-loader.gif",genomeID:null,workspaceID:null,kbCache:null},cdmiURL:"https://kbase.us/services/cdmi_api",kbprotstructURL:"https://kbase.us/services/protein_structure_service",init:function(a){return this._super(a),null===this.options.featureID?this:(this.cdmiClient=new CDMI_API(this.cdmiURL),this.entityClient=new CDMI_EntityAPI(this.cdmiURL),this.kbprotstruct=new KBaseProteinStructure(this.kbprotstructURL),this.render(),this.options.workspaceID?this.renderCentralStore():this.renderCentralStore(),this)},render:function(){this.$messagePane=a("<div/>").addClass("kbwidget-message-pane kbwidget-hide-message"),this.$elem.append(this.$messagePane),this.$infoPanel=a("<div>"),this.$infoPara=a("<p>"),this.$morePara=a("<p>"),this.$structTable=a("<div>"),this.$elem.append(this.$infoPanel.append(this.$infoPara).append(this.$morePara).append(this.$structTable))},renderCentralStore:function(){this.$infoPanel.hide(),lookup_prom=this.kbprotstruct.lookup_pdb_by_fid([this.options.featureID]),this.pdburl=function(a,b){var c;return c="<a href='http://www.rcsb.org/pdb/explore.do?structureId="+a+"' target='_blank'>"+a+"</a>",b.match(/^\s*$/)||(c=c+" "+b),c},this.pdbimage=function(a){return"<img src='http://www.rcsb.org/pdb/images/"+a+"_bio_r_80.jpg'>"},this.rightj=function(a,b){var c="              "+a;return c.substring(c.length-b,c.length)},self=this,this.matchtab=[],a.when(lookup_prom).fail(function(a){console.log("PDB structure widget could not perform lookup"),console.log(a),self.$elem.append("<b>Structure match not yet computed for this feature.  Soon, you will soon be able to compute structure matches for your genome in the Narrative interface.")}).done(function(a){var b,c,d,e=1e3;for(b in a)if(a.hasOwnProperty(b))for(hits=a[b],d=hits.length,c=0;c<hits.length;c++)console.log(typeof hits[c].percent_id),console.log("["+self.rightj(hits[c].percent_id.toFixed(2),6)+"]"),e>c&&self.matchtab.push({image:self.pdbimage(hits[c].pdb_id),"PDB id":self.pdburl(hits[c].pdb_id,hits[c].chains),"% identity":self.rightj(hits[c].percent_id.toFixed(2),6),"align. len.":self.rightj(hits[c].align_length.toString(),5)});0>=d?self.$infoPara.append("No PDB Sequence matches"):(self.$infoPara.append("PDB Sequence matches"),self.$structTable.kbaseTable({structure:{header:[{value:"image"},{value:"PDB id",sortable:!0},{value:"% identity",sortable:!0},{value:"align. len.",sortable:!0}],rows:self.matchtab}}),d>=e&&self.$infoPara.append("<BR>("+e+" of "+d+" matches shown)"),d>=4&&self.$structTable.height(400),self.$structTable.addClass("scroll-pane vertical-only")),self.hideMessage(),self.$infoPanel.show()})},makeRow:function(b,c){var d=a("<tr>").append(a("<td>").append(b)).append(a("<td>").append(c));return d},renderWorkspace:function(){},buildObjectIdentity:function(a,b){var c={};return/^\d+$/.exec(a)?c.wsid=a:c.workspace=a,/^\d+$/.exec(b)?c.objid=b:c.name=b,c},getData:function(){return{type:"Feature",id:this.options.featureID,workspace:this.options.workspaceID,title:"Matching Structures"}},showMessage:function(b){var c=a("<span/>").append(b);this.$messagePane.empty().append(c).removeClass("kbwidget-hide-message")},hideMessage:function(){this.$messagePane.addClass("kbwidget-hide-message")},renderError:function(b){errString="Sorry, an unknown error occurred","string"==typeof b?errString=b:b.error&&b.error.message&&(errString=b.error.message);var c=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+errString);this.$elem.empty(),this.$elem.append(c)}})}(jQuery);