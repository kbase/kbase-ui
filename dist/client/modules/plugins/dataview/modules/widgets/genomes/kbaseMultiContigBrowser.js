define(["jquery","d3","kb/common/html","kb/service/client/cdmi","kb_plugin_dataview","kb/widget/legacy/widget","kb_dataview_genomes_contigBrowserButtons"],function(a,b,c,d,e){"use strict";a.KBWidget({name:"KBaseMultiContigBrowser",parent:"kbaseWidget",version:"1.0.0",options:{genomeID:null,workspaceID:null,contig:null,centerFeature:null,onClickUrl:null,allowResize:!1,svgWidth:500,svgHeight:70,trackMargin:5,trackThickness:20,leftMargin:5,topMargin:20,arrowSize:15,start:1,length:16750,embedInCard:!1,showButtons:!0,cardContainer:null,onClickFunction:null,width:525,kbCache:null,genomeInfo:null},seedOntology:[],seedTermsUniq:[],seedColors:[],tooltip:null,operonFeatures:[],$messagePane:null,noContigs:"No Contigs",genome:null,$selectPanel:null,$contigViewPanel:null,$featureInfoPanel:null,init:function(b){this._super(b);var e=this;null===this.options.contig,this.$messagePane=a("<div/>"),this.$elem.append(this.$messagePane),this.showMessage(c.loading("loading contig details"));var f=a('<div class="row"/>');this.$contigSelect=a("<select>").addClass("form-control").css({width:"60%","margin-right":"5px"}).append(a("<option>").attr("id",this.noContigs).append(this.noContigs)),this.$contigButton=a("<button>").addClass("kb-primary-btn").append("Show Contig").click(function(b){e.$elem.find("select option:selected").each(function(){var b=a(this).attr("id");b!==e.noContigs&&(e.contig=a(this).attr("id"),e.options.contig=a(this).attr("id"),e.render())})}),this.$selectPanel=a('<div class="col-md-3"/>'),this.$selectPanel.append(a("<div>").addClass("form-inline").append(this.$contigSelect).append(this.$contigButton)),f.append(this.$selectPanel);var g=a('<div class="col-md-6"/>');if(this.$contigViewPanel=a('<div id="contigmainview" align="center"/>').css({overflow:"auto"}),g.append(this.$contigViewPanel).append("<div>").KBaseContigBrowserButtons({browser:e}),f.append(g),this.$featureInfoPanel=a('<div class="col-md-3"/>').html("<b>Click on a feature to view details</b>"),f.append(this.$featureInfoPanel),this.cdmiClient=new d(this.runtime.getConfig("services.cdmi.url")),e.options.genomeInfo)e.showData(e.options.genomeInfo.data,f);else{var h=this.buildObjectIdentity(this.options.workspaceID,this.options.genomeID),i=this.options.kbCache.req("ws","get_objects",[h]);a.when(i).done(a.proxy(function(a){a=a[0].data,e.showData(a,f)},this)),a.when(i).fail(a.proxy(function(a){this.renderError(a)},this))}return this.options.onClickFunction||(this.options.onClickFunction=function(b,c){e.$featureInfoPanel.empty();var d=a("<table>").addClass("table table-striped table-bordered");c.id&&d.append(e.addInfoRow("Feature ID",'<a href="#/genes/'+e.options.workspaceID+"/"+e.options.genomeID+"/"+c.id+'" target="_blank">'+c.id+"</a>")),c.type&&d.append(e.addInfoRow("Type",c.type)),c["function"]&&d.append(e.addInfoRow("Function",c["function"])),e.$featureInfoPanel.append(d)}),this},showData:function(a,b){var c=this;c.genome=a;var d={};if(a.contig_ids&&a.contig_ids.length>0)for(var e=0;e<a.contig_ids.length;e++){var f="Unknown";a.contig_lengths&&a.contig_lengths[e]&&(f=a.contig_lengths[e]),d[a.contig_ids[e]]=f}else if(a.features&&a.features.length>0)for(var e=0;e<a.features.length;e++){var g=a.features[e];g.location&&g.location[0][0]&&(d[g.location[0][0]]="Unknown")}c.populateContigSelector(d),c.$elem.append(b),c.hideMessage(),a.contig_ids.length>0&&(c.contig=a.contig_ids[0],c.options.contig=a.contig_ids[0],c.render())},addInfoRow:function(a,b){return"<tr><th>"+a+"</th><td>"+b+"</td></tr>"},render:function(){this.loading(!1);var a=this;return a.$contigViewPanel.empty(),this.tooltip=b.select("body").append("div").classed("kbcb-tooltip",!0),this.svg=b.select(a.$contigViewPanel[0]).append("svg").attr("width",this.options.svgWidth).attr("height",this.options.svgHeight).classed("kbcb-widget",!0),this.trackContainer=this.svg.append("g"),this.xScale=b.scale.linear().domain([this.options.start,this.options.start+this.options.length]).range([0,this.options.svgWidth]),this.xAxis=b.svg.axis().scale(this.xScale).orient("top").tickFormat(b.format(",.0f")),this.axisSvg=this.svg.append("g").attr("class","kbcb-axis").attr("transform","translate(0, "+this.options.topMargin+")").call(this.xAxis),this.loadSeedOntology(this.wait_for_seed_load),this},wait_for_seed_load:function(){this.assignSeedColors(this.seedTermsUniq);var a=this;return this.setWorkspaceContig(a.options.workspaceID,a.options.genomeID,a.options.contig),null!==this.options.centerFeature&&this.setCenterFeature(this.options.centerFeature),!0},populateContigSelector:function(b){this.$contigSelect.empty(),b&&0!==b.length||this.$contigSelect.append(a("<option>").attr("id",this.noContigs).append(this.noContigs));for(var c in b)this.$contigSelect.append(a("<option>").attr("id",c).append(c+" - "+b[c]+" bp"))},track:function(){var a={};return a.regions=[],a.min=Number.POSITIVE_INFINITY,a.max=Number.NEGATIVE_INFINIITY,a.numRegions=0,a.addRegion=function(a){for(var b=0;b<a.length;b++){var c=Number(a[b][1]),d=Number(a[b][3]),e="+"===a[b][2]?c+d-1:c-d+1;if(c>e){var f=e;e=c,c=f}this.regions.push([c,e]),c<this.min&&(this.min=c),e>this.max&&(this.max=e),this.numRegions++}},a.hasOverlap=function(a){for(var b=0;b<a.length;b++){var c=Number(a[b][1]),d=Number(a[b][3]),e="+"===a[b][2]?c+d-1:c-d+1;if(c>e){var f=e;e=c,c=f}for(var g=0;g<this.regions.length;g++){var h=this.regions[g];if(!(c<=h[0]&&e<=h[0]||c>=h[1]&&e>=h[1]))return!0}}return!1},a},setCdmiContig:function(a){a&&this.options.contig!==a&&(this.options.centerFeature=null,this.operonFeatures=[],this.options.contig=a);var b=this;this.cdmiClient.contigs_to_lengths([this.options.contig],function(a){b.contigLength=parseInt(a[b.options.contig]),b.options.start=0,b.options.length>b.contigLength&&(b.options.length=b.contigLength)}),this.options.centerFeature?this.setCenterFeature():this.update()},calcFeatureRange:function(a){for(var b,c=function(a){var b=Number(a[1]),c=Number(a[1])+Number(a[3])-1;return"-"===a[2]&&(c=b,b-=Number(a[3])+1),[b,c]},d=c(a[0]),e=1;e<a.length;e++)b=c(a[e]),b[0]<d[0]&&(d[0]=b[0]),b[1]>d[1]&&(d[1]=b[1]);return d},setWorkspaceContig:function(b,c,d){var e=this;d&&this.options.contig!==d&&(this.options.centerFeature=null,this.operonFeatures=[],this.options.contig=d);var f=e.genome;if(this.contigLength=-1,f.contig_ids&&f.contig_ids.length>0){var g=a.inArray(d,f.contig_ids);-1!==g&&(this.contigLength=f.contig_lengths[g])}this.wsFeatureSet={};for(var h=0;h<f.features.length;h++){var i=f.features[h];if(i.location&&i.location.length>0&&i.location[0][0]===d){var j=this.calcFeatureRange(i.location);i.feature_id=i.id,i.feature_type=i.type,i.feature_location=i.location,i.range=j,i.feature_function=i["function"],i.subsystem_data=i.subsystem_data,this.wsFeatureSet[i.id]=i,j[1]>this.contigLength&&(this.contigLength=j[1])}}this.options.start=0,this.options.length>this.contigLength&&(this.options.length=this.contigLength),this.options.centerFeature?this.setCenterFeature():this.update()},setGenome:function(a){this.options.genomeID=a;this.cdmiClient.genomes_to_contigs([a],function(b){setContig(this.genomeList[a][0])})},setRange:function(a,b){this.options.start=a,this.options.length=b,this.update()},processFeatures:function(a){var b=[];b[0]=this.track();var c,d=[];for(c in a)d.push(a[c]);a=d,a.sort(function(a,b){return a.feature_location[0][1]-b.feature_location[0][1]});for(var e=0;e<a.length;e++){for(var f=a[e],g=0;g<b.length;g++)if(!b[g].hasOverlap(f.feature_location)){b[g].addRegion(f.feature_location),f.track=g;break}if(void 0===f.track){var h=b.length;b[h]=this.track(),b[h].addRegion(f.feature_location),f.track=h}}return this.numTracks=b.length,a},update:function(a){var b=this,c=function(a){a?(a=a[b.options.centerFeature],b.options.start=Math.max(0,Math.floor(parseInt(a.feature_location[0][1])+parseInt(a.feature_location[0][3])/2-b.options.length/2))):window.alert("Error: fid '"+b.options.centerFeature+"' not found! Continuing with original range..."),b.cdmiClient.region_to_fids([b.options.contig,b.options.start,"+",b.options.length],d)},d=function(a){b.cdmiClient.fids_to_feature_data(a,e)},e=function(a){if(b.options.centerFeature)for(var c in a)for(var d in b.operonFeatures)a[c].feature_id===b.operonFeatures[d]&&(a[c].isInOperon=1);b.renderFromRange(a)};if(b.options.workspaceID&&b.options.genomeID){var f=[b.options.start,b.options.start+b.options.length-1];if(b.options.centerFeature&&a){var g=this.wsFeatureSet[b.options.centerFeature];g&&(b.options.start=Math.max(0,Math.floor(parseInt(g.location[0][1])+parseInt(g.location[0][3])/2-b.options.length/2)),f=[b.options.start,b.options.start+b.options.length-1])}var h={};for(var i in this.wsFeatureSet)this.rangeOverlap(f,this.wsFeatureSet[i].range)&&(h[i]=this.wsFeatureSet[i]);this.renderFromRange(h)}else b.options.centerFeature&&a?b.cdmiClient.fids_to_feature_data([b.options.centerFeature],c):b.cdmiClient.region_to_fids([b.options.contig,b.options.start,"+",b.options.length],d)},rangeOverlap:function(a,b){return a[0]<b[0]&&a[1]>b[0]||b[0]<a[0]&&b[1]>a[0]?!0:!1},adjustHeight:function(){var a=this.numTracks*(this.options.trackThickness+this.options.trackMargin)+this.options.topMargin+this.options.trackMargin;a>this.svg.attr("height")&&this.svg.attr("height",a)},renderFromRange:function(a){a=this.processFeatures(a);var c=this;this.options.allowResize&&this.adjustHeight();var d=this.trackContainer.selectAll("path").data(a,function(a){return a.feature_id});d.enter().append("path").classed("kbcb-feature",!0).classed("kbcb-operon",function(a){return c.isOperonFeature(a)}).classed("kbcb-center",function(a){return c.isCenterFeature(a)}).style("fill",function(a){return c.calcFillColorByProtAnnot(a,0)}).attr("id",function(a){return a.feature_id}).on("mouseover",function(a){return b.select(this).style("fill",b.rgb(b.select(this).style("fill")).darker()),c.tooltip=c.tooltip.text(a.feature_id+": "+a.feature_function),c.tooltip.style("visibility","visible")}).on("mouseout",function(){return b.select(this).style("fill",b.rgb(b.select(this).style("fill")).brighter()),c.tooltip.style("visibility","hidden")}).on("mousemove",function(){return c.tooltip.style("top",b.event.pageY+15+"px").style("left",b.event.pageX-10+"px")}).on("click",function(a){c.options.onClickFunction?c.options.onClickFunction(this,a):c.highlight(this,a)}),d.exit().remove(),d.attr("d",function(a){return c.featurePath(a)}),c.xScale=c.xScale.domain([c.options.start,c.options.start+c.options.length]),c.xAxis=c.xAxis.scale(c.xScale),c.axisSvg.call(c.xAxis),c.resize(),this.loading(!0)},featurePath:function(a){for(var b="",c=[],d=0;d<a.feature_location.length;d++){var e=a.feature_location[d],f=this.calcXCoord(e),g=this.calcYCoord(e,a.track),h=this.calcHeight(e),i=this.calcWidth(e);c.push([f,f+i]),b+="+"===e[2]?this.featurePathRight(f,g,h,i)+" ":this.featurePathLeft(f,g,h,i)+" "}if(a.feature_location.length>1){c.sort(function(a,b){return a[0]-b[0]});for(var j=this.calcYCoord(a.feature_location[0],a.track)+this.calcHeight(a.feature_location[0])/2,d=0;d<c.length-1;d++)b+="M"+c[d][1]+" "+j+" L"+c[d+1][0]+" "+j+" Z "}return b},featurePathRight:function(a,b,c,d){var e="M"+a+" "+b;return e+=d>this.options.arrowSize?" L"+(a+(d-this.options.arrowSize))+" "+b+" L"+(a+d)+" "+(b+c/2)+" L"+(a+(d-this.options.arrowSize))+" "+(b+c)+" L"+a+" "+(b+c)+" Z":" L"+(a+d)+" "+(b+c/2)+" L"+a+" "+(b+c)+" Z"},featurePathLeft:function(a,b,c,d){var e="M"+(a+d)+" "+b;return e+=d>this.options.arrowSize?" L"+(a+this.options.arrowSize)+" "+b+" L"+a+" "+(b+c/2)+" L"+(a+this.options.arrowSize)+" "+(b+c)+" L"+(a+d)+" "+(b+c)+" Z":" L"+a+" "+(b+c/2)+" L"+(a+d)+" "+(b+c)+" Z"},calcXCoord:function(a){var b=a[1];return"-"===a[2]&&(b=a[1]-a[3]+1),(b-this.options.start)/this.options.length*this.options.svgWidth},calcYCoord:function(a,b){return this.options.topMargin+this.options.trackMargin+this.options.trackMargin*b+this.options.trackThickness*b},calcWidth:function(a){return Math.floor((a[3]-1)/this.options.length*this.options.svgWidth)},calcHeight:function(a){return this.options.trackThickness},isCenterFeature:function(a){return a.feature_id===this.options.centerFeature},isOperonFeature:function(a){return a.isInOperon},calcFillColor:function(a){return a.feature_id===this.options.centerFeature?"#00F":1===a.isInOperon?"#0F0":"#F00"},calcFillColorByProtAnnot:function(a,b){return"CDS"!==a.feature_type?"#000":(this.options.annot_namespace="SEED",this.options.annot_level=3,this.colorByAnnot(a,this.options.annot_namespace,this.options.annot_level,b))},colorByAnnot:function(a,b,c,d){if("SEED"===b){if(!a.feature_function)return"#CCC";var e=a.feature_function.replace(/\s+\/.+/,"").replace(/\s+\#.*/,"");return this.seedColorLookup(e,c)}return"#CCC"},seedColorLookup:function(a,b){var c,d=this;if(c=0,void 0===d.seedOntology[a])return"#CCC";var e=d.seedOntology[a][b][c];return d.seedColors[b][e]},loadSeedOntology:function(a){for(var c=this.seedOntology,d=this.seedTermsUniq,f=this,g=[],h=3,i=4,j=0;i>j;j++)g[j]=[],d[j]=[];return b.text(e.plugin.path+"/data/subsys.txt",function(a){console.log("IN"),console.log(e.plugin.path),console.log("GOT"),console.log(a);for(var k=b.tsv.parseRows(a),l="",m=0;m<k.length;m++)if(""!==k[m][h])for(l=k[m][h],void 0===c[l]&&(c[l]=[]),void 0===g[h][l]&&(g[h][l]=!0,d[h].push(l)),j=0;i>j;j++)void 0===c[l][j]&&(c[l][j]=[]),k[m][j]=""===k[m][j]?"--- "+k[m][j-1]+" ---":k[m][j],c[l][j].push(k[m][j]),void 0===g[j][k[m][j]]&&(g[j][k[m][j]]=!0,d[j].push(k[m][j]));f.wait_for_seed_load()}),!0},assignSeedColors:function(a){for(var b=this.seedColors,c=["#F00","#900","#C30","#F60","#F90","#FC0","#CF3","#9FC","#9F9","#0C0","#393","#060","#0F9","#0CF","#F39","#39F","#69F","#36C","#00F","#33C","#00C","#FC9","#96F","#C9F","#60C","#C0C","#F99","#F66","#909"],d=c.length,e=4,f=0;e>f;f++){void 0===b[f]&&(b[f]=[]);for(var g=0;g<a[f].length;g++)b[f][a[f][g]]=c[g%d]}return!0},highlight:function(a,b){this.recenter(b)},recenter:function(a){centerFeature=a.feature_id,this.options.onClickUrl?this.options.onClickUrl(a.feature_id):this.update(!0)},resize:function(){var a=Math.min(this.$elem.parent().width(),this.options.svgWidth);this.svg.attr("width",a)},moveLeftEnd:function(){this.options.start=0,this.update()},moveLeftStep:function(){this.options.start=Math.max(0,this.options.start-Math.ceil(this.options.length/2)),this.update()},zoomIn:function(){this.options.start=Math.min(this.contigLength-Math.ceil(this.options.length/2),this.options.start+Math.ceil(this.options.length/4)),this.options.length=Math.max(1,Math.ceil(this.options.length/2)),this.update()},zoomOut:function(){this.options.length=Math.min(this.contigLength,2*this.options.length),this.options.start=Math.max(0,this.options.start-Math.ceil(this.options.length/4)),this.options.start+this.options.length>this.contigLength&&(this.options.start=this.contigLength-this.options.length),this.update()},moveRightStep:function(){this.options.start=Math.min(this.options.start+Math.ceil(this.options.length/2),this.contigLength-this.options.length),this.update()},moveRightEnd:function(){this.options.start=this.contigLength-this.options.length,this.update()},loading:function(a){a?this.hideMessage():this.showMessage(c.loading())},showMessage:function(b){var c=a("<span/>").append(b);this.$messagePane.empty().append(c).show()},hideMessage:function(){this.$messagePane.hide()},getData:function(){return{type:"Contig",id:this.options.contig,workspace:this.options.workspaceID,title:"Contig Browser"}},renderError:function(b){errString="Sorry, an unknown error occurred","string"==typeof b?errString=b:b.error&&b.error.message&&(errString=b.error.message);var c=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+errString);this.$elem.empty(),this.$elem.append(c)},buildObjectIdentity:function(a,b){var c={};return/^\d+$/.exec(a)?c.wsid=a:c.workspace=a,/^\d+$/.exec(b)?c.objid=b:c.name=b,c}})});