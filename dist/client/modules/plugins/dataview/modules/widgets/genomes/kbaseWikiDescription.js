define(["jquery","kb/common/html","kb/service/client/cdmi","kb/service/client/cdmiEntity","kb/service/client/workspace","kb/widget/legacy/widget"],function(a,b,c,d,e){"use strict";a.KBWidget({name:"KBaseWikiDescription",parent:"kbaseWidget",version:"1.0.0",options:{genomeID:null,workspaceID:null,title:"Description",maxNumChars:900,width:400,maxTextHeight:300,genomeInfo:null},init:function(b){return this._super(b),null===this.options.featureID?this:(this.$messagePane=a("<div>"),this.$elem.append(this.$messagePane),this.cdmiClient=new c(this.runtime.getConfig("services.cdmi.url")),this.entityClient=new d(this.runtime.getConfig("services.cdmi.url")),this.workspaceClient=new e(this.runtime.getConfig("services.workspace.url",{token:this.runtime.service("session").getAuthToken()})),this.options.workspaceID?this.renderWorkspace():this.renderCdmi(),this)},renderCdmi:function(){return this.showMessage(b.loading("loading...")),null===this.options.genomeID?void this.renderError("Error: no genome identifier given!"):(this.cdmiClient.genomes_to_taxonomies([this.options.genomeID],a.proxy(function(a){a=a[this.options.genomeID],a?this.renderFromTaxonomy(a.reverse()):this.renderError("Genome '"+this.options.genomeID+"' not found in the KBase Central Store.")},this),this.renderError),this)},renderFromTaxonomy:function(b){var c=b,d=b[0];this.wikipediaLookup(c,a.proxy(function(b){var c=a("<div>"),e=a("<div>");if(b.hasOwnProperty("description")&&null!==b.description)if(b.searchTerm){var f,g=a('<div style="text-align:justify; max-height: '+this.options.maxTextHeight+'px; overflow-y:auto; padding-right:5px">').append(b.description),h=a("<div>");d===b.redirectFrom?h=a(this.redirectHeader(d,b.redirectFrom,b.searchTerm)):d!==b.searchTerm&&(h=a(this.notFoundHeader(d,b.searchTerm,b.redirectFrom)));var i=a('<p>[<a href="'+b.wikiUri+'" target="_new">more at Wikipedia</a>]</p>'),j='Unable to find an image. If you have one, you might consider <a href="'+b.wikiUri+'" target="_new">adding it to Wikipedia</a>.';null!==b.imageUri&&(j='<img src="'+b.imageUri+'"',this.options.width&&(j+='style="width:'+this.options.width+'px;"'),j+="/>"),c.append(h).append(g).append(i),e.append(j)}else h=a(this.notFoundHeader(d,b.searchTerm,b.redirectFrom)),c.append(h),e.append("Unable to find an image.");else f=this.notFoundHeader(d);this.hideMessage(),this.$elem.append(a('<div id="mainview">').css("overflow","auto").append(a('<table cellpadding=4, cellspacing=2, border=0 style="width:100%">').append(a("<tr>").append(a('<td style="vertical-align:top">').append(c)).append(a('<td style="vertical-align:top">').append(e)))).append(a("<br>")))},this),a.proxy(this.renderError,this))},renderWorkspace:function(){function a(a){if(a.taxonomy){for(var b=a.taxonomy,d=[],e=a.scientific_name.split(/\s+/),f=e.length;f>0;f--)d.push(e.slice(0,f).join(" "));d&&"Unknown"!==d&&(d=d.concat(b.split(/\;\s*/).reverse())),c.renderFromTaxonomy(d)}else if(a.scientific_name){for(var d=[],e=a.scientific_name.split(/\s+/),f=e.length;f>0;f--)d.push(e.slice(0,f).join(" "));c.renderFromTaxonomy(d)}}var c=this;this.searchedOnce=!1,this.showMessage(b.loading("loading..."));var d=this.buildObjectIdentity(this.options.workspaceID,this.options.genomeID);d.included=["/taxonomy","/scientific_name"],c.options.genomeInfo?a(c.options.genomeInfo.data):c.workspaceClient.get_object_subset([d],function(b){b[0]&&a(b[0].data)},function(b){var d=c.buildObjectIdentity(c.options.workspaceID,c.options.genomeID);d.included=["/scientific_name"],c.workspaceClient.get_object_subset([d],function(b){b[0]&&a(b[0].data)},function(a){c.renderError(a)})})},buildObjectIdentity:function(a,b){var c={};return/^\d+$/.exec(a)?c.wsid=a:c.workspace=a,/^\d+$/.exec(b)?c.objid=b:c.name=b,c},uid:function(){for(var a="",b=0;32>b;b++)a+=Math.floor(16*Math.random()).toString(16).toUpperCase();return a},notFoundHeader:function(a,b,c){var d=a.replace(/\s+/g,"_"),e='<p><b>"<i>'+a+"</i>\" not found in Wikipedia. Add a description on <a href='http://en.wikipedia.org/wiki/"+d+"' target='_new'>Wikipedia</a>.</b></p>";return b&&(e+="<p><b>Showing description for <i>"+b+"</i></b>",c&&(e+="<br>redirected from <i>"+c+"</i>"),e+="</p>"),e},redirectHeader:function(a,b,c){var d=b.replace(/\s+/g,"_"),e="<p><b>Showing description for <i>"+c+"</i></b><br>redirected from <i>"+d+"</i></p>";return e},showMessage:function(b){var c=a("<span>").append(b);this.$messagePane.append(c),this.$messagePane.removeClass("kbwidget-hide-message")},hideMessage:function(){this.$messagePane.addClass("kbwidget-hide-message"),this.$messagePane.empty()},getData:function(){return{type:"Description",id:this.options.genomeID,workspace:this.options.workspaceID,title:"Organism Description"}},renderError:function(b){errString="Sorry, an unknown error occured. Wikipedia.org may be down or your browser may be blocking an http request to Wikipedia.org.","string"==typeof b?errString=b:b&&b.error&&b.error.message&&(errString=b.error.message);var c=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+errString);this.$elem.empty(),this.$elem.append(c)},searchedOnce:!1,wikipediaLookup:function(b,c,d){b&&"[object Array]"===Object.prototype.toString.call(b)&&0!==b.length||d&&!this.searchedOnce&&d("No search term given"),this.searchedOnce=!0;var e=b.shift(),f="//en.wikipedia.org/w/api.php?action=parse&format=json&prop=text|pageimages&section=0&redirects=&callback=?&page="+e,g="//en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages&pithumbsize="+this.options.width+"&callback=?&titles=";a.ajax({type:"GET",url:f,contentType:"application/json; charset=utf-8",async:!0,dataType:"json"}).then(a.proxy(function(f,h){if(f.error)this.wikipediaLookup(b,c,d);else if(f.parse&&f.parse.text){var i={searchTerm:e},j=a("<div>").html(f.parse.text["*"]);j.find("a").each(function(){a(this).replaceWith(a(this).html())}),j.find("sup.reference").remove(),j.find(".mw-ext-cite-error").remove(),i.description="",j.children("p").each(function(b,c){i.description+="<p>"+a(c).html()+"</p>"}),i.wikiUri="//www.wikipedia.org/wiki/"+f.parse.title,f.parse.redirects&&f.parse.redirects.length>0&&(i.redirectFrom=f.parse.redirects[0].from),a.ajax({type:"GET",url:g+f.parse.title,contentType:"application/json; charset=utf-8",async:!0,dataType:"json"}).then(function(a,b){if(b&&(i.imageUri=null,a.query&&a.query.pages&&Object.keys(a.query.pages).length>0)){var d=Object.keys(a.query.pages)[0];a.query.pages[d].thumbnail&&(i.imageUri=a.query.pages[d].thumbnail.source)}c&&c(i)},function(a){d&&d(a)})}},this),function(a){d&&d(a)})},dbpediaLookup:function(b,c,d,e){b&&"[object Array]"===Object.prototype.toString.call(b)&&0!==b.length||d&&d("No search term given");var f=b.shift(),g=f.replace(/\s+/g,"_"),h="http://dbpedia.org/resource/"+g,i="http://dbpedia.org/ontology/abstract",j="en",k="http://xmlns.com/foaf/0.1/depiction",l="http://xmlns.com/foaf/0.1/isPrimaryTopicOf",m="http://dbpedia.org/ontology/wikiPageRedirects",n="http://dbpedia.org/data/"+g+".json";a.get(n).then(a.proxy(function(a,g){var n={searchTerm:f};if(a[h]){var o=a[h];if(o[l]&&o[i]){if(o[l]&&(n.wikiUri=o[l][0].value),o[i])for(var p=o[i],q=0;q<p.length;q++)p[q].lang===j&&(n.description=p[q].value);o[k]&&(n.imageUri=o[k][0].value),e&&(n.redirectFrom=e),c(n)}else if(o[m]){var r=o[m][0].value.split("/");this.dbpediaLookup([r[r.length-1]],c,d,f)}else b.length>0?this.dbpediaLookup(b,c,d):c(n)}else b.length>0?this.dbpediaLookup(b,c,d):c(n);return n},this),function(a){d&&d(a)})}})});