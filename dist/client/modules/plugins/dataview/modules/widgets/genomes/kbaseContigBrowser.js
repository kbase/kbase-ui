!function(a,b){a.KBWidget({name:"KBaseContigBrowser",parent:"kbaseWidget",version:"1.0.0",options:{contig:null,centerFeature:null,onClickUrl:null,allowResize:!0,svgWidth:600,svgHeight:70,trackMargin:5,trackThickness:20,leftMargin:5,topMargin:20,arrowSize:15,start:1,length:16750,embedInCard:!1,showButtons:!0,cardContainer:null,onClickFunction:null,width:525,workspaceId:null,genomeId:null,kbCache:null,genomeInfo:null},$contigViewPanel:null,seedOntology:[],seedTermsUniq:[],seedColors:[],cdmiURL:"http://kbase.us/services/cdmi_api",proteinInfoURL:"http://kbase.us/services/protein_info_service",tooltip:null,operonFeatures:[],$messagePane:null,init:function(b){this._super(b);var c=this;null===this.options.contig&&console.log("kbaseContigBrowser.js: missing contig.  Will set from feature"),this.$messagePane=a("<div/>").addClass("kbwidget-message-pane").addClass("kbwidget-hide-message"),this.$elem.append(this.$messagePane);var d=a("<div/>");return this.$contigViewPanel=a('<div id="contigmainview" align="center"/>').css({overflow:"auto"}),d.append(this.$contigViewPanel).append("<div>").KBaseContigBrowserButtons({browser:c}),this.$elem.append(d),this.cdmiClient=new CDMI_API(this.cdmiURL),this.proteinInfoClient=new ProteinInfo(this.proteinInfoURL),this.loadSeedOntology(this.wait_for_seed_load),this},wait_for_seed_load:function(){return this.assignSeedColors(this.seedTermsUniq),this.render(),!0},render:function(){this.loading(!1),this.tooltip=d3.select("body").append("div").classed("kbcb-tooltip",!0),this.svg=d3.select(this.$contigViewPanel[0]).append("svg").attr("width",this.options.svgWidth).attr("height",this.options.svgHeight).classed("kbcb-widget",!0),this.trackContainer=this.svg.append("g"),this.xScale=d3.scale.linear().domain([this.options.start,this.options.start+this.options.length]).range([0,this.options.svgWidth]),this.xAxis=d3.svg.axis().scale(this.xScale).orient("top").tickFormat(d3.format(",.0f")),this.axisSvg=this.svg.append("g").attr("class","kbcb-axis").attr("transform","translate(0, "+this.options.topMargin+")").call(this.xAxis);var b=this;return a(window).on("resize",function(){b.resize()}),null!=this.options.centerFeature&&this.setCenterFeature(this.options.centerFeature),this.options.workspaceId&&this.options.genomeId?this.setWorkspaceContig(this.options.workspaceId,this.options.genomeId,this.options.contig):this.setCdmiContig(),this.options.onClickFunction=function(a,b,c,d){console.log("in onClickFunction");window.open("/functional-site/#/genes/"+c+"/"+d+"/"+b.feature_id)},this},track:function(){var a={};return a.regions=[],a.min=1/0,a.max=-(1/0),a.numRegions=0,a.addRegion=function(a){for(var b=0;b<a.length;b++){var c=Number(a[b][1]),d=Number(a[b][3]),e="+"===a[b][2]?c+d-1:c-d+1;if(c>e){var f=e;e=c,c=f}this.regions.push([c,e]),c<this.min&&(this.min=c),e>this.max&&(this.max=e),this.numRegions++}},a.hasOverlap=function(a){for(var b=0;b<a.length;b++){var c=Number(a[b][1]),d=Number(a[b][3]),e="+"===a[b][2]?c+d-1:c-d+1;if(c>e){var f=e;e=c,c=f}for(var g=0;g<this.regions.length;g++){var h=this.regions[g];if(!(c<=h[0]&&e<=h[0]||c>=h[1]&&e>=h[1]))return!0}}return!1},a},setCdmiContig:function(a){a&&this.options.contig!==a&&(this.options.centerFeature=null,this.operonFeatures=[],this.options.contig=a);var b=this;this.cdmiClient.contigs_to_lengths([this.options.contig],function(a){b.contigLength=parseInt(a[b.options.contig]),b.options.start=0,b.options.length>b.contigLength&&(b.options.length=b.contigLength)}),this.options.centerFeature?(this.setCenterFeature(),this.update(!0)):this.update()},calcFeatureRange:function(a){for(var b=function(a){var b=Number(a[1]),c=Number(a[1])+Number(a[3])-1;return"-"===a[2]&&(c=b,b-=Number(a[3])+1),[b,c]},c=b(a[0]),d=1;d<a.length;d++)nextRange=b(a[d]),nextRange[0]<c[0]&&(c[0]=nextRange[0]),nextRange[1]>c[1]&&(c[1]=nextRange[1]);return c},setWorkspaceContig:function(b,c,d){var e=this;if(d&&this.options.contig!==d&&(this.options.centerFeature=null,this.operonFeatures=[],this.options.contig=d),e.options.genomeInfo)return void e.showData(d,e.options.genomeInfo);var f=this.buildObjectIdentity(this.options.workspaceId,this.options.genomeId),g=this.options.kbCache.req("ws","get_objects",[f]);a.when(g).fail(a.proxy(function(a){this.renderError(a)},this)),a.when(g).done(a.proxy(function(a){a=a[0],e.showData(d,a)},this))},showData:function(b,c){var d=this;if(d.options.centerFeature)for(var e=0;e<c.data.features.length;e++){var f=c.data.features[e];f.id===d.options.centerFeature&&f.location&&f.location.length>0&&(d.options.contig=f.location[0][0],b=f.location[0][0])}else d.options.contig||c.data.contig_ids&&c.data.contig_ids.length>0&&(d.options.contig=c.data.contig_ids[0],b=d.options.contig);if(this.contigLength=-1,c.data.contig_ids&&c.data.contig_ids.length>0){var g=a.inArray(b,c.data.contig_ids);-1!==g&&(this.contigLength=c.data.contig_lengths[g])}this.wsFeatureSet={};for(var e=0;e<c.data.features.length;e++){var f=c.data.features[e];if(f.location&&f.location.length>0&&f.location[0][0]===b){var h=this.calcFeatureRange(f.location);f.feature_id=f.id,f.feature_type=f.type,f.feature_location=f.location,f.range=h,f.feature_function=f["function"],f.subsystem_data=f.subsystem_data,this.wsFeatureSet[f.id]=f,h[1]>this.contigLength&&(this.contigLength=h[1])}}this.options.start=0,this.options.length>this.contigLength&&(this.options.length=this.contigLength),this.options.centerFeature?(this.setCenterFeature(),this.update(!0)):this.update()},setCenterFeature:function(a){a&&(this.options.centerFeature=a)},setGenome:function(a){this.options.genomeId=a;cdmiAPI.genomes_to_contigs([a],function(b){setContig(this.genomeList[a][0])})},setRange:function(a,b){this.options.start=a,this.options.length=b,this.update()},processFeatures:function(a){var c=[];c[0]=this.track();var d=[];for(fid in a)d.push(a[fid]);a=d,a.sort(function(a,b){return a.feature_location[0][1]-b.feature_location[0][1]});for(var e=0;e<a.length;e++){for(var f=a[e],g=0;g<c.length;g++)if(!c[g].hasOverlap(f.feature_location)){c[g].addRegion(f.feature_location),f.track=g;break}if(f.track===b){var h=c.length;c[h]=this.track(),c[h].addRegion(f.feature_location),f.track=h}}return this.numTracks=c.length,a},update:function(a){var b=this,c=function(a){a?(a=a[b.options.centerFeature],b.options.start=Math.max(0,Math.floor(parseInt(a.feature_location[0][1])+parseInt(a.feature_location[0][3])/2-b.options.length/2))):window.alert("Error: fid '"+b.options.centerFeature+"' not found! Continuing with original range..."),b.cdmiClient.region_to_fids([b.options.contig,b.options.start,"+",b.options.length],d)},d=function(a){b.cdmiClient.fids_to_feature_data(a,e)},e=function(a){if(b.options.centerFeature)for(var c in a)for(var d in b.operonFeatures)a[c].feature_id===b.operonFeatures[d]&&(a[c].isInOperon=1);b.renderFromRange(a)};if(b.options.workspaceId&&b.options.genomeId){var f=[b.options.start,b.options.start+b.options.length-1];if(b.options.centerFeature&&a){var g=b.wsFeatureSet[b.options.centerFeature];g&&(b.options.start=Math.max(0,Math.floor(parseInt(g.location[0][1])+parseInt(g.location[0][3])/2-b.options.length/2)),f=[b.options.start,b.options.start+b.options.length-1])}var h={};for(var i in this.wsFeatureSet)this.rangeOverlap(f,this.wsFeatureSet[i].range)&&(h[i]=this.wsFeatureSet[i]);this.renderFromRange(h)}else b.options.centerFeature&&a?b.cdmiClient.fids_to_feature_data([b.options.centerFeature],c):b.cdmiClient.region_to_fids([b.options.contig,b.options.start,"+",b.options.length],d)},rangeOverlap:function(a,b){return a[0]<b[0]&&a[1]>b[0]||b[0]<a[0]&&b[1]>a[0]?!0:!1},adjustHeight:function(){var a=this.numTracks*(this.options.trackThickness+this.options.trackMargin)+this.options.topMargin+this.options.trackMargin;a>this.svg.attr("height")&&this.svg.attr("height",a)},renderFromRange:function(a){a=this.processFeatures(a);var b=this;this.options.allowResize&&this.adjustHeight();var c=this.trackContainer.selectAll("path").data(a,function(a){return a.feature_id});c.enter().append("path").classed("kbcb-feature",!0).classed("kbcb-operon",function(a){return b.isOperonFeature(a)}).classed("kbcb-center",function(a){return b.isCenterFeature(a)}).style("fill",function(a){return b.calcFillColorByProtAnnot(a,0)}).attr("id",function(a){return a.feature_id}).on("mouseover",function(a){return d3.select(this).style("fill",d3.rgb(d3.select(this).style("fill")).darker()),b.tooltip=b.tooltip.text(a.feature_id+": "+a.feature_function),b.tooltip.style("visibility","visible")}).on("mouseout",function(){return d3.select(this).style("fill",d3.rgb(d3.select(this).style("fill")).brighter()),b.tooltip.style("visibility","hidden")}).on("mousemove",function(){return b.tooltip.style("top",d3.event.pageY+15+"px").style("left",d3.event.pageX-10+"px")}).on("click",function(a){b.options.onClickFunction&&a.feature_id!==b.options.centerFeature?b.options.onClickFunction(this,a,b.options.workspaceId,b.options.genomeId):b.highlight(this,a)}),c.exit().remove(),c.attr("d",function(a){return b.featurePath(a)}),b.xScale=b.xScale.domain([b.options.start,b.options.start+b.options.length]),b.xAxis=b.xAxis.scale(b.xScale),b.axisSvg.call(b.xAxis),b.resize(),this.loading(!0)},featurePath:function(a){for(var b="",c=[],d=0;d<a.feature_location.length;d++){var e=a.feature_location[d],f=this.calcXCoord(e),g=this.calcYCoord(e,a.track),h=this.calcHeight(e),i=this.calcWidth(e);c.push([f,f+i]),b+="+"===e[2]?this.featurePathRight(f,g,h,i)+" ":this.featurePathLeft(f,g,h,i)+" "}if(a.feature_location.length>1){c.sort(function(a,b){return a[0]-b[0]});for(var j=this.calcYCoord(a.feature_location[0],a.track)+this.calcHeight(a.feature_location[0])/2,d=0;d<c.length-1;d++)b+="M"+c[d][1]+" "+j+" L"+c[d+1][0]+" "+j+" Z "}return b},featurePathRight:function(a,b,c,d){var e="M"+a+" "+b;return e+=d>this.options.arrowSize?" L"+(a+(d-this.options.arrowSize))+" "+b+" L"+(a+d)+" "+(b+c/2)+" L"+(a+(d-this.options.arrowSize))+" "+(b+c)+" L"+a+" "+(b+c)+" Z":" L"+(a+d)+" "+(b+c/2)+" L"+a+" "+(b+c)+" Z"},featurePathLeft:function(a,b,c,d){var e="M"+(a+d)+" "+b;return e+=d>this.options.arrowSize?" L"+(a+this.options.arrowSize)+" "+b+" L"+a+" "+(b+c/2)+" L"+(a+this.options.arrowSize)+" "+(b+c)+" L"+(a+d)+" "+(b+c)+" Z":" L"+a+" "+(b+c/2)+" L"+(a+d)+" "+(b+c)+" Z"},calcXCoord:function(a){var b=a[1];return"-"===a[2]&&(b=a[1]-a[3]+1),(b-this.options.start)/this.options.length*this.options.svgWidth},calcYCoord:function(a,b){return this.options.topMargin+this.options.trackMargin+this.options.trackMargin*b+this.options.trackThickness*b},calcWidth:function(a){return Math.floor((a[3]-1)/this.options.length*this.options.svgWidth)},calcHeight:function(a){return this.options.trackThickness},isCenterFeature:function(a){return a.feature_id===this.options.centerFeature},isOperonFeature:function(a){return a.isInOperon},calcFillColor:function(a){return a.feature_id===this.options.centerFeature?"#CCC":1===a.isInOperon?"#FFF":"CDS"===a.feature_type?"#CCC":"#000"},calcFillColorByProtAnnot:function(a,b){return"CDS"!==a.feature_type?"#000":(this.options.annot_namespace="SEED",this.options.annot_level=3,this.colorByAnnot(a,this.options.annot_namespace,this.options.annot_level,b))},colorByAnnot:function(a,b,c,d){if("SEED"===b){if(!a.feature_function)return"#CCC";var e=a.feature_function.replace(/\s+\/.+/,"").replace(/\s+\#.*/,"");return this.seedColorLookup(e,c)}return"#CCC"},seedColorLookup:function(a,c){var d,e=this;if(d=0,e.seedOntology[a]===b)return"#CCC";var f=e.seedOntology[a][c][d];return e.seedColors[c][f]},loadSeedOntology:function(a){for(var c=this.seedOntology,d=this.seedTermsUniq,e=this,f=[],g=3,h=4,i=0;h>i;i++)f[i]=[],d[i]=[];return d3.text("assets/data/subsys.txt",function(a){for(var j=d3.tsv.parseRows(a),k="",l=0;l<j.length;l++)if(""!==j[l][g])for(k=j[l][g],c[k]===b&&(c[k]=[]),f[g][k]===b&&(f[g][k]=!0,d[g].push(k)),i=0;h>i;i++)c[k][i]===b&&(c[k][i]=[]),j[l][i]=""===j[l][i]?"--- "+j[l][i-1]+" ---":j[l][i],c[k][i].push(j[l][i]),f[i][j[l][i]]===b&&(f[i][j[l][i]]=!0,d[i].push(j[l][i]));e.wait_for_seed_load()}),!0},assignSeedColors:function(a){for(var c=this.seedColors,d=["#F00","#900","#C30","#F60","#F90","#FC0","#CF3","#9FC","#9F9","#0C0","#393","#060","#0F9","#0CF","#F39","#39F","#69F","#36C","#00F","#33C","#00C","#FC9","#96F","#C9F","#60C","#C0C","#F99","#F66","#909"],e=d.length,f=4,g=0;f>g;g++){c[g]===b&&(c[g]=[]);for(var h=0;h<a[g].length;h++)c[g][a[g][h]]=d[h%e]}return!0},highlight:function(a,b){this.recenter(b)},recenter:function(a){centerFeature=a.feature_id,this.options.onClickUrl?this.options.onClickUrl(a.feature_id):this.update(!0)},resize:function(){var a=Math.min(this.$elem.parent().width(),this.options.svgWidth);this.svg.attr("width",a)},moveLeftEnd:function(){this.options.start=0,this.update()},moveLeftStep:function(){this.options.start=Math.max(0,this.options.start-Math.ceil(this.options.length/2)),this.update()},zoomIn:function(){this.options.start=Math.min(this.contigLength-Math.ceil(this.options.length/2),this.options.start+Math.ceil(this.options.length/4)),this.options.length=Math.max(1,Math.ceil(this.options.length/2)),this.update()},zoomOut:function(){this.options.length=Math.min(this.contigLength,2*this.options.length),this.options.start=Math.max(0,this.options.start-Math.ceil(this.options.length/4)),this.options.start+this.options.length>this.contigLength&&(this.options.start=this.contigLength-this.options.length),this.update()},moveRightStep:function(){this.options.start=Math.min(this.options.start+Math.ceil(this.options.length/2),this.contigLength-this.options.length),this.update()},moveRightEnd:function(){this.options.start=this.contigLength-this.options.length,this.update()},loading:function(a){a?this.hideMessage():this.showMessage("<img src='"+this.options.loadingImage+"'/>")},showMessage:function(b){var c=a("<span/>").append(b);this.$messagePane.append(c),this.$messagePane.removeClass("kbwidget-hide-message")},hideMessage:function(){this.$messagePane.addClass("kbwidget-hide-message"),this.$messagePane.empty()},getData:function(){return{type:"Contig",id:this.options.contig,workspace:this.options.workspaceId,title:"Contig Browser"}},renderError:function(b){errString="Sorry, an unknown error occurred","string"==typeof b?errString=b:b.error&&b.error.message&&(errString=b.error.message);var c=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+errString);this.$elem.empty(),this.$elem.append(c)},buildObjectIdentity:function(a,b){var c={};return/^\d+$/.exec(a)?c.wsid=a:c.workspace=a,/^\d+$/.exec(b)?c.objid=b:c.name=b,c}})}(jQuery);