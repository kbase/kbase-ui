define(["jquery","bluebird","kb/service/client/workspace","kb/service/client/fba","kb_dataview_widget_modeling_objects","kb/widget/legacy/tabs","kb/widget/legacy/authenticatedWidget","kb_dataview_widget_modeling_biochem_media","kb_dataview_widget_modeling_fba_fba","kb_dataview_widget_modeling_fba_fbaModel","kb_dataview_widget_modeling_fba_fbaModelSet","kb/widget/legacy/helpers","datatables_bootstrap"],function(a,b,c,d,e){"use strict";a.KBWidget({name:"kbaseTabTable",parent:"kbaseAuthenticatedWidget",version:"1.0.0",options:{},init:function(f){function g(a){var b=[],c=a.columns;return c.forEach(function(c){"tabLink"!==c.type&&"wstype"!==c.type||"dispWSRef"!==c.linkformat||q.obj[a.key].forEach(function(a){b.push({ref:a[c.key]})})}),b.length?q.workspace.get_object_info_new({objects:b}).then(function(a){b.forEach(function(b,c){B[b.ref]={name:a[c][1],ws:a[c][7],type:a[c][2].split("-")[0],link:a[c][7]+"/"+a[c][1]}})}):void 0}function h(){for(var a=0;a<w.length;a++){var b=w[a],c=p.tabContent(b.name);if("verticaltbl"!==b.type)if(b.widget){var d=b.keys.split(/\,\s+/g),e={};b.arguments.split(/\,\s+/g).forEach(function(a,b){e[a]=q.obj[d[b]]}),c[b.widget](e)}else{var f=g(b);f?f.then(function(){i(b,c)}):i(b,c)}}}function i(a,b){var c=q.getTableSettings(a,q.obj.data);b.rmLoading(),b.append('<table class="table table-bordered table-striped" style="margin-left: auto; margin-right: auto;">'),b.find("table").dataTable(c),j(a.name)}function j(c){var d=p.tabContent(c).find(".id-click");d.unbind("click"),d.click(function(){var c={id:a(this).data("id"),type:a(this).data("type"),method:a(this).data("method"),ref:a(this).data("ref"),name:a(this).data("name"),ws:a(this).data("ws"),action:a(this).data("action")},d=a("<div>");if(c.method&&"undefined"!==c.method){var e=q.obj[c.method](c);e?(d=a("<div>").loading(),b.resolve(e).then(function(a){d.rmLoading();var b=q.verticalTable({rows:a});d.append(b)})["catch"](function(a){d.append("ERROR")})):void 0===e&&d.append("<br>No data found for "+c.id),p.addTab({name:c.id,content:d,removable:!0}),p.showTab(c.id),j(c.id)}else"openWidget"===c.action&&(d.kbaseTabTable({ws:c.ws,type:c.type,obj:c.name}),p.addTab({name:c.id,content:d,removable:!0}),p.showTab(c.id),j(c.id))})}function k(a){for(var b=[],c=a.columns,d=0;d<c.length;d++){var e=c[d],f=e.key,g=e.type,h=e.linkformat,i=e.method,j=e.action,k={sTitle:e.label,sDefaultContent:"-",mData:l(f,g,h,i,j)};e.width&&(k.sWidth=e.width),b.push(k)}return b}function l(b,c,d,e,f){return function(f){if("tabLink"===c&&"dispIDCompart"===d){var g=f[b];return"dispid"in f&&(g=f.dispid),'<a class="id-click" data-id="'+f[b]+'" data-method="'+e+'">'+g+"</a>"}if("tabLink"===c&&"dispID"===d){var h=f[b];return'<a class="id-click" data-id="'+h+'" data-method="'+e+'">'+h+"</a>"}if("wstype"===c&&"dispWSRef"===d){var i=B[f[b]];return i&&i.link?'<a href="'+r+i.link+'" target="_blank" " class="id-click"" data-ws="'+i.ws+'" data-id="'+i.name+'" data-ref="'+f[b]+'" data-type="'+i.type+'" data-action="openPage"" data-method="'+e+'" data-name="'+i.name+'">'+i.name+"</a>":"no link"}var j=f[b];return a.isArray(j)?"tabLinkArray"===c?m(j,e):f[b].join(", "):j}}function m(a,b){var c=[];return a.forEach(function(a){var d=a.id;"dispid"in a&&(d=a.dispid),c.push('<a class="id-click" data-id="'+a.id+'" data-method="'+b+'">'+d+"</a>")}),c.join(", ")}function n(a){var b={},c=a.split("=");return b.left=c[0].match(/cpd\d*/g),b.right=c[1].match(/cpd\d*/g),b}function o(a){return q.workspace.get_object_info_new({objects:[{ref:a}]}).then(function(a){var b=a[0];return{url:b[7]+"/"+b[1],ref:b[6]+"/"+b[0]+"/"+b[4]}})}this._super(f);var p,q=this,r="#dataview/",s=f.type,t=new e({runtime:this.runtime}),u=s.split(/-/)[0].replace(/\./g,"_"),v=t[u];this.obj=new v(q);for(var w=this.obj.tabList,x=[],y=0;y<w.length;y++){var z=(w[y],a("<div>"));z.loading(),x.push({name:w[y].name,content:z})}if(x[0].active=!0,p=q.$elem.kbTabs({tabs:x}),isNaN(f.ws)&&isNaN(f.obj))var A={workspace:f.ws,name:f.obj};else if(!isNaN(f.ws)&&!isNaN(f.obj))var A={ref:f.ws+"/"+f.obj};if(this.workspace=new c(this.runtime.getConfig("services.workspace.url"),{token:this.runtime.service("session").getAuthToken()}),this.fba=new d(this.runtime.getConfig("services.fba.url"),{token:this.runtime.service("session").getAuthToken()}),this.workspace.get_object_info_new({objects:[A],includeMetadata:1}).then(function(a){q.obj.setMetadata(a[0]);for(var b=0;b<w.length;b++){var c=w[b];if("verticaltbl"===c.type){var d=c.key,e=q.obj[d],f=p.tabContent(c.name),g=q.verticalTable({rows:c.rows,data:e});f.rmLoading(),f.append(g)}}})["catch"](function(a){console.log("ERROR getting object info (new)"),console.log(a)}),isNaN(f.ws)&&isNaN(f.obj))var A={workspace:f.ws,name:f.obj};else if(!isNaN(f.ws)&&!isNaN(f.obj))var A={ref:f.ws+"/"+f.obj};this.workspace.get_objects([A]).then(function(a){var b=q.obj.setData(a[0].data);b&&"done"in b?b.done(function(){h()}):h()})["catch"](function(a){console.log("ERROR getting objects"),console.log(a)});var B={};this.getTableSettings=function(a,b){for(var c=k(a),d={dom:'<"top"lf>rt<"bottom"ip><"clear">',aaData:q.obj[a.key],aoColumns:c,language:{search:"_INPUT_",searchPlaceholder:"Search "+a.name}},e=0;e<a.columns.length;e++){a.columns[e];d.fnDrawCallback=function(){j(a.name)}}return d},this.verticalTable=function(b){for(var c=b.data,d=b.rows,e=a('<table class="table table-bordered" style="margin-left: auto; margin-right: auto;">'),f=0;f<d.length;f++){var g=d[f],h=g.type;if(!("data"in g&&"undefined"==typeof g.data||"key"in g&&"undefined"==typeof c[g.key])){var i=a("<tr>");if(i.append("<td><b>"+g.label+"</b></td>"),"data"in g){var j;j="tabLinkArray"===h?m(g.data,g.method):"tabLink"===h?'<a class="id-click" data-id="'+g.data+'" data-method="'+g.method+'">'+g.dispid+"</a>":g.data,i.append("<td>"+j+"</td>")}else if("key"in g)if("wstype"===g.type){var k=c[g.key],l=a('<td data-ref="'+k+'">loading...</td>');i.append(l),o(k).then(function(a){var b=a.url.split("/")[1],c=a.ref;e.find("[data-ref='"+c+"']").html('<a href="'+r+a.url+'" target="_blank">'+b+"</a>")})}else i.append("<td>"+c[g.key]+"</td>");else"pictureEquation"===g.type&&i.append("<td>"+pictureEquation(g.data)+"</td>");e.append(i)}}return e},this.getBiochemReaction=function(a){return new b.resolve(this.fba.get_reactions({reactions:[a]})).then(function(a){return a[0]})},this.getBiochemCompound=function(a){return new b.resolve(this.fba.get_compounds({compounds:[a]})).then(function(a){return a[0]})},this.getBiochemCompounds=function(a){return new b.resolve(this.fba.get_compounds({compounds:a}))},this.compoundImage=function(a){return"http://bioseed.mcs.anl.gov/~chenry/jpeg/"+a+".jpeg"};var C="http://bioseed.mcs.anl.gov/~chenry/jpeg/";return this.pictureEquation=function(c){for(var d=n(c),e=0;e<d.left.length;e++){var f=d.left[e],g=C+f+".jpeg";panel.append('<div class="pull-left text-center">                                    <img src="'+g+'" width=150 ><br>                                    <div class="cpd-id" data-cpd="'+f+'">'+f+"</div>                                </div>");var h=a('<div class="pull-left text-center">+</div>');h.css("margin","30px 0 0 0"),e<d.left.length-1&&panel.append(h)}var i=a('<div class="pull-left text-center"><=></div>');i.css("margin","25px 0 0 0"),panel.append(i);for(var e=0;e<d.right.length;e++){var f=d.right[e],g=C+f+".jpeg";panel.append('<div class="pull-left text-center">                                    <img src="'+g+'" data-cpd="'+f+'" width=150 ><br>                                    <div class="cpd-id" data-cpd="'+f+'">'+f+"</div>                                </div>");var h=a('<div class="pull-left text-center">+</div>');h.css("margin","25px 0 0 0"),e<d.right.length-1&&panel.append(h)}var j=d.left.concat(d.right);return b.resolve(this.fba.get_compounds({compounds:j})).then(function(b){var c={};for(var d in b)c[b[d].id]=b[d].name;a(".cpd-id").each(function(){a(this).html(c[a(this).data("cpd")])})}),panel},this}})});