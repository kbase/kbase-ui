define(["jquery","kb/service/client/fba","kb/service/client/workspace","kb_dataview_widget_modeling_objects"],function(a,b,c,d){"use strict";function e(d){var e=this;this.modeltabs=d,this.runtime=d.runtime,this.setMetadata=function(b){this.workspace=b[7],this.objName=b[1],this.overview={wsid:b[7]+"/"+b[1],ws:b[7],obj_name:b[1],objecttype:b[2],owner:b[5],instance:b[4],moddate:b[3]},"Name"in b[10]&&(this.usermeta={name:b[10].Name,source:b[10].Source+"/"+b[10]["Source ID"],genome:b[10].Genome,modeltype:b[10].Type,numreactions:b[10]["Number reactions"],numcompounds:b[10]["Number compounds"],numcompartments:b[10]["Number compartments"],numbiomass:b[10]["Number biomasses"],numgapfills:b[10]["Number gapfills"]},a.extend(this.overview,this.usermeta))},this.cmpnamehash={c:"Cytosol",p:"Periplasm",g:"Golgi apparatus",e:"Extracellular",r:"Endoplasmic reticulum",l:"Lysosome",n:"Nucleus",d:"Plastid",m:"Mitochondria",x:"Peroxisome",v:"Vacuole",w:"Cell wall"},this.tabList=[{key:"overview",name:"Overview",type:"verticaltbl",rows:[{label:"Name",key:"name"},{label:"ID",key:"wsid"},{label:"Object type",key:"objecttype",type:"typelink"},{label:"Owner",key:"owner"},{label:"Version",key:"instance"},{label:"Mod-date",key:"moddate"},{label:"Source",key:"source"},{label:"Genome",key:"genome",type:"wstype"},{label:"Model type",key:"modeltype"},{label:"Number reactions",key:"numreactions"},{label:"Number compounds",key:"numcompounds"},{label:"Number compartments",key:"numcompartments"},{label:"Number biomass",key:"numbiomass"},{label:"Number gapfills",key:"numgapfills"}]},{key:"modelreactions",name:"Reactions",type:"dataTable",columns:[{label:"Reaction",type:"tabLink",linkformat:"dispIDCompart",key:"id",method:"ReactionTab",width:"15%"},{label:"Name",key:"name"},{label:"Equation",key:"equation",type:"tabLink",linkformat:"linkequation"},{label:"Genes",key:"genes",type:"tabLinkArray",method:"GeneTab"}]},{key:"modelcompounds",name:"Compounds",type:"dataTable",columns:[{label:"Compound",key:"id",type:"tabLink",linkformat:"dispIDCompart",method:"CompoundTab",width:"15%"},{label:"Name",key:"name"},{label:"Formula",key:"formula"},{label:"Charge",key:"charge"},{label:"Compartment",key:"cmpkbid",type:"tabLink",method:"CompartmentTab",linkformat:"dispID"}]},{key:"modelgenes",name:"Genes",type:"dataTable",columns:[{label:"Gene",key:"id",type:"tabLink",method:"GeneTab"},{label:"Reactions",key:"reactions",type:"tabLinkArray",method:"ReactionTab"}]},{key:"modelcompartments",name:"Compartments",type:"dataTable",columns:[{label:"Compartment",key:"id",type:"tabLink",method:"CompartmentTab",linkformat:"dispID"},{label:"Name",key:"name"},{label:"pH",key:"pH"},{label:"Potential",key:"potential"}]},{key:"biomasscpds",name:"Biomass",type:"dataTable",columns:[{label:"Biomass",key:"biomass",type:"tabLink",method:"BiomassTab",linkformat:"dispID"},{label:"Compound",key:"id",type:"tabLink",linkformat:"dispIDCompart",method:"CompoundTab"},{label:"Name",key:"name"},{label:"Coefficient",key:"coefficient"},{label:"Compartment",key:"cmpkbid",type:"tabLink",linkformat:"dispID",method:"CompartmentTab"}]},{key:"gapfillings",name:"Gapfilling",type:"dataTable",columns:[{label:"Gapfill",key:"simpid",linkformat:"dispID",type:"tabLink",method:"GapfillTab"},{label:"Integrated",key:"integrated"},{label:"Media",key:"media_ref",linkformat:"dispWSRef",type:"wstype",wstype:"KBaseFBA.Media"}]}],this.ReactionTab=function(a){var c=e.rxnhash[a.id],d=[{label:"Reaction",data:c.dispid},{label:"Name",data:c.name}];if("pathway"in c&&d.push({label:"Pathway",data:c.pathway}),"reference"in c&&d.push({label:"Reference",data:c.reference}),d.push({label:"Compartment",data:e.cmphash[c.cmpkbid].name+" "+e.cmphash[c.cmpkbid].compartmentIndex},{label:"Equation",data:c.equation,type:"pictureEquation"},{label:"GPR",data:c.gpr}),"rxn00000"!==c.rxnkbid){var f=new b(e.runtime.getConfig("services.fba.url"),{token:e.runtime.service("session").getAuthToken()});return f.get_reactions({reactions:[c.rxnkbid],biochemistry:e.biochem,biochemistry_workspace:e.biochemws}).then(function(a){"deltaG"in a[0]&&d.push({label:"Delta G",data:a[0].deltaG+" ("+a[0].deltaGErr+") kcal/mol"}),d.push({label:"Enzymes",data:a[0].enzymes.join(", ")});for(var b={},c=[],e=0;e<a[0].aliases.length;e++)a[0].aliases[e]in b||(c.push(a[0].aliases[e]),b[a[0].aliases[e]]=1);return d.push({label:"Aliases",data:c.join(", ")}),d})}return d},this.GeneTab=function(a){var b;return e.modelgenes.forEach(function(c){c.id===a.id&&(b=[{label:"ID",data:c.id},{label:"Reactions",data:c.reactions,type:"tabLinkArray",method:"ReactionTab"}])}),b},this.CompoundTab=function(a){var c=e.cpdhash[a.id],d=[{label:"Compound",data:c.dispid},{label:"Name",data:c.name},{label:"Formula",data:c.formula},{label:"Charge",data:c.charge},{label:"Compartment",data:c.cmpkbid,dispid:e.cmphash[c.cmpkbid].name+" "+e.cmphash[c.cmpkbid].compartmentIndex,type:"tabLink","function":"CompartmentTab"}];if("cpd00000"!==c.cpdkbid){var f=new b(e.runtime.getConfig("services.fba.url"),{token:e.runtime.service("session").getAuthToken()});return f.get_compounds({compounds:[c.cpdkbid],biochemistry:e.biochem,biochemistry_workspace:e.biochemws}).then(function(a){"deltaG"in a[0]&&d.push({label:"Delta G",data:a[0].deltaG+" ("+a[0].deltaGErr+") kcal/mol"});for(var b={},c=[],e=0;e<a[0].aliases.length;e++)a[0].aliases[e]in b||(c.push(a[0].aliases[e]),b[a[0].aliases[e]]=1);return d.push({label:"Aliases",data:c.join(", ")}),d})}return d},this.CompartmentTab=function(a){var b=e.cmphash[a.id],c=[{label:"Compartment",data:b.id},{label:"Name",data:b.name},{label:"pH",data:b.pH},{label:"potential",data:b.potential}];return c},this.BiomassTab=function(a){var b=e.biohash[a.id],c=[{label:"Biomass",data:b.id},{label:"Name",data:b.name},{label:"DNA fraction",data:b.dna},{label:"RNA fraction",data:b.RNA},{label:"Protein fraction",data:b.protein},{label:"Cell wall fraction",data:b.cellwall},{label:"Lipid fraction",data:b.lipid},{label:"Cofactor fraction",data:b.cofactor},{label:"Other fraction",data:b.other},{label:"Energy mols",data:b.energy},{label:"Equation",data:b.equation}];return c},this.GapfillTab=function(a){var b,d=a.id,f=e.gfhash[d];if("gapfill_ref"in f?b=f.gapfill_ref:"fba_ref"in f&&(b=f.fba_ref),"output"in f)return f.output;var g=new c(this.runtime.getConfig("services.workspace.url"),{token:this.runtime.service("session").getAuthToken()});return g.get_objects([{ref:b}]).then(function(a){var b=a[0].data.gapfillingSolutions;return e.parse_gf_solutions(b)}).then(function(a){"1"===f.integrated?f.integrated="yes":"0"===f.integrated&&(f.integrated="no"),f.output=[{label:"Gapfill ID",data:f.simpid},{label:"Media",linkformat:"dispWSRef",type:"wstype",wstype:"KBaseFBA.Media",data:f.media_ref},{label:"Integrated",data:f.integrated}],"yes"===f.integrated&&f.output.push({label:"Integrated solution",data:f.integrated_solution});for(var b="",c=0;c<a.length;c++)for(var d=a[c].gapfillingSolutionReactions,e=0;e<d.length;e++)e>0&&(b+="<br>"),b+=d[e].id,"equation"in d[e]&&(b+=":"+d[e].equation);return f.output.push({label:"Solution "+c,data:b}),f.output})},this.parse_gf_solutions=function(a){for(var c={},d="kbase",e="default",f=0;f<a.length;f++)for(var g=a[f].gapfillingSolutionReactions,h=0;h<g.length;h++){var i=g[h].reaction_ref.split("/");g[h].id=i.pop(),g[h].id.match(/^rxn\d\d\d\d\d$/)&&"reactions"===i[3]&&(d=i[0],e=i[1],c[g[h].id]=g[h])}var j=new Array;for(var k in c)j.push(k);if(j.length>0){var l=new b(this.runtime.getConfig("services.fba.url"),{token:this.runtime.service("session").getAuthToken()});return l.get_reactions({reactions:j,biochemistry:e,biochemistry_workspace:d}).then(function(b){for(var d=0;d<b.length;d++)b[d]&&(c[b[d].id].equation=b[d].definition);return a})}return a},this.setData=function(a){this.data=a,this.modelreactions=this.data.modelreactions,this.modelcompounds=this.data.modelcompounds,this.modelgenes=[],this.modelcompartments=this.data.modelcompartments,this.biomasses=this.data.biomasses,this.biomasscpds=[],this.gapfillings=this.data.gapfillings,this.cpdhash={},this.biohash={},this.rxnhash={},this.cmphash={},this.genehash={},this.gfhash={},this.biochemws="kbase",this.biochem="default";for(var b=0;b<this.gapfillings.length;b++)this.gapfillings[b].simpid="gf."+(b+1),this.gfhash[this.gapfillings[b].simpid]=this.gapfillings[b];for(var b=0;b<this.modelcompartments.length;b++){var c=this.modelcompartments[b];c.cmpkbid=c.compartment_ref.split("/").pop(),c.name=e.cmpnamehash[c.cmpkbid],this.cmphash[c.id]=c}for(var b=0;b<this.modelcompounds.length;b++){var d=this.modelcompounds[b],f=d.id.split("_");if(d.dispid=f[0]+"["+f[1]+"]",d.cmpkbid=d.modelcompartment_ref.split("/").pop(),d.cpdkbid=d.compound_ref.split("/").pop(),void 0===d.name&&(d.name=d.dispid),d.name=d.name.replace(/_[a-zA-z]\d+$/,""),this.cpdhash[d.id]=d,"cpd00000"!==d.cpdkbid){var g=d.compound_ref.split("/");this.biochemws=g[0],this.biochem=g[1],this.cpdhash[d.cpdkbid+"_"+d.cmpkbid]=d,f[0]!==d.cpdkbid&&(d.dispid+="<br>("+d.cpdkbid+")")}}for(var b=0;b<this.biomasses.length;b++){var h=this.biomasses[b];this.biohash[h.id]=h,h.dispid=h.id;for(var i="",j="",k=0;k<h.biomasscompounds.length;k++){var l=h.biomasscompounds[k];l.id=l.modelcompound_ref.split("/").pop();var f=l.id.split("_");if(l.dispid=f[0]+"["+f[1]+"]",l.name=this.cpdhash[l.id].name,l.formula=this.cpdhash[l.id].formula,l.charge=this.cpdhash[l.id].charge,l.cmpkbid=this.cpdhash[l.id].cmpkbid,l.biomass=h.id,this.biomasscpds.push(l),l.coefficient<0){if(i.length>0&&(i+=" + "),-1!==l.coefficient){var m=Math.round(-100*l.coefficient)/100;i+="("+m+") "}i+=l.name+"["+l.cmpkbid+"]"}else{if(j.length>0&&(j+=" + "),1!==l.coefficient){var m=Math.round(100*l.coefficient)/100;j+="("+m+") "}j+=l.name+"["+l.cmpkbid+"]"}}h.equation=i+" => "+j}for(var b=0;b<this.modelreactions.length;b++){var n=this.modelreactions[b],f=n.id.split("_");n.dispid=f[0]+"["+f[1]+"]",n.rxnkbid=n.reaction_ref.split("/").pop(),n.cmpkbid=n.modelcompartment_ref.split("/").pop(),n.name=n.name.replace(/_[a-zA-z]\d+$/,""),n.gpr="","CustomReaction"===n.name&&(n.name=n.dispid),this.rxnhash[n.id]=n,"rxn00000"!==n.rxnkbid&&(this.rxnhash[n.rxnkbid+"_"+n.cmpkbid]=n,n.rxnkbid!==f[0]&&(n.dispid+="<br>("+n.rxnkbid+")"));var i="",j="",o="<=>";">"===n.direction?o="=>":"<"===n.direction&&(o="<="),n.modelReactionProteins>0&&(n.gpr="");for(var k=0;k<n.modelReactionReagents.length;k++){var p=n.modelReactionReagents[k];if(p.cpdkbid=p.modelcompound_ref.split("/").pop(),p.coefficient<0){if(i.length>0&&(i+=" + "),-1!==p.coefficient){var m=Math.round(-100*p.coefficient)/100;i+="("+m+") "}i+=this.cpdhash[p.cpdkbid].name+"["+this.cpdhash[p.cpdkbid].cmpkbid+"]"}else{if(j.length>0&&(j+=" + "),1!==p.coefficient){var m=Math.round(100*p.coefficient)/100;j+="("+m+") "}j+=this.cpdhash[p.cpdkbid].name+"["+this.cpdhash[p.cpdkbid].cmpkbid+"]"}}n.ftrhash={};for(var k=0;k<n.modelReactionProteins.length;k++){var q=n.modelReactionProteins[k];k>0&&(n.gpr+=" or "),n.gpr+="(";for(var r=0;r<q.modelReactionProteinSubunits.length;r++){var s=q.modelReactionProteinSubunits[r];r>0&&(n.gpr+=" and "),n.gpr+="(",0===s.feature_refs.length&&(n.gpr+="Unknown");for(var t=0;t<s.feature_refs.length;t++){var u=s.feature_refs[t].split("/").pop();n.ftrhash[u]=1,t>0&&(n.gpr+=" or "),n.gpr+=u}n.gpr+=")"}n.gpr+=")"}n.dispfeatures="",n.genes=[];for(var v in n.ftrhash){n.genes.push({id:v});var w=[];this.modelgenes.forEach(function(a){w.push(a.id)}),-1===w.indexOf(v)?this.modelgenes.push({id:v,reactions:[{id:n.id,dispid:n.dispid}]}):this.modelgenes[w.indexOf(v)].reactions.push({id:n.id,dispid:n.dispid})}n.equation=i+" "+o+" "+j}}}d.prototype.KBaseFBA_FBAModel=e});