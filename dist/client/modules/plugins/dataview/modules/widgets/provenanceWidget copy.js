define(["jquery","kb.runtime","kb.html","d3","d3-sankey","css!d3-sankey-css","kb.jquery.authenticatedwidget"],function(a,b,c,d){"use strict";a.KBWidget({name:"KBaseWSObjGraphCenteredView",parent:"kbaseAuthenticatedWidget",version:"1.0.0",wsUrl:null,ws:null,options:{wsNameOrId:null,objNameOrId:null,width:1200,height:700,token:null,ws_url:null},wsNameOrId:"",objNameOrId:"",wsId:null,objData:{},objRefToNodeIdx:null,graph:null,init:function(a){this._super(a);var d=this;return d.$elem.append("This is a visualization of the relationships between this piece of data and other data in KBase.  Mouse over objects to show additional information (shown below the graph). Double click on an object to select and recenter the graph on that object in a new window.<br><br>"),d.$elem.append(c.loading("building object reference graph...")),b.isLoggedIn()?d.ws=new Workspace(b.getConfig("services.workspace.url"),{token:b.getAuthToken()}):d.ws=new Workspace(b.getConfig("services.workspace.url")),d.wsNameOrId=a.wsNameOrId,d.$elem.append('<div id="objgraphview" style="overflow:auto;height:450px;resize:vertical">'),d.needColorKey=!0,d.buildDataAndRender(d.getObjectIdentity(a.wsNameOrId,a.objNameOrId)),this},typeToColor:{selected:"#FF9800",core:"#FF9800",ref:"#C62828",included:"#2196F3",none:"FFFFFF",copied:"#4BB856"},typeToName:{selected:" Current version",core:" All Versions of this Data",ref:" Data Referencing this Data",included:" Data Referenced by this Data",copied:"Copied From"},needColorKey:!1,addNodeColorKey:function(){var a=this;if(a.needColorKey){var b='<br><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td valign="top"><table cellpadding="2" cellspacing="0" border="0" id="graphkey" 				style="">';for(var c in a.typeToName)"selected"!==c&&(b+='<tr><td><svg width="40" height="20"><rect x="0" y="0" width="40" height="20" fill="'+a.typeToColor[c]+'" 		     /></svg></td><td valign="middle"><b> 		    '+a.typeToName[c]+"</b></td></tr>");b+='</table></td><td><div id="objdetailsdiv"></div></td></tr></table>',a.$elem.append(b),a.needColorKey=!1}},renderSankeyStyleGraph:function(){var b=this;0===b.graph.links.length&&(b.graph.nodes.push({node:1,name:"No references found",info:[-1,"No references found","No Type",0,0,"N/A",0,"N/A",0,0,{}],nodeType:"none",objId:"-1",isFake:!0}),b.objRefToNodeIdx[-1]=1,b.graph.links.push({target:0,source:1,value:1}));var c={top:10,right:10,bottom:10,left:10},e=b.options.width-50-c.left-c.right,f=38*b.graph.nodes.length-c.top-c.bottom;d.scale.category20();450>f&&b.$elem.find("#objgraphview").height(f+40),d.select(b.$elem.find("#objgraphview")[0]).html(""),b.$elem.find("#objgraphview").show();var g=d.select(b.$elem.find("#objgraphview")[0]).append("svg");g.attr("width",e+c.left+c.right).attr("height",f+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")");var h=d.sankey().nodeWidth(25).nodePadding(40).size([e,f]),i=h.link();h.nodes(b.graph.nodes).links(b.graph.links).layout(40);var j=g.append("g").selectAll(".link").data(b.graph.links).enter().append("path").attr("class","sankeylink").attr("d",i).style("stroke-width",function(a){return 10}).sort(function(a,b){return b.dy-a.dy});j.append("title").text(function(a){return"copied"===a.source.nodeType?a.text=a.target.name+" copied from "+a.source.name:"core"===a.source.nodeType?a.text=a.target.name+" is a newer version of "+a.source.name:"ref"===a.source.nodeType?a.text=a.source.name+" references "+a.target.name:"included"===a.source.nodeType&&(a.text=a.target.name+" references "+a.source.name),a.text}),a(j).tooltip({delay:{show:0,hide:100}});var k=g.append("g").selectAll(".node").data(b.graph.nodes).enter().append("g").attr("class","sankeynode").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).call(d.behavior.drag().origin(function(a){return a}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",function(a){d.select(this).attr("transform","translate("+(a.x=Math.max(0,Math.min(e-a.dx,d.event.x)))+","+(a.y=Math.max(0,Math.min(f-a.dy,d.event.y)))+")"),h.relayout(),j.attr("d",i)})).on("dblclick",function(a){d.event.defaultPrevented||(a.isFake?alert("Cannot expand this node."):a.info[1].indexOf(" ")>=0?window.location.href="#/objgraphview/"+encodeURI(a.info[7]+"/"+a.info[0]):window.location.href="#/objgraphview/"+encodeURI(a.info[7]+"/"+a.info[1]))}).on("mouseover",function(a){if(a.isFake){var c=a.info,d=(new Date(c[3]),'<center><table cellpadding="2" cellspacing="0" class="table table-bordered"><tr><td>');d+='<h4>Object Details</h4><table cellpadding="2" cellspacing="0" border="0" class="table table-bordered table-striped">',d+="<tr><td><b>Name</b></td><td>"+c[1]+"</td></tr>",d+="</td></tr></table></td><td>",d+='<h4>Provenance</h4><table cellpadding="2" cellspacing="0" class="table table-bordered table-striped">',d+="<tr><td><b>N/A</b></td></tr>",d+="</table>",d+="</td></tr></table>",b.$elem.find("#objdetailsdiv").html(d)}else b.ws.get_object_provenance([{ref:a.objId}],function(c){var d=a.info,e='<center><table cellpadding="2" cellspacing="0" class="table table-bordered"><tr><td>';e+='<h4>Data Object Details</h4><table cellpadding="2" cellspacing="0" border="0" class="table table-bordered table-striped">',e+="<tr><td><b>Name</b></td><td>"+d[1]+' (<a href="#/dataview/'+d[6]+"/"+d[1]+"/"+d[4]+'" target="_blank">'+d[6]+"/"+d[0]+"/"+d[4]+"</a>)</td></tr>",e+='<tr><td><b>Type</b></td><td><a href="#/spec/type/'+d[2]+'">'+d[2]+"</a></td></tr>",e+="<tr><td><b>Saved on</b></td><td>"+b.getTimeStampStr(d[3])+"</td></tr>",e+='<tr><td><b>Saved by</b></td><td><a href="#/people/'+d[5]+'" target="_blank">'+d[5]+"</td></tr>";var f=!1,g='<tr><td><b>Meta data</b></td><td><div style="width:250px;word-wrap: break-word;">';for(var h in d[10])f=!0,g+="<b>"+h+"</b> : "+d[10][h]+"<br>";if(f&&(e+=g+"</div></td></tr>"),e+="</div></td></tr></table></td><td>",e+='<h4>Provenance</h4><table cellpadding="2" cellspacing="0" class="table table-bordered table-striped">',c.length>0)if(c[0].copied&&(e+=b.getTableRow("Copied from",'<a href="#/dataview/'+c[0].copied+'" target="_blank">'+c[0].copied+"</a>")),c[0].provenance.length>0)for(var i="",j=0;j<c[0].provenance.length;j++)c[0].provenance.length>1&&(i="Action "+j+": "),e+=b.getProvRows(c[0].provenance[j],i);else e+='<tr><td></td><td><b><span style="color:red">No provenance data set.</span></b></td></tr>';else e+='<tr><td></td><td><b><span style="color:red">No provenance data set.</span></b></td></tr>';e+="</table>",e+="</td></tr></table>",b.$elem.find("#objdetailsdiv").html(e)},function(c){var d=a.info,e='<center><table cellpadding="2" cellspacing="0" class="table table-bordered"><tr><td>';e+='<h4>Data Object Details</h4><table cellpadding="2" cellspacing="0" border="0" class="table table-bordered table-striped">',e+="<tr><td><b>Name</b></td><td>"+d[1]+'(<a href="#/dataview/'+d[6]+"/"+d[1]+"/"+d[4]+'" target="_blank">'+d[6]+"/"+d[0]+"/"+d[4]+"</a>)</td></tr>",e+='<tr><td><b>Type</b></td><td><a href="#/spec/type/'+d[2]+'">'+d[2]+"</a></td></tr>",e+="<tr><td><b>Saved on</b></td><td>"+b.getTimeStampStr(d[3])+"</td></tr>",e+='<tr><td><b>Saved by</b></td><td><a href="#/people/'+d[5]+'" target="_blank">'+d[5]+"</td></tr>";var f=!1,g='<tr><td><b>Meta data</b></td><td><div style="width:250px;word-wrap: break-word;">';for(var h in d[10])f=!0,g+="<b>"+h+"</b> : "+d[10][h]+"<br>";f&&(e+=g+"</div></td></tr>"),e+="</div></td></tr></table></td><td>",e+='<h4>Provenance</h4><table cellpadding="2" cellspacing="0" class="table table-bordered table-striped">',e+="error in fetching provenance",e+="</table>",e+="</td></tr></table>",b.$elem.find("#objdetailsdiv").html(e),console.error(c)})});return k.append("rect").attr("y",function(a){return-5}).attr("height",function(a){return Math.abs(a.dy)+10}).attr("width",h.nodeWidth()).style("fill",function(a){return a.color=b.typeToColor[a.nodeType]}).style("stroke",function(a){return 0*d.rgb(a.color).darker(2)}).append("title").html(function(a){var c=a.info,d=c[1]+" ("+c[6]+"/"+c[0]+"/"+c[4]+")\n--------------\n  type:  "+c[2]+"\n  saved on:  "+b.getTimeStampStr(c[3])+"\n  saved by:  "+c[5]+"\n",e=!1,f="  metadata:\n";for(var g in c[10])d+="     "+g+" : "+c[10][g]+"\n",e=!0;return e&&(d+=f),d}),k.append("text").attr("y",function(a){return a.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(a){return a.name}).filter(function(a){return a.x<e/2}).attr("x",6+h.nodeWidth()).attr("text-anchor","start"),this},getProvRows:function(a,b){var c=this,d="";return"description"in a&&(d+=c.getTableRow(b+"Description",a.description)),"service"in a&&(d+=c.getTableRow(b+"Service Name",a.service)),"service_ver"in a&&(d+=c.getTableRow(b+"Service Version",a.service_ver)),"method"in a&&(d+=c.getTableRow(b+"Method",a.method)),"method_params"in a&&(d+=c.getTableRow(b+"Method Parameters",JSON.stringify(c.scrub(a.method_params),null,"  "))),"script"in a&&(d+=c.getTableRow(b+"Command Name",a.script)),"script_ver"in a&&(d+=c.getTableRow(b+"Script Version",a.script_ver)),"script_command_line"in a&&(d+=c.getTableRow(b+"Command Line Input",a.script_command_line)),"intermediate_incoming"in a&&a.intermediate_incoming.length>0&&(d+=c.getTableRow(b+"Action Input",JSON.stringify(a.intermediate_incoming,null,"  "))),"intermediate_outgoing"in a&&a.intermediate_outgoing.length>0&&(d+=c.getTableRow(b+"Action Output",JSON.stringify(a.intermediate_outgoing,null,"  "))),"external_data"in a&&a.external_data.length>0&&(d+=c.getTableRow(b+"External Data",c.formatProvenanceExternalData(a.external_data),null,"  ")),"time"in a&&(d+=c.getTableRow(b+"Timestamp",c.getTimeStampStr(a.time))),d},formatProvenanceExternalData:function(a){for(var b=this,c="",d=0;d<a.length;d++)edu=a[d],"resource_name"in edu&&(c+="<b>Resource Name</b><br/>","resource_url"in edu&&(c+='<a target="_blank" href='+edu.resource_url,c+=">"),c+=edu.resource_name,"resource_url"in edu&&(c+="</a>"),c+="<br/>"),"resource_version"in edu&&(c+="<b>Resource Version</b><br/>",c+=edu.resource_version+"<br/>"),"resource_release_date"in edu&&(c+="<b>Resource Release Date</b><br/>",c+=b.getTimeStampStr(edu.resource_release_date)+"<br/>"),"data_id"in edu&&(c+="<b>Data ID</b><br/>","data_url"in edu&&(c+='<a target="_blank" href='+edu.data_url,c+=">"),c+=edu.data_id,"data_url"in edu&&(c+="</a>"),c+="<br/>"),"description"in edu&&(c+="<b>Description</b><br/>",c+=edu.description+"<br/>");return c},scrub:function(a){if(a&&a.constructor===Array)for(var b=0;b<a.length;b++)a[b]&&"object"==typeof a[b]&&a[b].hasOwnProperty("auth")&&delete a[b].auth;return a},getTableRow:function(a,b){return'<tr><td style="max-width:250px;"><b>'+a+'</b></td><td style="max-width:300px;"><div style="max-width:300px;max-height:250px;overflow-y:auto;white-space:pre;word-wrap: break-word;">'+b+"</div></td></tr>"},getNodeLabel:function(a){return a[1]+" (v"+a[4]+")"},tempRefData:null,buildDataAndRender:function(b){var c=this;c.$elem.find("#loading-mssg").show(),c.$elem.find("#objgraphview").hide(),c.graph={nodes:[],links:[]},c.objRefToNodeIdx={},c.ws.get_object_history(b,function(b){for(var d=[],e=0,f="",g=0;g<b.length;g++){var h=(b[g][2].split("-")[0],b[g][6]+"/"+b[g][0]+"/"+b[g][4]),i=c.graph.nodes.length;c.graph.nodes.push({node:i,name:c.getNodeLabel(b[g]),info:b[g],nodeType:"core",objId:h}),b[g][4]>e&&(e=b[g][4],f=h),c.objRefToNodeIdx[h]=i,d.push({ref:h})}f.length>0&&(c.graph.nodes[c.objRefToNodeIdx[f]].nodeType="selected");var j=[c.ws.list_referencing_objects(d,function(a){for(var b=0;b<a.length;b++)for(var e=50,f=0;f<a[b].length;f++){if(f>=e){var g=c.graph.nodes.length,h=a[b].length-e+" more ...";c.graph.nodes.push({node:g,name:h,info:[-1,h,"Multiple Types",0,0,"N/A",0,"N/A",0,0,{}],nodeType:"ref",objId:"-1",isFake:!0}),c.objRefToNodeIdx[j]=g,null!=c.objRefToNodeIdx[d[b].ref]&&c.graph.links.push({source:c.objRefToNodeIdx[d[b].ref],target:g,value:1});break}var i=a[b][f],j=(i[2].split("-")[0],i[6]+"/"+i[0]+"/"+i[4]),g=c.graph.nodes.length;c.graph.nodes.push({node:g,name:c.getNodeLabel(i),info:i,nodeType:"ref",objId:j}),c.objRefToNodeIdx[j]=g,null!=c.objRefToNodeIdx[d[b].ref]&&c.graph.links.push({source:c.objRefToNodeIdx[d[b].ref],target:g,value:1})}},function(a){c.$elem.find("#loading-mssg").hide(),c.$elem.append("<br><b>Error in building object graph!</b><br>"),c.$elem.append("<i>Error was:</i></b> &nbsp "),c.$elem.append(a.error.message+"<br>"),console.error("Error in building object graph!"),console.error(a)}),c.ws.get_object_provenance(d,function(a){for(var b={},e=[],f=[],g=0;g<a.length;g++){for(var h=0;h<a[g].refs.length;h++)a[g].refs[h]in b||(b[a[g].refs[h]]="included",e.push({ref:a[g].refs[h]})),f.push({source:a[g].refs[h],target:d[g].ref,value:1});for(var i=0;i<a[g].provenance.length;i++)if(a[g].provenance[i].hasOwnProperty("resolved_ws_objects"))for(var j=0;j<a[g].provenance[i].resolved_ws_objects.length;j++)a[g].provenance[i].resolved_ws_objects[j]in b||(b[a[g].provenance[i].resolved_ws_objects[j]]="included",e.push({ref:a[g].provenance[i].resolved_ws_objects[j]})),f.push({source:a[g].provenance[i].resolved_ws_objects[j],target:d[g].ref,value:1});if(a[g].hasOwnProperty("copied")){var k=a[g].copied.split("/")[0]+"/"+a[g].copied.split("/")[1],l=d[g].ref.split("/")[0]+"/"+d[g].ref.split("/")[1];k!==l&&(a[g].copied in b||(b[a[g].copied]="copied",e.push({ref:a[g].copied})),f.push({source:a[g].copied,target:d[g].ref,value:1}))}}c.tempRefData={uniqueRefs:b,uniqueRefObjectIdentities:e,links:f}},function(a){c.$elem.find("#loading-mssg").hide(),c.$elem.append("<br><b>Error in building object graph!</b><br>"),c.$elem.append("<i>Error was:</i></b> &nbsp "),c.$elem.append(a.error.message+"<br>"),console.error("Error in building object graph!"),console.error(a)})];a.when.apply(a,j).done(function(){if("uniqueRefObjectIdentities"in c.tempRefData)if(c.tempRefData.uniqueRefObjectIdentities.length>0){var b=[c.ws.get_object_info_new({objects:c.tempRefData.uniqueRefObjectIdentities,includeMetadata:1,ignoreErrors:1},function(a){for(var b={},d=0;d<a.length;d++)a[d]&&(b[a[d][6]+"/"+a[d][0]+"/"+a[d][4]]=a[d]);var e=c.tempRefData.uniqueRefs;for(var f in e){var g=b[f];if(g){var h=(g[2].split("-")[0],g[6]+"/"+g[0]+"/"+g[4]),i=c.graph.nodes.length;c.graph.nodes.push({node:i,name:c.getNodeLabel(g),info:g,nodeType:e[f],objId:h}),c.objRefToNodeIdx[h]=i}}for(var j=c.tempRefData.links,d=0;d<j.length;d++)null!=c.objRefToNodeIdx[j[d].source]&&null!=c.objRefToNodeIdx[j[d].target]&&c.graph.links.push({source:c.objRefToNodeIdx[j[d].source],target:c.objRefToNodeIdx[j[d].target],value:j[d].value})},function(a){var b=c.tempRefData.uniqueRefs;for(var d in b){var e=c.graph.nodes.length,f=d.split("/");c.graph.nodes.push({node:e,name:d,info:[f[1],"Data not found, object may be deleted","Unknown","",f[2],"Unknown",f[0],f[0],"Unknown","Unknown",{}],nodeType:b[d],objId:d}),c.objRefToNodeIdx[d]=e}for(var g=c.tempRefData.links,h=0;h<g.length;h++)c.graph.links.push({source:c.objRefToNodeIdx[g[h].source],target:c.objRefToNodeIdx[g[h].target],value:g[h].value})})];a.when.apply(a,b).done(function(){c.finishUpAndRender()}).fail(function(){c.finishUpAndRender()})}else c.finishUpAndRender();else c.finishUpAndRender()})},function(a){c.$elem.find("#loading-mssg").hide(),c.$elem.append("<br><b>Error in building object graph!</b><br>"),c.$elem.append("<i>Error was:</i></b> &nbsp "),c.$elem.append(a.error.message+"<br>"),console.error("Error in building object graph!"),console.error(a)})},finishUpAndRender:function(){var a=this;a.addVersionEdges(),a.renderSankeyStyleGraph(),a.addNodeColorKey(),a.$elem.find("#loading-mssg").hide()},addVersionEdges:function(){for(var a=this,b=0;b<a.graph.nodes.length;b++)if("copied"!==a.graph.nodes[b].nodeType){var c=a.graph.nodes[b].info[4]+1,d=a.graph.nodes[b].info[6]+"/"+a.graph.nodes[b].info[0]+"/"+c;d in a.objRefToNodeIdx&&a.graph.links.push({source:a.objRefToNodeIdx[a.graph.nodes[b].objId],target:a.objRefToNodeIdx[d],value:1})}},getData:function(){return{title:"Data Object Reference Network",workspace:this.wsNameOrId,id:"This view shows the data reference connections to object "+this.options.objNameOrId}},getObjectIdentity:function(a,b,c){return c?{ref:a+"/"+b+"/"+c}:{ref:a+"/"+b}},getTimeStampStr:function(a){if(!a)return"";var b=new Date(a),c=Math.floor((new Date-b)/1e3);if(isNaN(c)){var d=a.split("+"),e=d[0]+"+"+d[0].substr(0,2)+":"+d[1].substr(2,2);if(b=new Date(e),c=Math.floor((new Date-b)/1e3),isNaN(c))return b=new Date(d[0]),this.monthLookup[b.getMonth()]+" "+b.getDate()+", "+b.getFullYear()}return this.monthLookup[b.getMonth()]+" "+b.getDate()+", "+b.getFullYear()},monthLookup:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]})});