define(["jquery","bluebird","kb/service/client/workspace","kb/common/html","kb/service/utils","kb_types"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){var c=f.getViewer({type:a});if(c&&b.sub&&b.subid){if(!c.sub)throw new Error("Sub was specified, but config has no sub handler, sub:"+b.sub);if(!c.sub.hasOwnProperty(b.sub))throw new Error("Sub was specified, but config has no correct sub handler, sub:"+b.sub+"config:");c=c.sub[b.sub]}return c}function i(a){return a.objectVersion=a.ver,new b(function(d,f){var i=new c(R.getConfig("services.workspace.url"),{token:R.getAuthToken()}),j=[{ref:a.workspaceId+"/"+a.objectId}];b.resolve(i.get_object_info_new({objects:j,ignoreErrors:1,includeMetadata:1})).then(function(b){if(0===b.length)return void f("Object not found");if(b.length>1)return void f("Too many ("+b.length+") objects found.");if(null===b[0])return void f("Null object returned");var c=e.object_info_to_object(b[0]),i=e.parseTypeId(c.type),j=h(i,a);if(!j)return void f("Not Found","Sorry, cannot find widget for "+i.module+"."+i.name);var k={workspaceId:a.workspaceId,objectId:a.objectId,objectName:c.name,workspaceName:c.ws,objectVersion:c.version,objectType:c.type,type:c.type};j.options&&j.options.forEach(function(a){var b=k[a.from];if(!b&&a.optional!==!0)throw"Missing param, from "+a.from+", to "+a.to;k[a.to]=b});var i=j.type||"kbwidget";switch(i){case"kbwidget":var l=g.make({module:j.module,jquery_object:j.jquery_object||j.widget,panel:j.panel,title:j.title});d({widget:l,params:k});break;case"widgetBase":require([j.module],function(a){d({widget:Object.create(a),params:k})});break;case"widgetFactory":require([j.module],function(a){d({widget:a.make(),params:k})});break;default:f("Invalid type "+i+" in widget mapping")}})["catch"](function(a){f(a)})})}function j(c){function e(a){var b;b="string"==typeof a?a:a.message?a.message:a.error&&a.error.error?a.error.error.message:"Unknown Error",m.innerHTML=d.bsPanel("Error",b)}function f(c){return new b(function(b){l=c,m=document.createElement("div"),n=a(m),l.appendChild(m),b()})}function g(a){return new b(function(b,d){var f;i(a).then(function(a){return o=a.widget,f=a.params,o.init?o.init(c):null}).then(function(){return o.attach(m)}).then(function(){return o.start(f)}).then(function(){})["catch"](function(a){e(a),d(a)})})}function h(){return new b(function(a,b){o&&o.stop?o.stop().then(function(){a()})["catch"](function(a){b(a)}):a()})}function j(){return new b(function(a,b){o&&o.detach?o.detach().then(function(){a()})["catch"](function(a){b(a)}):a()})}function k(){return new b(function(a){o&&o.destroy?o.destroy().then(function(){a()})["catch"](function(a){reject(a)}):a()})}var l,m,n,o;c.runtime;return{attach:f,start:g,stop:h,detach:j,destroy:k}}return{create:function(a){return j(a)}}});