define(["nunjucks","jquery","promise","kb.utils","kb.alert","kb.html","kb_plugin_dataview"],function(a,b,c,d,e,f,g){"use strict";var h=Object.create({},{DataviewWidget_init:{value:function(b){return this._generatedId=0,this.localConfig={},this.initConfig=b||{},this.setupConfig(),this.params={},this.runtime=b.runtime,d.isBlank(b.userId)?this.runtime.getService("session").isLoggedIn()&&(this.params.userId=this.runtime.getService("session").getUsername()):this.params.userId=b.userId,this.setupCoreApp(),this.setup(),this.messages=[],this.error=null,this.state={},this.stateMeta={status:"none",timestamp:new Date},this.createListMaps(),this.templates={},this.templates.env=new a.Environment(new a.WebLoader(g.plugin.path+"/javascript/widgets/"+this.widgetName+"/templates"),{autoescape:!1}),this.templates.env.addFilter("kbmarkup",function(a){return a=a.replace(/\n/g,"<br>")}),this.templates.cache={},this.context={},this.context.env={widgetTitle:this.widgetTitle,widgetName:this.widgetName,docsite:this.runtime.getConfig("docsite"),browser:{location:{scheme:window.location.protocol,host:window.location.host,path:window.location.pathname}}},this.context.state=this.state,this.context.params=this.params,this.alert=Object.create(e).init(),this.status="ready",this}},setupConfig:{value:function(){if(this.configs=[{},this.initConfig,this.localConfig],!this.hasConfig("container"))throw"A container is required by this Widget, but was not provided.";if(!this.hasConfig("name"))throw"Widget name is required";if(!this.hasConfig("title"))throw"Widget title is required"}},setupCoreApp:{value:function(){this.container=this.getConfig("container"),"string"==typeof this.container&&(this.container=b(this.container)),this.widgetName=this.getConfig("name"),this.widgetTitle=this.getConfig("title"),this.instanceId=this.genId()}},start:{value:function(){this.setupUI(),this.renderWaitingView(),this.setInitialState().then(function(){return this.initialDataLoaded=!0,this.refresh()}.bind(this))["catch"](function(a){console.log("ERROR"),console.log(a),this.setError(a)}.bind(this))}},setup:{value:function(){return this}},setupUI:{value:function(){return this.loadCSS(),this.renderLayout(),this}},stop:{value:function(){this.status="stopped"}},destroy:{value:function(){}},getConfig:{value:function(a,b){for(var c=0;c<this.configs.length;c++)if(void 0!==d.getProp(this.configs[c],a))return d.getProp(this.configs[c],a);return b}},setConfig:{value:function(a,b){d.setProp(this.configs[0],a,b)}},hasConfig:{value:function(a){for(var b=0;b<this.configs.length;b++)if(void 0!==d.getProp(this.configs[b],a))return!0;return!1}},setParam:{value:function(a,b){d.setProp(this.params,a,b),this.refresh()}},getParam:{value:function(a,b){return d.getProp(this.params,a,b)}},recalcState:{value:function(){this.setInitialState().then(function(){return this.refresh()}.bind(this))["catch"](function(a){this.setError(a)}.bind(this))}},refresh:{value:function(){return new c(function(a,b,c){this.initialDataLoaded?this.refreshTimer||(this.refreshTimer=window.setTimeout(function(){this.refreshTimer=null,this.render(),a(!0)}.bind(this),0)):a(!1)}.bind(this))}},setState:{value:function(a,b,c){d.setProp(this.state,a,b),c||this.refresh()}},hasState:{value:function(a){return d.hasProp(this.state,a)}},getState:{value:function(a,b){return d.getProp(this.state,a,b)}},setError:{value:function(a){if(a){var b;"string"==typeof a?b=a:"object"==typeof a&&(b=a.message?a.message:a.error&&a.error.message?a.error.message:"Unknown error"),this.error={message:b,original:a},this.refresh()}}},checkState:{value:function(a){return this.stateMeta.status===a?!0:!1}},setInitialState:{value:function(a){return new c(function(a,b,c){a()})}},onLoggedIn:{value:function(a){this.setup(),this.setInitialState({force:!0}).then(function(){this.refresh()}.bind(this))}},onLoggedOut:{value:function(){this.setup(),this.setInitialState({force:!0}).then(function(){this.refresh()}.bind(this))}},getTemplate:{value:function(a){return void 0===this.templates.cache[a]&&(this.templates.cache[a]=this.templates.env.getTemplate(a+".html")),this.templates.cache[a]}},createTemplateContext:{value:function(a){if(this.context.params=this.params,this.context.env.generatedId=this.genId(),this.context.env.loggedIn=this.runtime.getService("session").isLoggedIn(),this.runtime.getService("session").isLoggedIn()?this.context.env.loggedInUser=this.runtime.getService("session").getUsername():delete this.context.env.loggedInUser,this.context.env.instanceId=this.instanceId,a){var b=d.merge({},this.context);return d.merge(b,a)}return this.context}},renderTemplate:{value:function(a,b){var c=this.getTemplate(a);if(!c)throw"Template "+a+" not found";var b=b?b:this.createTemplateContext();return c.render(b)}},genId:{value:function(){return"gen_"+this.widgetName+"_"+this._generatedId++}},renderError:{value:function(){var a=this.createTemplateContext({error:{message:d.getProp(this.error,"message")}});this.places.content.html(this.getTemplate("error").render(a))}},renderErrorView:{value:function(a){if(a){var b;"string"==typeof a?b=a:"object"==typeof a&&(a instanceof Error?b=a.message:a=""+a)}var c=this.createTemplateContext({error:b});this.places.content.html(this.getTemplate("error").render(c))}},render:{value:function(){return this.error?this.renderError():(this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate("main"))),this.afterRender&&this.afterRender(),this}},renderLayout:{value:function(){this.container.html(this.getTemplate("layout").render(this.createTemplateContext())),this.places={title:this.container.find('[data-placeholder="title"]'),alert:this.container.find('[data-placeholder="alert"]'),content:this.container.find('[data-placeholder="content"]')},this.alert.setContainer(this.places.alert)}},renderWaitingView:{value:function(){this.places.content.html(f.loading())}},loadCSS:{value:function(){b("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href","/src/widgets/dataview/style.css"),b("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href","/src/widgets/dataview/"+this.widgetName+"/style.css")}},makeWorkspaceObjectId:{value:function(a,b){return"ws."+a+".obj."+b}},object_to_array:{value:function(a,b,c){var d=Object.keys(a),e=[];for(var f in d){var g={};g[b]=d[f],g[c]=a[d[f]],e.push(g)}return e}},workspace_metadata_to_object:{value:function(a){return{id:a[0],name:a[1],owner:a[2],moddate:a[3],object_count:a[4],user_permission:a[5],globalread:a[6],lockstat:a[7],metadata:a[8]}}},workspace_object_to_object:{value:function(a){return a.info=this.object_info_to_object(a.info),a}},object_info_to_object:{value:function(a){var b=a[2].split(/[-\.]/);return{id:a[0],name:a[1],type:a[2],save_date:a[3],version:a[4],saved_by:a[5],wsid:a[6],ws:a[7],checksum:a[8],size:a[9],metadata:a[10],ref:a[7]+"/"+a[1],obj_id:"ws."+a[6]+".obj."+a[0],typeName:b[1],typeMajorVersion:b[2],typeMinorVersion:b[3]}}},logNotice:{value:function(a,b){console.log("NOTICE: ["+a+"] "+b)}},logDeprecation:{value:function(a,b){console.log("DEPRECATION: ["+a+"] "+b)}},logWarning:{value:function(a,b){console.log("WARNING: ["+a+"] "+b)}},logError:{value:function(a,b){console.log("ERROR: ["+a+"] "+b)}},createListMaps:{value:function(){this.listMaps={};for(var a in this.lists){var b=this.lists[a];this.listMaps[a]={};for(var c in b)this.listMaps[a][b[c].id]=b[c]}}},lists:{value:{permissionFlags:[{id:"r",label:"Read",description:"Read Only"},{id:"w",label:"Write",description:"Read and Write"},{id:"a",label:"Admin",description:"Read, Write, and Share"},{id:"n",label:"None",description:"No Access"}]}}});return h});