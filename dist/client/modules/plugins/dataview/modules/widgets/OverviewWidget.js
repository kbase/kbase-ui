define(["promise","kb/service/utils","kb/common/utils","kb/common/html","kb/common/dom","kb/service/client/workspace","kb/common/state"],function(a,b,c,d,e,f,g){"use strict";function h(h){function i(a){var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(c.isBlank(a))return"";var d=c.iso8601ToDate(a);return b[d.getMonth()]+" "+d.getDate()+", "+d.getFullYear()}function j(){return S.get_object_history({ref:P}).then(function(a){var c=a.map(function(a){return b.object_info_to_object(a)});R.set("versions",c.sort(function(a,b){return b.version-a.version}))})}function k(){return S.get_object_provenance([{ref:P}]).then(function(a){var b=a[0].refs,c=a[0].provenance;return c.forEach(function(a){b=b.concat(a.resolved_ws_objects)}),b.length>100?(R.set("too_many_out_refs",!0),b):(R.set("too_many_out_refs",!1),l("out_references",b))})}function l(c,d){return a["try"](function(){if(d&&!(d.length<1)){var a=d.map(function(a){return{ref:a}});return S.get_object_info_new({objects:a,ignoreErrors:1}).then(function(a){var d=a.filter(function(a){return a?!0:!1}).map(function(a){return b.object_info_to_object(a)});R.set(c,d.sort(function(a,b){return b.name-a.name}))})}})}function m(){return S.list_referencing_object_counts([{ref:P}]).then(function(a){return a[0]>100?void R.set("too_many_inc_refs",!0):(R.set("too_many_inc_refs",!1),n())})}function n(){return S.list_referencing_objects([{ref:P}]).then(function(a){var c=[];if(a[0])for(var d=0;d<a[0].length;d++)c.push(b.object_info_to_object(a[0][d]));return R.set("inc_references",c.sort(function(a,b){return b.name-a.name})),c})}function o(a){try{var b=a[2],c=Q.service("type").parseTypeId(b),e=Q.service("type").getIcon({type:c}),f=d.tag("div"),g=d.tag("span"),h=d.tag("i");return f([g({"class":"fa-stack fa-2x"},[h({"class":"fa fa-circle fa-stack-2x",style:{color:e.color}}),h({"class":"fa-inverse fa-stack-1x "+e.classes.join(" ")})])])}catch(i){return console.error("When fetching icon config: ",i),""}}function p(){return S.get_object_info_new({objects:[{ref:P}],includeMetadata:1}).then(function(a){if(!a||0===a.length)throw R.set("status","notfound"),new Error("notfound");R.set("status","found");var c=b.object_info_to_object(a[0]);R.set("object",c),Q.send("ui","setTitle","Data View for "+c.name),R.set("dataicon",o(a[0]))}).then(function(){var a=/^\d+$/.test(M);return S.get_workspace_info({id:a?M:null,workspace:a?null:M}).then(function(a){R.set("workspace",b.workspace_metadata_to_object(a))})}).then(function(){return j()}).then(function(){return m()}).then(function(){return n()}).then(function(){return k()}).then(function(a){return l(a)}).then(function(){S.list_workspace_info({perm:"w"}).then(function(a){var c=a.map(function(a){return b.workspace_metadata_to_object(a)}),d=c.filter(function(a){return a.metadata.narrative&&!isNaN(parseInt(a.metadata.narrative))&&a.id!==M&&a.metadata.narrative_nice_name&&a.metadata.is_temporary&&"true"!==a.metadata.is_temporary?!0:!1});R.set("writableNarratives",d)})})}function q(){var a=d.tag("div");return d.makePanel({title:"Data Overview",content:a([a({dataPlaceholder:"alert"}),a({dataPlaceholder:"content"})])})}function r(){return Z({style:{verticalAlign:"baseline"}},[$(R.get("dataicon")),_(function(){return R.get("sub.id")?[_(U(R.get("sub.subid"))),_(["(in",X({href:"#dataview/"+P},R.get("object.name")),")"])]:[_(U(R.get("object.name"))),_(["v",R.get("object.version")])]}())])}function s(){return Z([$("Type"),_([function(){return R.get("sub.sub")?get("sub.sub")+" in ":""}(),X({href:"#spec/type/"+R.get("object.type"),target:"_blank"},R.get("object.typeName"))])])}function t(){return R.get("workspace.metadata.narrative_nice_name")?Z([$("In Narrative"),_(X({href:"/narrative/ws."+R.get("workspace.id")+"."+R.get("object.id"),target:"_blank"},R.get("workspace.metadata.narrative_nice_name")))]):""}function u(){return window.location.protocol}function v(){return window.location.host}function w(){var a=u()+"//"+v()+"#dataview/"+P;return R.get("sub.subid")&&(a+="?"+R.get("sub.sub")+"&"+R.get("sub.subid")),Z([$("Permalink"),_(X({href:a},a))])}function x(){var a=R.get("object.version")||"Latest";return Z([$("Version"),_(a)])}function y(a){var b=d.genId(),c="heading_"+b,e="body_"+b;return T({"class":"panel panel-default"},[T({"class":"panel-heading",role:"tab",id:c},[V({"class":"panel-title"},[W({dataToggle:"collapse",dataParent:"#"+a.parent,dataTarget:"#"+e,ariaExpanded:"false",ariaControls:e,"class":"collapsed",style:{cursor:"pointer"}},[W({"class":"fa angle-right"}),a.title])])]),T({id:e,"class":"panel-collapse collapse",role:"tabpanel",ariaLabelledby:c},[T({"class":"panel-body"},[a.body])])])}function z(a){var b,c=R.get("object.metadata");return b=c&&Object.keys(c).length>0?Y({"class":"table"},[Object.keys(c).map(function(a){return Z([_(a),_(c[a])])})]):"no metadata for this object",y({title:"Raw Metadata",body:b,parent:a})}function A(a){var b,c=R.get("versions");return b=c&&c.length>0?Y({"class":"table"},c.map(function(a){return Z([_(X({href:"#dataview/"+a.wsid+"/"+a.id+"/"+a.version},["v"+a.version])),_(["Saved on ",i(a.save_date)," by ",X({href:"#people/"+a.saved_by},a.saved_by)])])})):"no versions",y({title:"Versions",body:b,parent:a})}function B(a){var b,c=R.get("too_many_inc_refs"),d=R.get("inc_references");return b=c?"Sorry, there are too many references to this data to display.":d&&d.length>0?Y({"class":"table"},[Z([$("Name"),$("Type"),$()])].concat(d.map(function(a){return Z([_(X({href:["#dataview",a.wsid,a.id,a.version].join("/")},a.name)),_(X({href:["#spec","type",a.type].join("/")},a.typeName)),_(["Saved on ",i(a.save_date)," by ",X({href:["#people",a.saved_by].join("/")})])])}))):"No other data references this data object.",y({title:"Referenced by",body:b,parent:a})}function C(a){var b,c=R.get("too_many_out_refs"),d=R.get("out_references");return b=c?"Sorry, there are too many references from this data to display.":d&&d.length>0?Y({"class":"table"},[Z([$("Name"),$("Type"),$()])].concat(d.map(function(a){return Z([_(X({href:["#dataview",a.wsid,a.id,a.version].join("/")},a.name)),_(X({href:["#spec","type",a.type].join("/")},a.typeName)),_(["Saved on ",i(a.save_date)," by ",X({href:["#people",a.saved_by].join("/")},a.saved_by)])])}))):"This data object references no other data.",y({title:"References",body:b,parent:a})}function D(){return T({"class":"row"},[T({"class":"col-sm-6"},[Y({"class":"kb-dataview-header-tbl"},[r()]),Y({"class":"table"},[x(),s(),t(),Z([$("Last Updated"),_([i(R.get("object.save_date"))," by ",X({href:["#people",R.get("object.saved_by")].join("/")},R.get("object.saved_by"))])]),w()])]),T({"class":"col-sm-6"},[T({"class":"panel-group",id:"accordion",role:"tablist",ariaMultiselectable:"true"},[z("accordion"),A("accordion"),B("accordion"),C("accordion")])])])}function E(b){return a["try"](function(){})}function F(b){return a["try"](function(){K=b,L=e.createElement("div"),K.appendChild(L),L.innerHTML=q(),L.querySelector('[data-placeholder="content"]').innerHTML=d.loading()})}function G(c){return a["try"](function(){if(M=c.workspaceId,N=c.objectId,O=c.objectVersion,P=b.makeWorkspaceObjectRef(M,N,O),!M)throw"Workspace ID is required";if(!N)throw"Object ID is required";return p().then(function(){L.innerHTML=q();var a=L.querySelector('[data-placeholder="content"]');a&&(a.innerHTML=D()),Q.send("ui","addButton",{name:"copy",label:"+ New Narrative",style:"primary",icon:"plus-square",url:"#narrativemanager/new?copydata="+P,external:!0})})["catch"](function(a){console.log("ERROR"),console.log(a),a.status&&500===a.status?(a.error.error.match(/^us.kbase.workspace.database.exceptions.NoSuchObjectException:/)?(R.set("status","notfound"),R.set("error",{type:"client",code:"notfound",shortMessage:"This object does not exist",originalMessage:a.error.message})):a.error.error.match(/^us.kbase.workspace.database.exceptions.InaccessibleObjectException:/)?(R.set("status","denied"),R.set("error",{type:"client",code:"denied",shortMessage:"You do not have access to this object",originalMessage:a.error.message})):(R.set("status","error"),R.set("error",{type:"client",code:"error",shortMessage:"An unknown error occured",originalMessage:a.error.message})),resolve()):R.set("error",{type:"general",code:"error",shortMessage:"An unknown error occured"})})})}function H(){return a["try"](function(){})}function I(){return a["try"](function(){K.removeChild(L)})}function J(){return a["try"](function(){})}var K,L,M,N,O,P,Q=h.runtime,R=(h.sub,g.make()),S=new f(Q.getConfig("services.workspace.url"),{token:Q.getService("session").getAuthToken()}),T=d.tag("div"),U=d.tag("h3"),V=d.tag("h4"),W=d.tag("span"),X=(d.tag("p"),d.tag("a")),Y=d.tag("table"),Z=d.tag("tr"),$=d.tag("th"),_=d.tag("td");return{init:E,attach:F,start:G,stop:H,detach:I,destroy:J}}return{make:function(a){return h(a)}}});