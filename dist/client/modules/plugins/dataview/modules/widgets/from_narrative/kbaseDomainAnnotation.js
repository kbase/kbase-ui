!function(a,b){a.KBWidget({name:"kbaseDomainAnnotation",parent:"kbaseAuthenticatedWidget",version:"1.0.1",options:{domainAnnotationID:null,workspaceID:null,domainAnnotationVer:null,kbCache:null,loadingImage:"assets/img/ajax-loader.gif",height:null},domainAnnotationData:null,genomeRef:null,genomeId:null,genomeName:null,domainModelSetRef:null,domainModelSetName:null,domainAccession2Description:{},annotatedGenesCount:0,annotatedDomainsCount:0,init:function(b){return this._super(b),this.workspaceURL=kb.urls.workspace_url,this.landingPageURL="#/dataview/",this.$messagePane=a("<div/>"),this.$elem.append(this.$messagePane),this},loggedInCallback:function(a,b){return this.ws=new Workspace(this.workspaceURL,b),this.render(),this},loggedOutCallback:function(a,b){return this.ws=null,this.isLoggedIn=!1,this},render:function(){var b=this;b.pref=this.uuid(),b.loading(!0);var c=this.$elem,d=this.ws,e=b.buildObjectIdentity(this.options.workspaceID,this.options.domainAnnotationID,this.options.domainAnnotationVer);d.get_objects([e],function(e){b.domainAnnotationData=e[0].data,b.genomeRef=b.domainAnnotationData.genome_ref,b.domainModelSetRef=b.domainAnnotationData.used_dms_ref;var f=d.get_object_subset([{ref:b.genomeRef,included:["/id"]},{ref:b.genomeRef,included:["/scientific_name"]}],function(a){b.genomeId=a[0].data.id,b.genomeName=a[1].data.scientific_name},function(a){b.clientError(a)}),g=d.get_objects([{ref:b.domainModelSetRef}],function(a){b.domainSetName=a[0].data.set_name,b.domainAccession2Description=a[0].data.domain_accession_to_description},function(a){b.clientError(a)});a.when.apply(a,[f,g]).done(function(){function d(){a(".show-gene"+b.pref).unbind("click"),a(".show-gene"+b.pref).click(function(){var c=a(this).attr("data-id"),d=a(this).attr("data-contigId"),f=a(this).attr("data-geneIndex");if(e.kbaseTabs("hasTab",c))return void e.kbaseTabs("showTab",c);var g=a("<div/>"),h=a('<table class="table table-striped table-bordered" style="width: 100%; margin-left: 0px; margin-right: 0px;" id="'+b.pref+c+'-table"/>');g.append(h);var i={sPaginationType:"full_numbers",iDisplayLength:10,aaData:[],aaSorting:[[3,"asc"],[5,"desc"]],aoColumns:[{sTitle:"Domain",mData:"domainId"},{sTitle:"Description",mData:"domainDescription",sWidth:"30%"},{sTitle:"Location",mData:"image"},{sTitle:"Start",mData:"domainStart"},{sTitle:"End",mData:"domainEnd"},{sTitle:"eValue",mData:"eValue"}],oLanguage:{sEmptyTable:"No domains found!",sSearch:"Search: "}},j=[],k=b.domainAnnotationData.data[d][f],l=k[0],m=k[1],n=k[2],o=k[4];for(var p in o)for(var q=o[p],r=0;r<q.length;r++){var s=q[r][0],t=q[r][1],u=q[r][2],v=(n-m+1)/3,w=100*(t-s)/v,x=100*s/v;j.push({contigId:d,geneId:l,geneStart:m,geneEnd:n,domainId:p,domainDescription:b.domainAccession2Description[p],domainStart:s,domainEnd:t,eValue:u,image:'<div style="widht: 100%; height:100%; vertical-align: middle; margin-top: 1em; margin-bottom: 1em;"><div style="position:relative; border: 1px solid gray; width:100%; height:2px;"><div style="position:relative; left: '+x+"%; width:"+w+'%; top: -5px; height:10px; background-color:red;"/></div></div>'})}i.aaData=j,h.dataTable(i),e.kbaseTabs("addTab",{tab:c,content:g,canDelete:!0,show:!0})})}b.loading(!1),b.prepareVizData(),c.empty();var e=a('<div id="'+b.pref+'tab-content">');c.append(e),e.kbaseTabs({canDelete:!0,tabs:[]});var f=a("<div/>");e.kbaseTabs("addTab",{tab:"Overview",content:f,canDelete:!1,show:!0});var g=a('<table class="table table-striped table-bordered" style="width: 100%; margin-left: 0px; margin-right: 0px;" id="'+b.pref+'overview-table"/>');f.append(g),g.append(b.makeRow("Annotated genome",a("<span />").append(b.genomeName).css("font-style","italic").append("<br /><a href='"+b.landingPageURL+b.genomeRef+"' target='_blank'>"+b.genomeRef+"</a>"))).append(b.makeRow("Domain models set",b.domainSetName)).append(b.makeRow("Annotated genes",b.annotatedGenesCount)).append(b.makeRow("Annotated domains",b.annotatedDomainsCount));var h=a("<div/>");e.kbaseTabs("addTab",{tab:"Domains",content:h,canDelete:!1,show:!1});var i=a('<table class="table table-striped table-bordered" style="width: 100%; margin-left: 0px; margin-right: 0px;" id="'+b.pref+'domain-table"/>');h.append(i);var j={sPaginationType:"full_numbers",iDisplayLength:10,aaData:[],aaSorting:[[2,"asc"],[0,"asc"]],aoColumns:[{sTitle:"Domain",mData:"id"},{sTitle:"Description",mData:"description"},{sTitle:"#Genes",mData:"geneCount"},{sTitle:"Genes",mData:"geneRefs"}],oLanguage:{sEmptyTable:"No domains found!",sSearch:"Search: "},fnDrawCallback:d},k=[],l=b.domains;for(var m in l){for(var n=l[m],o="",p=0;p<n.genes.length;p++)gene=n.genes[p],p>0&&(o+="<br />"),o+='<a class="show-gene'+b.pref+'" data-id="'+gene.geneId+'" data-contigId="'+gene.contigId+'" data-geneIndex="'+gene.geneIndex+'">'+gene.geneId+"</a>";k.push({id:m,description:n.description,geneCount:n.genes.length,geneRefs:o})}j.aaData=k,i.dataTable(j)})})},prepareVizData:function(){var b=this,c=b.domainAnnotationData,d={},e=0,f=0;for(var g in c.data){for(var h=c.data[g],i=0;i<h.length;i++){var j=h[i][0],k=h[i][4];if(!a.isEmptyObject(k)){f++;for(var l in k){var m=d[l];"undefined"==typeof m&&(m={id:l,description:b.domainAccession2Description[l],genes:[]},d[l]=m,e++),m.genes.push({geneId:j,contigId:g,geneIndex:i})}}}b.domains=d,b.annotatedDomainsCount=e,b.annotatedGenesCount=f}},makeRow:function(b,c){var d=a("<tr/>").append(a("<th />").css("width","20%").append(b)).append(a("<td />").append(c));return d},getData:function(){return{type:"DomainAnnotation",id:this.options.domainAnnotationID,workspace:this.options.workspaceID,title:"Domain Annotation"}},loading:function(a){a?this.showMessage("<img src='"+this.options.loadingImage+"'/>"):this.hideMessage()},showMessage:function(b){var c=a("<span>").append(b);this.$messagePane.append(c),this.$messagePane.show()},hideMessage:function(){this.$messagePane.hide(),this.$messagePane.empty()},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},buildObjectIdentity:function(a,b,c,d){var e={};return d?e.ref=d:(/^\d+$/.exec(a)?e.wsid=a:e.workspace=a,/^\d+$/.exec(b)?e.objid=b:e.name=b,c&&(e.ver=c)),e},clientError:function(a){this.loading(!1),this.showMessage(a.error.error)}})}(jQuery);