define(["jquery","kb_widget_dataview_base","kb.utils.api","kb.utils","kb.html","kb.runtime","kb.service.workspace","kb.widget.navbar","bluebird","underscore","kb_types"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=Object.create(b,{init:{value:function(a){a.name="OverviewWidget",a.title="Data Object Summary",this.DataviewWidget_init(a);var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(this.templates.env.addFilter("dateFormat",function(a){if(d.isBlank(a))return"";var c=d.iso8601ToDate(a);return b[c.getMonth()]+" "+c.getDate()+", "+c.getFullYear()}.bind(this)),this.templates.env.addFilter("fileSizeFormat",function(a){return d.isBlank(a)?"":d.fileSizeFormat(a)}.bind(this)),this.templates.env.addFilter("length2",function(a){if(a){if(a instanceof Array)return a.length;if(a instanceof Object)return Object.keys(a).length}}.bind(this)),!this.hasConfig("workspaceId"))throw"Workspace ID is required";if(this.setParam("workspaceId",this.getConfig("workspaceId")),!this.hasConfig("objectId"))throw"Object ID is required";return this.setParam("objectId",this.getConfig("objectId")),this.hasConfig("objectVersion")&&this.setParam("objectVersion",this.getConfig("objectVersion")),this.hasConfig("sub")&&this.setParam("sub",this.getConfig("sub")),this}},go:{value:function(){return this.start(),this}},setup:{value:function(){if(!f.hasConfig("services.workspace.url"))throw"The workspace client url is not defined";this.workspaceClient=new g(f.getConfig("services.workspace.url"),{token:f.getAuthToken()})}},render:{value:function(){if("stopped"===this.status)return this;switch(this.getState("status")){case"found":var a=this.getState("object.name");a&&h.setTitle(a),this.places.content.html(this.renderTemplate("main"));var b=this.getObjectRef();h.clearButtons(),h.addDropdown({place:"end",name:"download",style:"default",icon:"download",label:"Download",widget:"kbaseDownloadPanel",params:{ws:this.getState("workspace.id"),obj:this.getState("object.id"),ver:this.getState("object.version")}}),h.addButton({name:"copy",label:"+ New Narrative",style:"primary",icon:"plus-square",url:"/functional-site/#/narrativemanager/new?copydata="+b,external:!0});var c=this.getState("writableNarratives");if(c){var d,e=[];for(d=0;d<c.length;d++){var f=c[d];e.push({name:"narrative_"+d,icon:"file",label:f.metadata.narrative_nice_name,external:!0,callback:function(a){var b=this;return function(c){c.preventDefault(),b.copyObjectToNarrative(a)}}.bind(this)(f)})}h.addDropdown({place:"end",name:"options",style:"default",icon:"copy",label:"Copy",items:e})}break;case"notfound":h.setTitle('<span style="color: red;">This Object was Not Found</span>').clearButtons(),this.places.content.html(this.renderTemplate("error"));break;case"denied":h.setTitle('<span style="color: red;">Access Denied to this Object</span>').clearButtons(),this.places.content.html(this.renderTemplate("error"));break;case"error":h.setTitle('<span style="color: red;">An Error has Occurred Accessing this Object</span>').clearButtons(),this.places.content.html(this.renderTemplate("error"));break;default:h.setTitle("An Error has Occurred Accessing this Object").clearButtons(),this.setState("error",{type:"internal",code:"invalidstatus",shortMessage:'The internal status "'+this.getState("status")+'" is not suppored'}),this.places.content.html(this.renderTemplate("error"))}}},getObjectRef:{value:function(){return this.hasState("object")?c.makeWorkspaceObjectRef(this.getState("workspace.id"),this.getState("object.id"),this.getState("object.version")):void 0}},makeUrl:{value:function(a){return window.location.protocol+"//"+window.location.host+a}},copyObjectToNarrative:{value:function(a){var b=this.getObjectRef(),d=a.id+"",e=this.getState("object.name");i.resolve(this.workspaceClient.copy_object({from:{ref:b},to:{wsid:d,name:e}})).then(function(b){if(b){var d=this.makeUrl("/narrative/"+c.makeWorkspaceObjectId(a.id,a.metadata.narrative));this.alert.addSuccessMessage("Success","Successfully copied this data object to Narrative <i>"+a.metadata.narrative_nice_name+'</i>.  <a href="'+d+'" target="_blank">Open this Narrative</a>')}else this.alert.addErrorMessage("Error","An unknown error occurred copying the data.")}.bind(this))["catch"](function(a){if(a.error&&a.error.message)var b=a.error.message;else var b="";this.alert.addErrorMessage("Error","Error copying the data object to the selected Narrative. "+b),console.log("ERROR"),console.log(a)}.bind(this)).done()}},fetchVersions:{value:function(){i.resolve(this.workspaceClient.get_object_history({ref:c.makeWorkspaceObjectRef(this.getState("workspace.id"),this.getState("object.id"))})).then(function(a){var b=a.map(function(a){return c.object_info_to_object(a)});this.setState("versions",b.sort(function(a,b){return b.version-a.version}))}.bind(this))["catch"](function(a){console.log("ERROR"),console.log(a)}).done()}},checkRefCountAndFetchOutgoingReferences:{value:function(){i.resolve(this.workspaceClient.get_object_provenance([{ref:this.getObjectRef()}])).then(function(a){for(var b=a[0].refs,c=a[0].provenance,d=0;d<c.length;d++)b=b.concat(c[d].resolved_ws_objects);b.length>100?this.setState("too_many_out_refs",!0):(this.setState("too_many_out_refs",!1),this.fetchOutgoingReferences(b))}.bind(this))["catch"](function(a){this.setError("client",a)}.bind(this)).done()}},fetchOutgoingReferences:{value:function(a){if(!(a.length<1)){for(var b=[],d=0;d<a.length;d++)b.push({ref:a[d]});i.resolve(this.workspaceClient.get_object_info_new({objects:b,ignoreErrors:1})).then(function(a){var b=[];if(a)for(var d=0;d<a.length;d++)a[d]&&b.push(c.object_info_to_object(a[d]));this.setState("out_references",b.sort(function(a,b){return b.name-a.name}))}.bind(this))["catch"](function(a){this.setError("client",a)}.bind(this)).done()}}},checkRefCountAndFetchReferences:{value:function(){i.resolve(this.workspaceClient.list_referencing_object_counts([{ref:this.getObjectRef()}])).then(function(a){a[0]>100?this.setState("too_many_inc_refs",!0):(this.setState("too_many_inc_refs",!1),this.fetchReferences())}.bind(this))["catch"](function(a){this.setError("client",a)}.bind(this)).done()}},setError:{value:function(a,b){this.setState("status","error");var c=b.error;console.error(c);var d;d="string"==typeof c?c:c.message,this.setState("error",{type:a,code:"error",shortMessage:"An unexpected error occured",originalMessage:d})}},fetchReferences:{value:function(){i.resolve(this.workspaceClient.list_referencing_objects([{ref:this.getObjectRef()}])).then(function(a){var b=[];if(a[0])for(var d=0;d<a[0].length;d++)b.push(c.object_info_to_object(a[0][d]));this.setState("inc_references",b.sort(function(a,b){return b.name-a.name}))}.bind(this))["catch"](function(a){this.setError("client",a)}.bind(this)).done()}},createDataIcon:{value:function(a){try{for(var b=a[2],c=k.parseTypeId(b),d=k.getIcon({type:c}),f=0,g=0;g<c.length;f+=c.charCodeAt(g++));var h=["#F44336","#E91E63","#9C27B0","#3F51B5","#2196F3","#673AB7","#FFC107","#0277BD","#00BCD4","#009688","#4CAF50","#33691E","#2E7D32","#AEEA00","#03A9F4","#FF9800","#FF5722","#795548","#006064","#607D8B"],i=h[f%h.length],j=e.tag("div"),l=e.tag("span"),g=e.tag("i"),m=j([l({"class":"fa-stack fa-2x"},[g({"class":"fa fa-circle fa-stack-2x",style:{color:i}}),g({"class":"fa-inverse fa-stack-1x "+d.classes.join(" ")})])]);return m}catch(n){return console.error("When fetching icon config: ",n),""}}},setInitialState:{value:function(){return new i(function(a,b,d){this.getParam("sub")&&this.setState("sub",this.getParam("sub")),i.resolve(this.workspaceClient.get_object_info_new({objects:[{ref:c.makeWorkspaceObjectRef(this.getParam("workspaceId"),this.getParam("objectId"),this.getParam("objectVersion"))}],includeMetadata:1})).then(function(d){if(d&&0!==d.length){this.setState("status","found");var e=c.object_info_to_object(d[0]);this.setState("object",e),this.setState("dataicon",this.createDataIcon(d[0]));var f=this.getParam("workspaceId"),g=/^\d+$/.test(f);i.resolve(this.workspaceClient.get_workspace_info({id:g?f:null,workspace:g?null:f})).then(function(d){this.setState("workspace",c.workspace_metadata_to_object(d)),this.fetchVersions(),this.checkRefCountAndFetchReferences(),this.checkRefCountAndFetchOutgoingReferences(),i.resolve(this.workspaceClient.list_workspace_info({perm:"w"})).then(function(b){var d=b.map(function(a){return c.workspace_metadata_to_object(a)}),e=d.filter(function(a){return a.metadata.narrative&&!isNaN(parseInt(a.metadata.narrative))&&a.id!==this.getState("workspace.id")&&a.metadata.narrative_nice_name&&a.metadata.is_temporary&&"true"!==a.metadata.is_temporary?!0:!1}.bind(this));this.setState("writableNarratives",e),a()}.bind(this))["catch"](function(a){b(a)}).done()}.bind(this))["catch"](function(a){b(a)}).done()}else this.setState("status","notfound"),a()}.bind(this))["catch"](function(c){c.status&&500===c.status?(c.error.error.match(/^us.kbase.workspace.database.exceptions.NoSuchObjectException:/)?(this.setState("status","notfound"),this.setState("error",{type:"client",code:"notfound",shortMessage:"This object does not exist",originalMessage:c.error.message})):c.error.error.match(/^us.kbase.workspace.database.exceptions.InaccessibleObjectException:/)?(this.setState("status","denied"),this.setState("error",{type:"client",code:"denied",shortMessage:"You do not have access to this object",originalMessage:c.error.message})):(this.setState("status","error"),this.setState("error",{type:"client",code:"error",shortMessage:"An unknown error occured",originalMessage:c.error.message})),a()):(this.setState("error",{type:"general",code:"error",shortMessage:"An unknown error occured"}),b(c))}.bind(this)).done()}.bind(this))}}});return l});