!function(a,b){a.KBWidget({name:"kbaseMSA",parent:"kbaseAuthenticatedWidget",version:"0.0.1",options:{msaID:null,workspaceID:null,jobID:null,kbCache:null,workspaceURL:"https://kbase.us/services/ws/",loadingImage:"assets/img/ajax-loader.gif",ujsServiceURL:"https://kbase.us/services/userandjobstate/",height:null,width:1e3},msaWsRef:null,pref:null,timer:null,loadingImage:"assets/img/ajax-loader.gif",token:null,aminoAcidColors:{K:"#ff8f8f",R:"#ff8f8f",S:"#6fff6f",T:"#6fff6f",Q:"#6fff6f",N:"#6fff6f",L:"#9fcfff",V:"#9fcfff",I:"#9fcfff",A:"#9fcfff",F:"#9fcfff",W:"#9fcfff",M:"#9fcfff",C:"#ffcfef",E:"#ff8fff",D:"#ff8fff",G:"orange",P:"yellow",H:"#9fffff",Y:"#9fffff"},init:function(b){return this._super(b),this.pref=this.uuid(),this.$messagePane=a("<div/>").addClass("kbwidget-message-pane kbwidget-hide-message"),this.$elem.append(this.$messagePane),this.options.msaID?this.options.workspaceID?this.options.kbCache||this.authToken()?(this.token=this.authToken(),this.render()):this.renderError("No cache given, and not logged in!"):this.renderError("No workspace given!"):this.renderError("No MSA to render!"),this},render:function(){if(this.wsClient=new Workspace(this.options.workspaceURL,{token:this.token}),this.loading(!1),this.msaWsRef||null==this.options.jobID)this.loadMSA();else{var b=this,c=new UserAndJobState(b.options.ujsServiceURL,{token:this.token});b.$elem.empty();var d=a('<div class="loader-table"/>');b.$elem.append(d);var e=a('<table class="table table-striped table-bordered"             			style="margin-left: auto; margin-right: auto;" id="'+b.pref+'overview-table"/>');d.append(e),e.append("<tr><td>Job was created with id</td><td>"+b.options.jobID+"</td></tr>"),e.append("<tr><td>Output result will be stored as</td><td>"+b.options.msaID+"</td></tr>"),e.append('<tr><td>Current job state is</td><td id="'+b.pref+'job"></td></tr>');var f=function(d){c.get_job_status(b.options.jobID,function(c){var d=c[2],e=c[5],f=c[6],g=a("#"+b.pref+"job");"running"===d?g.html(d+'... &nbsp &nbsp <img src="'+b.loadingImage+'">'):g.html(d),1===e&&(clearInterval(b.timer),this.msaWsRef||0===f&&b.loadMSA())},function(c){if(clearInterval(b.timer),this.msaWsRef);else{var d=a("#"+b.pref+"job");d.html("Error accessing job status: "+c.error.message)}})};f(),b.timer=setInterval(f,5e3)}},loadMSA:function(){var b,c=this.buildObjectIdentity(this.options.workspaceID,this.options.msaID,null,this.msaWsRef);b=this.options.kbCache?this.options.kbCache.req("ws","get_objects",[c]):this.wsClient.get_objects([c]);var d=this;a.when(b).done(a.proxy(function(b){d.$elem.empty(),d.$elem.append('<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;"><tr><td width="40%">Multiple Sequence Alignment object ID</td><td>'+d.options.msaID+"</td></tr></table>");var c="canvas-"+d.pref,e="canvas-div-"+d.pref,f=a('<div id="'+e+'" style="border:1px solid #d3d3d3;">').append(a('<canvas id="'+c+'">'));f.css({"max-height":400,"max-width":1080,overflow:"scroll"}),d.$elem.append(f),watchForWidgetMaxWidthCorrection(e);var g=document.getElementById(c),h=b[0].data.alignment,i=0,j=null,k=0;for(var l in h){i++;var m=d.drawLine(g,l,0,!0);m>k&&(k=m),j=h[l].length}g.width=k+8*(2+j),g.height=12*i+2;var n=0;for(var l in h){d.drawLine(g,l,n,!1);for(var o=h[l],p=0;p<o.length;p++){var q=o.substring(p,p+1);d.drawSymbol(g,q,d.getColor(q),k,2+p,n)}n++}d.loading(!0)},this)),a.when(b).fail(a.proxy(function(a){this.renderError(a)},this))},drawSymbol:function(a,b,c,d,e,f){var g=b,h=a.getContext("2d"),i=10,j=7,k=i+"pt courier-new";CanvasTextFunctions.enable(h),h.strokeStyle="#000000",h.fillStyle=c;var l=h.measureText(k,i,g),m=d+e*(j+1),n=f*(i+2);h.fillRect(m-1,n+1,j+1,i+2),h.drawText(k,i,m+(j-l)/2,n+1.1*i,g)},drawLine:function(a,b,c,d){var e=a.getContext("2d"),f=10,g=f+"pt courier-new";CanvasTextFunctions.enable(e),e.strokeStyle="#000000";var h=e.measureText(g,f,b),i=c*(f+2);return d||e.drawText(g,f,0,i+1.1*f,b),h},getColor:function(a){var b=this.aminoAcidColors[a];return b||(b="#ffffff"),b},renderError:function(b){errString="Sorry, an unknown error occurred","string"==typeof b?errString=b:b.error&&b.error.message&&(errString=b.error.message);var c=a("<div>").addClass("alert alert-danger").append("<b>Error:</b>").append("<br>"+errString);this.$elem.empty(),this.$elem.append(c)},getData:function(){return{type:"MSA",id:this.options.msaID,workspace:this.options.workspaceID,title:"Multiple sequence alignment"}},buildObjectIdentity:function(a,b,c,d){var e={};return d?e.ref=d:(/^\d+$/.exec(a)?e.wsid=a:e.workspace=a,/^\d+$/.exec(b)?e.objid=b:e.name=b,c&&(e.ver=c)),e},loading:function(a){a?this.hideMessage():this.showMessage("<img src='"+this.options.loadingImage+"'/>")},showMessage:function(b){var c=a("<span/>").append(b);this.$messagePane.append(c),this.$messagePane.show()},hideMessage:function(){this.$messagePane.hide(),this.$messagePane.empty()},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},getState:function(){var a=this,b={msaWsRef:a.msaWsRef};return b},loadState:function(a){var b=this;a&&a.msaWsRef&&(b.msaWsRef=a.msaWsRef,b.render())},loggedInCallback:function(a,b){return null==this.token&&(this.token=b.token,this.render()),this},loggedOutCallback:function(a,b){return this.render(),this}})}(jQuery);