define(["jquery","kb/common/html","kb/service/client/workspace","d3","kb/widget/legacy/authenticatedWidget"],function(a,b,c,d){"use strict";a.KBWidget({name:"GenomeComparisonWidget",parent:"kbaseAuthenticatedWidget",version:"1.0.0",ws_name:null,ws_id:null,options:{ws_name:null,ws_id:null},cmpImgUrl:null,timer:null,geneRows:21,geneRowH:21,pref:null,size:500,imgI:0,imgJ:0,scale:null,stepPercent:25,geneI:-1,dirI:1,geneJ:-1,dirJ:1,cmp:null,cmp_ref:null,selectHitsMessage:"Move mouse over hits in map and select hit to visualize region around it",genome1wsName:null,genome1objName:null,genome2wsName:null,genome2objName:null,tooltip:null,init:function(a){return this._super(a),this.cmpImgUrl=this.runtime.getConfig("services.genome_comparison.url").replace("jsonrpc","image"),this.ws_name=a.ws_name,this.ws_id=a.ws_id,this.pref=this.uuid(),this},render:function(){var e=this;e.tooltip=d.select("body").append("div").classed("kbcb-tooltip",!0);var f=this.$elem;if(f.empty(),!e.authToken())return void f.append("<div>[Error] You're not logged in</div>");var g=new c(this.runtime.getConfig("services.workspace.url"),{token:this.authToken()}),h=function(){var b=e.cmp_ref;b||(b=e.ws_name+"/"+e.ws_id),g.get_objects([{ref:b}],function(a){e.cmp=a[0].data;var b=a[0].info;e.cmp_ref=b[6]+"/"+b[0]+"/"+b[4],i()},function(b){var c=a("#"+e.pref+"job");c.html("Error accessing comparison object: "+b.error.message)})},i=function(){f.empty(),f.append(b.loading("loading comparison data...")),g.get_object_subset([{ref:e.cmp.genome1ref,included:["scientific_name"]},{ref:e.cmp.genome2ref,included:["scientific_name"]}],function(b){e.genome1wsName=b[0].info[7],e.genome1objName=b[0].info[1];var c=b[0].data.scientific_name;e.genome2wsName=b[1].info[7],e.genome2objName=b[1].info[1];var d=b[1].data.scientific_name;f.empty();var g=a("<table/>").addClass("table table-bordered").css({"margin-left":"auto","margin-right":"auto"});f.append(g);var h=function(a,b){return"<tr><td>"+a+"</td><td>"+b+"</td></tr>"},i=0;for(var j in e.cmp.data1)e.cmp.data1[j].length>0&&i++;var k=0;for(var j in e.cmp.data2)e.cmp.data2[j].length>0&&k++;g.append(h("Comparison object",e.ws_id)),g.append(h("Genome1 (x-axis)",'<a href="#dataview/'+e.genome1wsName+"/"+e.genome1objName+'" target="_blank">'+c+"</a> ("+e.cmp.proteome1names.length+" genes, "+i+" have hits)")),g.append(h("Genome2 (y-axis)",'<a href="#dataview/'+e.genome2wsName+"/"+e.genome2objName+'" target="_blank">'+d+"</a> ("+e.cmp.proteome2names.length+" genes, "+k+" have hits)")),null==e.scale&&(e.scale=100*e.size/Math.max(e.cmp.proteome1names.length,e.cmp.proteome2names.length));var l=' style="border: 0px; margin: 0px; padding: 0px;"',m=' style="border: 0px; margin: 0px; padding: 0px;"',n=' style="border: 0px; margin: 0px; padding: 1px;"',o=' style="width: 27px;"';g.append('<tr><td><center><button id="'+e.pref+'btn-zi">Zoom +</button>&nbsp;<button id="'+e.pref+'btn-zo">Zoom -</button><br><br><table'+l+"><tr"+m+"><td"+n+'><button id="'+e.pref+'btn-mul"'+o+">&#8598;</button></td><td"+n+'><button id="'+e.pref+'btn-mu"'+o+">&#8593;</button></td><td"+n+'><button id="'+e.pref+'btn-mur"'+o+">&#8599;</button></td></tr><tr"+m+"><td"+n+'><button id="'+e.pref+'btn-ml"'+o+">&#8592;</button></td><td"+n+"/><td"+n+'><button id="'+e.pref+'btn-mr"'+o+">&#8594;</button></td></tr><tr"+m+"><td"+n+'><button id="'+e.pref+'btn-mdl"'+o+">&#8601;</button></td><td"+n+'><button id="'+e.pref+'btn-md"'+o+">&#8595;</button></td><td"+n+'><button id="'+e.pref+'btn-mdr"'+o+">&#8600;</button></td></tr></table></center></td><td><table"+l+"><tr"+m+'><td width="'+(e.size+100)+'"'+n+'><div style="position:relative"><img id="'+e.pref+'img" src=""/><div id="'+e.pref+'rect" style="position:absolute; z-index: 2; border: 1px; border-style: solid; border-color: red; background-color: transparent; display:none; pointer-events:none;"/></div></td><td width="300"'+n+'><table id="'+e.pref+'genes"'+l+"><tr"+l+"><td"+l+">"+e.selectHitsMessage+"</td></tr></table></td></tr></table></td></tr>"),e.refreshImage(),e.refreshGenes();var p=function(a){var b=Math.min(e.size,e.cmp.proteome1names.length*e.scale/100),c=Math.min(e.size,e.cmp.proteome2names.length*e.scale/100),d=e.imgI+50*b/e.scale,f=e.imgJ+50*c/e.scale;100*e.size/(e.scale*a)>1.1*Math.max(e.cmp.proteome1names.length,e.cmp.proteome2names.length)||(e.scale*=a,e.imgI=d-50*e.size/e.scale,e.imgJ=f-50*e.size/e.scale,e.refreshImage())};a("#"+e.pref+"btn-zi").click(function(){p(1.5)}),a("#"+e.pref+"btn-zo").click(function(){p(1/1.5)});var q=function(a,b){e.imgJ+=a*e.size*e.stepPercent/e.scale,e.imgI+=b*e.size*e.stepPercent/e.scale,e.refreshImage()};a("#"+e.pref+"btn-mul").click(function(){q(1,-1)}),a("#"+e.pref+"btn-mu").click(function(){q(1,0)}),a("#"+e.pref+"btn-mur").click(function(){q(1,1)}),a("#"+e.pref+"btn-ml").click(function(){q(0,-1)}),a("#"+e.pref+"btn-mr").click(function(){q(0,1)}),a("#"+e.pref+"btn-mdl").click(function(){q(-1,-1)}),a("#"+e.pref+"btn-md").click(function(){q(-1,0)}),a("#"+e.pref+"btn-mdr").click(function(){q(-1,1)});var r=function(b){var c=b.pageX,d=b.pageY;!c&&!d&&b.clientX&&b.clientY&&(c=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d=b.clientY+document.body.scrollTop+document.documentElement.scrollTop);var f=a("#"+e.pref+"img").offset(),g=c-f.left-35,h=d-f.top,i=Math.min(e.size,e.cmp.proteome1names.length*e.scale/100),j=Math.min(e.size,e.cmp.proteome2names.length*e.scale/100),k=-1,l=-1,m=-1;if(g>=0&&i>=g&&h>=0&&j>=h)for(var n in e.cmp.data1){var o=(n-e.imgI)*e.scale/100;if(o>=0&&i>o&&Math.abs(g-o)<=2)for(var p in e.cmp.data1[n]){var q=e.cmp.data1[n][p],r=q[0],s=j+1-(r-e.imgJ)*e.scale/100;if(s>=0&&j>s&&Math.abs(h-s)<=2){var t=Math.sqrt((g-o)*(g-o)+(h-s)*(h-s));(0>k||k>t)&&(k=t,l=n,m=r)}}}return{scrX:c,scrY:d,relX:g,relY:h,bestDist:k,bestI:l,bestJ:m}};a("#"+e.pref+"img").hover(function(){e.tip().style("visibility","visible")},function(){e.tip().style("visibility","hidden")}).mousemove(function(a){var b=r(a),c=e.tip();if(Number(b.bestDist)>=0){var d="X-axis: "+e.cmp.proteome1names[Number(b.bestI)]+", Y-axis: "+e.cmp.proteome2names[Number(b.bestJ)]+"<br>click to see detailes...";return c.html(d),c.style("top",a.pageY+15+"px").style("left",a.pageX-10+"px"),void c.style("visibility","visible")}c.style("visibility","hidden"),c.text("")}).click(function(a){var b=r(a);Number(b.bestDist)>=0?(e.geneI=Number(b.bestI),e.geneJ=Number(b.bestJ)):(e.geneI=-1,e.geneJ=-1),e.refreshGenes()})},function(b){var c=a("#"+e.pref+"job");c.html("Error accessing genome objects: "+b.error.message)})};return h(),this},tip:function(){return this.tooltip},refreshDetailedRect:function(){var b=this,c=a("#"+b.pref+"rect").append(c);if(b.geneI<0||b.geneJ<0)return void c.hide();var d=(a("#"+b.pref+"img").offset(),(b.geneI-b.imgI)*b.scale/100),e=(b.geneJ-b.imgJ)*b.scale/100;if(0>d||d>=b.size||0>e||e>=b.size)return void c.hide();var f=b.geneRows*b.scale/200;1>f&&(f=1);var g=Math.min(b.size,b.cmp.proteome2names.length*b.scale/100),h=d+35-f-1,i=g+1-e-f-1;c.css({top:Math.round(i)+"px",left:Math.round(h)+"px",width:1+2*f+"px",height:1+2*f+"px"}),c.show()},refreshImage:function(){var b=this,c=b.imgI+100*b.size/b.scale;c>b.cmp.proteome1names.length&&(c=b.cmp.proteome1names.length);var d=b.imgJ+100*b.size/b.scale;d>b.cmp.proteome2names.length&&(d=b.cmp.proteome2names.length),b.imgI=c-100*b.size/b.scale,b.imgJ=d-100*b.size/b.scale,b.imgI<0&&(b.imgI=0),b.imgJ<0&&(b.imgJ=0),b.imgI=Math.round(b.imgI),b.imgJ=Math.round(b.imgJ);var e=b.cmpImgUrl+"?ws="+b.ws_name+"&id="+b.ws_id+"&x="+b.imgI+"&y="+b.imgJ+"&w="+b.size+"&sp="+b.scale+"&token="+encodeURIComponent(b.authToken());a("#"+b.pref+"img").attr("src",e),b.refreshDetailedRect()},refreshGenes:function(){var b=this,c=a("#"+b.pref+"genes");c.empty();var d=' style="border: 0px; margin: 0px; padding: 0px;"';if(b.geneI<0||b.geneJ<0)return b.refreshDetailedRect(),void c.append("<tr"+d+"><td"+d+">"+b.selectHitsMessage+"</td></tr>");var e=Math.floor(b.geneRows/2),f=Math.floor(b.geneRowH/2),g="&#8595;",h="&#8595;";b.dirI<0&&(g="&#8593;"),b.dirJ<0&&(h="&#8593;");var i=' style="border: 0px; margin: 0px; padding: 0px;"',j=' style="width: 27px;"';c.append("<tr"+i+'><td rowspan="'+(b.geneRows+2)+'" width="10" style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-dirI"'+j+">"+g+'</button></td><td style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-i-up"'+j+'>&#8593;</button></td><td style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-both-up"'+j+'>&#8593;&#8593;</button></td><td style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-j-up"'+j+'>&#8593;</button></td><td rowspan="'+(b.geneRows+2)+'" width="10" style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-dirJ"'+j+">"+h+"</button></td></tr>");for(var k="",l=[],m=0;m<b.geneRows;m++){var n=b.geneI+(m-e)*b.dirI,o=b.geneJ+(m-e)*b.dirJ,p="-",q="-";n>=0&&n<b.cmp.proteome1names.length&&(p=b.cmp.proteome1names[n]),o>=0&&o<b.cmp.proteome2names.length&&(q=b.cmp.proteome2names[o]),m===e&&(p='<font color="red">'+p+"</font>",q='<font color="red">'+q+"</font>");var r=' style="border: 0px; margin: 0px; padding: 0px; font-size: 12px; height: '+b.geneRowH+'px; text-align: center; vertical-align: middle;"',s="<td "+r+'><a href="#genes/'+b.genome1wsName+"/"+b.genome1objName+"/"+b.cmp.proteome1names[n]+'" target="_blank">'+p+"</a></td>";0===m&&(s+='<td id="'+b.pref+'glinks" rowspan="'+b.geneRows+'" width="30"'+i+"/>"),s+="<td "+r+'><a href="#genes/'+b.genome2wsName+"/"+b.genome2objName+"/"+b.cmp.proteome2names[o]+'" target="_blank">'+q+"</a></td>",c.append("<tr"+i+">"+s+"</tr>");var t=m*(b.geneRowH+.2)+f;for(var u in b.cmp.data1[n]){var v=b.cmp.data1[n][u],w=v[0],x=(w-b.geneJ)*b.dirJ+e;if(x>=0&&x<b.geneRows){var y=x*(b.geneRowH+.2)+f,z="";v[2]<100&&(z=' stroke-dasharray="5, 5"'),k+='<line x1="0" y1="'+t+'" x2="30" y2="'+y+'"'+z+' style="stroke:rgb(0,0,0);stroke-width:1"/>',l.push({x1:0,y1:t,x2:30,y2:y,gene1:b.cmp.proteome1names[n],gene2:b.cmp.proteome2names[w],bit_score:v[1],percent_of_bbh:v[2]})}}}c.append("<tr"+i+'><td style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-i-dn"'+j+'>&#8595;</button></td><td style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-both-dn"'+j+'>&#8595;&#8595;</button></td><td style="border: 0px; margin: 0px; padding: 0px; text-align: center; vertical-align: middle;"><button id="'+b.pref+'btn-j-dn"'+j+">&#8595;</button></td></tr>");var A=a("#"+b.pref+"glinks"),B=b.geneRows*b.geneRowH;A.append('<svg width="30" height="'+B+'">'+k+"</svg>"),A.hover(function(){b.tip().style("visibility","visible")},function(){b.tip().style("visibility","hidden")}).mousemove(function(a){var c=a.pageX,d=a.pageY;!c&&!d&&a.clientX&&a.clientY&&(c=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);var e=A.offset(),f=c-e.left,g=d-e.top,h=-1,i=null;for(var j in l){var k=l[j],m=Math.abs((k.y2-k.y1)*f-(k.x2-k.x1)*g+k.x2*k.y1-k.y2*k.x1)/Math.sqrt((k.y2-k.y1)*(k.y2-k.y1)+(k.x2-k.x1)*(k.x2-k.x1));(0>h||h>m)&&(h=m,i=k)}var n=b.tip();if(h&&2>=h){var o="Gene1: "+i.gene1+"<br>Gene2: "+i.gene2+"<br>Bit-score: "+i.bit_score+"<br>Percent of related BBH bit-score: "+i.percent_of_bbh+"%";return n.html(o),n.style("top",a.pageY+15+"px").style("left",a.pageX-10+"px"),void n.style("visibility","visible")}n.style("visibility","hidden"),n.html("")}),a("#"+b.pref+"btn-dirI").click(function(){b.dirI*=-1,b.refreshGenes()}),a("#"+b.pref+"btn-i-up").click(function(){b.geneI-=b.dirI,b.refreshGenes()}),a("#"+b.pref+"btn-both-up").click(function(){b.geneI-=b.dirI,b.geneJ-=b.dirJ,b.refreshGenes()}),a("#"+b.pref+"btn-j-up").click(function(){b.geneJ-=b.dirJ,b.refreshGenes()}),a("#"+b.pref+"btn-dirJ").click(function(){b.dirJ*=-1,b.refreshGenes()}),a("#"+b.pref+"btn-i-dn").click(function(){b.geneI+=b.dirI,b.refreshGenes()}),a("#"+b.pref+"btn-both-dn").click(function(){b.geneI+=b.dirI,b.geneJ+=b.dirJ,b.refreshGenes()}),a("#"+b.pref+"btn-j-dn").click(function(){b.geneJ+=b.dirJ,b.refreshGenes()}),b.refreshDetailedRect()},loggedInCallback:function(a,b){return this.render(),this},loggedOutCallback:function(a,b){return this.render(),this},getState:function(){var a=this;null===a.scale&&(a.scale=100*a.size/Math.max(a.cmp.proteome1names.length,a.cmp.proteome2names.length));var b={imgI:a.imgI,imgJ:a.imgJ,scale:a.scale,geneI:a.geneI,dirI:a.dirI,geneJ:a.geneJ,dirJ:a.dirJ,cmp_ref:a.cmp_ref};return b},loadState:function(a){if(a){var b=this;b.imgI=a.imgI,b.imgJ=a.imgJ,b.scale=a.scale,b.geneI=a.geneI,b.dirI=a.dirI,b.geneJ=a.geneJ,b.dirJ=a.dirJ,b.cmp_ref=a.cmp_ref,b.cmp?(null===b.scale&&(b.scale=100*b.size/Math.max(b.cmp.proteome1names.length,b.cmp.proteome2names.length)),b.refreshImage(),b.refreshGenes()):b.render()}},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})}})});