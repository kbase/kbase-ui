define(["jquery","kb/common/html","kb/service/client/workspace","kb/widget/legacy/authenticatedWidget","kb/widget/legacy/tabs","datatables_bootstrap"],function(a,b,c){"use strict";a.KBWidget({name:"kbaseGenomeComparisonViewer",parent:"kbaseAuthenticatedWidget",version:"1.0.0",id:null,ws:null,pref:null,width:1150,options:{id:null,ws:null},init:function(a){return this._super(a),this.pref=this.genUUID(),this.ws=a.ws,this.id=a.id,console.log("A: here"),console.log(a),this.render(),this},render:function(){var d=this,e=this.$elem,f=new c(this.runtime.getConfig("services.workspace.url"),{token:d.token});return e.empty(),d.authToken()?(e.html(b.loading("loading genome comparison data...")),f.get_objects([{ref:d.ws+"/"+d.id}],function(b){function c(){a(".show-family"+d.pref).unbind("click"),a(".show-family"+d.pref).click(function(){var b=a(this).data("id");if(l.kbaseTabs("hasTab",b))return void l.kbaseTabs("showTab",b);var c;for(var e in k)k[e].id===b&&(c=k[e]);var f=a("<div/>"),g=a('<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;" id="'+d.pref+b+'-table"/>');f.append(g);var h=["Genome","Genes","Score","Functions","Subsystems","Primary class","Secondary class"];g.append("<tr><th><b>"+h.join("</b></th><th><b>")+"</b></th></tr>");for(var e in i){var m=i[e],n="",o="",p="",q="",r="",s="";if(void 0===c.genome_features[m.genome_ref])n="none",o="none",p="none",q="none",r="none",s="none";else{var t=c.genome_features[m.genome_ref],u=1;for(var v in t){v>0&&(n+="<br>",o+="<br>"),n+=u+":"+t[0],o+=u+":"+t[2];var w=t[1];for(var x in w)(x>0||v>0)&&(p+="<br>",q+="<br>",r+="<br>",s+="<br>"),p+=u+":"+j[w[x]].id,q+=u+":"+j[w[x]].subsystem,r+=u+":"+j[w[x]].primclass,s+=u+":"+j[w[x]].subclass;u++}}var y=[m.name,n,o,p,q,r,s];g.append("<tr><td>"+y.join("</td><td>")+"</td></tr>")}l.kbaseTabs("addTab",{tab:b,content:f,canDelete:!0,show:!0})}),a(".show-function"+d.pref).unbind("click"),a(".show-function"+d.pref).click(function(){var b=a(this).data("id");if(l.kbaseTabs("hasTab",b))return void l.kbaseTabs("showTab",b);var c;for(var e in j)j[e].id===b&&(c=j[e]);var f=a("<div/>"),g=a('<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;" id="'+d.pref+b+'-table"/>');f.append(g);var h=["Genome","Genes","Scores","Families"];g.append("<tr><th><b>"+h.join("</b></th><th><b>")+"</b></th></tr>");for(var e in i){var m=i[e],n="",o="",p="";if(void 0===c.genome_features[m.genome_ref])n="none",o="none",p="none";else{var q=c.genome_features[m.genome_ref];for(var r in q)r>0&&(n+="<br>",o+="<br>",p+="<br>"),n+=q[0],o+=q[2],p+=k[q[1]].id}var s=[m.name,n,p,o];g.append("<tr><td>"+s.join("</td><td>")+"</td></tr>")}l.kbaseTabs("addTab",{tab:b,content:f,canDelete:!0,show:!0})})}function f(a){var b=[];for(var c in a)b.push(c);return b.sort(function(b,c){return a[c]-a[b]})}var g=b[0].data,h=b[0].info,i=g.genomes,j=g.functions,k=g.families,l=a('<div id="'+d.pref+'tab-content">');e.html(l),l.kbaseTabs({canDelete:!0,tabs:[]});var m=a("<div/>");l.kbaseTabs("addTab",{tab:"Overview",content:m,canDelete:!1,show:!0});var n=a('<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;" id="'+d.pref+'overview-table"/>');m.append(n),n.append("<tr><td>Genome comparison object</td><td>"+h[1]+"</td></tr>"),n.append("<tr><td>Genome comparison workspace</td><td>"+h[7]+"</td></tr>"),n.append("<tr><td>Core functions</td><td>"+g.core_functions+"</td></tr>"),n.append("<tr><td>Core families</td><td>"+g.core_families+"</td></tr>"),g.protcomp_ref?n.append("<tr><td>Protein Comparison</td><td>"+g.protcomp_ref+"</td></tr>"):n.append("<tr><td>Protein Comparison</td><td>"+g.pangenome_ref+"</td></tr>"),n.append("<tr><td>Owner</td><td>"+h[5]+"</td></tr>"),n.append("<tr><td>Creation</td><td>"+h[3]+"</td></tr>");var o=a("<div/>");l.kbaseTabs("addTab",{tab:"Genomes",content:o,canDelete:!1,show:!1});var p=a('<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;" id="'+d.pref+'genome-table"/>');o.append(p);var q=["Genome","Legend"];for(var r in i)q.push("G"+r);p.append("<tr><th><b>"+q.join("</b></th><th><b>")+"</b></th></tr>");for(var r in i){var s=i[r],t=["<b>G"+r+"</b>-"+s.name,"# of families:<br># of functions:"];for(var u in i){var v=i[u];s.genome_similarity[v.genome_ref]?t.push(s.genome_similarity[v.genome_ref][0]+"<br>"+s.genome_similarity[v.genome_ref][1]):u===r?t.push(s.families+"<br>"+s.functions):t.push("0<br>0")}p.append("<tr><td>"+t.join("</td><td>")+"</td></tr>")}var w=a("<div/>");l.kbaseTabs("addTab",{tab:"Functions",content:w,canDelete:!1,show:!1});var x=a('<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;" id="'+d.pref+'function-table"/>');w.append(x);var y=[],z={sPaginationType:"full_numbers",iDisplayLength:10,aaData:y,aaSorting:[[2,"desc"],[0,"asc"]],aoColumns:[{sTitle:"Function",mData:"id"},{sTitle:"Subsystem",mData:"subsystem"},{sTitle:"Primary class",mData:"primclass"},{sTitle:"Secondary class",mData:"subclass"},{sTitle:"Totals",mData:"totals"},{sTitle:"Families",mData:"families"},{sTitle:"Family genes",mData:"famgenes"},{sTitle:"Family genomes",mData:"famgenomes"}],oLanguage:{sEmptyTable:"No functions found!",sSearch:"Search: "},fnDrawCallback:c};for(var r in k){var A=k[r],B=0;for(var u in i){var v=i[u];if(A.genome_features[v.genome_ref]){var C=A.genome_features[v.genome_ref];for(var D in C)B++}}A.numgenes=B}for(var r in j){var E=j[r];E.subsystem=E.subsystem.replace(/_/g," ");var F={id:'<a class="show-function'+d.pref+'" data-id="'+E.id+'">'+E.id+"</a>",subsystem:E.subsystem,primclass:E.primclass,subclass:E.subclass},G={},H={},B=0;for(var u in i){var v=i[u];if(E.genome_features[v.genome_ref]){var I={},C=E.genome_features[v.genome_ref];for(var D in C)B++,O=C[D],I[O[1]]=1,void 0===G[O[1]]&&(G[O[1]]=0),G[O[1]]++;for(var J in I)void 0===H[J]&&(H[J]=0),H[J]++}}E.numgenes=B;var K=f(G);F.totals="Families:&nbsp;"+K.length+"<br>Genes:&nbsp;"+B+"<br>Genomes:&nbsp;"+E.number_genomes,F.families="",F.famgenes="",F.famgenomes="";for(var u in K)F.families.length>0&&(F.families+="<br>",F.famgenes+="<br>",F.famgenomes+="<br>"),"null"===K[u]?(F.famgenes=0,F.famgenomes=0,F.families="none"):(F.famgenes+=G[K[u]]+"("+Math.round(100*G[K[u]]/k[K[u]].numgenes)+"%)",F.famgenomes+=H[K[u]]+"("+Math.round(100*H[K[u]]/k[K[u]].number_genomes)+"%)",F.families+='<a class="show-family'+d.pref+'" data-id="'+k[K[u]].id+'">'+k[K[u]].id+"</a>");z.aaData.push(F)}x.dataTable(z);var L=a("<div/>");d.options.withExport&&L.append("<p><b>Please choose homolog family and push 'Export' button on opened ortholog tab.</b></p><br>"),l.kbaseTabs("addTab",{tab:"Families",content:L,canDelete:!1,show:!1});var M=a('<table class="table table-striped table-bordered" style="margin-left: auto; margin-right: auto;" id="'+d.pref+'genome-table"/>');L.append(M);var N=[];z={sPaginationType:"full_numbers",iDisplayLength:10,aaData:N,aaSorting:[[2,"desc"],[0,"asc"]],aoColumns:[{sTitle:"Family",mData:"id"},{sTitle:"Totals",mData:"totals"},{sTitle:"Functions",mData:"functions"},{sTitle:"Subsystems",mData:"subsystem"},{sTitle:"Primary classes",mData:"primclass"},{sTitle:"Secondary classes",mData:"subclass"},{sTitle:"Function genes",mData:"funcgenes"},{sTitle:"Function genomes",mData:"funcgenomes"}],oLanguage:{sEmptyTable:"No families found!",sSearch:"Search: "},fnDrawCallback:c};for(var r in k){var O,A=k[r],P={id:'<a class="show-family'+d.pref+'" data-id="'+A.id+'">'+A.id+"</a>"},Q={},R={},B=0;for(var u in i){var v=i[u];if(A.genome_features[v.genome_ref]){var I={},C=A.genome_features[v.genome_ref];for(var D in C){B++,O=C[D];var S=O[1];for(var T in S)void 0===Q[S[T]]&&(Q[S[T]]=0),I[S[T]]=1,Q[S[T]]++}for(var J in I)void 0===R[J]&&(R[J]=0),R[J]++}}var U=f(Q);P.totals="Genes:&nbsp;"+B+"<br>Functions:&nbsp;"+U.length+"<br>Genomes:&nbsp;"+A.number_genomes,P.functions="",P.subsystem="",P.primclass="",P.subclass="",P.funcgenes="",P.funcgenomes="";var V=1;for(var u in U)P.functions.length>0&&(P.functions+="<br>",P.subsystem+="<br>",P.primclass+="<br>",P.subclass+="<br>",P.funcgenes+="<br>",P.funcgenomes+="<br>"),"null"===U[u]?(P.funcgenes+=0,P.funcgenomes+=0,P.functions+="none",P.subsystem+="none",P.primclass+="none",P.subclass+="none"):(P.funcgenes+=V+": "+Q[U[u]]+"("+Math.round(100*Q[U[u]]/j[U[u]].numgenes)+"%)",P.funcgenomes+=V+": "+R[U[u]]+"("+Math.round(100*R[U[u]]/j[U[u]].number_genomes)+"%)",P.functions+=V+': <a class="show-function'+d.pref+'" data-id="'+j[U[u]].id+'">'+j[U[u]].id+"</a>",P.subsystem+=V+": "+j[U[u]].subsystem,P.primclass+=V+": "+j[U[u]].primclass,P.subclass+=V+": "+j[U[u]].subclass),V++;z.aaData.push(P)}M.dataTable(z)},function(a){e.empty(),e.append("<p>[Error] "+a.error.message+"</p>")}),this):void e.append("<div>[Error] You're not logged in</div>")},loggedInCallback:function(a,b){return this.render(),this},loggedOutCallback:function(a,b){return this.render(),this},genUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})}})});