define(["jquery","kb_dataview_communities_jquerySvg"],function(a){"use strict";var b={about:{name:"graph",title:"Graph",author:"Tobias Paczian",version:"1.0"},defaults:{type:"column",title:"",title_color:"black",title_settings:{fontSize:"15px"},x_title:"",y_title:"",y2_title:"",x_title_color:"black",y_title_color:"black",y2_title_color:"black",x_labels:[],x_labels_rotation:null,y_labels:[],y_scale:"linear",y2_labels:[],y2_scale:"linear",x_tick_interval:0,y_tick_interval:30,y2_tick_interval:30,x_labeled_tick_interval:1,y_labeled_tick_interval:5,y2_labeled_tick_interval:5,default_line_color:"black",default_line_width:1,show_legend:!1,legend_position:"right",show_grid:!1,short_axis_labels:!1,normalize_stacked_area:!0,width:800,height:400},options:[{general:[{name:"type",type:"select",description:"type of the graph",title:"type",options:[{value:"column",selected:!0},{value:"stackedColumn",label:"stacked column"},{value:"row"},{value:"stackedRow",label:"stacked row"},{value:"line"},{value:"pie"},{value:"stackedArea",label:"stacked area"},{value:"deviation",label:"deviation"}]},{name:"default_line_color",type:"color",description:"default color of the data lines of the graph",title:"default line color"},{name:"default_line_width",type:"int",description:"default width of the data lines of the graph in pixel",title:"default line width"},{name:"show_grid",type:"select",description:"sets whether grid is displayed or not",title:"show grid",options:[{value:0,selected:!0,label:"no"},{value:1,label:"yes"}]}]},{text:[{name:"title",type:"text",description:"title string of the graph",title:"title"},{name:"title_color",type:"color",description:"color of the title string of the graph",title:"title color"},{name:"x_title",type:"text",description:"title of the x-axis of the graph",title:"x title"},{name:"y_title",type:"text",description:"title of the y-axis of the graph",title:"y title"},{name:"x_title_color",type:"color",description:"color of the title of the x-axis of the graph",title:"x title color"},{name:"y_title_color",type:"color",description:"color of the title of the y-axis of the graph",title:"y title color"},{name:"x_labels_rotation",type:"int",description:"rotation in degrees of the x-axis labels",title:"x label rotation"}]},{layout:[{name:"width",type:"int",description:"width of the graph in pixel",title:"width"},{name:"height",type:"int",description:"height of the graph in pixel",title:"height"},{name:"show_legend",type:"select",description:"sets whether the legend is displayed or not",title:"show legend",options:[{value:0,selected:!0,label:"no"},{value:1,label:"yes"}]},{name:"legend_position",type:"select",description:"position of the legend",title:"legend position",options:[{value:"left",selected:!0},{value:"right"},{value:"top"},{value:"bottom"}]}]},{axes:[{name:"y_scale",type:"select",description:"type of the scale of the y-axis",title:"y scale",options:[{value:"linear",selected:!0},{value:"log"}]},{name:"x_tick_interval",type:"int",description:"pixel distance of the minor tickmarks on the x-axis",title:"minor x ticks"},{name:"y_tick_interval",type:"int",description:"pixel distance of the minor tickmarks on the y-axis",title:"minor y ticks"},{name:"x_labeled_tick_interval",type:"int",description:"pixel distance of the major tickmarks on the x-axis",title:"major x ticks"},{name:"y_labeled_tick_interval",type:"int",description:"pixel distance of the major tickmarks on the y-axis",title:"major y ticks"},{name:"short_axis_labels",type:"select",description:"sets whether the axis labels should be shortened or not",title:"short axis labels",options:[{value:0,selected:!0,label:"no"},{value:1,label:"yes"}]}]}],exampleData:function(){return[{name:"IE",data:[95,91,78,66]},{name:"Netscape",data:[3,12,18,18]},{name:"Firefox",data:[0,4,8,9]},{name:"Chrome",data:[0,8,18,22]},{name:"Gecko",data:[1,2,3,33]}]},create:function(b){var c={settings:{},index:b.index};return a.extend(!0,c,this),a.extend(!0,c.settings,this.defaults,b),c},render:function(){var b=this.settings.target;b.innerHTML="<div class='graph_div'></div>",b.firstChild.setAttribute("style","width: "+this.settings.width+"px; height: "+this.settings.height+"px;"),a(b).find(".graph_div").svg();var c=0;return"deviation"!==this.settings.type||this.settings.data[0].data.hasOwnProperty("upper")||(this.calculateData(this.settings.data),c=this.cmax),this.drawImage(a(b).find(".graph_div").svg("get"),c),this},niceNum:function(a,b){var c,d=Math.floor(Math.log10(a)),e=a/Math.pow(10,d);return c=b?1.5>e?1:3>e?2:7>e?5:10:1>=e?1:2>=e?2:5>=e?5:10,c*Math.pow(10,d)},niceScale:function(a){var b=a.min,c=a.max,d=a.ticks||10,e=this.niceNum(c-b,!1),f=this.niceNum(e/(d-1),!0),g=Math.floor(b/f)*f,h=Math.ceil(c/f)*f;return{min:g,max:h,space:f}},hover:function(b,c,d,e){var f=e.currentTarget.ownerSVGElement.ownerSVGElement.parentNode.id,g=f.substr(9),h=a("#"+f).svg("get");if(b?(a(this,h.root()).attr("fill-opacity",.8),a(this,h.root()).attr("title",b+": "+c)):a(this,h.root()).attr("fill-opacity",1),"click"===d){var i=parseInt(this.parentElement.className.baseVal.substr(this.parentElement.className.baseVal.search(/\d+/)),10);if(h.graph.options({explode:[i],explodeDist:15}),"function"==typeof this.settings.onclick){var j,k="";for(j=0;j<this.parentElement.children.length;j+=1)if(this.parentElement.children[j]===this){this.getAttribute("r")&&(j-=1),k=h.graph.xAxis.labels().labels[j];break}this.settings.onclick({"this":g,series:b,value:c,label:k,item:this,index:j,series_index:i,svg:h})}}},drawImage:function(a,b){var c,d,e=[[.1,.1,.95,.9],[.2,.1,.95,.9],[.1,.1,.75,.9],[.1,.25,.9,.9],[.1,.1,.9,.8]],f=[[0,0,0,0],[.005,.1,.125,.5],[.8,.1,.97,.5],[.2,.1,.8,.2],[.2,.9,.8,.995]],g=["url(#fadeBlue)","url(#fadeRed)","url(#fadeGreen)","url(#fadeYellow)","url(#fadeLightblue)","url(#fadePurple)"],h=a.defs(),i=0,j=0;for(c=0;c<this.settings.data.length;c+=1)for(d=0;d<this.settings.data[c].data.length;d+=1)this.settings.data[c].settings&&this.settings.data[c].settings.isY2?parseFloat(this.settings.data[c].data[d])>j&&(j=parseFloat(this.settings.data[c].data[d])):parseFloat(this.settings.data[c].data[d])>i&&(i=parseFloat(this.settings.data[c].data[d]));for(i=b||i,a.linearGradient(h,"fadeRed",[[0,"#EE5F5B"],[1,"#BD362F"]]),a.linearGradient(h,"fadeBlue",[[0,"#0088CC"],[1,"#0044CC"]]),a.linearGradient(h,"fadeGreen",[[0,"#62C462"],[1,"#51A351"]]),a.linearGradient(h,"fadeYellow",[[0,"#FBB450"],[1,"#F89406"]]),a.linearGradient(h,"fadeLightblue",[[0,"#5BC0DE"],[1,"#2F96B4"]]),a.linearGradient(h,"fadePurple",[[0,"#ee5be0"],[1,"#bd2fa6"]]),a.graph.shortAxisLabels=this.settings.short_axis_labels,a.graph.normalizeStackedArea=this.settings.normalize_stacked_area,a.graph.noDraw().title(this.settings.title,this.settings.title_color,this.settings.title_settings),a.graph.noDraw().format("white",this.settings.show_grid?"gray":"white"),this.settings.show_grid&&a.graph.noDraw().gridlines({stroke:"gray",strokeDashArray:"2,2"},"gray"),c=0;c<this.settings.data.length;c+=1){[this.settings.data[c].name,this.settings.data[c].data,null,this.settings.data[c].lineColor||"red",this.settings.data[c].lineWidth||this.settings.default_line_width,this.settings.data[c].settings||{}];a.graph.noDraw().addSeries(this.settings.data[c].name,this.settings.data[c].data,null,this.settings.data[c].lineColor||"red",this.settings.data[c].lineWidth||this.settings.default_line_width,this.settings.data[c].settings||{})}a.graph.xAxis.title(this.settings.x_title,this.settings.x_title_color).ticks(this.settings.x_labeled_tick_interval,this.settings.x_tick_interval).scale(0,3),this.settings.x_labels.length&&(a.graph.xAxis.labelRotation=this.settings.x_labels_rotation,a.graph.xAxis.labels(this.settings.x_labels));var k=this.niceScale({min:0,max:i,ticks:this.settings.y_labeled_tick_interval});a.graph.yAxis.title(this.settings.y_title,this.settings.y_title_color).ticks(k.max/this.settings.y_labeled_tick_interval,k.max/this.settings.y_tick_interval,null,null,this.settings.y_scale).scale(0,i,this.settings.y_scale),this.settings.hasY2?(a.graph.y2Axis.title(this.settings.y2_title||"",this.settings.y2_title_color).ticks(parseInt(j/this.settings.y2_labeled_tick_interval,10),parseInt(j/this.settings.y2_tick_interval,10),null,null,this.settings.y_scale).scale(0,j,this.settings.y2_scale),this.settings.y2_labels.length&&a.graph.y2Axis.labels(this.settings.y2_labels)):a.graph.y2Axis=null,this.settings.y_labels.length&&a.graph.yAxis.labels(this.settings.y_labels),a.graph.legend.settings({fill:"white",stroke:"white"});var l=this.settings.type,m=0;if(this.settings.show_legend)switch(this.settings.legend_position){case"left":m=1;break;case"right":m=2;break;case"top":m=3;break;case"bottom":m=4}var n={barWidth:this.settings.barWidth||25};for(a.graph.status(this.hover),a.graph.noDraw().legend.show(this.settings.show_legend).area(this.settings.legendArea||f[m]).end(),c=0;c<this.settings.data.length;c+=1)a.graph.noDraw().series(c).format(this.settings.data[c].fill||g[c]).end();a.graph.noDraw().area(this.settings.chartArea||e[m]).type(l,n).redraw()},calculateData:function(a){var b,c=[],d=a[0].data[0],e=a[0].data[0];for(b=0;b<a.length;b+=1){a[b].data=a[b].data.sort(function(a,b){return a-b}),a[b].data[0]<d&&(d=a[b].data[0]),a[b].data[a[b].data.length-1]>e&&(e=a[b].data[a[b].data.length-1]),c[b]=[],c[b].min=a[b].data[0],c[b].max=a[b].data[a[b].data.length-1];if(a[b].data.length%2===1){var f=parseInt(a[b].data.length/2);c[b].median=a[b].data[f],(f+1)%2===1?(c[b].lower=a[b].data[parseInt((f+1)/2)],c[b].upper=a[b].data[f+parseInt((f+1)/2)]):(c[b].lower=(a[b].data[(f+1)/2]+a[b].data[(f+1)/2+1])/2,c[b].upper=(a[b].data[f+(f+1)/2-1]+a[b].data[f+(f+1)/2])/2)}else{var g=a[b].data.length/2,h=a[b].data.length/2-1;c[b].median=(a[b].data[h]+a[b].data[g])/2,g%2===1?(c[b].lower=a[b].data[h/2],c[b].upper=a[b].data[g+h/2]):(c[b].lower=(a[b].data[g/2-1]+a[b].data[g/2])/2,c[b].upper=(a[b].data[g+g/2-1]+a[b].data[g+g/2])/2)}}for(var b=0;b<a.length;b++)this.settings.data[b].data=[c[b]];this.cmax=e}};return b});