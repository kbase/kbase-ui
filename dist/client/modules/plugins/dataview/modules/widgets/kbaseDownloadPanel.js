define(["jquery","bluebird","kb.runtime","kb.html","kb.service.workspace","kb.utils","kb.jquery.widget"],function(a,b,c,d,e,f){"use strict";a.KBWidget({name:"kbaseDownloadPanel",parent:"kbaseWidget",version:"1.0.0",options:{dropdown:null,navbar:null,params:null},token:null,type:null,wsId:null,objId:null,wsUrl:null,transformURL:null,ujsURL:null,shockURL:null,exportURL:null,timer:null,downloaders:{"KBaseGenomes.ContigSet":[{name:"FASTA",external_type:"FASTA.DNA.Assembly",transform_options:{output_file_name:"?.fasta"}}],"KBaseGenomes.Genome":[{name:"GENBANK",external_type:"Genbank.Genome",transform_options:{}}],"KBaseAssembly.SingleEndLibrary":[{name:"FASTA/FASTQ",external_type:"SequenceReads",transform_options:{}}],"KBaseAssembly.PairedEndLibrary":[{name:"FASTA/FASTQ",external_type:"SequenceReads",transform_options:{}}],"KBaseFile.SingleEndLibrary":[{name:"FASTA/FASTQ",external_type:"SequenceReads",transform_options:{}}],"KBaseFile.PairedEndLibrary":[{name:"FASTA/FASTQ",external_type:"SequenceReads",transform_options:{}}],"KBaseFBA.FBAModel":[{name:"SBML",external_type:"SBML.FBAModel",transform_options:{}},{name:"TSV",external_type:"TSV.FBAModel",transform_options:{}},{name:"EXCEL",external_type:"Excel.FBAModel",transform_options:{}}],"KBaseFBA.FBA":[{name:"TSV",external_type:"TSV.FBA",transform_options:{}},{name:"EXCEL",external_type:"Excel.FBA",transform_options:{}}],"KBaseBiochem.Media":[{name:"TSV",external_type:"TSV.Media",transform_options:{}},{name:"EXCEL",external_type:"Excel.Media",transform_options:{}}],"KBasePhenotypes.PhenotypeSet":[{name:"TSV",external_type:"TSV.PhenotypeSet",transform_options:{}}],"KBasePhenotypes.PhenotypeSimulationSet":[{name:"TSV",external_type:"TSV.PhenotypeSimulationSet",transform_options:{}},{name:"EXCEL",external_type:"Excel.PhenotypeSimulationSet",transform_options:{}}],"KBaseGenomes.Pangenome":[{name:"TSV",external_type:"TSV.Pangenome",transform_options:{}},{name:"EXCEL",external_type:"Excel.Pangenome",transform_options:{}}]},init:function(a){this._super(a),this.wsUrl=c.getConfig("services.workspace.url"),this.transformURL=c.getConfig("services.transform.url"),this.ujsURL=c.getConfig("services.user_job_state.url"),this.shockURL=c.getConfig("services.shock.url"),this.exportURL=c.getConfig("services.data_import_export.url"),this.token=c.getAuthToken(),this.type=null,this.wsId=this.options.params.ws,this.objId=this.options.params.obj;var d=this,f=new e(this.wsUrl,{token:this.token});return b.resolve(f.get_object_info_new({objects:[{ref:this.wsId+"/"+this.objId}]})).then(function(a){d.objId=a[0][1],d.type=a[0][2].split("-")[0],d.wsId=a[0][7],d.render()})["catch"](function(a){console.error("ERROR"),console.error(a)}),this},render:function(){var b=this,c=this.$elem;c.css({"min-width":"260px","margin-left":"10px"});var d=a("<td>").css({"white-space":"nowrap",padding:"1px"}).append("Export as:"),e=a("<td>").css({padding:"1px"});c.append(a("<table>").css({width:"100%"}).append("<tr>").append(d).append(e));var f=a("<button>").addClass("kb-data-list-cancel-btn").append("Cancel").click(function(){b.stopTimer(),e.find(".kb-data-list-btn").prop("disabled",!1),b.$statusDivContent.empty()}),g=function(c){var d=a("<button>").addClass("kb-data-list-btn").append(c.name).click(function(a){a.stopPropagation(),e.find(".kb-data-list-btn").prop("disabled",!0),b.runDownloader(b.type,b.wsId,b.objId,c,function(a){a&&f.click()})});e.append(d)},h=b.prepareDownloaders(b.type,b.wsId,b.objId);for(var i in h)g(h[i]);var j=a("<button>").addClass("kb-data-list-btn").append("JSON").click(function(a){var c=b.exportURL+"/download?ws="+encodeURIComponent(b.wsId)+"&id="+encodeURIComponent(b.objId)+"&token="+encodeURIComponent(b.token)+"&url="+encodeURIComponent(b.wsUrl)+"&wszip=1&name="+encodeURIComponent(b.objId+".JSON.zip");b.downloadFile(c)});e.append(j),e.append("<br>").append(f),b.$statusDiv=a("<div>").css({margin:"15px"}),b.$statusDivContent=a("<div>"),b.$statusDiv.append(b.$statusDivContent),c.append(b.$statusDiv.hide())},prepareDownloaders:function(a,b,c){var d=this.downloaders[a],e=[];for(var f in d){var g=d[f],h={name:g.name,external_type:g.external_type,unzip:g.unzip};if(e.push(h),g.transform_options){h.transform_options={};for(var i in g.transform_options)if(g.transform_options.hasOwnProperty(i)){var j=g.transform_options[i];0==j.indexOf("?")&&(j=c+j.substring(1)),h.transform_options[i]=j}}}return e},runDownloader:function(b,c,e,f,g){var h=this;h.showMessage(d.loading()+"Export status: Preparing data"),h.$statusDiv.show();var i=f.transform_options;i||(i={});var j={external_type:f.external_type,kbase_type:b,workspace_name:c,object_name:e,optional_arguments:{transform:i}};console.log("Downloader data to be sent to transform service:"),console.log(JSON.stringify(j));var k="."+f.name.replace(/[^a-zA-Z0-9|\.\-_]/g,"_"),l=new Transform(this.transformURL,{token:this.token});l.download(j,a.proxy(function(a){console.log(a);var b=a[1];h.waitForJob(b,e+k,f.unzip,g)},this),a.proxy(function(a){console.log(a.error.error),h.showError(a.error.error),g&&g(!1)},this))},showButtonSpinner:function(a){var b=this.options.dropdown.find("button").find(".fa");b.find("img").remove(),a&&b.append(d.loading())},waitForJob:function(a,b,c,e){var f=this,g=new UserAndJobState(this.ujsURL,{token:this.token}),h=function(h){g.get_job_status(a,function(h){var i=h[2],j=h[5],k=h[6];1===j?(f.stopTimer(),0===k?(console.log("Export is complete"),g.get_results(a,function(a){f.$statusDiv.hide(),f.$elem.find(".kb-data-list-btn").prop("disabled",!1),console.log(a),f.downloadUJSResults(a,b,c),e&&e(!0)},function(a){console.log(a.error.message),f.showError(a.error.message),e&&e(!1)})):(console.log(i),f.showError(i),e&&e(!1))):(console.log("Export status: "+i,!0),f.showMessage(d.loading()+" Export status: "+i))},function(a){f.stopTimer(),console.log(a.error.message),f.showError(a.error.message),e&&e(!1)})};f.timer=setInterval(h,5e3),h()},downloadUJSResults:function(a,b,c){var d=this,e=a.shocknodes[0],f=e.split("/");f.length>1&&(e=f[f.length-1]),f=e.split("?"),f.length>0&&(e=f[0]),console.log("Shock node ID: "+e);var g=(new ShockClient({url:d.shockURL,token:d.token}),function(b){var f=d.exportURL+"/download?id="+e+"&token="+encodeURIComponent(d.token)+"&del=1";f+=c?"&unzip="+encodeURIComponent(c):"&name="+encodeURIComponent(b);var g=a.shockurl;g&&(f+="&url="+encodeURIComponent(g)),d.downloadFile(f)});g(b+".zip")},downloadFile:function(a){console.log("Downloading url="+a);var b="hiddenDownloader",c=document.getElementById(b);null===c&&(c=document.createElement("iframe"),c.id=b,c.style.display="none",document.body.appendChild(c)),c.src=a},showMessage:function(a){var b=this;b.$statusDivContent.empty(),b.$statusDivContent.append(a)},showError:function(b){var c=this;c.$statusDivContent.empty(),c.$elem.find(".kb-data-list-btn").prop("disabled",!1),c.$statusDivContent.append(a("<span>").css({color:"#F44336"}).append("Error: "+b))},stopTimer:function(){null!=this.timer&&(clearInterval(this.timer),this.timer=null,console.log("Timer was stopped"))}})});