define(["jquery","bluebird","underscore","kb/service/client/workspace","kb/common/html","kb/service/utils"],function(a,b,c,d,e,f){"use strict";function g(c){function g(a,b){var c=x.getService("type").getViewer({type:a});if(c&&b.sub&&b.subid){if(!c.sub)throw new Error("Sub was specified, but config has no sub handler, sub:"+b.sub);if(!c.sub.hasOwnProperty(b.sub))throw new Error("Sub was specified, but config has no correct sub handler, sub:"+b.sub+"config:");c=c.sub[b.sub]}return c}function h(a){return[a.workspaceId,a.objectId,a.objectVersion].filter(function(a){return a?!0:void 0}).join("/")}function i(a){return new b(function(c,e){var i=new d(x.getConfig("services.workspace.url"),{token:x.getService("session").getAuthToken()}),j=[{ref:h(a)}];b.resolve(i.get_object_info_new({objects:j,ignoreErrors:1,includeMetadata:1})).then(function(b){if(0===b.length)return void e("Object not found");if(b.length>1)return void e("Too many ("+b.length+") objects found.");if(null===b[0])return void e("Null object returned");var d=f.object_info_to_object(b[0]),h=f.parseTypeId(d.type),i=g(h,a);if(!i)return void e("Not Found","Sorry, cannot find widget for "+h.module+"."+h.name);var j={workspaceId:a.workspaceId,objectId:a.objectId,objectName:d.name,workspaceName:d.ws,objectVersion:d.version,objectType:d.type,type:d.type};a.sub&&(j[a.sub.toLowerCase()+"ID"]=a.subid),i.options&&i.options.forEach(function(a){var b=j[a.from];if(!b&&a.optional!==!0)throw"Missing param, from "+a.from+", to "+a.to;j[a.to]=b}),x.getService("widget").makeWidget(i.widget.name,i.widget.config).then(function(a){c({widget:a,params:j,mapping:i})})["catch"](function(a){e(a)})})["catch"](function(a){e(a)})})}function j(a){var b;console.log("ERROR"),console.log(a),b="string"==typeof a?a:a.message?a.message:a.error&&a.error.error?a.error.error.message:"Unknown Error",r.innerHTML=e.bsPanel("Error",b)}function k(c){return new b(function(b){q=c,r=document.createElement("div"),s=a(r),q.appendChild(r),b()})}function l(a){return new b(function(b,d){var f;i(a).then(function(a){if(t=a.widget,f=a.params,w=a.params,a.mapping.panel){var b=r.appendChild(document.createElement("div")),d=e.genId(),g=e.tag("div");b.innerHTML=e.makePanel({title:"Data View",content:g({id:d})}),v=!0,u=document.getElementById(d)}else u=r;return t.init?t.init(c):null}).then(function(){return t.attach(u)}).then(function(){return t.start(f)}).then(function(){b()})["catch"](function(a){j(a),d(a)})})}function m(a){return b["try"](function(){return t.run(a)})}function n(){return new b(function(a,b){t&&t.stop?t.stop().then(function(){a()})["catch"](function(a){b(a)}):a()})}function o(){return new b(function(a,b){t&&t.detach?t.detach().then(function(){a()})["catch"](function(a){b(a)}):a()})}function p(){return new b(function(a){t&&t.destroy?t.destroy().then(function(){a()})["catch"](function(a){reject(a)}):a()})}var q,r,s,t,u,v,w,x=c.runtime;return{attach:k,start:l,run:m,stop:n,detach:o,destroy:p}}return{make:function(a){return g(a)}}});