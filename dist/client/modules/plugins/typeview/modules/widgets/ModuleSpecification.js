define(["jquery","bluebird","underscore","kb/common/html","kb/service/workspace","kb_spec_common","google-code-prettify","kb/common/format","datatables_bootstrap"],function(a,b,c,d,e,f,g,h){"use strict";var i=function(i){function j(){return D({"class":"table table-striped table-bordered",style:{width:"100%"},"data-attach":"table"})}function k(a){var b=B.getService("session").getUsername();c.some(a.owners,function(a){return a===b});return D({"class":"table table-striped table-bordered",style:"margin-left: auto; margin-right: auto"},[E([F("Name"),G(z)]),E([F("Owners"),G(a.owners.join(", "))]),E([F("Version"),G(A)]),E([F("Upload time"),G(h.niceTime(a.ver))]),E([F("Description"),G(J({style:{"white-space":"pre-wrap","word-wrap":"break-word"}},a.description))])])}function l(a){var b=f.replaceMarkedTypeLinksInSpec(z,a.spec,"links-click"),c=I({style:{width:"100%"}},[J({"class":"prettyprint lang-spec"},b)]);return{content:c,widget:{attach:function(a){g.prettyPrint(null,a.get(0))}}}}function m(b){var c=b.functions.map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:H({href:"#","data-action":"spec-functions","data-funcid":a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Function name",mData:"name"},{sTitle:"Function version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search function:",sEmptyTable:"No functions use this type"}};return{content:j(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function n(b){var c=Object.keys(b.types).map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:H({href:"#spec/type/"+a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Type name",mData:"name"},{sTitle:"Type version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search types:",sEmptyTable:"No types registered"}};return{content:j(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function o(b){var c=Object.keys(b.included_spec_version).map(function(a){var c=b.included_spec_version[a],d=a+"-"+c;return{name:H({href:"#spec/module/"+d},a),ver:c}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Module name",mData:"name"},{sTitle:"Module version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search module:",sEmptyTable:"No included modules used."}};return{content:j(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function p(c){return{content:j(),widget:{attach:function(c){b.resolve(C.list_module_versions({mod:z})).then(function(b){var d=b.vers.map(function(a){return a===A?{name:""+a+" (current)",date:a}:{name:H({href:"#spec/module/"+z+"-"+a},a),date:a}}),e={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Module version",mData:"name"},{sTitle:"Upload date",mData:function(a,b){switch(b){case"display":return h.niceTime(a.date);default:return a.date}}}],aaData:d,oLanguage:{sSearch:"Search versions:",sEmptyTable:"No versions registered."}};a(c).find('[data-attach="table"]').dataTable(e)})["catch"](function(a){console.log("ERROR"),console.log(a)}).done()}}}}function q(){return new b(function(c,e){b.resolve(C.get_module_info({mod:z,ver:A})).then(function(b){var e=[{title:"Overview",id:"overview",content:k},{title:"Spec-file",id:"spec",content:l},{title:"Types",id:"types",content:n},{title:"Functions",id:"funcs",content:m},{title:"Included modules",id:"inc",content:o},{title:"Versions",id:"vers",content:p}],f="_"+d.genId(),h=[],i=I([K({id:f,"class":"nav nav-tabs"},e.map(function(a){var b="overview"===a.id?"active":"";return L({"class":b},H({href:"#"+a.id+f,"data-toggle":"tab"},a.title))})),I({"class":"tab-content"},e.map(function(a){var c="overview"===a.id?" active":"",e=a.content(b);if("string"==typeof e)return I({"class":"tab-pane in"+c,id:a.id+f},a.content(b));var g=d.genId();return h.push({id:g,widget:e.widget}),I({"class":"tab-pane in"+c,id:a.id+f},[I({id:g},[e.content])])}))]);y.html(i),h.forEach(function(b){b.widget.attach(a("#"+b.id))}),g.prettyPrint(),c()})["catch"](function(a){e(a)}).done()})}function r(){return new b(function(a){a()})}function s(c){return new b(function(b){w=c,x=document.createElement("div"),w.appendChild(x),y=a(x),b()})}function t(){return new b(function(a){x.empty(),a()})}function u(a){return new b(function(b,c){y.html(d.loading());var e=a.moduleid,f=e.match(/^(.+?)-(.+)$/);if(!f)throw new Error("Invalid module id "+e);if(3!==f.length)throw new Error("Invalid module id "+e);z=f[1],A=f[2],q().then(function(){b()})["catch"](function(a){c(a)}).done()})}function v(){return new b(function(a){a()})}var w,x,y,z,A,B=i.runtime,C=new e(B.getConfig("workspace_url",{token:B.getService("session").getAuthToken()})),D=d.tag("table"),E=d.tag("tr"),F=d.tag("th"),G=d.tag("td"),H=d.tag("a"),I=d.tag("div"),J=d.tag("pre"),K=d.tag("ul"),L=d.tag("li");return{create:r,attach:s,detach:t,start:u,stop:v}};return{make:function(a){return i(a)}}});