define(["jquery","bluebird","underscore","kb/common/html","kb/service/workspace","kb_spec_common","google-code-prettify","kb/common/format"],function(a,b,c,d,e,f,g,h){"use strict";var i=function(c){function h(){return B({"class":"table table-striped table-bordered",style:{width:"100%"},"data-attach":"table"})}function i(a){var b=a.func_def.match(/-/),c=b[1],d=b[2],e=a.module_vers.map(function(a){var b=w+"."+a;return F({href:"#spec/module/"+b},a)});return B({"class":"table table-striped table-bordered",style:"margin-left: auto; margin-right: auto"},[C([D("Name"),E(c)]),C([D("Version"),E(d)]),C([D("Module version(s)"),E(e.join(", "))]),C([D("Description"),E(H({style:{"white-space":"pre-wrap","word-wrap":"break-word"}},a.description))])])}function j(a){var b=f.replaceMarkedTypeLinksInSpec(w,a.spec_def,"links-click"),c=G({style:{width:"100%"}},[H({"class":"prettyprint lang-spec"},b)]);return{content:c,widget:{attach:function(a){g.prettyPrint(null,a.get(0))}}}}function k(b){var c=b.used_type_defs.map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:F({href:"#spec/type/"+a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Type name",mData:"name"},{sTitle:"Type version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search types:",sEmptyTable:"No types use this type"}};return{content:h(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function l(b){var c=b.func_vers.map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:F({href:"#spec/function/"+a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Function name",mData:"name"},{sTitle:"Function version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search versions:",sEmptyTable:"No versions registered"}};return{content:h(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function m(){return new b(function(c,e){b.resolve(A.get_func_info(v)).then(function(b){var e=[{title:"Overview",id:"overview",content:i},{title:"Spec-file",id:"spec",content:j},{title:"Sub-types",id:"subs",content:k},{title:"Versions",id:"vers",content:l}],f="_"+d.genId(),h=[],m=G([I({id:f,"class":"nav nav-tabs"},e.map(function(a){var b="overview"===a.id?"active":"";return J({"class":b},F({href:"#"+a.id+f,"data-toggle":"tab"},a.title))})),G({"class":"tab-content"},e.map(function(a){var c="overview"===a.id?" active":"",e=a.content(b);if("string"==typeof e)return G({"class":"tab-pane in"+c,id:a.id+f},a.content(b));var g=d.genId();return h.push({id:g,widget:e.widget}),G({"class":"tab-pane in"+c,id:a.id+f},[G({id:g},[e.content])])}))]);u.html(m),h.forEach(function(b){b.widget.attach(a("#"+b.id))}),g.prettyPrint(),c()})["catch"](function(a){e(a)}).done()})}function n(){return new b(function(a){a()})}function o(c){return new b(function(b){s=c,t=document.createElement("div"),s.appendChild(t),u=a(t),b()})}function p(){return new b(function(a){t.empty(),a()})}function q(a){return new b(function(b,c){u.html(d.loading()),v=a.functionid;var e=v.match(/^(.+?)-(.+)\.(.+)$/);if(!e)throw new Error("Invalid function id "+v);if(4!==e.length)throw new Error("Invalid function id "+v);w=e[1],x=e[2],y=e[3],m().then(function(){b()})["catch"](function(a){c(a)}).done()})}function r(){return new b(function(a){a()})}var s,t,u,v,w,x,y,z=c.runtime,A=new e(z.getConfig("services.workspace.url",{token:z.getService("session").getAuthToken()})),B=d.tag("table"),C=d.tag("tr"),D=d.tag("th"),E=d.tag("td"),F=d.tag("a"),G=d.tag("div"),H=d.tag("pre"),I=d.tag("ul"),J=d.tag("li");return{create:n,attach:o,detach:p,start:q,stop:r}};return{make:function(a){return i(a)}}});