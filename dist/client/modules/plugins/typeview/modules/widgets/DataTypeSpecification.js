define(["jquery","bluebird","kb/common/html","kb/common/utils","kb/service/client/workspace","kb_spec_common","google-code-prettify","datatables_bootstrap"],function(a,b,c,d,e,f,g){"use strict";var h=function(h){function i(){return D({"class":"table table-striped table-bordered",style:{width:"100%"},"data-attach":"table"})}function j(a){return D({"class":"table table-striped table-bordered",style:"margin-left: auto; margin-right: auto"},[E([F("Name"),G(A)]),E([F("Version"),G(B)]),E([F("Module version(s)"),G(M(["Version id","Created at"],a.module_vers.map(function(a){var b=z+"-"+a;return[H({href:"#spec/module/"+b},a),d.niceTimestamp(parseInt(a,10))]})))]),E([F("Description"),G(J({style:{"white-space":"pre-wrap","word-wrap":"break-word"}},a.description))])])}function k(a){var b=f.replaceMarkedTypeLinksInSpec(z,a.spec_def,"links-click"),c=I({style:{width:"100%"}},[J({"class":"prettyprint lang-spec"},b)]);return{content:c,widget:{attach:function(a){g.prettyPrint(null,a.get(0))}}}}function l(b){var c=b.using_func_defs.map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:H({href:"#spec/functions/"+a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Function name",mData:"name"},{sTitle:"Function version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search function:",sEmptyTable:"No functions use this type"}};return{content:i(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function m(b){var c=b.using_type_defs.map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:H({href:"#spec/type/"+a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Type name",mData:"name"},{sTitle:"Type version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search types:",sEmptyTable:"No types use this type"}};return{content:i(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function n(b){var c=b.used_type_defs.map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:H({href:"#spec/type/"+a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Type name",mData:"name"},{sTitle:"Type version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search types:",sEmptyTable:"No types use this type"}};return{content:i(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function o(b){var c=b.type_vers.map(function(a){var b=a.match(/^(.+?)-(.+?)$/),c=b[1],d=b[2];return{name:H({href:"#spec/type/"+a},c),ver:d}}),d={sPaginationType:"full_numbers",iDisplayLength:10,aoColumns:[{sTitle:"Type name",mData:"name"},{sTitle:"Type version",mData:"ver"}],aaData:c,oLanguage:{sSearch:"Search versions:",sEmptyTable:"No versions registered"}};return{content:i(),widget:{attach:function(b){a(b).find('[data-attach="table"]').dataTable(d)}}}}function p(){var d=new e(C.getConfig("workspace_url",{token:C.getService("session").getAuthToken()}));b.resolve(d.get_type_info(y)).then(function(b){var d=[{title:"Overview",id:"overview",content:j},{title:"Spec-file",id:"spec",content:k},{title:"Functions",id:"funcs",content:l},{title:"Using Types",id:"types",content:m},{title:"Sub-types",id:"subs",content:n},{title:"Versions",id:"vers",content:o}],e="_"+c.genId(),f=[],h=I([K({id:e,"class":"nav nav-tabs"},d.map(function(a){var b="overview"===a.id?"active":"";return L({"class":b},H({href:"#"+a.id+e,"data-toggle":"tab"},a.title))})),I({"class":"tab-content"},d.map(function(a){var d="overview"===a.id?" active":"",g=a.content(b);if("string"==typeof g)return I({"class":"tab-pane in"+d,id:a.id+e},a.content(b));var h=c.genId();return f.push({id:h,widget:g.widget}),I({"class":"tab-pane in"+d,id:a.id+e},[I({id:h},[g.content])])}))]);x.html(h),f.forEach(function(b){b.widget.attach(a("#"+b.id))}),g.prettyPrint()})["catch"](function(a){var b="Error rendering widget";console.log(a),x.html(b)})}function q(){return new b(function(a){a()})}function r(c){return new b(function(b){v=c,w=document.createElement("div"),v.appendChild(w),x=a(w),b()})}function s(){return new b(function(a){x.empty(),a()})}function t(a){return new b(function(b){x.html(c.loading()),y=a.datatype;var d=y.match(/^(.+?)\.(.+?)-(.+)$/);if(!d)throw new Error("Invalid data type "+y);if(4!==d.length)throw new Error("Invalid data type "+y);z=d[1],A=d[1]+"."+d[2],B=d[3],p(),b()})}function u(){return new b(function(a){a()})}var v,w,x,y,z,A,B,C=h.runtime;console.log("creating data type spec widget..");var v,w,x,D=c.tag("table"),E=c.tag("tr"),F=c.tag("th"),G=c.tag("td"),H=c.tag("a"),I=c.tag("div"),J=c.tag("pre"),K=c.tag("ul"),L=c.tag("li"),M=function(a,b){return c.makeTable({columns:a,rows:b,"class":"table"})};return{create:q,attach:r,detach:s,start:t,stop:u}};return{make:function(a){return h(a)}}});