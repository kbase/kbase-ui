define(["jquery","kb_dashboard_widget_base","kb/service/serviceApi","kb/widget/widgets/buttonBar","bluebird","bootstrap"],function(a,b,c,d,e){"use strict";var f=Object.create(b,{init:{value:function(a){return a.name="SharedNarrativesWidget",a.title="Narratives Shared with You",this.DashboardWidget_init(a),this.params.limit=10,this.view="slider",this.templates.env.addFilter("appName",function(a){return this.getState(["appsMap",a,"name"],a)}.bind(this)),this.templates.env.addFilter("methodName",function(a){return this.getState(["methodsMap",a,"name"],a)}.bind(this)),this}},setup:{value:function(){this.kbservice=c.make({runtime:this.runtime})}},getAppName:{value:function(a){return this.getState(["appsMap",a,"name"],a)}},getMethodName:{value:function(a){return this.getState(["methodsMap",a,"name"],a)}},setupUI:{value:function(){this.hasState("narratives")&&this.getState("narratives").length>0&&(this.buttonbar=Object.create(d).init({container:this.container.find('[data-placeholder="buttonbar"]')}),this.buttonbar.clear().addInput({placeholder:"Search",place:"end",onkeyup:function(b){this.setParam("filter",a(b.target).val())}.bind(this)}))}},render:{value:function(){return this.error?this.renderError():this.runtime.getService("session").isLoggedIn()?(this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate(this.view))):(this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate("unauthorized"))),this.container.find('[data-toggle="popover"]').popover(),this.container.find('[data-toggle="tooltip"]').tooltip(),this}},filterState:{value:function(){var a=this.getParam("filter");if(!a||0===a.length)return void this.setState("narrativesFiltered",this.getState("narratives"));try{var b=new RegExp(a,"i")}catch(c){}var d=this.getState("narratives").filter(function(a){return a.workspace.metadata.narrative_nice_name.match(b)||a.object.metadata.cellInfo&&function(a){for(var c in a){var d=a[c];if(d.match(b)||this.getAppName(d).match(b))return!0}}.bind(this)(Object.keys(a.object.metadata.cellInfo.app))||a.object.metadata.cellInfo&&function(a){for(var c in a){var d=a[c];if(d.match(b)||this.getMethodName(d).match(b))return!0}}.bind(this)(Object.keys(a.object.metadata.cellInfo.method))?!0:!1}.bind(this));this.setState("narrativesFiltered",d)}},onStateChange:{value:function(){var a=this.doState("narratives",function(a){return a.length},null),b=this.doState("narrativesFiltered",function(a){return a.length},null);this.viewState.setItem("sharedNarratives",{count:a,filtered:b})}},setInitialState:{value:function(a){return e["try"](function(){return e.all([this.kbservice.getNarratives({params:{showDeleted:0}}),this.kbservice.getApps(),this.kbservice.getMethods()]).then(function(a){var b=a[0],c=a[1],d=a[2];this.setState("apps",c);var e={};c.forEach(function(a){e[a.id]=a}),this.setState("appsMap",e),this.setState("methods",d);var f={};return d.forEach(function(a){f[a.id]=a}),this.setState("methodsMap",f),0===b.length?void this.setState("narratives",[]):(b=b.filter(function(a){return a.workspace.owner===this.runtime.getService("session").getUsername()||"n"===a.workspace.user_permission?!1:!0}.bind(this)),this.kbservice.getPermissions(b).then(function(a){a=a.sort(function(a,b){return b.object.saveDate.getTime()-a.object.saveDate.getTime()}),this.setState("narratives",a),this.filterState()}.bind(this)))}.bind(this))}.bind(this))}}});return f});