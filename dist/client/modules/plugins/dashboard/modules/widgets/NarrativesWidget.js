define(["jquery","bluebird","kb_dashboard_widget_base","kb/service/serviceApi","kb/widget/widgets/buttonBar","bootstrap"],function(a,b,c,d,e){"use strict";var f=Object.create(c,{init:{value:function(a){return a.name="NarrativesWidget",a.title="Your Narratives",this.DashboardWidget_init(a),this.templates.env.addFilter("appName",function(a){return this.getState(["appsMap",a,"name"],a)}.bind(this)),this.templates.env.addFilter("methodName",function(a){return this.getState(["methodsMap",a,"name"],a)}.bind(this)),this}},getAppName:{value:function(a){return this.getState(["appsMap",a,"name"],a)}},getMethodName:{value:function(a){return this.getState(["methodsMap",a,"name"],a)}},setup:{value:function(){this.kbservice=d.make({runtime:this.runtime})}},getViewTemplate:{value:function(){return this.error?"error":this.runtime.getService("session").isLoggedIn()?"slider":"unauthorized"}},render:{value:function(){return this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate(this.getViewTemplate())),this.container.find('[data-toggle="popover"]').popover(),this.container.find('[data-toggle="tooltip"]').tooltip(),this}},setupUI:{value:function(){this.hasState("narratives")&&this.getState("narratives").length>0&&(this.buttonbar=Object.create(e).init({container:this.container.find('[data-placeholder="buttonbar"]')}),this.buttonbar.clear().addButton({name:"newnarrative",label:"New Narrative",icon:"plus-circle",style:"primary","class":"btn-kbase",url:"#/narrativemanager/new",external:!0}).addInput({placeholder:"Search Your Narratives",place:"end",onkeyup:function(b){this.setParam("filter",a(b.target).val())}.bind(this)}))}},filterNarratives:{value:function(){var a,b=this.getParam("filter"),c=new RegExp(b,"i");return b&&0!==b.length?(a=this.getState("narratives").filter(function(a){return a.workspace.metadata.narrative_nice_name.match(c)||a.object.metadata.cellInfo&&function(a){for(var b in a){var d=a[b];if(d.match(c)||this.getAppName(d).match(c))return!0}}.bind(this)(Object.keys(a.object.metadata.cellInfo.app))||a.object.metadata.cellInfo&&function(a){for(var b in a){var d=a[b];if(d.match(c)||this.getMethodName(d).match(c))return!0}}.bind(this)(Object.keys(a.object.metadata.cellInfo.method))?!0:!1}.bind(this)),void this.setState("narrativesFiltered",a)):void this.setState("narrativesFiltered",this.getState("narratives"))}},onParamChange:{value:function(){this.filterNarratives()}},onStateChange:{value:function(){var a=this.doState("narratives",function(a){return a.length},null),b=this.doState("narrativesFiltered",function(a){return a.length},null),c=this.doState("narratives",function(a){if(!a)return 0;for(var b=0,c=0;c<a.length;c++){var d=a[c];d.permissions.length>0&&b++}return b});this.hasState("narratives")&&this.viewState.setItem("narratives",{count:a,sharingCount:c,filtered:b})}},setInitialState:{value:function(a){return b["try"](function(){return this.runtime.getService("session").isLoggedIn()||(this.deleteState(),resolve()),b.all([this.kbservice.getNarratives({params:{showDeleted:0,owners:[this.runtime.getService("session").getUsername()]}}),this.kbservice.getApps(),this.kbservice.getMethods()]).spread(function(a,b,c){this.setState("apps",b);var d={};b.forEach(function(a){d[a.id]=a}),this.setState("appsMap",d),this.setState("methods",c);var e={};return c.forEach(function(a){e[a.id]=a}),this.setState("methodsMap",e),0!==a.length?this.kbservice.getPermissions(a).then(function(a){a=a.sort(function(a,b){return b.object.saveDate.getTime()-a.object.saveDate.getTime()}),this.setState("narratives",a),this.filterNarratives()}.bind(this)):(this.setState("narratives",[]),void this.setState("narrativesFiltered",[]))}.bind(this))}.bind(this))}}});return f});