define(["nunjucks","jquery","bluebird","kb/common/html","kb/common/utils","kb/service/userProfile","kb/common/logger","kb/common/gravatar","kb_plugin_dashboard"],function(a,b,c,d,e,f,g,h,i){"use strict";var j=Object.create({},{DashboardWidget_init:{value:function(b){if(this._generatedId=0,this.localConfig={},this.initConfig=b||{},this.setupConfig(),this.params={},this.runtime=b.runtime,!this.runtime)throw{type:"ArgumentError",reason:"RuntimeMissing",message:"The runtime is required for a dashboard widget."};this.container=b.container,e.isBlank(b.userId)?this.runtime.getService("session").isLoggedIn()&&(this.params.userId=this.runtime.getService("session").getUsername()):this.params.userId=b.userId,this.setupAuth(),this.setupCoreApp(),this.setup(),this.messages=[],this.error=null,this.state={},this.stateMeta={status:"none",timestamp:new Date},this.createListMaps(),this.templates={};var c=[new a.WebLoader(i.plugin.fullPath+"/"+this.widgetName+"/templates",!0),new a.WebLoader(i.plugin.fullPath+"/DashboardWidget/templates",!0)];return this.templates.env=new a.Environment(c,{autoescape:!1}),this.templates.env.addFilter("roleLabel",function(a){return this.listMaps.userRoles[a]?this.listMaps.userRoles[a].label:a}.bind(this)),this.templates.env.addFilter("userClassLabel",function(a){return this.listMaps.userClasses[a]?this.listMaps.userClasses[a].label:a}.bind(this)),this.templates.env.addFilter("titleLabel",function(a){return this.listMaps.userTitles[a]?this.listMaps.userTitles[a].label:a}.bind(this)),this.templates.env.addFilter("permissionLabel",function(a){return this.listMaps.permissionFlags[a]?this.listMaps.permissionFlags[a].label:a}.bind(this)),this.templates.env.addFilter("length2",function(a){if(a){if(a instanceof Array)return a.length;if(a instanceof Object)return Object.keys(a).length}}.bind(this)),this.templates.env.addFilter("gravatar",function(a,b,c,d){return h.make().makeGravatarUrl(a,b,c,d)}.bind(this)),this.templates.env.addFilter("kbmarkup",function(a){return a?a.replace(/\n/g,"<br>"):""}),this.templates.env.addFilter("unixNiceTime",function(a){if(a){var b=parseInt(a,10);if(b&&!isNaN(b))return e.niceElapsedTime(1e3*b)}}),this.templates.env.addFilter("dateFormat",function(a){return e.niceElapsedTime(a)}.bind(this)),this.templates.env.addFilter("jsDatestring",function(a){return e.iso8601ToDate(a).toISOString()}.bind(this)),this.templates.env.addFilter("niceRuntime",function(a){if(!a)return"";var b=a/1e3,c=Math.floor(b/60);b%=60;var d=Math.floor(c/60);c%=60;var e=Math.floor(d/24);d%=24;var f=!1;return e?(e?e+"d":"")+(d?" "+d+"h":""):d?(d?" "+d+"h":"")+(c?" "+c+"m":""):(c?" "+c+"m":"")+(b&&f?" "+b+"s":"")}.bind(this)),this.templates.env.addFilter("defaultDash",function(a){return null===a||void 0===a||"string"==typeof a&&0===a.length?"-":a}),this.templates.env.addFilter("isBlank",function(a){return null===a||void 0===a||"string"==typeof a&&0===a.length?!0:!1}),this.templates.env.addFilter("isEmpty",function(a){return null===a||void 0===a||"string"==typeof a&&0===a.length?!0:a.push&&a.pop&&0===a.length?!0:0===Object.keys(a).length?!0:!1}),this.templates.env.addFilter("sort",function(a,b){return"object"==typeof a&&a.pop&&a.push?a.sort(function(a,c){return b&&(a=a[b],c=c[b]),c>a?1:a>c?-1:0}):a}),this.templates.env.addFilter("plural",function(a,b){return"number"==typeof a&&1!==a?b||"s":""}),this.templates.env.addGlobal("randomNumber",function(a,b){return Math.floor(a+Math.random()*(b-a))}),this.templates.env.addGlobal("getConfig",function(a){return this.runtime.getConfig(a)}.bind(this)),this.templates.cache={},this.context={},this.context.env={widgetTitle:this.widgetTitle,widgetName:this.widgetName,docsite:this.runtime.getConfig("docsite"),getConfig:function(a){return this.runtime.getConfig(a)}.bind(this)},this.context.state=this.state,this.context.params=this.params,this.refreshEnabled=!1,this.refreshInterval=6e4,this.refreshLastTime=null,this.status="new",this}},setupConfig:{value:function(){if(this.configs=[{},this.initConfig,this.localConfig],!this.hasConfig("container"))throw"A container is required by this Widget, but was not provided.";if(!this.hasConfig("name"))throw"Widget name is required";if(!this.hasConfig("title"))throw"Widget title is required"}},setupCoreApp:{value:function(){if(this.container=this.getConfig("container"),"string"==typeof this.container&&(this.container=b(this.container)),this.widgetName=this.getConfig("name"),this.widgetTitle=this.getConfig("title"),this.instanceId=this.genId(),!this.hasConfig("viewState"))throw"The View State was not provided in "+this.widgetName;this.viewState=this.getConfig("viewState")}},setupAuth:{value:function(){}},go:{value:function(){return this.renderUI(),this.renderWaitingView(),this.setInitialState().then(function(){this.status="dirty",this.setupUI()}.bind(this))["catch"](function(a){this.setError(a)}.bind(this))["finally"](function(){this.startSubscriptions(),this.afterStart&&this.afterStart()}.bind(this)),this}},startSubscriptions:{value:function(){this.subscriptions=[],this.subscriptions.push(this.runtime.recv("session","login.success",function(a){this.onLoggedIn(a.session)}.bind(this))),this.subscriptions.push(this.runtime.recv("session","logout.success",function(){this.onLoggedOut()}.bind(this))),this.subscriptions.push(this.runtime.recv("app","heartbeat",function(a){this.handleHeartbeat(a)}.bind(this)))}},stopSubscriptions:{value:function(){this.subscriptions&&(this.subscriptions.forEach(function(a){this.runtime.drop(a)}.bind(this)),this.subscriptions=[])}},stop:{value:function(){this.stopSubscriptions(),this.onStop&&this.onStop()}},handleHeartbeat:{value:function(a){if(this.refreshEnabled){var b=(new Date).getTime();this.refreshLastTime||(this.refreshLastTime=b),b-this.refreshLastTime>=this.refreshInterval&&this.onRefreshbeat&&(this.refreshLastTime=b,this.onRefreshbeat(a))}this.onHeartbeat&&this.onHeartbeat(a)}},onHeartbeat:{value:function(a){switch(this.status){case"dirty":this.status="clean",this.refresh()["catch"](function(a){this.setError(a)});break;case"error":this.status="errorshown",this.renderError()}}},onRefreshbeat:{value:function(){return console.log("REFRESHBEAT"),this.setInitialState()["catch"](function(a){this.setError(a)}.bind(this)),this}},setup:{value:function(){return this}},renderUI:{value:function(){return this.loadCSS(),this.renderLayout(),this}},destroy:{value:function(){}},getConfig:{value:function(a,b){var c;for(c=0;c<this.configs.length;c++)if(void 0!==e.getProp(this.configs[c],a))return e.getProp(this.configs[c],a);return b}},setConfig:{value:function(a,b){e.setProp(this.configs[0],a,b)}},hasConfig:{value:function(a){for(var b=0;b<this.configs.length;b++)if(void 0!==e.getProp(this.configs[b],a))return!0;return!1}},setParam:{value:function(a,b){e.setProp(this.params,a,b),this.onParamChange&&this.onParamChange()}},getParam:{value:function(a,b){return e.getProp(this.params,a,b)}},onParamChange:{value:function(){this.filterState&&this.filterState()}},refresh:{value:function(){return new c(function(a,b,c){this.render(),a()}.bind(this))}},setState:{value:function(a,b,c){e.isEqual(e.getProp(this.state,a),b)||(e.setProp(this.state,a,b),this.onStateChange(),this.status="dirty")}},onStateChange:{value:function(){}},hasState:{value:function(a){return e.hasProp(this.state,a)}},getState:{value:function(a,b){return e.getProp(this.state,a,b)}},deleteState:{value:function(){this.state={},this.status="dirty"}},doState:{value:function(a,b,c){return e.hasProp(this.state,a)?b(e.getProp(this.state,a)):c}},setError:{value:function(a){g.logError({source:"Dashboard/"+this.widgetName,title:"ERROR in "+this.widgetName,data:a}),this.status="error",this.error=a}},checkState:{value:function(a){return this.stateMeta.status===a?!0:!1}},setInitialState:{value:function(a){return new c(function(a,b,c){a()})}},onLoggedIn:{value:function(a){this.setupAuth(),this.setup(),this.setInitialState({force:!0}).then(function(){this.status="dirty"}.bind(this))["catch"](function(a){this.setError(a)}.bind(this)).done()}},onLoggedOut:{value:function(){this.setupAuth(),this.setup(),this.setInitialState({force:!0}).then(function(){this.status="dirty"}.bind(this))["catch"](function(a){this.setError(a)}.bind(this)).done()}},getTemplate:{value:function(a){return void 0===this.templates.cache[a]&&(this.templates.cache[a]=this.templates.env.getTemplate(a+".html")),this.templates.cache[a]}},createTemplateContext:{value:function(a){if(this.context.env.generatedId=this.genId(),this.context.env.loggedIn=this.runtime.getService("session").isLoggedIn(),this.runtime.service("session").isLoggedIn()?this.context.env.loggedInUser=this.runtime.getService("session").getUsername():delete this.context.env.loggedInUser,this.context.env.instanceId=this.instanceId,a)var b=e.merge({},this.context),c=e.merge(b,a);else var c=this.context;return this.onCreateTemplateContext?this.onCreateTemplateContext(c):c}},renderTemplate:{value:function(a,b){var c=this.getTemplate(a);if(!c)throw"Template "+a+" not found";var b=b?b:this.createTemplateContext();return c.render(b)}},genId:{value:function(){return"gen_"+this.widgetName+"_"+this._generatedId++}},renderError:{value:function(){this.renderErrorView(this.error)}},renderErrorView:{value:function(a){if(a){if("string"==typeof a)var b={title:"Error",message:a};else if("object"==typeof a)if(a instanceof Error)var b={title:"Error",message:a.message};else if(a.status&&a.error)var b={title:"Service Error "+a.status,message:a.error};else var b={title:"Unknown Error",message:""+a}}else var b={title:"Unknown Error",message:""};var c=this.createTemplateContext({error:b});this.places.content.html(this.getTemplate("error").render(c))}},render:{value:function(){try{return this.runtime.getService("session").isLoggedIn()?(this.setTitle(this.widgetTitle),this.places.content.html(this.renderTemplate("authorized"))):(this.setTitle(this.widgetTitle),this.places.content.html(this.renderTemplate("unauthorized"))),this.afterRender&&this.afterRender(),this}catch(a){this.setError(a)}}},renderLayout:{value:function(){this.container.html(this.getTemplate("layout").render(this.createTemplateContext())),this.places={title:this.container.find('[data-placeholder="title"]'),alert:this.container.find('[data-placeholder="alert"]'),content:this.container.find('[data-placeholder="content"]')}}},setupUI:{value:function(){}},renderWaitingView:{value:function(){this.places.content.html(d.loading())}},setTitle:{value:function(a){this.places.title.html(this.widgetTitle)}},clearButtons:{value:function(a){}},addButton:{value:function(a){}},loadCSSResource:{value:function(a){this.cssLoaded||(this.cssLoaded={}),this.cssLoaded[a]||b("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",a)}},loadCSS:{value:function(){this.loadCSSResource(i.plugin.path+"/"+this.widgetName+"/style.css")}},renderMessages:{value:function(){if(this.places.alert){this.places.alert.empty();for(var a=0;a<this.messages.length;a++){var b=this.messages[a],c="default";switch(b.type){case"success":c="success";break;case"info":c="info";break;case"warning":c="warning";break;case"danger":case"error":c="danger"}this.places.alert.append('<div class="alert alert-dismissible alert-'+c+'" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><strong>'+b.title+"</strong> "+b.message+"</div>")}}}},clearMessages:{value:function(){this.messages=[],this.renderMessages()}},addSuccessMessage:{value:function(a,b){void 0===b&&(b=a,a=""),this.messages.push({type:"success",title:a,message:b}),this.renderMessages()}},addWarningMessage:{value:function(a,b){void 0===b&&(b=a,a=""),this.messages.push({type:"warning",title:a,message:b}),this.renderMessages()}},addErrorMessage:{value:function(a,b){void 0===b&&(b=a,a=""),this.messages.push({type:"error",title:a,message:b}),this.renderMessages()}},logNotice:{value:function(a,b){console.log("NOTICE: ["+a+"] "+b)}},logDeprecation:{value:function(a,b){console.log("DEPRECATION: ["+a+"] "+b)}},logWarning:{value:function(a,b){console.log("WARNING: ["+a+"] "+b)}},logError:{value:function(a,b){console.log("ERROR: ["+a+"] "+b)}},createListMaps:{value:function(){this.listMaps={};for(var a in this.lists){var b=this.lists[a];this.listMaps[a]={};for(var c in b)this.listMaps[a][b[c].id]=b[c]}}},lists:{value:{permissionFlags:[{id:"r",label:"Read",description:"Read Only"},{id:"w",label:"Write",description:"Read and Write"},{id:"a",label:"Admin",description:"Read, Write, and Share"},{id:"n",label:"None",description:"No Access"}],userRoles:[{id:"pi",label:"Principal Investigator"},{id:"gradstudent",label:"Graduate Student"},{id:"developer",label:"Developer"},{id:"tester",label:"Tester"},{id:"documentation",label:"Documentation"},{id:"general",label:"General Interest"}],userClasses:[{id:"pi",label:"Principal Investigator"},{id:"gradstudent",label:"Graduate Student"},{id:"kbase-internal",label:"KBase Staff"},{id:"kbase-test",label:"KBase Test/Beta User"},{id:"commercial",label:"Commercial User"}],userTitles:[{id:"mr",label:"Mr."},{id:"ms",label:"Ms."},{id:"dr",label:"Dr."},{id:"prof",label:"Prof."}],gravatarDefaults:[{id:"mm",label:"Mystery Man - simple, cartoon-style silhouetted outline"},{id:"identicon",label:"Identicon - a geometric pattern based on an email hash"},{id:"monsterid",label:'MonsterID - generated "monster" with different colors, faces, etc'},{id:"wavatar",label:"Wavatar - generated faces with differing features and backgrounds"},{id:"retro",label:"Retro - 8-bit arcade-style pixelated faces"},{id:"blank",label:"Blank - A Blank Space"}]}}});return j});