define(["promise","kb_dashboard_widget_base","kb/common/utils"],function(a,b,c){"use strict";var d=Object.create(b,{init:{value:function(a){return a.name="ProfileWidget",a.title="Your Profile",this.DashboardWidget_init(a),this}},afterStart:{value:function(){return this.runtime.service("userprofile").onChange(function(a){this.setState("userProfile",a),this.setState("profileCompletion",this.calcProfileCompletion(a))}.bind(this),function(a){this.setError(a)}.bind(this)),this}},setInitialState:{value:function(b){return new a(function(a,b,c){return this.runtime.getService("session").isLoggedIn()?void this.runtime.service("userprofile").whenChange().then(function(b){this.setState("userProfile",b),this.setState("profileCompletion",this.calcProfileCompletion(b)),a()}.bind(this))["catch"](function(a){console.log("ERROR"),console.log(a),b(a)}).done():void a()}.bind(this))}},onCreateTemplateContext:{value:function(a){return c.merge(c.merge({},a),{env:{lists:this.lists}})}},calcProfileCompletion:{value:function(a){var b=a.calcProfileCompletion();return"complete"===b.status?null:b}},getProfileStatus:{value:function(){return"error"===this.status?"error":this.hasState("userProfile")?this.getState("userProfile").getProfileStatus():"none"}},render:{value:function(){if(!this.runtime.getService("session").isLoggedIn())return this.places.title.html("Unauthorized"),void this.places.content.html(this.renderTemplate("unauthorized"));if("error"===this.status)this.renderError();else if(this.hasState("userProfile")){switch(this.getState("userProfile").getProfileStatus()){case"profile":try{this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate("view"))}catch(a){this.places.title.html(this.widgetTitle),this.places.content.html("ERROR: "+a)}break;case"stub":this.places.title.html(this.widgetTitle),this.places.content.html(this.renderTemplate("stub_profile"));break;case"none":this.places.title.html("User Not Found"),this.places.content.html(this.renderTemplate("no_user"));break;default:this.renderErrorView('Invalid profile state "'+this.getState("userProfile").getProfileStatus()+'"')}return this}}}});return d});