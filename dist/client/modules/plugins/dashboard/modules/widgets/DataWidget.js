define(["kb_widget_dashboard_base","kb.utils","kb.utils.api","kb.session","kb.service.workspace","bluebird"],function(a,b,c,d,e,f){"use strict";var g=Object.create(a,{init:{value:function(a){return a.name="DataWidget",a.title="Your Data",this.DashboardWidget_init(a),this.templates.env.addFilter("dateFormat",function(a){return b.niceElapsedTime(a)}.bind(this)),this}},setup:{value:function(){if(d.isLoggedIn()){if(!this.hasConfig("services.workspace.url"))throw"The workspace client url is not defined";this.workspaceClient=new e(this.getConfig("services.workspace.url"),{token:d.getAuthToken()})}else this.workspaceClient=null}},setInitialState:{value:function(a){return new f(function(a,e,g){return d.isLoggedIn()?(console.log("starting..."),void f.resolve(this.workspaceClient.list_workspace_info({showDeleted:0,excludeGlobal:1,owners:[d.getUsername()]})).then(function(d){console.log("Hmm .. did this work yet?");for(var g=[],h=0;h<d.length;h++){var i=c.workspace_metadata_to_object(d[h]);i.metadata.narrative&&"true"!==i.metadata.is_temporary&&(g.push(i.id),i[i.id]=i)}var j=[];f.resolve(this.workspaceClient.list_objects({ids:g,includeMetadata:1})).then(function(d){console.log("Well .. did this work yet?");for(var e=0;e<d.length;e++)j.push(c.object_info_to_object(d[e]));j=j.sort(function(a,c){var d=b.iso8601ToDate(a.save_date).getTime(),e=b.iso8601ToDate(c.save_date).getTime();return e>d?1:d>e?-1:0}.bind(this)),this.setState("workspaceObjects",j),a()}.bind(this))["catch"](function(a){console.log("ERROR"),console.log(a),e(a)}).done()}.bind(this))["catch"](function(a){console.log("ERROR"),console.log(a),e(a)}).done()):void a()}.bind(this))}}});return g});