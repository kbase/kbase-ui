define(["bluebird","kb/service/client/NarrativeMethodStore","kb/service/serviceApi","kb/common/logger","kb/common/html","kb/widget/bases/dataWidget","bootstrap"],function(a,b,c,d,e,f){"use strict";function g(a){function g(a){return j({"class":"panel panel-default dashboardAppsWidget",dataWidget:"dashboardApps"},[j({"class":"panel-heading"},[j({"class":"kb-row"},[j({"class":"-col -span-8"},[k({"class":"fa fa-cubes pull-left",style:{fontSize:"150%",paddingRight:"10px"}}),k({"class":"panel-title",style:{verticalAlign:"middle"},dataPlaceholder:"title"},[a.title])]),j({"class":"-col -span-4",style:{textAlign:"right"}},[j({"class":"btn-group",dataPlaceholder:"buttons"})])])]),j({"class":"panel-body"},[j({dataPlaceholder:"alert"}),j({dataPlaceholder:"content"},a.content)])])}function h(a,b){var c=a.get("appOwnership")[b];return 0===c.length?j({style:{font:"italic",textAlign:"center"}},["No Apps found."]):c.map(function(a){return l({"class":"table table-borderless hoverable"},[m([n({valign:"baseline",style:{verticalAlign:"top"}},[p({href:"#narrativestore/app/"+a.app.id,target:"_blank"},a.app.name)]),n({width:"30px",valign:"baseline",style:{verticalAlign:"top"}},[j({"class":"-switchable"},[j({"class":"-if-inactive"},[k({"class":"-appcount"},a.count)]),j({"class":"-if-active"},[p({href:"#narrativemanager/new?app="+a.app.id,"class":"btn btn-default btn-link",target:"_blank",dataToggle:"tooltip",dataPlacement:"auto",title:"Create a new Narrative using this App",dataContainer:"body"},[k({"class":"-icon"},[k({"class":"fa-stack"},[q({"class":"fa fa-file fa-stack-2x"}),q({"class":"fa fa-plus fa-inverse fa-stack-1x",style:{marginTop:"3px"}})])])])])])])])])})}function i(a){return l({"class":"apps"},[m([o(r("Your Favorites")),o(r("Collaborator's Favorites")),o(r("Public Favorites"))]),m([n(h(a,"owned")),n(h(a,"shared")),n(h(a,"public"))])])}var j=e.tag("div"),k=e.tag("span"),l=e.tag("table"),m=e.tag("tr"),n=e.tag("td"),o=e.tag("th"),p=e.tag("a"),q=e.tag("i"),r=e.tag("h4");return f.make({runtime:a.runtime,title:"KBase Apps",on:{initialContent:function(){return e.loading()},fetch:function(a){var e=this,f=new b(e.getConfig("services.narrative_method_store.url"),{token:e.runtime.service("session").getAuthToken()}),g=c.make({runtime:e.runtime}),h={};return e.runtime.service("session").isLoggedIn()?(this.set("ready",!1),f.list_apps_full_info({}).then(function(a){return a.forEach(function(a){h[a.id]={owned:{count:0,narratives:{}},shared:{count:0,narratives:{}},"public":{count:0,narratives:{}}}}),[a,g.getNarratives({params:{showDeleted:0}})]}).spread(function(a,b){var c,f;b.forEach(function(a){var b,c,f;a.object.metadata.methods&&(c=JSON.parse(a.object.metadata.methods),b=c.app,f=a.workspace.owner===e.runtime.service("session").getUsername()?"owned":"n"===a.workspace.globalread?"shared":"public",Object.keys(b).forEach(function(b){h[b]?(h[b][f].count+=1,h[b][f].narratives[a.workspace.id]=1):d.logWarning({source:"AppsWidget",title:"Skipped App",message:'The app "'+b+'" was skipped because it is not in the Apps Store'})}))}),a.forEach(function(a){a.narrativeCount=h[a.id]}),c=a.sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0}),e.set("appList",c),f={owned:[],shared:[],"public":[]},a.forEach(function(a){["owned","shared","public"].forEach(function(b){a.narrativeCount[b].count>0&&f[b].push({count:a.narrativeCount[b].count,app:a})})}),e.set("appOwnership",f),e.set("ready",!0)})):void e.set("apps",null)},render:function(){return this.get("ready")?g({title:"KBase Apps",content:i(this)}):void 0}},events:[{type:"mouseenter",selector:"table.hoverable tr",handler:function(a){a.target.classList.add("-active")},capture:!0},{type:"mouseleave",selector:"table.hoverable tr",handler:function(a){a.target.classList.remove("-active")},capture:!0}]})}return{make:function(a){return g(a)}}});