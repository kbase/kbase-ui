define(["jquery","kb/service/client/NarrativeMethodStore","kb/widget/legacy/authenticatedWidget"],function(a,b){a.KBWidget({name:"KBaseNarrativeStoreView",parent:"kbaseAuthenticatedWidget",options:{type:null,id:null},$mainPanel:null,$errorPanel:null,narstore:null,init:function(c){return this._super(c),console.log("NARR VIEW"),console.log(this.$elem),this.$errorPanel=a("<div>").addClass("alert alert-danger").hide(),this.$elem.append(this.$errorPanel),this.$mainPanel=a("<div>"),this.$elem.append(this.$mainPanel),this.$narMethodStoreInfo=a("<div>").css({margin:"10px",padding:"10px"}),this.$elem.append(this.$narMethodStoreInfo),this.narstore=new b(this.runtime.getConfig("services.narrative_method_store.url")),this.getNarMethodStoreInfo(),this.imageUrl=this.runtime.getConfig("services.narrative_method_store.image_url"),console.log("Narrative Store"),console.log(c),"app"===c.type?this.fetchAppInfoAndRender():"method"===c.type?this.fetchMethodInfoAndRender():this.showError({error:{message:'Must specify either "app" or "method" in url, as in narrativestore/app/app_id.'}}),this},getParameterByName:function(a){var a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.search);return null===d?"":decodeURIComponent(d[1].replace(/\+/g," "))},getNarMethodStoreInfo:function(){var b=this;this.narstore.status(function(c){var d=c.git_spec_url+"/tree/"+c.git_spec_branch;"app"===b.options.type&&(d+="/apps/"+b.options.id),"method"===b.options.type&&(d+="/methods/"+b.options.id);var e=c.git_spec_commit.split(/\r\n|\r|\n/);e=[e[0],e[1],e[2],e[3]].join("<br>\n"),b.$narMethodStoreInfo.append(a("<table>").css({border:"1px solid #bbb",margin:"10px",padding:"10px"}).append(a("<tr>").append(a('<th style = "vertical-align : top; padding-right : 5px">').append("Yaml/Spec Location ")).append(a("<td>").append('<a href="'+d+'" target="_blank">'+d+"</a>"))).append(a("<tr>").append(a('<th style = "vertical-align : top; padding-right : 5px">').append("Method Spec Commit  ")).append(a("<td>").append(e))))},function(a){this.showError(a)})},appFullInfo:null,appSpec:null,appMethodSpecs:null,fetchAppInfoAndRender:function(){var a=this;a.narstore.get_app_full_info({ids:[a.options.id]},function(b){console.log("fetchAppInfoAndRender"),a.appFullInfo=b[0],a.narstore.get_app_spec({ids:[a.options.id]},function(b){a.appSpec=b[0];for(var c=[],d=0;d<a.appSpec.steps.length;d++)c.push(a.appSpec.steps[d].method_id);a.narstore.get_method_brief_info({ids:c},function(b){a.appMethodSpecs={};for(var c=0;c<b.length;c++)a.appMethodSpecs[b[c].id]=b[c];a.renderApp()},function(b){a.showError(b),console.error(b)})},function(b){a.showError(b),console.error(b)})},function(b){a.showError(b),console.error(b)})},methodFullInfo:null,methodSpec:null,fetchMethodInfoAndRender:function(){var a=this;a.narstore.get_method_full_info({ids:[a.options.id]},function(b){a.methodFullInfo=b[0],a.narstore.get_method_spec({ids:[a.options.id]},function(b){a.methodSpec=b[0],a.renderMethod()},function(b){a.showError(b),console.error(b)})},function(b){console.error(b),b.error.message.indexOf("No such file or directory")>=0?a.fetchAppInfoAndRender():a.showError(b)})},renderApp:function(){var b=this,c=b.appFullInfo,d=b.appSpec,e=b.appMethodSpecs,f=a.jqElem("div").addClass("row").css("width","95%"),g=a.jqElem("div").addClass("col-md-8"),f=a("<div>").addClass("row").css("width","95%"),g=a("<div>").addClass("col-md-8");g.append(a.jqElem("div").append(a.jqElem("h2").append("App - "+c.name))),c.subtitle&&g.append(a.jqElem("div").append(a.jqElem("h4").append(c.subtitle))),c.contact&&g.append("<div>").append("<strong>Help or Questions? Contact: </strong>&nbsp&nbsp").append(a.jqElem("a").attr("href","mailto:"+c.contact).append(c.contact));var h=a.jqElem("div").addClass("col-md-4").css("text-align","right").append(a.jqElem("div").addClass("btn-group").append(a('<a href="#/narrativemanager/new?app='+c.id+'" target="_blank">').append(a.jqElem("button").addClass("kb-primary-btn").append('<span class="fa fa-plus"></span> Launch in New Narrative'))));if(f.append(g),b.auth()&&b.auth().token&&f.append(h),b.$mainPanel.append(f),c.screenshots&&c.screenshots.length){var i=a.jqElem("div");a.each(c.screenshots,function(c,d){i.append(a.jqElem("a").on("click",function(c){var e=a.jqElem("img").attr("src",b.imageUrl+d.url).css("width","100%"),f=a.jqElem("div").kbasePrompt({body:e});f.dialogModal().css("width","100%"),f.dialogModal().find(".modal-dialog").css("width","100%"),f.openPrompt()}).append(a.jqElem("img").attr("src",b.imageUrl+d.url).attr("width","300")))}),b.$mainPanel.append(i)}if(c.description&&b.$mainPanel.append(a.jqElem("div").addClass("row").css("width","95%").append(a.jqElem("div").addClass("col-md-12").append(a.jqElem("div").append(a.jqElem("hr")).append(c.description)))).append(a.jqElem("hr")),d.steps&&d.steps.length){var j=a.jqElem("div").css("width","95%").append(a.jqElem("h4").append("App Steps")),k=a.jqElem("ul").css("list-style-type","none").css("padding-left","0px");j.append(k),a.each(d.steps,function(b,c){var d=a.jqElem("li"),f=e[c.method_id];d.append(a.jqElem("ul").css("list-style-type","none").append(a.jqElem("li").append(a.jqElem("b").append("Step "+(b+1)+". ")).append(a.jqElem("a").attr("href","#narrativestore/method/"+f.id).attr("target","_blank").append(f.name)).append(a.jqElem("ul").css("list-style-type","none").append(a.jqElem("li").append(f.subtitle))))),k.append(d)}),b.$mainPanel.append(j.append(k))}a.each(b.$mainPanel.find("[data-method-id]"),function(b,c){var d=a(c).data("method-id");a(c).attr("target","_blank"),a(c).attr("href","#/narrativestore/method/"+d)}),console.log(b.$mainPanel)},renderMethod:function(){var b=this,c=b.methodFullInfo,d=b.methodSpec,e=a.jqElem("div").addClass("row").css("width","95%"),f=a.jqElem("div").addClass("col-md-8"),e=a("<div>").addClass("row").css("width","95%"),f=a("<div>").addClass("col-md-8");f.append(a.jqElem("div").append(a.jqElem("h2").append("Method - "+c.name))),c.subtitle&&f.append(a.jqElem("div").append(a.jqElem("h4").append(c.subtitle))),c.contact&&f.append("<div>").append("<strong>Help or Questions? Contact: </strong>&nbsp&nbsp").append(a.jqElem("a").attr("href","mailto:"+c.contact).append(c.contact));var g=a.jqElem("div").addClass("col-md-4").css("text-align","right").append(a.jqElem("div").addClass("btn-group"));if(e.append(f),e.append(g),b.$mainPanel.append(e),c.screenshots&&c.screenshots.length){var h=a.jqElem("div");a.each(c.screenshots,function(c,d){h.append(a.jqElem("a").on("click",function(c){var e=a.jqElem("img").attr("src",b.imageUrl+d.url).css("width","100%"),f=a.jqElem("div").kbasePrompt({body:e});f.dialogModal().css("width","100%"),f.dialogModal().find(".modal-dialog").css("width","100%"),f.openPrompt()}).append(a.jqElem("img").attr("src",b.imageUrl+d.url).attr("width","300")))}),b.$mainPanel.append(h)}if(c.description&&b.$mainPanel.append(a.jqElem("div").addClass("row").css("width","95%").append(a.jqElem("div").addClass("col-md-12").append(a.jqElem("div").append(a.jqElem("hr")).append(c.description)))).append(a.jqElem("hr")),d.parameters&&d.parameters.length){var i=a.jqElem("div"),j=a.jqElem("ul").css("list-style-type","none").css("padding-left","0px");i.append(j);var k={inputs:[],outputs:[],parameters:[]};a.each(d.parameters,function(a,b){"input"===b.ui_class?k.inputs.push(b):"output"===b.ui_class?k.outputs.push(b):k.parameters.push(b)});var l=function(a){return void 0!==a&&a.length?a.charAt(0).toUpperCase()+a.slice(1):void 0};a.each(["inputs","outputs","parameters"],function(b,c){if(0!==k[c].length){var d=a.jqElem("li").append(a.jqElem("h4").append(l(c))),e=a.jqElem("ul").css("list-style-type","none").css("padding-left","0px");d.append(e),j.append(d),a.each(k[c],function(b,c){var d="";c.text_options&&c.text_options.valid_ws_types&&(d=a.jqElem("i").append(" "+c.text_options.valid_ws_types.join(", ")));var f=a.jqElem("li");f.append(a.jqElem("ul").css("list-style-type","none").append(a.jqElem("li").append(a.jqElem("b").append(c.ui_name)).append(d).append(a.jqElem("ul").css("list-style-type","none").append(a.jqElem("li").append(c.short_hint)).append(a.jqElem("li").append(c.long_hint))))),e.append(f)})}}),b.$mainPanel.append(i.append("<hr>"))}if(d.fixed_parameters&&d.fixed_parameters.length){var i=a.jqElem("div").append(a.jqElem("h4").append("Fixed parameters")),j=a.jqElem("ul").css("list-style-type","none").css("padding-left","0px");i.append(j),a.each(d.fixed_parameters,function(b,c){var d=a.jqElem("li");d.append(a.jqElem("ul").css("list-style-type","none").append(a.jqElem("li").append(a.jqElem("b").append(c.ui_name)).append(a.jqElem("ul").css("list-style-type","none").append(a.jqElem("li").append(c.description))))),j.append(d)}),b.$mainPanel.append(i.append("<hr>"))}if(c.publications&&c.publications.length){var m=a.jqElem("div").append(a.jqElem("strong").append("Related publications")),n=a.jqElem("ul");a.each(c.publications,function(b,c){n.append(a.jqElem("li").append(c.display_text).append(a.jqElem("a").attr("href",c.link).attr("target","_blank").append(c.link)))}),b.$mainPanel.append(m.append(n))}if(void 0!==c.kb_contributors&&c.kb_contributors.length){a.jqElem("div").append(a.jqElem("strong").append("Team members")),a.jqElem("ul");a.each(c.publications,function(b,c){n.append(a.jqElem("li").append(c))}),b.$mainPanel.append(m.append(n))}a.each(b.$mainPanel.find("[data-method-id]"),function(b,c){var d=a(c).data("method-id");a(c).attr("target","_blank"),a(c).attr("href","#/narrativestore/method/"+d)})},loggedInCallback:function(a,b){return this},loggedOutCallback:function(a,b){return this},refresh:function(){},showError:function(a){this.$errorPanel.empty(),this.$errorPanel.append("<strong>Error when fetching App/Method information.</strong><br><br>"),this.$errorPanel.append(a.error.message),this.$errorPanel.append("<br>"),this.$errorPanel.show()}})});