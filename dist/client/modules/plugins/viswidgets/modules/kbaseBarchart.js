define(["jquery","d3","kb_vis_visWidget"],function(a,b){"use strict";a.KBWidget({name:"kbaseBarchart",parent:"kbaseVisWidget",version:"1.0.0",options:{xScaleType:"ordinal",overColor:"yellow",strokeWidth:2,zeroLine:!1,zeroLineColor:"black",zeroLineWidth:1},_accessors:[],defaultXDomain:function(){return void 0===this.dataset()?[0,0]:this.dataset().map(function(a){return a.bar})},defaultYDomain:function(){if(void 0===this.dataset())return[0,0];var c=.9*b.min(this.dataset().map(function(c){return a.isArray(c.value)?c.stacked?b.sum(c.value):b.min(c.value):c.value}));return c>0&&(c=0),[c,1.1*b.max(this.dataset().map(function(c){return a.isArray(c.value)?c.stacked?b.sum(c.value):b.max(c.value):c.value}))]},extractLegend:function(b){var c=[];b.forEach(function(b,d){a.isArray(b.color)||c.push({color:b.color,label:b.bar})}),this.setLegend(c)},renderChart:function(){if(void 0!==this.dataset()){var c=this.chartBounds(),d=this,e=this.initialized?this.options.transitionTime:0,f=function(e,f,g,h){return h?this.attr("x",c.origin.x+c.size.width).attr("opacity",0):this.attr("x",function(a,b){var c=f.bar;return d.options.useIDMapping&&(c=d.xIDMap()[c]),d.xScale()(c)+e(f.stacked?0:b)}).attr("opacity",1),this.attr("y",function(c,e){var g=c;return f.stacked&&a.isArray(f.value)&&(g=b.sum(f.value.slice(0,e+1))),d.yScale()(Math.max(0,g))}).attr("width",e.rangeBand()).attr("height",function(a,b){return Math.abs(d.yScale()(0)-d.yScale()(a))}).attr("fill",function(a,b){return f.color[b%f.color.length]}).attr("stroke",function(a,b){return f.stroke?f.stroke[b%f.stroke.length]:"none"}).attr("stroke-width",function(a,b){return f.strokeWidth||d.options.strokeWidth}).attr("data-fill",function(a,b){return f.color[b%f.color.length]}),this},g=function(a,c){return this.on("mouseover",function(c,e){var f=a.bar;if(d.options.useIDMapping&&(f=d.xIDMap()[f]),d.options.overColor){b.select(this).attr("stroke",d.options.overColor).attr("stroke-width",3),d.data("D3svg").select(".yPadding").selectAll("g g text").attr("fill",function(a,b){return a===f?d.options.overColor:"black"});var g=f;a.value.length>1&&(g+="["+(e+1)+"]");var h=void 0!==a.label?a.label[e%a.label.length]:g+" is "+a.value[e%a.value.length];void 0!==h&&d.showToolTip({label:h})}}).on("mouseout",function(c,e){d.options.overColor&&(b.select(this).transition().attr("stroke",function(b){return a.stroke?a.stroke[e%a.stroke.length]:"none"}).attr("stroke-width",function(b){return a.strokeWidth||d.options.strokeWidth}),d.data("D3svg").select(".yPadding").selectAll("g g text").attr("fill",function(a,b){return"black"}),d.hideToolTip())}),this},h=function(){return this.each(function(c,h){void 0===c.value||a.isArray(c.value)||(c.value=[c.value]),void 0===c.color||a.isArray(c.color)||(c.color=[c.color]),void 0===c.stroke||a.isArray(c.stroke)||(c.stroke=[c.stroke]),void 0===c.label||a.isArray(c.label)||(c.label=[c.label]);var i=[0];if(!c.stacked){var j=0;for(j=0;j<c.value.length;j++)i.push(j)}var k=b.scale.ordinal().domain(i).rangeBands([0,d.xScale().rangeBand()],.05);b.scale.ordinal().domain(i).rangeBands([0,85],.05);b.select(this).selectAll(".bar").data(c.value).enter().append("rect").attr("class","bar").call(function(){return f.call(this,k,c,h,!0)}),b.select(this).selectAll(".bar").data(c.value).call(function(){return g.call(this,c,h)}).transition().duration(e).call(function(){return f.call(this,k,c,h)})}),this};if(this.options.hGrid&&this.yScale){var i=b.svg.axis().scale(this.yScale()).orient("left").tickSize(0-c.size.width).outerTickSize(0).tickFormat(""),j=this.D3svg().select(this.region("chart")).select(".yAxis");void 0===j[0][0]&&(j=this.D3svg().select(this.region("chart")).append("g").attr("class","yAxis axis").attr("transform","translate(0,0)")),j.transition().call(i),j.selectAll("line").style("stroke","lightgray")}var k=this.D3svg().select(this.region("chart")).selectAll(".barGroup");if(k.data(this.dataset()).enter().append("g").attr("class","barGroup").call(h),k.data(this.dataset()).call(h),k.data(this.dataset()).exit().call(function(){this.each(function(a,d){b.select(this).selectAll(".bar").transition().duration(e).attr("x",c.origin.x+c.size.width).attr("opacity",0)})}),this.options.zeroLine){var l=this.D3svg().select(this.region("chart")).selectAll(".zeroLine");l.data([0]).enter().append("line").attr("class","zeroLine").attr("x1",0).attr("x2",c.size.width).attr("stroke",d.options.zeroLineColor).attr("stroke-width",d.options.zeroLineWidth).attr("y1",d.yScale()(0)).attr("y2",d.yScale()(0)),l.data([0]).transition().duration(e).attr("y1",d.yScale()(0)).attr("y2",d.yScale()(0))}this.initialized=!0}},setXScaleRange:function(a,b){return void 0===b&&(b=this.xScale()),b.rangeBands(a,.05),b},setYScaleRange:function(a,b){return this._super(a.reverse(),b.nice())}})});