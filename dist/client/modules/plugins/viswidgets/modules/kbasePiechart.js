define(["jquery","d3","kb_vis_visWidget"],function(a,b){"use strict";a.KBWidget({name:"kbasePiechart",parent:"kbaseVisWidget",version:"1.0.0",options:{xGutter:0,xPadding:0,yPadding:0,overColor:"blue",innerRadius:0,outerRadius:0,startAngle:0,gradient:!0,startingPosition:"final",strokeWidth:1,strokeColor:"white",highlightColor:"black",sliceOffset:25,bgColor:"rgba(0,0,0,0)",xOffset:0,yOffset:0,outsideLabels:!0,labels:!0,autoEndAngle:!1,colorScale:b.scale.category20(),outerArcOpacity:.4,cornerToolTip:!1,draggable:!0,tooltips:!0,rescaleChildren:!0,outerRadiusInset:10},_accessors:[],init:function(b){return this._super(b),void 0===this.options.endAngle&&(this.options.endAngle=this.options.startAngle+2*Math.PI),this.pieSize=this.options.endAngle-this.options.startAngle,this.uniqueID=a.proxy(function(a){void 0===a.data&&(a.data={});var b=a.data.id||(a.data.id=this.ticker());return b},this),void 0!==this.parent&&(this.outerRadiusInset=0),this},childOptions:function(a,b){var c=this._super(a,b);return this.options.rescaleChildren&&(c.outerRadius=this.options.innerRadius*(a+1),c.innerRadius=this.options.innerRadius),c},reenter:function(a,b,c){return this.options.rescaleChildren&&(this.options.outerRadius=c.options.innerRadius*(a+1),this.options.innerRadius=c.options.innerRadius),this},startingPosition:function(a,b){return this.initialized?b<this.lastPieData.length-1?{startAngle:this.lastPieData[b+1].startAngle,endAngle:this.lastPieData[b+1].startAngle}:{startAngle:this.options.endAngle,endAngle:this.options.endAngle}:"slice"===this.options.startingPosition?{startAngle:a.startAngle,endAngle:a.startAngle}:"top"===this.options.startingPosition?{startAngle:this.options.startAngle,endAngle:this.options.startAngle}:"final"===this.options.startingPosition?{startAngle:a.startAngle,endAngle:a.endAngle}:void 0},midAngle:function(a){var b=a.startAngle+(a.endAngle-a.startAngle)/2;return b},midPosition:function(a){var b=this.midAngle(a),c=b%(2*Math.PI),d=c>0&&c<Math.PI||c<-Math.PI?1:-1;return d},useOutsideLabels:function(a){return this.options.outsideLabels&&void 0===a.data.outsideLabel||a.data.outsideLabel},setDataset:function(b){void 0!==b&&a.each(b,function(a,c){"number"==typeof c&&(b[a]={value:c})}),this._super(b)},outerRadius:function(){var a=this.chartBounds(),b=this.options.outerRadius;if(0>=b){var c=a.size.width<a.size.height?a.size.width:a.size.height;b=c/2+b,0>c&&(c=0),0>b&&(b=c/2)}return b},innerRadius:function(){var a=this.options.innerRadius;return 0>a&&(a=this.outerRadius()+this.options.innerRadius),0>a&&(a=0),a},sliceAction:function(a){return function(){var c=a.outerRadius()-a.options.outerRadiusInset,d=b.svg.arc().innerRadius(c).outerRadius(c+10);return this.on("mouseover",function(c){if(!c.data.gap){var e=this;if(!a.dragging){a.outerArc.transition().duration(0).attr("fill-opacity",a.options.outerArcOpacity).attr("fill",function(b,d){return c.data.color||a.options.colorScale(d,c.data,a)}).attr("transform",function(a){return b.select(e).attr("transform")}).attr("d",function(a){return d({startAngle:c.startAngle,endAngle:c.endAngle})});var f=[0,0];f=b.mouse(this);f[0],f[1];if(a.options.tooltips){var g=a.tooltip(c);g&&a.showToolTip({label:g,event:{pageX:a.options.cornerToolTip?a.$elem.prop("offsetLeft")+5:b.event.pageX,pageY:a.options.cornerToolTip?a.$elem.prop("offsetTop")+20:b.event.pageY}})}}}}).on("mouseout",function(b){b.data.gap||(a.options.tooltips&&a.hideToolTip(),a.outerArc.attr("fill-opacity",0))}).on("dblclick",function(b){b.data.gap||a.options.draggable&&(a.options.startAngle=a.options.startAngle-b.startAngle,a.renderChart())}),this}},tooltip:function(a){return void 0!==a.data.tooltip?a.data.tooltip:void 0!==a.data.label?a.data.label+" : "+a.data.value:void 0},pieData:function(a){return this.pieLayout=b.layout.pie().sort(null).startAngle(this.options.startAngle).endAngle(this.options.endAngle).value(function(a,b){return a.value}),this.pieLayout(a)},renderChart:function(){if(void 0!==this.dataset()){0===this.dataset().length&&(this.initialized=!1,this.lastPieData=void 0);var c=0;"final"===this.options.startingPosition&&(c=1);var d=this.chartBounds(),e=this;if(this.options.autoEndAngle){var f=0;a.each(e.dataset(),function(a,b){f+=b.value}),f>1&&(f=1),this.options.endAngle=2*f*Math.PI}else this.options.endAngle=this.options.startAngle+this.pieSize;var g=this.pieData(e.dataset()),h=this.outerRadius()-this.options.outerRadiusInset,i=this.innerRadius(),j=b.svg.arc().innerRadius(i).outerRadius(h),k=b.svg.arc().innerRadius(i+8*(h-i)/10).outerRadius(i+8*(h-i)/10),l=b.svg.arc().innerRadius(i+(h-i)/2).outerRadius(i+(h-i)/2),m=function(){return this.attr("transform",function(a,c){if(void 0!==a.data.offset){var d=b.svg.arc().innerRadius(0).outerRadius(a.data.offset||0),e=d.centroid(a);return"translate("+e+")"}}).attr("fill-opacity",function(a){return a.data.gap?0:1}).attr("stroke-opacity",function(a){return a.data.gap?0:1}),e.options.gradient||this.attr("fill",function(a,b){return void 0===a.data.color&&(a.data.color=e.options.colorScale(b,a.data,e)),a.data.color}),this.attrTween&&(e.options.gradient&&this.attrTween("fill",function(b,c){var d=e.uniqueness(),f=void 0===d?void 0:d(b),g=b.data.gradID;if(void 0===g){var i;void 0!==e.lastPieData&&c<e.lastPieData.length&&(void 0===f?i=e.lastPieData[c].data.gradID:a.each(e.lastPieData,function(a,b){var c=d(b);return c===f?void(i=b.data.gradID):void 0})),void 0===i&&(i=e.uuid()),g=b.data.gradID=i}var j=b.data.color;return void 0===b.data.color&&(b.data.color=e.options.colorScale(c,b.data,e)),j="url(#"+e.radialGradient({startColor:b.data.color,stopColor:e.options.gradient?e.options.radialGradientStopColor:b.data.color,id:g,r:h})+")",function(a){return j}}),this.attrTween("d",function(a,c){void 0===this._current&&(this._current=e.startingPosition(a,c));var d=b.interpolate(this._current,a);return this._current=d(0),function(a){return j(d(a))}})),this},n=function(a){return void 0===a&&(a=1),this.attr("text-anchor","middle"),this.attrTween&&this.text(function(a){return a.data.label}).attrTween("fill-opacity",function(d,f){void 0===this._currentOpacity&&(this._currentOpacity=e.initialized?0:c);var g=b.interpolate(this._currentOpacity,a);this._currentOpacity=g(0);var h=this;return function(a){return h._currentOpacity=g(a)}}).attrTween("transform",function(c,d){void 0===this._current&&(this._current=e.startingPosition(c,d));var f=c;0===a&&(f={startAngle:c.startAngle,endAngle:c.startAngle},d>0&&g.length&&(d>g.length&&(d=g.length),f={startAngle:g[d-1].endAngle,endAngle:g[d-1].endAngle}));var i=b.interpolate(this._current,f);this._current=i(0);var l=e.useOutsideLabels(c),m=l?k:j;return function(a){var b=i(a),c=m.centroid(b);return l&&(c[0]=1.06*h*e.midPosition(b),c[1]+=2),"translate("+c+")"}}).styleTween("text-anchor",function(a){this._current=this._current||a;var c=b.interpolate(this._current,a);this._current=c(0);var d=e.useOutsideLabels(a);return function(a){var b=c(a);return d?e.midPosition(b)>0?"start":"end":"middle"}}),this},o=b.behavior.drag();o.on("dragstart",function(a){this.__delta=0,e.outerArc.attr("fill-opacity",0),e.dragging=!0}).on("drag",function(a){this.__delta+=e.midPosition(a)*b.event.dy;var c=20;if(this.__delta>c||this.__delta<-1*c){var d=this.__delta,f=e.options.startAngle,g=f+Math.PI*(d/2)/h;e.options.startAngle=g,e.renderChart(),this.__delta=0}}).on("dragend",function(a){delete this.__delta,e.dragging=!1});var p=function(){return this},q=this.D3svg().select(this.region("chart")).selectAll(".pie").data([0]);if(q.enter().append("g").attr("class","pie").attr("transform","translate("+(d.size.width/2+this.options.xOffset)+","+(d.size.height/2+this.options.yOffset)+")"),a.each(g,function(a,b){void 0!==b.data.id&&(b.id=b.data.id)}),void 0!==e.options.pieColor){var r=this.D3svg().select(this.region("chart")).data([0]),s=r.selectAll(".pieBG").data([0]),t=b.svg.arc().innerRadius(0).outerRadius(h);s.enter().insert("path",".pie").attr("class","pieBG").attr("transform","translate("+(d.size.width/2+this.options.xOffset)+","+(d.size.height/2+this.options.yOffset)+")").attr("d",function(a){return t({startAngle:0,endAngle:2*Math.PI})}),s.attr("fill",e.options.pieColor)}e.outerArc=q.selectAll(".outerArc").data([0]),e.outerArc.enter().append("path").attr("class","outerArc");var u=q.selectAll(".slice").data(g,this.uniqueness());u.enter().append("path").attr("class","slice").attr("fill",function(a,b){return void 0===a.data.color&&(a.data.color=e.options.colorScale(b,a.data,e)),a.data.color}).attr("stroke",e.options.strokeColor).attr("stroke-width",e.options.strokeWidth).attr("stroke-linejoin","bevel");var v=this.initialized||"final"!==this.options.startingPosition?this.options.transitionTime:0;u.call(e.sliceAction(e)).transition().duration(v).call(m).call(e.endall,function(){e.initialized=!0,e.lastPieData=g}),e.options.draggable&&u.call(o),u.exit().transition().duration(v).attrTween("d",function(a,c){var d={startAngle:a.startAngle,endAngle:a.startAngle};c>0&&g.length&&c<=g.length&&(d={startAngle:g[c-1].endAngle,endAngle:g[c-1].endAngle});var e=b.interpolate(this._current,d);return this._current=e(0),function(a){return j(e(a))}}).each("end",function(a){b.select(this).remove()});var w=this.D3svg().select(this.region("chart")).selectAll(".labelG").data([0]);w.enter().append("g").attr("class","labelG").attr("transform","translate("+(d.size.width/2+this.options.xOffset)+","+(d.size.height/2+this.options.yOffset)+")");var x=w.selectAll(".label").data(g.filter(function(a){return(e.options.labels||a.data.forceLabel)&&void 0!==a.data.label&&a.data.label.length}),this.uniqueness());x.enter().append("text").attr("class","label").call(function(){n.call(this,1)}),x.call(p).transition().duration(v).call(function(){n.call(this,1)}),x.exit().transition().duration(v).call(function(){n.call(this,0)}).each("end",function(a){b.select(this).remove()});var y=function(a){return void 0===a&&(a=1),this.attrTween&&this.attrTween("stroke-opacity",function(d,f){void 0===this._currentOpacity&&(this._currentOpacity=e.initialized?0:c);var g=b.interpolate(this._currentOpacity,a);this._currentOpacity=g(0);var h=this;return function(a){return h._currentOpacity=g(a)}}).attrTween("points",function(c,d){this._current=this._current||e.startingPosition(c,d);var f=c;0===a&&(f={startAngle:c.startAngle,endAngle:c.startAngle},d>0&&g.length&&(d>g.length&&(d=g.length),f={startAngle:g[d-1].endAngle,endAngle:g[d-1].endAngle}));var i=b.interpolate(this._current,f),m=e.useOutsideLabels(c),n=m?k:j;return this._current=i(0),function(a){var b=i(a),c=n.centroid(b);return m&&(c[0]=1.05*h*e.midPosition(b)),[l.centroid(b),n.centroid(b),c]}}),this},z=w.selectAll("polyline").data(g.filter(function(a){return(e.options.labels||a.data.forceLabel)&&(e.options.outsideLabels||a.data.outsideLabel)&&void 0!==a.data.label&&a.data.label.length}),this.uniqueness());z.enter().append("polyline").attr("stroke","black").attr("stroke-width",1).attr("fill","rgba(0,0,0,0)"),z.transition().duration(v).call(function(){y.call(this,1)}),z.exit().transition().duration(v).call(function(){y.call(this,0)}).each("end",function(a){b.select(this).remove()})}},renderXAxis:function(){},renderYAxis:function(){}})});