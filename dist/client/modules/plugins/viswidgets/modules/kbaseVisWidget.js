define(["jquery","d3","kb_vis_rectangle","kb_vis_point","kb_vis_size","kb/widget/legacy/widget"],function(a,b,c,d,e){"use strict";a.KBWidget({name:"kbaseVisWidget",version:"1.0.0",options:{xGutter:20,xPadding:30,yGutter:20,yPadding:30,yLabels:!0,xLabels:!0,xScaleType:"linear",yScaleType:"linear",useIDMapping:!1,bgColor:"white",scaleXAxis:!1,scaleYAxis:!1,scaleAxes:!1,useUniqueID:!1,transitionTime:1750,ticker:0,radialGradientStopColor:"black",linearGradientStopColor:"black",defaultDataset:function(){return[]},defaultLegend:function(){return[]},width:"100%",height:"100%",customRegions:{},xAxisColor:"black",yAxisColor:"black",xAxisRegion:"yPadding",yAxisRegion:"xPadding",xAxisOrientation:"bottom",yAxisOrientation:"left",shouldRenderXAxis:!0,shouldRenderYAxis:!0,xLabelRegion:"yGutter",yLabelRegion:"xGutter",xLabelOffset:0,yLabelOffset:0,xLabelSize:"8pt",yLabelSize:"8pt",legendRegion:"chart",legendAlignment:"TL",legendOffset:[0,0],legendLineHeight:13,legendSize:"7pt",legendTextXOffset:6,legendTextYOffset:3,aspectRatio:"default"},shouldScaleAxis:function(a){return this.options.scaleAxes?!0:"x"===a&&this.options.scaleXAxis?!0:"y"===a&&this.options.scaleYAxis?!0:!1},_accessors:["xGutter","xPadding","yGutter","yPadding","width","height",{name:"dataset",setter:"setDataset"},{name:"legend",setter:"setLegend"},{name:"input",setter:"setInput"},{name:"xLabel",setter:"setXLabel"},{name:"yLabel",setter:"setYLabel"},{name:"xScale",setter:"setXScale"},{name:"yScale",setter:"setYScale"},"xScaleType","yScaleType","yHeightScaleType","xIDMap","yIDMap","radialGradients","linearGradients","children"],input:function(){return this.dataset()},setInput:function(b){return a.isPlainObject(b)&&void 0!==b.dataset?this.setValuesForKeys(b):this.setDataset(b)},setXLabel:function(a){this.setValueForKey("xLabel",a),this.render("xLabel")},setYLabel:function(a){this.setValueForKey("yLabel",a),this.render("yLabel")},setXScale:function(a){this.setValueForKey("xScale",a),this.render("xAxis")},setYScale:function(a){this.setValueForKey("yScale",a),this.render("yAxis")},createIDMapForDomain:function(b){var c={};return a.each(b,function(a,b){c[a]=b}),c},setXScaleDomain:function(a,c){var d=this.xScale();return void 0===d&&(void 0===c&&(c=this.xScaleType()||this.options.xScaleType),d=b.scale[c](),this.setXScaleRange([0,this.chartBounds().size.width],d),this.setValueForKey("xScale",d)),d.domain(a),this.options.useIDMapping&&void 0===this.xIDMap()&&this.xIDMap(this.createIDMapForDomain(a)),this.render("xAxis"),d},setXScaleRange:function(a,b){return void 0===b&&(b=this.xScale()),b.range(a),b},setYScaleDomain:function(a,c){var d=this.yScale();return void 0===d&&(void 0===c&&(c=this.yScaleType()||this.options.yScaleType),d=b.scale[c](),this.setYScaleRange([0,this.chartBounds().size.height],d),this.setValueForKey("yScale",d)),d.domain(a),this.options.useIDMapping&&void 0===this.yIDMap()&&this.yIDMap(this.createIDMapForDomain(a)),this.render("yAxis"),d},setYScaleRange:function(a,b){return void 0===b&&(b=this.yScale()),b.range(a),b},init:function(b){return this._super(b),void 0===this.children()&&this.children([]),void 0===this.options.transformations&&(this.options.transformations={}),void 0===this.radialGradients()&&this.radialGradients({}),void 0===this.linearGradients()&&this.linearGradients({}),void 0===this.options.chartID&&(this.options.chartID=this.uuid()),this.ticker=function(){return this.options.ticker+=1,this.options.ticker},this.uniqueID=a.proxy(function(a){return void 0===a.id&&(a.id=this.ticker()),a.id},this),void 0!==this.options.width&&this.options.width.match(/px/)?this.width(parseInt(this.options.width,10)):this.width(this.$elem.width()),void 0!==this.options.height&&this.options.height.match(/px/)?this.height(parseInt(this.options.height,10)):this.height(this.$elem.height()),this.appendUI(this.$elem),this.xScale()&&this.setXScaleRange([0,this.chartBounds().size.width],this.xScale()),this.yScale()&&this.setYScaleRange([0,this.chartBounds().size.height],this.yScale()),this.callAfterInit(a.proxy(function(){this.render()},this)),this},render:function(a){this._init&&((void 0===a||"chart"===a)&&this.renderChart(),(void 0===a||"xAxis"===a)&&this.renderXAxis(),(void 0===a||"yAxis"===a)&&this.renderYAxis(),(void 0===a||"xLabel"===a)&&this.renderXLabel(),(void 0===a||"yLabel"===a)&&this.renderYLabel(),(void 0===a||"ulCorner"===a)&&this.renderULCorner(),(void 0===a||"legend"===a)&&this.renderLegend())},fitTextToWidth:function(a,b){for(var c=this.D3svg().append("text").attr("opacity",0).attr("font-size",this.options.legendSize).text(a),d=c[0][0].getBBox(),e=a,f=!1,g=d.width;d.width+this.options.legendTextXOffset>b&&e.length;)e=e.substring(0,e.length-1),c.text(e+"..."),d=c[0][0].getBBox(),f=!0;return c.remove(),{truncated:f,text:a,truncatedText:a===e?a:e+"...",width:g}},renderLegend:function(){if(void 0!==this.legend()){var a=this,c={circle:81,square:81,"triangle-up":49,"triangle-down":49,diamond:36,cross:49},d=this[this.options.legendRegion+"Bounds"](),e=Math.min(this.options.legendWidth||1e9,d.size.width),f=0,g=0,h=a.options.legendTextXOffset,i=a.options.legendTextYOffset;if(this.options.legendAlignment.match(/B/)&&(g=d.size.height-a.options.legendLineHeight*this.legend().length),this.options.legendAlignment.match(/R/)){var j=0;this.legend().forEach(function(b){var c=a.fitTextToWidth(b.label,e);j=Math.max(j,c.width)}),f=d.size.width-(j+h+6)}var k=function(a){return a.label};this.D3svg().select(this.region(this.options.legendRegion)).selectAll(".legend").data([0]).enter().append("g").attr("class","legend");var l=this.D3svg().select(this.region(this.options.legendRegion)).selectAll(".legend").selectAll("g").data(this.legend(),k),m=function(b,c,d){var e=6+f+a.options.legendOffset[0],h=6+d*a.options.legendLineHeight+g+a.options.legendOffset[1];return"translate("+e+","+h+")"};l.enter().append("g").each(function(a,c){var d=b.select(this);d.attr("transform",function(a,b){return m(a,b,c)}),d.append("path").attr("opacity",0),d.append("text").attr("class","legend-text").attr("opacity",0)});var n=this.drawnLegend?this.options.transitionTime:0;l.each(function(d,f){var g=b.select(this);g.transition().duration(n).attr("transform",function(a,b){return m(a,b,f)});var j=a.fitTextToWidth(d.label,e);g.selectAll("path").transition().duration(n).attr("d",function(){return b.svg.symbol().type(d.shape||"square").size(c[d.shape]||81)()}).style("fill",function(){return d.color}).style("stroke",function(){return d.color}).attr("opacity",1),g.selectAll("text").transition().duration(n).attr("x",h).attr("y",i).attr("font-size",a.options.legendSize).text(function(){return j.truncatedText}).attr("opacity",1),j.truncated&&g.selectAll("text").on("mouseover",function(){a.showToolTip({label:j.text})}).on("mouseout",function(){a.hideToolTip()})}),l.exit().each(function(){var a=b.select(this);a.selectAll("path").transition().duration(n).attr("opacity",0).remove(),a.selectAll("text").transition().duration(n).attr("opacity",0).remove()}),this.drawnLegend=!0}},renderULCorner:function(){var a=this.ULBounds(),b=new e(a.size.width,a.size.height),c=5;if(b.width-=c,b.height-=c,b.width>b.height?b.width=b.height:b.height>b.width&&(b.height=b.width),!(b.width<25)){var d=[this.options.ulIcon];if(this.options.ulIcon){var f=this.D3svg().select(this.region("UL")).selectAll(".ULLabel");f.data(d).enter().append("image").attr("x",c/2).attr("y",c/2).attr("width",b.width).attr("height",b.height).attr("xlink:href",function(a){return a})}}},setLegend:function(a){void 0===a&&(a=this.options.defaultLegend()),this.setValueForKey("legend",a),this.render()},extractLegend:function(a){},setDataset:function(a){void 0===a&&(a=this.options.defaultDataset()),this.setValueForKey("dataset",a),this.shouldScaleAxis("x")&&this.setXScaleDomain(this.defaultXDomain()),this.shouldScaleAxis("y")&&(console.warn("SHOULD SCALE Y, so sets it",this.defaultYDomain()),this.setYScaleDomain(this.defaultYDomain())),this.options.autoLegend&&this.extractLegend(a),this.render()},setDatasets:function(b){void 0===b&&(b=[]),void 0===this.children()&&this.children([]);var c=b.shift(),d=this,e=function(){d.setDataset(c);for(var e=0;e<b.length;e++){var f;if(e<d.children().length)f=d.children()[e],f.reenter(e,b[e],d);else{var g=d.childOptions(d.children().length,b[e]);g.parent=d,f=a.jqElem("div")[d.name](g),d.children().push(f)}f.setDataset(b[e])}for(var e=b.length;e<d.children().length;e++)d.children()[e].setDataset(void 0);d.render()};this.callAfterInit(e)},reenter:function(a,b,c){},childOptions:function(b,c){return a.extend(!0,{},c.options||this.options.childOptions||this.options)},defaultXDomain:function(){return[0,100]},defaultYDomain:function(){return[0,100]},renderXLabel:function(){var a=this[this.options.xLabelRegion+"Bounds"](),b=[this.xLabel()],c=this.options.xLabelOffset,d=this.D3svg().select(this.region(this.options.xLabelRegion)).selectAll(".xLabel");d.data(b).text(this.xLabel()).enter().append("text").attr("class","xLabel").attr("x",a.size.width/2).attr("y",a.size.height/2+3).attr("text-anchor","middle").attr("font-size",this.options.xLabelSize).attr("font-family","sans-serif").attr("fill","black").attr("transform","translate(0,"+c+")").text(this.xLabel())},renderYLabel:function(){var a=this[this.options.yLabelRegion+"Bounds"](),b=[this.yLabel()],c="xPadding"===this.options.yLabelRegion?-90:90,d=this.options.yLabelOffset,e=this.D3svg().select(this.region(this.options.yLabelRegion)).selectAll(".yLabel");e.data(b).text(this.yLabel()).enter().append("text").attr("class","yLabel").attr("x",a.size.width/2).attr("y",a.size.height/2+3).attr("text-anchor","middle").attr("font-size",this.options.yLabelSize).attr("font-family","sans-serif").attr("fill","black").attr("transform","translate("+d+",0) rotate("+c+","+(a.size.width/2-7)+","+a.size.height/2+")").text(this.yLabel())},xTickValues:function(){},xTickLabel:function(a){return a},renderXAxis:function(){var a=this;if(this.options.shouldRenderXAxis&&void 0!==this.xScale()&&void 0!==this.xScale().domain){var c="yGutter"===this.options.xAxisRegion?d.size.height:0;console.log("RENDERS X WITH TRANSFORM ",this.options.xAxisTransform),this.options.xAxisTransform&&(c=this.options.xAxisTransform);var d=this[this.options.xAxisRegion+"Bounds"](),e=this.options.xAxisOrientation;"bottom"===e&&c>d.size.height-30&&(e="top");var f=b.svg.axis().scale(this.xScale()).orient(e),g=this.xTickValues();void 0!==g&&f.tickValues(g).tickSubdivide(0).tickFormat(function(b){return a.xTickLabel.call(a,b)}),this.options.xLabels||f.tickFormat("");var h=this.D3svg().select(this.region(this.options.xAxisRegion)).select(".xAxis");h.empty()&&(h=this.D3svg().select(this.region(this.options.xAxisRegion)).append("g").attr("class","xAxis axis").attr("fill",this.options.xAxisColor)),console.log("GX AXIS ",h,h[0][0].parentNode),h[0][0].parentNode.appendChild(h[0][0]),this.D3svg().select(this.region(this.options.xAxisRegion)).selectAll(".xAxis").attr("transform","translate(0,"+c+")"),h.transition().call(f)}},svg2HTML:function(){var b=a.jqElem("div").append(this.data("$svg"));return b.html()},renderYAxis:function(){if(this.options.shouldRenderYAxis&&void 0!==this.yScale()){var a=b.svg.axis().scale(this.yScale()).orient(this.options.yAxisOrientation);this.options.yLabels||a.tickFormat("");var c=this.D3svg().select(this.region(this.options.yAxisRegion)).select(".yAxis"),d=this[this.options.yAxisRegion+"Bounds"](),e="xPadding"===this.options.yAxisRegion?d.size.width:0;void 0===c[0][0]&&(c=this.D3svg().select(this.region(this.options.yAxisRegion)).append("g").attr("class","yAxis axis").attr("fill",this.options.yAxisColor).attr("transform","translate("+e+",0)")),c.transition().call(a)}},renderChart:function(){},setGutter:function(a){this.xGutter(a),this.yGutter(a)},setPadding:function(a){this.xPadding(a),this.yPadding(a)},appendUI:function(c){var d=this.chartBounds();if(d.size.width!==d.size.height&&"default"!==this.options.aspectRatio){var e=Math.abs(d.size.width-d.size.height),f=c.height(),g=c.width();"minSquare"===this.options.aspectRatio?d.size.width<d.size.height?f-=e:d.size.height<d.size.width&&(g-=e):"maxSquare"===this.options.aspectRatio&&(d.size.height<d.size.width?f+=e:d.size.width<d.size.height&&(g+=e)),c.animate({width:g,height:f},0),this.width(g),this.height(f)}var h;if(this.options.parent)this.$elem=this.options.parent.$elem,this.width(this.$elem.width()),this.height(this.$elem.height()),h=this.D3svg();else{c.append(a.jqElem("style").html(".axis path, .axis line { fill : none; stroke : black; shape-rendering : crispEdges;} .axis text                             {font-family : sans-serif; font-size : 11px}")),h=b.select(c.get(0)).append("svg").attr("style","width : "+this.options.width+"; height : "+this.options.height);b.select("body").selectAll(".visToolTip").data([0]).enter().append("div").attr("class","visToolTip").style({position:"absolute","max-width":"300px",height:"auto",padding:"10px","background-color":"white","-webkit-border-radius":"10px","-moz-border-radius":"10px","border-radius":"10px","-webkit-box-shadow":"4px 4px 10px rgba(0, 0, 0, 0.4)","-moz-box-shadow":"4px 4px 10px rgba(0, 0, 0, 0.4)","box-shadow":"4px 4px 10px rgba(0, 0, 0, 0.4)","pointer-events":"none",display:"none","font-family":"sans-serif","font-size":"12px","line-height":"20px"});this.data("D3svg",h)}var i=["chart","UL","UR","LL","LR","yGutter","xGutter","yPadding","xPadding"],j=["red","green","blue","cyan","magenta","yellow","purple","orange","gray"];h.selectAll("defs").data([null]).enter().append("defs").attr("class","definitions");var k=this,l=h.selectAll("g").data(i,function(a){return a}).enter().append("g").attr("class",function(a){return a}).attr("data-x",a.proxy(function(a){var b=this[a+"Bounds"]();return b.origin.x},this)).attr("data-y",a.proxy(function(a){var b=this[a+"Bounds"]();return b.origin.y},this)).attr("data-width",a.proxy(function(a){var b=this[a+"Bounds"]();return b.size.width},this)).attr("data-height",a.proxy(function(a){var b=this[a+"Bounds"]();return b.size.height},this)).attr("transform",a.proxy(function(a){var b=this[a+"Bounds"]();return"translate("+b.origin.x+","+b.origin.y+")"},this));l.append("rect").attr("x",0).attr("y",0).attr("width",a.proxy(function(a){var b=this[a+"Bounds"]();return b.size.width},this)).attr("height",a.proxy(function(a){var b=this[a+"Bounds"]();return b.size.height},this)).attr("fill",function(a){return k.options.debug?j.shift():k.options.bgColor}).attr("class","background"),a.each(i,function(b,c){h.selectAll("."+c).selectAll("g").data([{region:k.region(c,!0),r:c}],function(a){return a.region}).enter().append("g").attr("class",function(a){return a.region}).attr("transform",function(b){var c=k.options.transformations[b.r]||k.options.transformations.global;if(void 0!==c)return c=a.extend(!0,{translate:{x:0,y:0},scale:{width:1,height:1}},c),"translate("+c.translate.x+","+c.translate.y+") scale("+c.scale.width+","+c.scale.height+")"})})},D3svg:function(){return this.options.parent?this.options.parent.D3svg():this.data("D3svg")},region:function(a,b){var c="";return b||(c="."),void 0!==this.options.customRegions[a]?c+this.options.customRegions[a]:c+a+"-"+this.options.chartID},ULBounds:function(){return new c(new d(0,0),new e(this.xPadding(),this.yGutter()))},URBounds:function(){return new c(new d(this.xPadding()+this.chartBounds().size.width,0),new e(this.xGutter(),this.yGutter()))},LLBounds:function(){return new c(new d(0,this.yGutter()+this.chartBounds().size.height),new e(this.xPadding(),this.yPadding()))},LRBounds:function(){return new c(new d(this.xPadding()+this.chartBounds().size.width,this.yGutter()+this.chartBounds().size.height),new e(this.xPadding(),this.yPadding()))},xPaddingBounds:function(){return new c(new d(0,this.yGutter()),new e(this.xPadding(),this.chartBounds().size.height))},xGutterBounds:function(){return new c(new d(this.xPadding()+this.chartBounds().size.width,this.yGutter()),new e(this.xGutter(),this.chartBounds().size.height))},yGutterBounds:function(){return new c(new d(this.xPadding(),0),new e(this.chartBounds().size.width,this.yGutter()))},yPaddingBounds:function(){return new c(new d(this.xPadding(),this.yGutter()+this.chartBounds().size.height),new e(this.chartBounds().size.width,this.yPadding()))},chartBounds:function(){var a=this.$elem.width(),b=this.$elem.height(),f=new c(new d(this.xPadding(),this.yGutter()),new e(a-this.xPadding()-this.xGutter(),b-this.yGutter()-this.yPadding()));return f.size.width<0&&(f.size.width=0),f.size.height<0&&(f.size.height=0),f},showToolTip:function(a){void 0===a.event&&(a.event=b.event),b.selectAll(".visToolTip").style("display","block").html(a.label).style("left",a.event.pageX+10+"px").style("top",a.event.pageY-10+"px")},hideToolTip:function(a){b.selectAll(".visToolTip").style("display","none")},radialGradient:function(b){b=a.extend(!0,{cx:0,cy:0,stopColor:this.options.radialGradientStopColor,r:this.chartBounds().size.width/2},b);var c=[b.cx,b.cy,b.r,b.startColor,b.stopColor].join(",");void 0!==this.radialGradients()[c]&&void 0===b.id&&(b.id=this.radialGradients()[c]),void 0===b.id&&(b.id=this.uuid());var d=this.D3svg().select(".definitions").selectAll("#"+b.id).data([b]),e=!1;d.enter().append("radialGradient").attr("id",function(a){return e=!0,a.id}).attr("gradientUnits","userSpaceOnUse").attr("cx",function(a){return a.cx}).attr("cy",function(a){return a.cy}).attr("r",function(a){return 2.5*a.r}).attr("spreadMethod","pad");var f=e?0:this.options.transitionTime,g=d.selectAll('stop[offset="0%"]').data([b]);g.enter().append("stop").attr("offset","0%"),g.transition().duration(f).attr("stop-color",function(a){return a.startColor});var h=d.selectAll('stop[offset="30%"]').data([b]);h.enter().append("stop").attr("offset","30%").attr("stop-opacity",1),h.transition().duration(f).attr("stop-color",function(a){return a.startColor});var i=d.selectAll('stop[offset="70%"]').data([b]);return i.enter().append("stop").attr("stop-opacity",1).attr("offset","70%"),i.transition().duration(f).attr("stop-color",function(a){return a.stopColor}),this.radialGradients()[c]=b.id},linearGradient:function(b){var c=this.chartBounds();b=a.extend(!0,{x1:0,x2:0,y1:c.size.height,y2:0,width:0,height:c.size.height},b);var d=[b.cx,b.cy,b.r,b.startColor,b.stopColor].join(",");void 0!==this.linearGradients()[d]&&void 0===b.id&&(b.id=this.linearGradients()[d]),void 0===b.id&&(b.id=this.uuid());var e=this.D3svg().select(".definitions").selectAll("#"+b.id).data([b]),f=!1;e.enter().append("linearGradient").attr("id",function(a){return f=!0,a.id}).attr("gradientUnits","userSpaceOnUse").attr("x1",function(a){return a.x1}).attr("x2",function(a){return a.x2}).attr("y1",function(a){return a.y1}).attr("y2",function(a){return a.y2}).attr("spreadMethod","pad");var g=f?0:this.options.transitionTime,h=e.selectAll("stop").data(b.colors);return h.enter().append("stop"),h.transition().duration(g).attr("offset",function(a,c){var d=0;return c===b.colors.length-1?d=1:c>0&&(d=c/(b.colors.length-1)),Math.round(1e4*d)/100+"%"}).attr("stop-color",function(a){return a}),this.linearGradients()[d]=b.id},wrap:function(a,c,d){void 0===d&&(d=function(){return 0}),a.each(function(){for(var a,e=b.select(this),f=e.text().split(/\s+/).reverse(),g=[],h=1.1,i=e.attr("y"),j=parseFloat(e.attr("dy"))||0,k=e.text(null).append("tspan").attr("x",d).attr("y",i).attr("dy",j+"em");a=f.pop();)g.push(a),k.text(g.join(" ")),k.node().getComputedTextLength()>c&&(g.pop(),k.text(g.join(" ")),g=[a],k=e.append("tspan").attr("x",d).attr("y",i).attr("dy",h+"em").text(a))})},absPos:function(a){var b=a.getBBox(),c=a.getScreenCTM();return{x:b.x+c.e,y:b.y+c.f}},endall:function(a,b){var c=0;a.each(function(){++c}).each("end",function(){--c||b.apply(this,arguments)})},uniqueness:function(a){return void 0===a&&(a=this.uniqueID),this.options.useUniqueID?a:void 0}})});