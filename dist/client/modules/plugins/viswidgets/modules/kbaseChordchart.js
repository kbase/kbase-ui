define(["jquery","d3","kb_vis_visWidget","kb_vis_RGBColor","kb_vis_rectangle","kb_vis_point","kb_vis_size","kb_vis_piechart"],function(a,b){"use strict";a.KBWidget({name:"kbaseChordchart",parent:"kbasePiechart",version:"1.0.0",options:{chordPadding:.1,xOffset:0,yOffset:0,innerRadius:-25,outerRadius:-25,strokeWidth:.5,strokeColor:"black",choppedGroups:!1,sortGroups:void 0,drawArcs:!0,drawChords:!0,sortSubgroups:b.descending,chordColorScale:function(a,b,c){return c.options.colorScale(a,b,c)}},_accessors:["calculatedPieData"],init:function(a){return this._super(a),this},pieData:function(){return this.calculatedPieData()},startingChordPosition:function(a,b){return this.initialized?b<this.lastChordData.length-1?{source:{startAngle:this.lastChordData[b+1].source.startAngle,endAngle:this.lastChordData[b+1].source.startAngle},target:{startAngle:this.lastChordData[b+1].target.startAngle,endAngle:this.lastChordData[b+1].target.startAngle}}:{source:{startAngle:this.options.endAngle,endAngle:this.options.endAngle},target:{startAngle:this.options.endAngle,endAngle:this.options.endAngle}}:"slice"===this.options.startingPosition?{source:{startAngle:a.source.startAngle,endAngle:a.source.startAngle},target:{startAngle:a.target.startAngle,endAngle:a.target.startAngle}}:"top"===this.options.startingPosition?{source:{startAngle:this.options.startAngle,endAngle:this.options.startAngle},target:{startAngle:this.options.startAngle,endAngle:this.options.startAngle}}:"final"===this.options.startingPosition?{source:{startAngle:a.source.startAngle,endAngle:a.source.endAngle},target:{startAngle:a.target.startAngle,endAngle:a.target.endAngle}}:void 0},sliceAction:function(b){var c=a.KBWidget.registry()[b.parent].prototype.sliceAction;return c=c.call(this,b),function(){return this.call(c),this}},renderChart:function(){function c(a){var c=(a.endAngle-a.startAngle)/a.value;return b.range(0,a.value,1e3).map(function(b,d){return{angle:b*c+a.startAngle,label:d%5?null:b/1e3+"k"}})}var d=this.chartBounds(),e=this,f=b.layout.chord().padding(this.options.chordPadding).sortGroups(this.options.sortGroups).sortSubgroups(this.options.sortSubgroups).matrix(e.dataset()),g=f.groups(),h=[];a.each(g,function(c,d){d.startAngle+=e.options.startAngle,d.endAngle+=e.options.startAngle;var f=d.endAngle-d.startAngle;if(d.data={},e.options.choppedGroups){var g=d.startAngle,i=e.dataset()[c].slice(),j=0;i.forEach(function(a){j+=a});var k=d.data.color||e.options.chordColorScale(c,d.data,e),l=b.rgb(k),m=.15,n=l.darker(m),o=l.brighter(m),p=b.scale.linear().domain([0,1]).range([n,o]);e.options.colorScale;i.sort(e.options.sortSubgroups).forEach(function(b,c){var e=f*b/j,i=g+e,k=a.extend(!0,{},d.data);k.color=p(c),h.push({startAngle:g,endAngle:i,index:d.index,value:d.value,data:k}),g=i})}else h.push(d)}),this.calculatedPieData(h),this.options.drawArcs&&this._super();var i=b.scale.ordinal().domain(b.range(4)).range(["#000000","#FFDD89","#957244","#F26223"]);if(this.options.drawChords){var j=this.data("D3svg").select(this.region("chart")).selectAll(".chords").data([0]);j.enter().insert("g",".labelG").attr("class","chords").attr("transform","translate("+(d.size.width/2+this.options.xOffset)+","+(d.size.height/2+this.options.yOffset)+")");var k=this.innerRadius(),l=this.outerRadius(),m=(b.svg.arc().innerRadius(k).outerRadius(l),[]);f.chords().forEach(function(b,c){var d=a.extend(!0,{},b);d.data={},d.source.startAngle+=e.options.startAngle,d.source.endAngle+=e.options.startAngle,d.target.startAngle+=e.options.startAngle,d.target.endAngle+=e.options.startAngle,m.push(d);var f=d.source.index;d.target.value>d.source.value&&(f=d.target.index),d.data.colorIdx=f});var n=function(){return this.attr("fill-opacity",.67).attr("fill",function(a,b){return a.data.color||e.options.colorScale(a.data.colorIdx,a.data,e)}).attr("stroke","black").attr("stroke-width",.5).attr("fill-opacity",.5),this.attrTween&&this.attrTween("d",function(a,c){void 0===this._current&&(this._current=e.startingChordPosition(a,c));var d=b.interpolate(this._current,a);return this._current=d(0),function(a){var c=b.svg.chord().radius(k)(d(a));return c}}),this},o=this.initialized||"final"!==this.options.startingPosition?this.options.transitionTime:0,p=j.selectAll("path").data(m);p.enter().append("path").attr("fill",function(a){return i(a.target.index)}),p.transition().duration(o).call(n).call(e.endall,function(){e.lastChordData=f.chords}),p.exit().remove()}var q=this.data("D3svg").select(this.region("chart")).selectAll(".ticks").data([0]);q.enter().insert("g",".labelG").attr("class","ticks"),q.attr("transform","translate("+(d.size.width/2+this.options.xOffset)+","+(d.size.height/2+this.options.yOffset)+")");var r=q.selectAll(".tickArcs").data(f.groups);r.enter().append("g").attr("class","tickArcs"),r.exit().transition().duration(o).attr("opacity",0).each("end",function(a){b.select(this).remove()});var s=r.selectAll("g").data(c),t=s.enter().append("g").attr("opacity",1);t.append("line"),t.append("text"),s.exit().transition().duration(o).attr("opacity",0).each("end",function(a){b.select(this).remove()}),s.transition().duration(o).attrTween("transform",function(a,c){void 0===this._current&&(this._current=e.startingChordPosition(a,c));var d=b.interpolate(this._current,a);return this._current=d(0),function(a){var b=d(a);return"rotate("+(180*b.angle/Math.PI-90)+")translate("+l+",0)"}}),s.select("line").attr("x1",1).attr("y1",0).attr("x2",5).attr("y2",0).style("stroke","#000").attr("stroke-opacity",function(a){return b.select(this).attr("stroke-opacity")||0}),s.select("line").transition().duration(o).attr("stroke-opacity",1),s.select("text").attr("x",8).attr("dy",".35em").attr("transform",function(a){return a.angle%(2*Math.PI)>Math.PI?"rotate(180)translate(-16)":null}).style("text-anchor",function(a){return a.angle%(2*Math.PI)>Math.PI?"end":null}).text(function(a){return a.label}).attr("opacity",function(a){return b.select(this).attr("opacity")||0}),s.select("text").transition().duration(o).attr("opacity",1)},renderXAxis:function(){},renderYAxis:function(){}})});