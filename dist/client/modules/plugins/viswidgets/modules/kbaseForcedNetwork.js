define(["jquery","d3","kb_vis_RGBColor","kb/widget/legacy/searchControls","kb_vis_visWidget","kb_vis_rectangle","kb_vis_point","kb_vis_size"],function(a,b,c){"use strict";a.KBWidget({name:"kbaseForcedNetwork",parent:"kbaseVisWidget",version:"1.0.0",options:{overColor:"blue",nodeColor:"gray",lineColor:"gray",lineWeight:3,nodeStrokeColor:"black",nodeStrokeWeight:1,nodeRadius:10,filteredNodeColor:"#BFBFBF",linkDistance:100,charge:-10,xGutter:0,xPadding:0,yPadding:0,maxCurveWeight:100,searchBox:!0,filter:!1,cornerToolTip:!1},_accessors:["forceLayout","restart"],defaultXDomain:function(){if(void 0===this.dataset())return[0,0];var a=2*b.min(this.dataset().nodes.map(function(a){return a.x}));return a>0&&(a=0),[a,2*b.max(this.dataset().nodes.map(function(a){return a.x}))]},defaultYDomain:function(){if(void 0===this.dataset())return[0,0];var a=2*b.min(this.dataset().nodes.map(function(a){return a.y}));return a>0&&(a=0),[a,2*b.max(this.dataset().nodes.map(function(a){return a.y}))]},appendUI:function(a){this._super(a);var d=void 0,e=this.data("D3svg").select(".chart"),f=this.chartBounds(),g=void 0,h=this,i=[];return e.on("mousedown",function(){if("background"===b.select(b.event.target).attr("class")){var a=b.mouse(this);d=new Point(a[0]+f.origin.x,a[1]+f.origin.y),g=e.append("rect").attr("class","selectionBox").attr("x",d.x).attr("y",d.y).attr("width",0).attr("height",0).attr("stroke","#222").attr("stroke-width","3").attr("fill",new c(0,0,0).asStringWithAlpha(.1))}}).on("mousemove",function(){if(void 0!==d){var a=b.mouse(this),c=new Point(a[0]+f.origin.x,a[1]+f.origin.y),e=d.rectWithPoint(c);e.origin.x-=f.origin.x,e.origin.y-=f.origin.y,g.attr("x",e.origin.x),g.attr("y",e.origin.y),g.attr("width",e.size.width),g.attr("height",e.size.height);var j=h.forceLayout().nodes();j.forEach(function(a,b){var c=new Rectangle(new Point(a.x-a.radius,a.y-a.radius),new Size(2*a.radius,2*a.radius));c.intersects(e)?(i.push(a),a.highlighted=3):a.highlighted=-1}),h.restart()()}}).on("mouseup",function(){if(void 0!==d){var a=b.mouse(this),c=new Point(a[0]+f.origin.x,a[1]+f.origin.y);d.rectWithPoint(c);d=void 0,g=void 0,e.select(".selectionBox").remove(),i.forEach(function(a,b){a.highlighted=!1}),i=[],h.restart()()}}),this},renderChart:function(){if(void 0!==this.dataset()){this.options.filter&&(this.$elem.kbaseSearchControls({context:this,searchCallback:function(a,b,c){c.options.filterVal=new RegExp(b,"i"),c.restart()()}}),this.$elem.data("searchControls").addClass("col-md-6"));var a=this.chartBounds(),d=this,e=this.data("D3svg").select(".chart").selectAll(".node"),f=this.data("D3svg").select(".chart").selectAll(".tag"),g=this.data("D3svg").select(".chart").selectAll(".edge"),h=this.forceLayout();if(void 0!==h)return this.forceLayout().nodes(this.dataset().nodes),this.forceLayout().links(this.dataset().edges),void d.restart()();var i=function(){g.attr("d",function(a){if(a.curveStrength){var c=a.target.x-a.source.x,e=a.target.y-a.source.y,f=b.scale.linear().domain([-d.options.maxCurveWeight,d.options.maxCurveWeight]).range([0,c]),g=b.scale.linear().domain([-d.options.maxCurveWeight,d.options.maxCurveWeight]).range([0,e]),h=a.source.x+f(a.curveStrength),i=a.target.y-g(a.curveStrength),j=" M"+a.source.x+","+a.source.y+" Q"+h+","+i+"  "+a.target.x+","+a.target.y;return j}return"M"+a.source.x+","+a.source.y+"L"+a.target.x+","+a.target.y}),e.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),f.attr("x",function(a){return a.x+(a.tagOffsetX||0)}).attr("y",function(a){return a.y+(a.tagOffsetY||0)}),f.attr("fill-opacity",function(a){var b=a.search;return void 0===b&&(b=a.tag),void 0===d.options.filterVal||b.match(d.options.filterVal)?1:.25})};h=b.layout.force().nodes(d.dataset().nodes).links(d.dataset().edges).size([a.size.width,a.size.height]).charge(function(a,b){return a.charge||d.options.charge}).linkDistance(function(a,b){return a.linkDistance||d.options.linkDistance}).on("tick",i),this.forceLayout(h);var j=function(){g=g.data(h.links());var i=function(){return this.on("mouseover",function(a){var c=[0,0];c=b.mouse(this);var e=c[0];c[1];d.showToolTip({label:a.label||"Node: "+a.name,event:{pageX:b.event.pageX-(d.options.cornerToolTip?e+300:0),pageY:b.event.pageY}}),a.source.highlighted=1,a.target.highlighted=1,a.highlighted=2,d.forceLayout().links().forEach(function(a,b){2!==a.highlighted&&(a.highlighted=-1)}),d.forceLayout().nodes().forEach(function(a,b){2!==a.highlighted&&1!==a.highlighted&&(a.highlighted=-1)}),j()}).on("mouseout",function(a){d.hideToolTip(),d.forceLayout().links().forEach(function(a,b){a.highlighted=0,a.source.highlighted=0,a.target.highlighted=0}),d.forceLayout().nodes().forEach(function(a,b){a.highlighted=0}),j()}).call(h.drag),this},k=function(){return this.attr("class","edge").attr("stroke",function(a){return a.color||d.options.lineColor}).attr("stroke-width",function(a){return a.weight||d.options.lineWeight}).attr("fill","none").attr("stroke-opacity",function(a){return void 0===d.options.filterVal&&-1!==a.highlighted||-1!==a.highlighted&&a.source.tag.match(d.options.filterVal)&&a.target.tag.match(d.options.filterVal)?1:.25}),this};g.enter().insert("path",".node").call(i).call(k),g.call(i).transition().duration(100).call(k),g.exit().remove(),e=e.data(h.nodes());var l=function(){return this.on("mouseover",function(a){var c=[0,0];c=b.mouse(this);var e=c[0];c[1];d.showToolTip({label:a.label||"Node: "+a.name,event:{pageX:b.event.pageX-(d.options.cornerToolTip?e+300:0),pageY:b.event.pageY}}),d.forceLayout().links().forEach(function(b,c){b.source===a&&(b.target.highlighted=1,b.highlighted=1),b.target===a&&(b.source.highlighted=1,b.highlighted=1),1!==b.highlighted&&(b.highlighted=-1)}),d.forceLayout().nodes().forEach(function(a,b){1!==a.highlighted&&(a.highlighted=-1)}),a.highlighted=2,j()}).on("mouseout",function(a){d.hideToolTip(),a.highlighted=0,d.forceLayout().links().forEach(function(a,b){a.highlighted=0,a.source.highlighted=0,a.target.highlighted=0}),d.forceLayout().nodes().forEach(function(a,b){a.highlighted=0}),j()}).on("mousedown",function(a){a.fixed=!1}).on("dblclick",function(a){a.fixed=!1}).on("mouseup",function(b){b.x<a.origin.x||b.y<a.origin.y||b.x>a.origin.x+a.size.width||b.y>a.origin.y+a.size.height?b.fixed=!1:b.fixed=!0}).call(h.drag),this},m=function(){return this.attr("r",function(a){return a.radius||d.options.nodeRadius}).attr("fill",function(a){var b=a.search;if(void 0===b&&(b=a.tag),2===a.highlighted)return a.highlightColor||d.options.nodeHighlightColor||a.color||d.options.nodeColor;if(1===a.highlighted)return a.relatedHighlightColor||d.options.relatedNodeHighlightColor||a.color||d.options.nodeColor;if(void 0!==d.options.filteredNodeColor&&void 0!==d.options.filterVal&&!b.match(d.options.filterVal)||-1===a.highlighted){var e=c.prototype.rgbFromString(a.color||d.options.nodeColor);if(e){var f=new c(e.r,e.g,e.b);return f.lightenBy(191).asString()}return d.options.filteredNodeColor||a.color||d.options.nodeColor}return a.color||d.options.nodeColor}).attr("stroke",function(a){return a.stroke||d.options.nodeStrokeColor}).attr("stroke-width",function(a){return a.strokeWidth||d.options.nodeStrokeWeight}).attr("data-name",function(a){return a.name}),this};e.enter().append("circle").attr("class","node").call(m).call(l),e.call(l).transition().duration(100).call(m),e.exit().remove(),f=f.data(h.nodes());var n=function(){return this.text(function(a){return a.tag}).attr("text-anchor","middle").attr("alignment-baseline","middle").attr("style",function(a){return a.tagStyle}),this};f.enter().append("text").attr("text","tag").call(n).call(l),f.call(l).transition().duration(100).call(n),f.exit().remove(),h.start()};d.restart(j),j()}},renderXAxis:function(){},renderYAxis:function(){}})});