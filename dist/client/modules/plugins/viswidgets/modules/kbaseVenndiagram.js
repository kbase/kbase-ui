define(["jquery","d3","kb_vis_visWidget"],function(a,b){"use strict";a.KBWidget({name:"kbaseVenndiagram",parent:"kbaseVisWidget",version:"1.0.0",options:{xGutter:0,xPadding:0,yPadding:0,xOffset:0,yOffset:0,overlap:.2,fillOpacity:.8,startAngle:2*Math.PI*150/360,strokeWidth:2,strokeColor:function(){return"black"},fillColor:function(c,d,e){if(void 0===e.fillScale&&(e.fillScale=b.scale.category20()),void 0===e.circleColors&&(e.circleColors=[]),d.data.fillColor)return e.circleColors[c]=d.data.fillColor,d.data.fillColor;if(d.fillColor)return e.circleColors[c]=d.fillColor,d.fillColor;if(a.isArray(c)){var f=[];a.each(c,function(a,c){f.push(b.rgb(e.options.fillColor(c,d,e)))});var g=b.rgb(),h=2;return a.each(f,function(a,b){g.r+=Math.floor(b.r/h),g.g+=Math.floor(b.g/h),g.b+=Math.floor(b.b/h)}),g.toString()}var i=e.circleColors[c];return void 0===i&&(i=e.circleColors[c]=e.fillScale(c)),i},circleFontSize:"18pt",intersectFontSize:"24pt",drawLabels:!0,tooltips:!0,radiusScale:1},_accessors:[],init:function(a){return this._super(a),this},intersectCircles:function(a,b){var c={x:Math.cos(a.angle)*a.originDistance,y:-Math.sin(a.angle)*a.originDistance},d={x:Math.cos(b.angle)*a.originDistance,y:-Math.sin(b.angle)*a.originDistance},e={x:Math.min(c.x,d.x),y:Math.min(c.y,d.y)},f={x:e.x+Math.abs(c.x-d.x)/2,y:e.y+Math.abs(c.y-d.y)/2},g=c.x-d.x,h=c.y-d.y,i=Math.PI/2;0!==g&&(i=Math.atan(h/g));var j=Math.PI/2-i,k=Math.sqrt(Math.pow(f.x-e.x,2)+Math.pow(f.y-e.y,2)),l=Math.sin(Math.acos(k/b.r))*b.r,m=l,n={x:f.x+Math.cos(j)*m,y:f.y-Math.sin(j)*m},o={x:f.x+Math.cos(j+Math.PI)*m,y:f.y-Math.sin(j+Math.PI)*m},p=Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2)),q=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),r=p>q?[n,o,f]:[o,n,f];return r},renderChart:function(){var a=this.chartBounds(),c=this,d=c.dataset();if(void 0!==d){var e=this.options.radius||Math.min(a.size.width,a.size.height)/2;e*=this.options.radiusScale;var f=this.data("D3svg").select(this.region("chart")).selectAll(".venn").data([0]);f.enter().append("g").attr("class","venn").attr("transform","translate("+(a.size.width/2+this.options.xOffset)+","+(a.size.height/2+this.options.yOffset)+")"),e=.5*e,e=this.options.radius||e;var g=this.options.overlap,h=e*(1-g),i=3,j=[{id:0,angle:c.options.startAngle,r:e,originDistance:h},{id:1,angle:c.options.startAngle+2*Math.PI/i,r:e,originDistance:h},{id:2,angle:c.options.startAngle+2*(2*Math.PI/i),r:e,originDistance:h}],k=this.intersectCircles(j[0],j[1]),l=this.intersectCircles(j[1],j[2]),m=this.intersectCircles(j[0],j[2]),n=[{angle:j[0].angle,label:d.c1.label,value:d.c1.value,radius:1.3*h,anchor:"end",fontSize:this.options.circleFontSize},{angle:j[0].angle,value:d.c1.value,radius:1.3*h,anchor:"end",fontSize:this.options.circleFontSize,dy:"1.5em"},{angle:j[1].angle,label:d.c2.label,value:d.c2.value,radius:1.3*h,anchor:"start",fontSize:this.options.circleFontSize},{angle:j[1].angle,value:d.c2.value,radius:1.3*h,anchor:"start",fontSize:this.options.circleFontSize,dy:"1.5em"},{angle:j[2].angle,label:d.c3.label,value:d.c3.value,radius:1.3*h,anchor:"middle",fontSize:this.options.circleFontSize},{angle:j[2].angle,value:d.c3.value,radius:1.3*h,anchor:"middle",fontSize:this.options.circleFontSize,dy:"1.5em"},{angle:2*Math.PI*90/360,value:d.c1c3.value,radius:.7*h,fontSize:this.options.intersectFontSize},{angle:2*Math.PI*210/360,value:d.c1c2.value,radius:.7*h,fontSize:this.options.intersectFontSize},{angle:2*Math.PI*330/360,value:d.c2c3.value,radius:.7*h,fontSize:this.options.intersectFontSize},{angle:0,value:d.c1c2c3.value,radius:0,fontSize:this.options.intersectFontSize}],o=this.initialized?this.options.transitionTime:0,p=function(){this.on("mouseover",function(a){if(b.select(this).attr("fill-opacity",1),c.options.tooltips){var d=c.tooltip(a);d&&c.showToolTip({label:d,event:{pageX:c.options.cornerToolTip?c.$elem.prop("offsetLeft")+5:b.event.pageX,pageY:c.options.cornerToolTip?c.$elem.prop("offsetTop")+20:b.event.pageY}})}}).on("mouseout",function(a){var d=b.event.toElement;d&&"text"!==d.tagName&&(b.select(this).attr("fill-opacity",a.fillOpacity||c.options.fillOpacity),c.options.tooltips&&c.hideToolTip())}).on("click",function(a){if(a.data.action){var b=a.data.action;"string"==typeof b&&(b=Function("d",b)),b(a.data)}})},q=[{d:"M "+m[0].x+" "+m[0].y+" A "+e+" "+e+" 0 1 0 "+k[0].x+" "+k[0].y+" A "+e+" "+e+" 0 0 1 "+l[1].x+" "+l[1].y+" A "+e+" "+e+" 0 0 1 "+m[0].x+" "+m[0].y+" Z",circle:0,fillColor:"#F00",data:d.c1},{d:"M "+m[0].x+" "+m[0].y+" A "+e+" "+e+" 0 1 1 "+l[0].x+" "+l[0].y+" A "+e+" "+e+" 0 0 0 "+k[1].x+" "+k[1].y+" A "+e+" "+e+" 0 0 0 "+m[0].x+" "+m[0].y+" Z",circle:1,fillColor:"#00F",data:d.c2},{d:"M "+l[0].x+" "+l[0].y+" A "+e+" "+e+" 0 1 1 "+k[0].x+" "+k[0].y+" A "+e+" "+e+" 0 0 0 "+m[1].x+" "+m[1].y+" A "+e+" "+e+" 0 0 0 "+l[0].x+" "+l[0].y+" Z",circle:2,fillColor:"#0F0",data:d.c3},{d:"M "+k[1].x+" "+k[1].y+" A "+e+" "+e+" 0 0 0 "+l[1].x+" "+l[1].y+" A "+e+" "+e+" 0 0 0 "+m[1].x+" "+m[1].y+" A "+e+" "+e+" 0 0 0 "+k[1].x+" "+k[1].y+" Z",circle:[0,1,2],data:d.c1c2c3},{d:"M "+k[0].x+" "+k[0].y+" A "+e+" "+e+" 0 0 1 "+l[1].x+" "+l[1].y+" A "+e+" "+e+" 0 0 0 "+m[1].x+" "+m[1].y+" A "+e+" "+e+" 0 0 1 "+k[0].x+" "+k[0].y+" Z",circle:[0,2],data:d.c1c3},{d:"M "+m[0].x+" "+m[0].y+" A "+e+" "+e+" 0 0 0 "+l[1].x+" "+l[1].y+" A "+e+" "+e+" 0 0 1 "+k[1].x+" "+k[1].y+" A "+e+" "+e+" 0 0 0 "+m[0].x+" "+m[0].y+" Z",circle:[0,1],data:d.c1c2},{d:"M "+l[0].x+" "+l[0].y+" A "+e+" "+e+" 0 0 0 "+k[1].x+" "+k[1].y+" A "+e+" "+e+" 0 0 1 "+m[1].x+" "+m[1].y+" A "+e+" "+e+" 0 0 0 "+l[0].x+" "+l[0].y+" Z",circle:[1,2],data:d.c2c3}],q=f.selectAll(".arc").data(q);q.enter().append("path").attr("class","arc"),q.call(p).transition().duration(o).attr("d",function(a){return a.d}).attr("fill",function(a,b){var d=c.options.fillColor(a.circle,a,c);return d}).attr("stroke","none").attr("fill-opacity",function(a){return a.fillOpacity||c.options.fillOpacity}).call(c.endall,function(){c.initialized=!0}),q.exit().remove();var r=f.selectAll(".strokedCircle").data(j);r.enter().append("circle").attr("class","strokedCircle"),r.transition().duration(o).attr("cx",function(a){return a.cx||Math.cos(a.angle)*a.originDistance}).attr("cy",function(a){return a.cy||-Math.sin(a.angle)*a.originDistance}).attr("r",function(a){return a.r}).attr("fill","none").attr("stroke",function(a,b){return a.strokeColor||c.options.strokeColor(b,a)}).attr("stroke-width",function(a){return a.strokeWidth||c.options.strokeWidth}),r.exit().remove();var s=function(a){return void 0===a&&(a=1),this.attr("text-anchor","middle").attr("dy",function(a){return a.dy||"0.5em"}).attr("cursor","default"),this.attrTween&&this.text(function(a){return a.label||a.value}).attrTween("transform",function(a,c){void 0===this._current&&(this._current=a);var d=a;void 0===d.radius&&(d.radius=.7*h);var e=b.interpolate(this._current,d);return this._current=e(0),function(a){var b=e(a),c=[Math.cos(b.angle)*b.radius,-Math.sin(b.angle)*b.radius];return"translate("+c+")"}}).attr("font-size",function(a){return a.fontSize||"12pt"}),this};if(c.options.labels){var t=f.selectAll("text").data(n);t.enter().append("text"),t.transition().duration(o).call(s),t.exit().remove()}}},tooltip:function(a){return void 0!==a.data.tooltip?a.data.tooltip:void 0!==a.data.label?a.data.label:void 0},renderXAxis:function(){},renderYAxis:function(){}})});