define(["jquery","d3","kb_vis_visWidget"],function(a,b){"use strict";a.KBWidget({name:"kbaseHeatmap",parent:"kbaseVisWidget",version:"1.0.0",options:{scaleAxes:!0,xScaleType:"ordinal",yScaleType:"ordinal",yGutter:80,yPadding:20,xPadding:150,xGutter:110,overColor:"#999900",hmBGColor:"lightgray",colors:["#ffff00","#000000","#0000ff"],rx:2,ry:2,cellPadding:1},_accessors:["spectrum"],init:function(a){return this._super(a),this.options.gradientID=this.linearGradient({colors:this.options.colors}),this},setDataset:function(b){void 0===b.data||a.isArray(b.data)||(b=b.data),this._super(b)},setSpectrum:function(a){this.spectrum(b.scale.ordinal().domain(b.range(0,1)).range(a))},defaultXDomain:function(){return void 0===this.dataset()?[0,0]:this.dataset().column_labels},defaultYDomain:function(){return void 0===this.dataset()?[0,0]:this.dataset().row_labels},setXScaleRange:function(a,b){return void 0===b&&(b=this.xScale()),b.rangeBands(a),b},setYScaleRange:function(a,b){return void 0===b&&(b=this.yScale()),b.rangeBands(a),b},renderXAxis:function(){if(void 0!==this.xScale()&&void 0!==this.xScale().domain){var a=b.svg.axis().scale(this.xScale()).orient("top"),c=this.D3svg().select(".yGutter").select(".xAxis");void 0===c[0][0]&&(c=this.D3svg().select(".yGutter").append("g").attr("class","xAxis axis").attr("transform","translate(0,"+this.yGutterBounds().size.height+")"));var d=this;c.transition().duration(0).call(a).selectAll("text").attr("transform",function(a,c){var e=(d.yGutterBounds(),b.select(this).node().getComputedTextLength());return"rotate(-45,0,0) translate("+(e/2+5)+",5)"}),c.selectAll("text").each(function(a,c){var e=b.select(this).text();e.length>15&&b.select(this).text(e.substring(0,12)+"...");var f=d.dataset().column_labels.indexOf(e);b.select(this).attr("data-id",d.dataset().column_ids[f]),b.select(this).on("mouseover",function(a){b.select(this).attr("fill",d.options.overColor);var c=b.select(this);d.options.labelOver?d.options.labelOver.call(this,a):c.text()!==e&&d.showToolTip({label:e})}).on("mouseout",function(a){b.select(this).attr("fill","black"),d.options.labelOut?d.options.labelOut.call(this,a):d.hideToolTip()})})}},renderXLabel:function(){var a=this.yGutterBounds(),b=[this.xLabel()],c=this.D3svg().select(".yPadding").selectAll(".xLabel");c.data(b).text(this.xLabel()).enter().append("text").attr("class","xLabel").attr("x",a.size.width/2).attr("y",a.size.height/2+3).attr("text-anchor","middle").attr("font-size","11px").attr("font-family","sans-serif").attr("fill","black").text(this.xLabel())},renderYLabel:function(){var a=this.xGutterBounds(),c=this.D3svg().select(this.region("xGutter")).selectAll(".yLabel").data([0]);c.enter().append("rect").attr("x",5).attr("y",0).attr("width",a.size.width/3).attr("height",a.size.height).attr("fill","url(#"+this.options.gradientID+")");var d=this.colorScale(),e=[d.domain()[d.domain().length-1],d.domain()[0]],f=b.scale.linear().domain(e).range([0,a.size.height]).nice(),g=b.svg.axis().scale(f).orient("right"),h=this.D3svg().select(this.region("xGutter")).select(".tempAxis");void 0===h[0][0]&&(h=this.D3svg().select(this.region("xGutter")).append("g").attr("class","tempAxis axis").attr("transform","translate("+(a.size.width/3+6)+",0)")),g.tickFormat(b.format(".2f")),h.transition().call(g)},renderYAxis:function(){if(void 0!==this.yScale()){var a=b.svg.axis().scale(this.yScale()).orient("left"),c=this.D3svg().select(this.region("xPadding")).select(".yAxis"),d=this;void 0===c[0][0]&&(c=this.D3svg().select(this.region("xPadding")).append("g").attr("class","yAxis axis").attr("transform","translate("+this.xPaddingBounds().size.width+",0)")),c.transition().call(a),c.selectAll("text").each(function(a,c){var e=b.select(this).text();e.length>23&&b.select(this).text(e.substring(0,18)+"...");var f=d.dataset().row_labels.indexOf(e);b.select(this).attr("data-id",d.dataset().row_ids[f]),b.select(this).on("mouseover",function(a){b.select(this).attr("fill",d.options.overColor);var c=b.select(this);d.options.labelOver?d.options.labelOver.call(this,a):c.text()!==e&&d.showToolTip({label:e})}).on("mouseout",function(a){b.select(this).attr("fill","black"),d.options.labelOut?d.options.labelOut.call(this,a):d.hideToolTip()})})}},colorScale:function(){var a=this.options.colorScale;if(void 0===a){var c=this.options.maxValue,d=this.options.minValue;if(void 0===c||void 0===d){c=0,d=0;for(var e=0;e<this.dataset().data.length;e++)for(var f=this.dataset().data[e],g=0;g<f.length;g++)f[g]>c&&(c=f[g]),f[g]<d&&(d=f[g])}var h=b.range(d,c,(c-d)/this.options.colors.length);h[0]=d,h[h.length-1]=c,a=b.scale.linear().domain(h).range(this.options.colors)}return a},renderChart:function(){var a=this,c=this.chartBounds();if(void 0!==this.dataset()){var d=this.yScale().copy();d.domain(this.dataset().row_ids);var e=this.xScale().copy();e.domain(this.dataset().column_ids);var f=function(){return this.attr("x",function(b){var c=b.x;a.options.useIDMapping&&(c=a.xIDMap()[c]);var d=e(c)+1;return d}).attr("y",function(b){var c=b.y;a.options.useIDMapping&&(c=a.yIDMap()[c]);var e=d(c)+1;return e}).attr("width",a.xScale().rangeBand()-2*a.options.cellPadding).attr("height",a.yScale().rangeBand()-2*a.options.cellPadding).attr("rx",a.options.rx).attr("ry",a.options.ry).attr("fill",function(a){return a.color}),this},g=function(){return this.on("mouseover",function(c){if(a.options.overColor){b.select(this).attr("stroke",a.options.overColor).attr("stroke-width",5),a.D3svg().select(".yGutter").selectAll("g g text").attr("fill",function(d,e){var f=c.x;return a.options.useIDMapping&&(f=a.xIDMap()[f]),b.select(this).attr("data-id")===f?a.options.overColor:void 0}),a.D3svg().select(".xPadding").selectAll("g g text").attr("fill",function(d,e){var f=c.y;return a.options.useIDMapping&&(f=a.yIDMap()[f]),b.select(this).attr("data-id")===f?a.options.overColor:void 0});var d=c.x;a.options.useIDMapping&&(d=a.xIDMap()[d]);var e=c.y;a.options.useIDMapping&&(e=a.yIDMap()[e]),a.showToolTip({label:c.label||"Value for: "+c.row+" - "+c.column+"<br>is "+c.value})}}).on("mouseout",function(c){a.options.overColor&&(b.select(this).attr("stroke",0),a.D3svg().select(".yGutter").selectAll("g g text").attr("fill",function(a,b){return"black"}),a.D3svg().select(".xPadding").selectAll("g g text").attr("fill",function(a,b){return"black"}),a.hideToolTip())}).on("click",function(b){a.options.clickCallback&&a.options.clickCallback(b,a)}),this},h=this.initialized?this.options.transitionTime:0,i=this.D3svg().select(this.region("chart")).selectAll(".hmBG").data([0]);i.enter().append("rect").attr("x",0).attr("y",0).attr("width",c.size.width).attr("height",c.size.height).attr("fill",a.options.hmBGColor).attr("class","hmBG");for(var j=[],k=this.colorScale(),l=0;l<this.dataset().data.length;l++)for(var m=this.dataset().data[l],n=0;n<m.length;n++)j.push({x:this.dataset().column_ids[n],y:this.dataset().row_ids[l],column:this.dataset().column_labels[n],row:this.dataset().row_labels[l],value:m[n],color:k(m[n])});var o=this.D3svg().select(this.region("chart")).selectAll(".davis-cell").data(j);o.enter().append("rect").attr("class","davis-cell"),o.call(g).transition().duration(h).call(f).call(a.endall,function(){a.initialized=!0}),o.data(j).exit().remove()}}})});