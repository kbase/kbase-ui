define(["jquery","promise","kb/common/dom","kb/common/html","kb/service/utils","kb/common/utils","kb/service/client/workspace","datatables_bootstrap"],function(a,b,c,d,e,f,g){"use strict";var h=function(h){function i(b){var c=d.tag("a"),e=d.genId(),g=["Object Name","Module","Type","Version","Icon","Lineage","Narrative","Version","Last Modified"],h=b.map(function(a){var b={module:a.info.typeModule,name:a.info.typeName,version:{major:a.info.typeMajorVersion,minor:a.info.typeMinorVersion}},d=a.info.wsid+"/"+a.info.id+"/"+a.info.version;return[c({href:"#dataview/"+d},a.info.name),b.module,c({href:"#spec/type/"+s.service("type").makeTypeId(b)},b.name),s.service("type").makeVersion(b),s.service("type").getIcon({type:b,size:"medium"}).html,c({href:"#taxontest/lineage/"+d},"Lineage"),c({href:"/narrative/"+a.narrative.workspaceId+"/"+a.info.id},a.narrative.name),a.info.version,f.niceElapsedTime(a.info.save_date)]});return{content:d.makeTable({columns:g,rows:h,classes:["table","table-striped"],id:e}),afterAttach:function(){a("#"+e).dataTable()}}}function j(a){return b.resolve(t.list_workspace_info({showDeleted:0,excludeGlobal:0})).then(function(c){var d,f,g=[],h={};for(d=0;d<c.length;d+=1)f=e.workspace_metadata_to_object(c[d]),g.push(f.id),h[f.id]=f;var i={ids:g,includeMetadata:1};return a.type&&(i.type=a.type),[h,b.resolve(t.list_objects(i))]}).spread(function(a,b){return r=b.map(function(b){var c=e.object_info_to_object(b);return{info:c,narrative:{workspaceId:c.wsid,name:a[c.wsid].metadata.narrative_nice_name||"not a narrative"}}})})}function k(a){return b["try"](function(){p=a,q=c.createElement("div"),c.append(p,q),c.setHTML(q,d.loading())})}function l(a){return b["try"](function(){})}function m(a){return b["try"](function(){var b=d.tag("div");return c.setHTML(q,"Loading data ... "+d.loading()),j(a).then(function(a){var b=i(a);c.setHTML(q,b.content),b.afterAttach&&b.afterAttach()})["catch"](function(a){c.setHTML(q,d.makePanel({title:"Error",content:b([a.message])}))})})}function n(){return b["try"](function(){})}function o(){return b["try"](function(){p.removeChild(q)})}var p,q,r,s=h.runtime,t=new g(s.getConfig("services.workspace.url"),{token:s.getService("session").getAuthToken()});return{attach:k,start:l,run:m,stop:n,detach:o}};return{make:function(a){return h(a)}}});