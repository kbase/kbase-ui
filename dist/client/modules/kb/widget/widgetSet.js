define(["kb/common/html","kb/common/dom","bluebird"],function(a,b,c){"use strict";function d(d){function e(a,b){var c,d,e,f=a[0].length;for(c=0;f>c;c+=1){for(e=[],d=0;d<a.length;d+=1)e.push(a[d][c]);b(e)}}function f(b,c){c=c||{};var d=r.getService("widget").getWidget(b),e=r.getService("widget").makeWidget(b,c),f=a.genId(),g={id:f,name:d.name||d.id,title:d.title,widgetMaker:e};return p.push(g),f}function g(a,b){a.map(function(a){return f(a,b)})}function h(){return c.all(p.map(function(a){return a.widgetMaker})).then(function(a){e([p,a],function(a){var b=a[1];a[0].widget=b})})}function i(a){return h().then(function(){return c.all(p.map(function(b){return b.widget.init?b.widget.init(a):void 0}))})}function j(){return c.all(p.map(function(a){if(a.node||(a.node=b.findById(a.id)),!a.node)throw{type:"WidgetError",reason:"MissingAttachmentNode",message:"The widget "+a.title+" does not have a valid node at "+a.id};return a.widget.attach(a.node)}))}function k(a){return c.all(p.map(function(b){return b.widget&&b.widget.start?b.widget.start(a):void 0}))}function l(a){return c.all(p.map(function(b){return b.widget&&b.widget.run?b.widget.run(a):void 0}).filter(function(a){return a?!0:!1}))}function m(){return c.all(p.map(function(a){return a.widget&&a.widget.stop?a.widget.stop():void 0}))}function n(){return c.all(p.map(function(a){return a.widget&&a.widget.detach?a.widget.detach():void 0}).filter(function(a){return a?!0:!1}))}function o(){return c.all(p.map(function(a){return a.widget&&a.widget.destroy?a.widget.destroy():void 0}))}var p=[],q=d||{},r=q.runtime;if(!r)throw{type:"ArgumentError",reason:"RuntimeMissing",name:"RuntimeMissing",message:"The rumtime argument was not provided",suggestion:"This is a programmer error, not your fault."};return{addWidget:f,addWidgets:g,makeWidgets:h,init:i,attach:j,start:k,run:l,stop:m,detach:n,destroy:o}}return{make:function(a){return d(a)}}});