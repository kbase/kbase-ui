define(["bluebird","underscore","kb/common/dom","kb/common/state","kb/common/html","kb/common/domEvent"],function(a,b,c,d,e,f){"use strict";function g(g){function h(a,b){Q.hasOwnProperty(a)||(Q[a]=[]),Q[a].push(b)}function i(a,c){b.isArray(a)?a.forEach(function(a){h(a[0],a[1])}):h(a,c)}function j(a){return Q.hasOwnProperty(a)?!0:!1}function k(a){return j(a)?Q[a]:[]}function l(a,b){return T.getConfig(a,b)}function m(a){return T.hasConfig(a)}function n(a,b){S.set(a,b)}function o(a,b){return S.get(a,b)}function p(a){return S.has(a)}function q(a,b){W.set(a,b)}function r(a,b){return W.get(a,b||X[a])}function s(a){return W.has(a)}function t(){return P}function u(a,b,c){R.push(T.recv(a,b,c))}function v(a,b,c){T.send(a,b,c)}function w(a,b,c,d){return V.addEvent(a,b,c,d)}function x(a,b,c,d){return V.attachEvent(a,b,c,d)}function y(){V.attachEvents()}function z(){V.detachEvents()}function A(){return a["try"](function(){if(S.isDirty()){S.setClean(),z();var b=k("render");if(b.length>1)throw{type:"HookError",reason:"TooManyHooks",message:"The render hook only supports 0 or 1 hooks"};if(0!==b.length)return a["try"](function(){return b[0].call(U)}).then(function(a){if(a)if("object"==typeof a){if(a.content&&E("body",a.content),a.after)try{a.after.call(U)}catch(b){console.log('Error running "after" method for render'),console.log(b),E("error",'Error running "after" method for render')}}else E("body",a)}).then(function(){y()})}})}function B(b){return a["try"](function(){if(j("fetch")){var c=k("fetch").map(function(c){return a["try"](function(){return c.call(U,b)})});return a.all(c).then(function(a){a.forEach(function(a){a&&n(a.name,a.value)})})}})}function C(){var a=e.tag("div"),b=e.tag("span"),c=e.genId(),d=a({id:c,"class":"panel panel-default"},[a({"class":"panel-heading"},[b({"class":"panel-title",dataElement:"title"})]),a({"class":"panel-body"},[a({dataElement:"body"}),a({dataElement:"error"})])]);return{id:c,content:d}}function D(){return Z||(Z=C()),Z}function E(a,b){var c=P.querySelector('[data-element="'+a+'"]');c&&(c.innerHTML=b)}function F(a){var b=P.querySelector('[data-element="title"]');b&&(b.innerHTML=a)}function G(a){return Y[a]}function H(b){return a["try"](function(){if(j("init")){var c=k("init").map(function(c){return a["try"](function(){return c.call(U,b)})});return a.all(c)}})}function I(b){return a["try"](function(){if(O=b,P=c.append(O,c.createElement("div")),P.innerHTML=D().content,j("attach")){var d=k("attach").map(function(b){return a["try"](function(){return b.call(U,P)})});return a.all(d).then(function(){y()})}if(j("layout")){var e=k("layout")[0];return a["try"](function(){return e.call(U)}).then(function(a){E("body",a.content),Object.keys(a.places).forEach(function(b){var c=a.places[b];c.id&&(c.node=document.getElementById(c.id)),Y[b]=c})})}})}function J(b){return a["try"](function(){return g.title&&F(g.title),R.push(T.recv("app","heartbeat",function(){A().then(function(){})["catch"](function(a){console.log("ERROR"),console.log(a)})})),a["try"](function(){var c=[];return j("initialContent")&&k("initialContent").forEach(function(d){c.push(a["try"](function(){return d.call(U,b)}).then(function(a){E("body",a)}))}),j("start")&&k("start").forEach(function(d){c.push(a["try"](function(){return d.call(U,b)}))}),c}).each(function(a,b,c){})})}function K(b){return a["try"](function(){return n("params",b),B(b)})}function L(){return a["try"](function(){if(j("stop")){var b=k("stop").map(function(b){return a["try"](function(){b.call(U)})});return a.all(b)}})}function M(){return a["try"](function(){if(O&&O.removeChild(P),P=null,O=null,j("detach")){var b=k("detach").map(function(b){return a["try"](function(){return b.call(U)})});return a.all(b).then(function(){z()})}})}function N(){return a["try"](function(){if(j("destroy")){var b=k("destroy").map(function(b){return a["try"](function(){return b.call(U)})});return a.all(b)}})}var O,P,Q=[],R=[],S=d.make(),T=g.runtime,U={},V=f.make(),W=d.make(),X=g.defaults,Y={};if(!T)throw{type:"ArgumentError",reason:"RuntimeMissing",blame:"dataWidget",message:"The runtime argument was not provided"};g&&g.on&&Object.keys(g.on).forEach(function(a){h(a,g.on[a])}),g&&g.events&&g.events.forEach(function(a){x(a)}),U=Object.freeze({recv:u,send:v,getConfig:l,hasConfig:m,getState:o,setState:n,hasState:p,getParam:r,setParam:q,hasParam:s,getPlace:G,getDomNode:t,get:o,set:n,addDomEvent:w,attachDomEvent:x,setTitle:F,runtime:T});var Z;return Object.freeze({on:i,init:H,attach:I,start:J,run:K,stop:L,detach:M,destroy:N})}return Object.freeze({make:function(a){return g(a)}})});