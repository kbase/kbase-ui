define(["bluebird","underscore","kb/common/dom","kb/common/state","kb/common/html","kb/common/domEvent"],function(a,b,c,d,e,f){"use strict";function g(g){function h(a,b){J.hasOwnProperty(a)||(J[a]=[]),J[a].push(b)}function i(a,c){b.isArray(a)?a.forEach(function(a){h(a[0],a[1])}):h(a,c)}function j(a){return J.hasOwnProperty(a)?!0:!1}function k(a){return j(a)?J[a]:[]}function l(a,b){return M.getConfig(a,b)}function m(a){return M.hasConfig(a)}function n(a,b){L.set(a,b)}function o(a,b){return L.get(a,b)}function p(a){return L.has(a)}function q(a,b,c){K.push(M.recv(a,b,c))}function r(a,b,c){M.send(a,b,c)}function s(a,b,c,d){return O.addEvent(a,b,c,d)}function t(a,b,c,d){return O.attachEvent(a,b,c,d)}function u(){O.attachEvents()}function v(){O.detachEvents()}function w(){return a["try"](function(){if(L.isDirty()){L.setClean(),v();var b=k("render");if(b.length>1)throw{type:"HookError",reason:"TooManyHooks",message:"The render hook only supports 0 or 1 hooks"};if(0!==b.length)return a["try"](function(){return b[0].call(N)}).then(function(a){if(a)if("object"==typeof a){if(a.content&&z("body",a.content),a.after)try{a.after.call(N)}catch(b){console.log('Error running "after" method for render'),console.log(b),z("error",'Error running "after" method for render')}}else z("body",a)}).then(function(){u()})}})}function x(b){return a["try"](function(){if(j("fetch")){var c=k("fetch").map(function(c){return a["try"](function(){return c.call(N,b)})});return a.all(c).then(function(a){a.forEach(function(a){a&&n(a.name,a.value)})})}})}function y(){var a=e.tag("div"),b=e.genId(),c=a({id:b},[a({dataElement:"body"})]);return{id:b,content:c}}function z(a,b){var c=I.querySelector('[data-element="'+a+'"]');c&&(c.innerHTML=b)}function A(b){return a["try"](function(){if(j("init")){var c=k("init").map(function(c){return a["try"](function(){return c.call(N,b)})});return a.all(c)}})}function B(b){return a["try"](function(){if(H=b,I=c.append(H,c.createElement("div")),I.innerHTML=P.content,j("attach")){var d=k("attach").map(function(b){return a["try"](function(){return b.call(N,I)})});return a.all(d).then(function(){u()})}})}function C(b){return a["try"](function(){return K.push(M.recv("app","heartbeat",function(){w()["catch"](function(a){console.log("ERROR"),console.log(a)})})),a["try"](function(){var c=[];return j("initialContent")&&k("initialContent").forEach(function(d){c.push(a["try"](function(){return d.call(N,b)}).then(function(a){z("body",a)}))}),j("start")&&k("start").forEach(function(d){c.push(a["try"](function(){return d.call(N,b)}))}),c}).each(function(a,b,c){})})}function D(b){return a["try"](function(){return n("params",b),x(b)})}function E(){return a["try"](function(){if(j("stop")){var b=k("stop").map(function(b){return a["try"](function(){b.call(N)})});return a.all(b)}})}function F(){return a["try"](function(){if(H.innerHTML="",I=null,H=null,j("detach")){var b=k("detach").map(function(b){return a["try"](function(){return b.call(N)})});return a.all(b).then(function(){v()})}})}function G(){return a["try"](function(){if(j("destroy")){var b=k("destroy").map(function(b){return a["try"](function(){return b.call(N)})});return a.all(b)}})}var H,I,J=[],K=[],L=d.make(),M=g.runtime,N={},O=f.make();if(!M)throw{type:"ArgumentError",reason:"RuntimeMissing",blame:"dataWidget",message:"The runtime argument was not provided"};g&&g.on&&Object.keys(g.on).forEach(function(a){h(a,g.on[a])}),g&&g.events&&g.events.forEach(function(a){t(a)}),N=Object.freeze({recv:q,send:r,getConfig:l,hasConfig:m,getState:o,setState:n,hasState:p,get:o,set:n,addDomEvent:s,attachDomEvent:t,runtime:M});var P=y();return Object.freeze({on:i,init:A,attach:B,start:C,run:D,stop:E,detach:F,destroy:G})}return Object.freeze({make:function(a){return g(a)}})});