define(["jquery","handlebars","d3"],function(a,b,c){function d(a,b){function c(){}c.prototype=b.prototype;var d=new c;d.constructor=a,a.prototype=d}a(document).on("libsLoaded.kbase",function(){a("[data-kbwidget]").each(function(b,c){var d=a(c),e=d.attr("data-kbwidget"),f=d.text();d.empty(),f=void 0!==f?JSON.parse(f):{},d[e](f)})});var e,f=function(a){return void 0!==a&&a.length?a.charAt(0).toUpperCase()+a.slice(1):void 0},g=function(a){return"willChangeValueFor"+f(a)},h=function(a){return"didChangeValueFor"+f(a)},i=function(b){var c=a(b).prop("tagName").toLowerCase();return c.match(/^(input|select|textarea)$/)?"checkbox"===a(b).attr("type")?{setter:"checked",getter:"checked"}:{setter:"val",getter:"val"}:{setter:"html",getter:"html"}},j=function(b,c,d,e,f){return a.proxy(function(c,d){c.preventDefault(),c.stopPropagation();var g=d.newValue;void 0!==e.transformedValue&&(g=e.transformedValue(g)),"checked"===f.setter?a(b).attr(f.setter,g):a(b)[f.setter](g)},a(b))},k=function(b,c,d,e,f){return a.proxy(function(g,h){if("keypress"!==g.type||13===g.which){g.preventDefault(),g.stopPropagation();var i;if(i="checked"===f.getter?this.is(":checked")?!0:!1:this[f.getter](),i!==this.data("kbase_bindingValue")){if(void 0!==e.validator){var j=e.validator(i);if(!j.success)return a(b).data("validationError.kbaseBinding",j.msg),this.popover({placement:"right",title:"Validation error",content:a.proxy(function(){return this.data("validationError.kbaseBinding")},a(b)),trigger:"manual",html:!0}),void this.popover("show");a(b).popover("hide"),j.newVal&&(i=j.newVal)}void 0!==e.reverseTransformedValue&&(i=e.reverseTransformedValue(i));var k=c.__attributes[d].setter;c[k](i),this.data("kbase_bindingValue",this[f.getter]())}}},a(b))},l=function(b,c,d){return a.proxy(function(a){a.preventDefault(),a.stopPropagation(),this.data("kbase_bindingValue",this[d.getter]())},a(b))};a.fn.asD3=function(){return void 0===this.data("d3rep")&&this.data("d3rep",c.select(this.get(0))),this.data("d3rep")},a.fn.kb_bind=function(b,c,d,e){if(this.length>1){var f=arguments;return a.each(this,function(b,c){a.fn.kb_bind.apply(a(c),f)}),this}void 0===e&&(e=i(this)),void 0===d&&(d={});var g=h(c);b.on(g,j(this,b,c,d,e)),a(this).on("blur.kbaseBinding",k(this,b,c,d,e)),a(this).on("focus.kbaseBinding",l(this,d,e));var m=a(this).prop("tagName").toLowerCase();m.match(/^(input)$/)&&(a(this).on("keypress.kbaseBinding",k(this,b,c,d,e)),"checkbox"===a(this).attr("type")&&a(this).on("change.kbaseBinding",k(this,b,c,d,e)));var n=b.__attributes[c].getter,o=b[n]();return void 0!==d.transformedValue&&(o=d.transformedValue(o)),"checked"===e.setter?a(this).attr(e.setter,o):a(this)[e.setter](o),this},a.fn.kb_unbind=function(b,c,d,e,f){if(this.length>1){var g=arguments;return a.each(this,function(b,c){a.fn.kb_unbind.apply(a(c),g)}),this}void 0===f&&(f=i(this)),void 0===e&&(e={});var l=h(c);b.off(l,j(this,b,c,e,f)),a(this).off("blur.kbaseBinding",k(this,b,c,e,f)),a(this).off("focus.kbaseBinding",k(this,e,f));var m=a(this).prop("tagName").toLowerCase();return m.match(/^(input)$/)&&(a(this).off("keypress.kbaseBinding",makeBindingEnterCallback(this,b,c,e,f)),"checkbox"===a(this).attr("type")&&a(this).off("change.kbaseBinding",k(this,b,c,e,f))),this};var m={};void 0===e&&(e=window.KBase),void 0===window.KBase&&(e=window.KBase={_functions:{getter:function(a){return function(){return this.valueForKey(a)}},setter:function(a){return function(b){return this.setValueForKey(a,b)}},getter_setter:function(a){return function(b){return 1===arguments.length?this.setValueForKey(a,b):this.valueForKey(a)}}}}),a.jqElem=function(b){var c="<"+b+">";return c.match(/^(area|base|br|col|command|embed|hr|img|input|keygen|link|meta|param|source|track)/)||(c+="</"+b+">"),a(c)},a.KBWidget=function(b){b=b||{};var c=b.name,f=b.parent;void 0===f&&(f="kbaseWidget");var g=b.asPlugin;void 0===g&&(g=!0);var h=function(c){return this.$elem=c,this.options=a.extend(!0,{},b.options,this.constructor.prototype.options),this};if(c){var i=c;i=i.replace(/^kbase/,""),i=i.charAt(0).toLowerCase()+i.slice(1),e[i]=function(b,c){var d=new h;return void 0===c&&(c=a.jqElem("div")),d.$elem=c,void 0===b&&(b={}),b.headless=!0,d.init(b),d._init=!0,d.trigger("initialized"),d},m[c]=h,void 0===b&&(b=f,f="kbaseWidget",void 0===b&&(b={}))}if(f){var j=m[f];if(void 0===j)throw new Error("Parent widget is not registered. Cannot find "+f+" for "+c);d(h,j)}var k=a.extend(!0,{},b);h.prototype.__attributes={},void 0!==k._accessors&&(a.each(k._accessors,a.proxy(function(a,b){var c={name:b,setter:b,getter:b,type:"rw"};if("object"==typeof b){c.setter=b.name,c.getter=b.name;for(var d in b)c[d]=b[d]}h.prototype.__attributes[c.name]=c,c.setter===c.getter&&c.type.match(/rw/)?h.prototype[c.getter]=e._functions.getter_setter(c.name):(c.type.match(/w/)&&void 0!==c.setter&&(h.prototype[c.setter]=e._functions.setter(c.name)),c.type.match(/r/)&&void 0!==c.getter&&(h.prototype[c.getter]=e._functions.getter(c.name)))},this)),k._accessors=void 0);var l=a.extend(!0,{},h.prototype.__attributes,m[f].prototype.__attributes);h.prototype.__attributes=l;for(var n in k)a.isFunction(k[n])?h.prototype[n]=function(a,b){var c=function(){throw"No parent method defined! Play by the rules!"},d=function(){throw"No parent method defined! Play by the rules!"};if(f)var c=function(){return m[f].prototype[a].apply(this,arguments)},d=function(a){return m[f].prototype[a].apply(this,Array.prototype.slice.call(arguments,1))};return function(){var a=this._super,e=this._superMethod;this._super=c,this._superMethod=d;var f=b.apply(this,arguments);return this._super=a,this._superMethod=e,f}}(n,k[n]):h.prototype[n]=k[n];if(f&&(h.prototype.options=a.extend(!0,{},m[f].prototype.options,h.prototype.options)),g){var o=function(b,d){if(this.length>1){var e=arguments;return a.each(this,function(b,d){a.fn[c].apply(a(d),e)}),this}if(void 0===this.data(c)&&this.data(c,new h(this)),h.prototype[b])return h.prototype[b].apply(this.data(c),Array.prototype.slice.call(arguments,1));if("object"==typeof b||!b){var f=(arguments,this.data(c));return void 0===f._init&&(f=h.prototype.init.apply(f,arguments)),f._init=!0,f.trigger("initialized"),f}return a.error("Method "+b+" does not exist on "+c),this};a.fn[c]=o,a[c]=a.fn[c]}return this.on=function(a,b){return this.$elem.bind(a,b),this},this.emit=function(a,b){return this.$elem.trigger(a,b),this},this.off=function(a){return this.$elem.unbind(a),this},void 0!==c?(h.prototype[c]=function(){return a.fn[c].apply(this.$elem,arguments)},a.fn[c]):this},a.KBWidget.registry=function(){var a={};for(var b in m)"kbaseWidget"!==b&&(a[b]=m[b]);return a},a.KBWidget.resetRegistry=function(){for(var a in m)"kbaseWidget"!==a&&delete m[a];return this},a.KBWidget({name:"kbaseWidget",dbg:function(a){window.console&&console.log(a)},callAfterInit:function(a){var b=this,c=function(){var c=arguments.callee;b._init?a():setTimeout(c,10)};return c(),c},init:function(b){this._attributes={},this.runtime=b.runtime;var c=a.extend(!0,{},this.options);this.options=a.extend(!0,{},c,b);var d;for(d in b)void 0===b[d]&&void 0!==this.options[d]&&delete this.options[d];var e;for(e in this.__attributes)if(void 0!==this.options[e]){var f=this.__attributes[e].setter;this[f](this.options[e])}return this.options.template&&this.callAfterInit(a.proxy(function(){this.appendUI(this.$elem)},this)),this},appendUI:function(b){return this.options.template&&a.ajax(this.options.template).done(a.proxy(function(a){this.templateSuccess.apply(this,arguments)},this)).fail(a.proxy(function(a){this.templateFailure.apply(this,arguments)},this)),b},templateSuccess:function(c){var d=b.compile(c),e=(d(),d(this.templateContent())),f=a.jqElem("span").append(e);this._rewireIds(f,this),this.$elem.append(f)},templateFailure:function(a){this.dbg("Template load failure"),this.dbg(a)},templateContent:function(){return this.options.templateContent||{}},alert:function(a){return void 0===a&&(a=this.data("msg")),this.data("msg",a),this},valueForKey:function(a){return this._attributes[a]},setValueForKey:function(a,b){var c=void 0,d=this.valueForKey(a);if(b!==d){var e=g(a);if(c={oldValue:d,newValue:b},this.trigger(e,c),this._attributes[a]=c.newValue,c.newValue!==d){var f=h(a);this.trigger(f,c)}}return this.valueForKey(a)},setValuesForKeys:function(b){var c=a.extend({},b);for(var d in this.__attributes)if(void 0!==c[d]){var e=this.__attributes[d].setter;this[e](c[d]),delete c[d]}this.options=a.extend(this.options,c)},data:function(a,b){return void 0===this.options._storage&&(this.options._storage={}),2===arguments.length&&(this.options._storage[a]=b),void 0!==a?this.options._storage[a]:this.options._storage},_rewireIds:function(b,c){return void 0===c&&(c=b),b.attr("id")&&(c.data(b.attr("id"),b),b.removeAttr("id")),a.each(b.find("[id]"),function(b){c.data(a(this).attr("id"),a(this)),a(this).attr("data-id",a(this).attr("id")),a(this).removeAttr("id")}),b},sortCaseInsensitively:function(a,b){return a.toLowerCase()<b.toLowerCase()?-1:a.toLowerCase()>b.toLowerCase()?1:0},sortByKey:function(a,b){return b?function(b,c){return b[a].toLowerCase()<c[a].toLowerCase()?-1:b[a].toLowerCase()>c[a].toLowerCase()?1:0}:function(b,c){return b[a]<c[a]?-1:b[a]>c[a]?1:0}},trigger:function(){this.$elem.trigger.apply(this.$elem,arguments)},on:function(){this.$elem.on.apply(this.$elem,arguments)},off:function(){this.$elem.off.apply(this.$elem,arguments)},makeObserverCallback:function(b,c,d){return a.proxy(function(a,c){a.preventDefault(),a.stopPropagation(),d.call(this,a,b,c)},this)},observe:function(a,b,c){a.on(b,a,this.makeObserverCallback(a,b,c))},unobserve:function(a,b,c){a.off(b,a,this.makeObserverCallback(a,b,c))},kb_bind:function(a,b,c){var d=h(b);this.observe(a,d,c)},kb_unbind:function(a,b,c){var d=h(b);this.unobserve(a,d,c)},uuid:function(){for(var a="",b=0;32>b;b++)a+=Math.floor(16*Math.random()).toString(16).toUpperCase();return"uuid-"+a}})});