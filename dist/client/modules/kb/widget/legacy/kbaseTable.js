define(["jquery","kb/widget/legacy/widget","kb/widget/legacy/deletePrompt","kb/widget/legacy/buttonControls","kb/widget/legacy/searchControls"],function(a){a.KBWidget({name:"kbaseTable",version:"1.0.0",_accessors:["numRows","sortButtons","visRowString"],options:{sortable:!1,striped:!0,hover:!0,bordered:!0,headerOptions:{},resizable:!1,header_callback:function(a){return void 0!=a.label?a.label:a.value.replace(/(?:^|\s+)([a-z])/g,function(a){return a.toUpperCase()})},row_callback:function(a,b,c,d){},sortButtons:{},navControls:!1},default_row_callback:function(a){return void 0==a?a:void 0!=a.label?a.label:(value="object"!=typeof a?a:a.value,"th"==a.type&&(value=value.replace(/(?:^|\s+)([a-z])/g,function(a){return a.toUpperCase()}),value+=" : "),"object"==typeof a&&void 0!=a.setup&&a.setup(value,a),value)},init:function(b){return this._super(b),this.appendUI(a(this.$elem),this.options.structure),this},appendUI:function(b,c){b.empty();var d=a("<table></table>").attr("id","table").css("margin","0px").addClass("table");if(this.options.tblOptions&&this.addOptions(d,this.options.tblOptions),this.options.striped&&d.addClass("table-striped"),this.options.hover&&d.addClass("table-hover"),this.options.bordered&&d.addClass("table-bordered"),this.options.caption&&d.append(a("<caption></caption>").append(this.options.caption)),c.header){var e=a("<thead></thead>").attr("id","thead");e.append(this.navControls(c.header.length));var f=a("<tr></tr>").attr("id","headerRow");a.each(c.header,a.proxy(function(b,d){"string"==typeof d&&(d={value:d},c.header[b]=d);var e=d.callback||this.options.header_callback,g=e(d,this),h=d.value,i=a.jqElem("th").append(g);if(this.options.resizable&&i.resizable({handles:"e"}),this.addOptions(i,a.extend(!0,{},this.options.headerOptions,d)),d.sortable||void 0==d.sortable&&this.options.sortable){var j=d.value+"-sortButton",k=a("<i></i>").addClass("fa fa-sort"),l=a("<button></button>").addClass("btn btn-default btn-xs").attr("id",j).css("display","none").css("float","right").append(k).data("shouldHide",!0);l.bind("click",a.proxy(function(a){var b=this.data("lastSort");void 0!=b&&b.get(0)!=l.get(0)&&(b.children(":first").removeClass("fa fa-sort-up"),b.children(":first").removeClass("fa fa-sort-down"),b.children(":first").addClass("fa fa-sort"),b.data("shouldHide",!0),b.css("display","none")),this.data("lastSortHeader",h),k.hasClass("fa fa-sort")?(k.removeClass("fa fa-sort"),k.addClass("fa fa-sort-up"),l.data("shouldHide",!1),this.sortAndLayoutOn(h,1),this.data("lastSortDir",1),this.data("lastSort",l)):k.hasClass("fa fa-sort-up")?(k.removeClass("fa fa-sort-up"),k.addClass("fa fa-sort-down"),l.data("shouldHide",!1),this.sortAndLayoutOn(h,-1),this.data("lastSortDir",-1),this.data("lastSort",l)):k.hasClass("fa fa-sort-down")&&(k.removeClass("fa fa-sort-down"),k.addClass("fa fa-sort"),l.data("shouldHide",!0),this.sortAndLayoutOn(void 0),this.data("lastSortHeader",void 0),this.data("lastSortDir",void 0),this.data("lastSort",void 0))},this)),this.sortButtons()[d.value]=l,i.append(l),i.bind("mouseover",a.proxy(function(a){l.css("display","inline")},this)),i.bind("mouseout",a.proxy(function(a){l.data("shouldHide")&&l.css("display","none")},this))}f.append(i)},this)),e.append(f),d.append(e)}if(c.rows){var g=this.data("tbody",a("<tbody></tbody>"));this.layoutRows(c.rows,c.header),d.append(g)}if(c.footer){var h=a("<tfoot></tfoot>").attr("id","tfoot"),i=a.jqElem("tr");h.append(i);for(var j=0;j<c.footer.length;j++){var k,l,m=c.footer[j],n=m;"object"==typeof m&&(n=m.value,k=m.style,l=m.colspan);var o=a.jqElem("td").append(n);k&&o.attr("style",k),l&&o.attr("colspan",l),i.append(o)}d.append(h)}return this._rewireIds(d,this),b.append(d),b},navControls:function(b){var c=this,d=a.jqElem("tr").css("display",this.options.navControls?void 0:"none").append(a.jqElem("td").attr("colspan",b).css("background-color","lightgray").append(a.jqElem("div").addClass("pull-left").addClass("input-group input-group-sm").append(a.jqElem("span").addClass("input-group-btn").append(a.jqElem("button").addClass("btn btn-default").attr("id","pageLeftButton").append(a.jqElem("i").attr("id","leftIcon").addClass("fa fa-caret-left")).on("click",function(b){var d=c.options.maxVisibleRowIndex||c.numRows(),e=c.options.minVisibleRowIndex||0,f=d-e,g=e-f;0>=g&&(a(this).attr("disabled",!0),g=0);var h=g+f;c.options.minVisibleRowIndex=g,c.options.maxVisibleRowIndex=h,c.displayRows()}))).append(a.jqElem("span").attr("id","visRecords").addClass("input-group-addon").kb_bind(this,"visRowString")).append(a.jqElem("span").addClass("input-group-btn").append(a.jqElem("button").addClass("btn btn-default").attr("id","pageRightButton").append(a.jqElem("i").attr("id","rightIcon").addClass("fa fa-caret-right")).on("click",function(b){var d=c.options.maxVisibleRowIndex||c.numRows(),e=c.options.minVisibleRowIndex||0,f=d-e,g=d+f;g>=c.numRows()&&(g=c.numRows(),a(this).attr("disabled",!0));var h=g-f;c.options.minVisibleRowIndex=h,c.options.maxVisibleRowIndex=g,c.displayRows()})))).append(a.jqElem("div").addClass("pull-left").addClass("input-group input-group-sm").append(a.jqElem("span").addClass("input-group-btn").append(a.jqElem("button").addClass("btn btn-default").attr("id","removeButton").append(a.jqElem("i").attr("id","removeIcon").addClass("fa fa-minus")).on("click",function(a){var b=c.options.maxVisibleRowIndex||0;b--,1>b&&(b=1),c.options.maxVisibleRowIndex=b,c.displayRows()}))).append(a.jqElem("span").addClass("input-group-btn").append(a.jqElem("button").addClass("btn btn-default").attr("id","addButton").append(a.jqElem("i").attr("id","addIcon").addClass("fa fa-plus")).on("click",function(a){var b=c.options.maxVisibleRowIndex||0;if(b++,b>c.numRows()){var d=b-c.numRows();b=c.options.structure.rows.length,c.options.minVisibleRowIndex-=d,c.options.minVisibleRowIndex<0&&(c.options.minVisibleRowIndex=0)}c.options.maxVisibleRowIndex=b,c.displayRows()})))).append(a.jqElem("div").addClass("pull-right").attr("id","searchDiv")));return this._rewireIds(d,this),this.data("searchDiv").kbaseSearchControls({onMouseover:!1,type:"inline",context:this,searchCallback:function(a,b,c){c.refilter(b)}}),d},sort:function(a,b){var c=this.sortButtons()[a];if(-1==b||1==b&&void 0!=c){var d=this.data("lastSortHeader"),e=this.data("lastSortDir");if(a==d&&b==e)return;a==d?1==b&&-1==d?(c.trigger("click"),c.trigger("click")):-1==b&&1==d&&c.trigger("click"):(c.trigger("click"),-1==b&&c.trigger("click")),c.css("display","inline")}},refilter:function(a){this.options.filter=a,this.sortAndLayoutOn(this.data("lastSortHeader"),this.data("lastSortDir"))},sortAndLayoutOn:function(a,b){var c=this.options.structure.rows;void 0!=a&&(c=this.options.structure.rows.slice().sort(function(c,d){var e=c[a],f=d[a];return e=void 0!=e&&void 0!=e.sortValue?e.sortValue:"string"==typeof e?e.toLowerCase():e,f=void 0!=f&&void 0!=f.sortValue?f.sortValue:"string"==typeof f?f.toLowerCase():f,f>e?0-b:e>f?b:0})),this.layoutRows(c,this.options.structure.header)},layoutRows:function(b,c){this.data("tbody").empty();var d=0;if(a.isArray(b))for(var e=0;e<b.length;e++){var f=this.createRow(b[e],c);void 0!=f&&f.children().length&&(d++,this.data("tbody").append(f))}else if(void 0!=this.options.structure.keys)for(var e=0;e<this.options.structure.keys.length;e++){var g=this.options.structure.keys[e];"object"!=typeof g&&(g={value:g}),g.type="th",g.style="white-space : nowrap";var f=this.createRow({key:g,value:{value:b[g.value],key:g.value}},[{value:"key"},{value:"value"}]);void 0!=f&&f.children().length&&(d++,this.data("tbody").append(f))}this.numRows(d),this.displayRows()},displayRows:function(){this.data("tbody").find("tr").css("display","");var a=this.options.maxVisibleRowIndex||this.numRows();a>this.numRows()&&(a=this.numRows());var b=this.options.minVisibleRowIndex||0;this.data("tbody").find("tr:lt("+b+")").css("display","none"),this.data("tbody").find("tr:gt("+(a-1)+")").css("display","none"),this.visRowString("Rows "+(b+1)+" to "+a+" of "+this.numRows()),this.options.navControls&&(this.data("pageLeftButton").attr("disabled",0==b),this.data("pageRightButton").attr("disabled",a==this.numRows()),this.data("removeButton").attr("disabled",a-b==1),this.data("addButton").attr("disabled",a==this.numRows()))},addOptions:function(b,c){if("string"!=typeof c&&void 0!=c){if(void 0!=c.style&&b.attr("style",c.style),void 0!=c["class"]){var d="string"==typeof c["class"]?[c["class"]]:c["class"];a.each(d,a.proxy(function(a,c){b.addClass(c)},this))}var e=["mouseover","mouseout","click"];a.each(e,a.proxy(function(a,d){void 0!=c[d]&&b.bind(d,c[d])},this)),c.colspan&&b.attr("colspan",c.colspan),c.rowspan&&b.attr("rowspan",c.rowspan)}},createRow:function(b,c){var d=a.jqElem("tr").css("background-color","white"),e=this.options.row_callback,f="";if(a.isArray(b)?a.each(b,a.proxy(function(b,c){var e="object"==typeof c?c.value:c;if(void 0!=e){f+=e instanceof jQuery?e.text():e;var g=a.jqElem("td").append(e);"object"==typeof c&&this.addOptions(g,c),d.append(g)}},this)):void 0!=c&&c.length&&a.each(c,a.proxy(function(c,g){var h=g.value,i="td";null==b[h]&&(b[h]=void 0),"object"==typeof b[h]&&null==b[h].value&&(b[h].value=""),"object"==typeof b[h]&&void 0!=b[h].type&&(i=b[h].type);var j=a.jqElem(i),k=e(b[h],h,b,this);void 0==k&&(k=this.default_row_callback(b[h],h,b,this)),f+=k instanceof jQuery?k.text():k,b[h]&&!b[h].externalSortValue&&(b[h].sortValue=k instanceof jQuery?k.text():k),j.append(k),"string"!=typeof b[h]&&this.addOptions(j,b[h]),void 0!=k&&d.append(j)},this)),void 0!=this.options.filter){var g=new RegExp(this.options.filter,"i");f.match(g)||(d=void 0)}return d},deletePrompt:function(b){var c=a("<div></div>").kbaseDeletePrompt({name:b,callback:this.deleteRowCallback(b)});c.openPrompt()},deleteRowCallback:function(a){},shouldDeleteRow:function(a){return 1}})});