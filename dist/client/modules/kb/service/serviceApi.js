define(["bluebird","kb/common/utils","kb/service/utils","kb/service/client/workspace","kb/service/client/UserProfile","kb/service/client/NarrativeMethodStore"],function(a,b,c,d,e,f){function g(g){function h(a){return a.metadata.narrative&&/^\d+$/.test(a.metadata.narrative)&&"true"!==a.metadata.is_temporary?!0:!1}function i(a,b){return!0}function j(b){return a.resolve(p.list_workspace_info(b.params)).then(function(d){var e,f,g=[];for(e=0;e<d.length;e+=1)f=c.workspaceInfoToObject(d[e]),h(f)&&i(b.filter)&&g.push(f);var j=g.map(function(a){return{ref:a.id+"/"+a.metadata.narrative}});return 0===j.length?void resolve([]):[g,a.resolve(p.get_object_info_new({objects:j,ignoreErrors:1,includeMetadata:1}))]}).spread(function(a,b){var d,e=[];for(d=0;d<b.length;d+=1)if(b[d]){var f=c.object_info_to_object(b[d]);"Narrative"===f.typeName&&(f.metadata&&f.metadata.job_info&&(f.metadata.jobInfo=JSON.parse(f.metadata.job_info)),f.metadata&&f.metadata.methods&&(f.metadata.cellInfo=JSON.parse(f.metadata.methods)),e.push({workspace:a[d],object:f}))}return e})}function k(c){return a["try"](function(){if(0!==c.length){var d=c.map(function(b){return a.resolve(p.get_permissions({id:b.workspace.id}))}),e=o.getService("session").getUsername();return a.all(d).then(function(a){for(var d=0;d<a.length;d++){var f=c[d];f.permissions=b.object_to_array(a[d],"username","permission").filter(function(a){return a.username===e||"*"===a.username||a.username===f.workspace.owner?!1:!0}).sort(function(a,b){return a.username<b.username?-1:a.username>b.username?1:0})}return c})}})}function l(){return a.resolve(r.list_apps({}))}function m(){return a.resolve(r.list_methods({}))}function n(c){var d=c&&c.users?c.users:[];return d.push(o.getService("session").getUsername()),j({params:{excludeGlobal:1}}).then(function(a){return k(a)}).then(function(c){var e,f,g,h={};for(e=0;e<c.length;e+=1)if(f=c[e].permissions,g=!0,!_.some(d,function(a){return c[e].workspace.owner===a||_.find(f,function(b){return b.username===a})?!1:!0})){var f=f.filter(function(a){return _.contains(d,a.username)||"*"===a.username?!1:!0});f.forEach(function(a){b.incrProp(h,a.username)})}var i=b.object_to_array(h,"username","count"),j=i.map(function(a){return a.username});return[i,j,a.resolve(q.get_user_profile(j))]}).spread(function(a,b,c){var d;for(d=0;d<c.length;d+=1)c[d]&&c[d].user?a[d].realname=c[d].user.realname:console.log("WARNING: user "+b[d]+" is a sharing partner but has no profile.");return a=a.filter(function(a){return a.realname?!0:!1})})}var o=g.runtime,p=new d(o.getConfig("services.workspace.url"),{token:o.getService("session").getAuthToken()}),q=new e(o.getConfig("services.user_profile.url"),{token:o.getService("session").getAuthToken()}),r=new f(o.getConfig("services.narrative_method_store.url"),{token:o.getService("session").getAuthToken()});return{getNarratives:j,getCollaborators:n,getPermissions:k,getApps:l,getMethods:m}}return{make:function(a){return g(a)}}});