define(["jquery","bluebird"],function(a,b){"use strict";function c(a){var c=this;c.url="https://kbase.us/services/shock-api/",c.auth_header={},c.chunkSize=2097152,a.url&&(c.url=a.url),a.token&&(c.auth_header={Authorization:"OAuth "+a.token}),a.chunkSize&&(c.chunkSize=a.chunkSize),c.get_node=function(a,d,e){var f=c.url+"/node/"+a,g=jQuery.Deferred();return jQuery.ajax(f,{success:function(a){null!==a&&a.hasOwnProperty("data")?null!==a.error?e&&e(a):d(a.data):e&&e("error: invalid return structure from SHOCK server"),g.resolve()},error:function(a,b){e&&e(b),g.resolve()},headers:c.auth_header,type:"GET"}),b.resolve(g)},c.get_nodes=function(a,b,d){var e=c.url+"/node";if(a){e+="?query";for(var f in a)e+="&"+encodeURIComponent(f)+"="+encodeURIComponent(a[f])}var g=jQuery.Deferred();return jQuery.ajax(e,{success:function(a){null!==a&&a.hasOwnProperty("data")?null!==a.error?d&&d(a.error):b(a.data):d&&d(a),g.resolve()},error:function(a,b){d&&d(b),g.resolve()},headers:c.auth_header}),g},c.get_node_acls=function(a,b,d){var e=c.url+"/node/"+a+"/acl/",f=jQuery.Deferred();return jQuery.ajax(e,{success:function(a){a.data?b(a.data):d&&d(a.error),f.resolve()},error:function(a,b){d&&d(b),f.resolve()},headers:c.auth_header}),f},c.delete_node=function(a,b,d){var e=c.url+"/node",f=jQuery.Deferred();return jQuery.ajax(e+"/"+a,{success:function(a){b(!0),f.resolve()},error:function(a,b){d&&d(b),f.resolve()},headers:c.auth_header,type:"DELETE"}),f},c.update_node=function(a,b,d,e){var f=c.url+"/node",g=jQuery.Deferred(),h=[JSON.stringify(b)],i=new Blob(h,{type:"text/json"}),j=new FormData;return j.append("attributes",i),jQuery.ajax(f+"/"+a,{contentType:!1,processData:!1,data:j,success:function(a){d(a.data),g.resolve()},error:function(a,b){e&&e(b),g.resolve()},headers:c.auth_header,type:"PUT"}),g},c.check_file=function(a,b,d){var e=jQuery.Deferred(),f=a.size,g=a.lastModifiedDate.getTime(),h={file_size:f,file_time:g,file_name:a.name,limit:1};return c.get_nodes(h,function(a){b(0===a.length?null:a[0]),e.resolve()},function(a){d&&d(a),e.resolve()}),e},c.loadNext=function(a,b,d,e,f,g,h,i,j,k){if(!k||!k()){var l=new FileReader;l.onload=function(l){if(!k||!k()){var m=new FormData,n=new Blob([l.target.result],{type:a.type});m.append(e+1,n);var o=(e+1)*h>=a.size,p={incomplete:o?"0":"1",file_size:""+a.size,file_name:a.name,file_time:""+a.lastModifiedDate.getTime(),chunks:""+(e+1),chunk_size:""+h},q=[JSON.stringify(p)],r=new Blob(q,{type:"text/json"});m.append("attributes",r),jQuery.ajax(b,{contentType:!1,processData:!1,data:m,success:function(l){if(!k||!k()){e++;var m=Math.min(a.size,e*h);i({file_size:a.size,uploaded_size:m,node_id:g}),e*h>=a.size?d.resolve():c.loadNext(a,b,d,e,f,g,h,i,j,k)}},error:function(a,b){j&&j(b),d.resolve()},headers:c.auth_header,type:"PUT"})}},l.onerror=function(){j&&j("error during upload at chunk "+e+"."),d.resolve()};var m=e*h;if(m<a.size){var n=m+h>=a.size?a.size:m+h,o=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice;l.readAsArrayBuffer(o.call(a,m,n))}else i({file_size:a.size,uploaded_size:a.size,node_id:g})}},c.upload_node=function(a,b,d,e,f,g){function h(){d?c.check_file(a,function(a){g&&g()||i(a)},function(a){f&&f(a),k.resolve()}):i(null)}function i(b){if(null!==b){var d=b.id;j+="/"+b.id;var h=0;b.attributes.incomplete_chunks?h=parseInt(b.attributes.incomplete_chunks):b.attributes.chunks&&(h=parseInt(b.attributes.chunks));var i=c.chunkSize;b.attributes.chunk_size&&(i=parseInt(b.attributes.chunk_size));var l=Math.min(a.size,h*i);e({file_size:a.size,uploaded_size:l,node_id:d}),c.loadNext(a,j,k,h,m,d,i,e,f,g)}else{var i=c.chunkSize,m=Math.ceil(a.size/i),n={incomplete:"1",file_size:""+a.size,file_name:a.name,file_time:""+a.lastModifiedDate.getTime(),chunk_size:""+i},o=[JSON.stringify(n)],p=new Blob(o,{type:"text/json"}),q=new FormData;q.append("attributes",p),q.append("parts",m),jQuery.ajax(j,{contentType:!1,processData:!1,data:q,success:function(b){if(!g||!g()){var d=b.data.id,h=0;e({file_size:a.size,uploaded_size:h,node_id:d}),j+="/"+b.data.id,c.loadNext(a,j,k,0,m,d,i,e,f,g)}},error:function(a,b){f&&f(b),k.resolve()},headers:c.auth_header,type:"POST"})}}var j=c.url+"/node",k=jQuery.Deferred();return b?c.get_node(b,function(b){g&&g()||(b&&b.attributes.file_size===""+a.size&&b.attributes.file_name===a.name&&b.attributes.file_time===""+a.lastModifiedDate.getTime()?i(b):h())},function(a){h()}):h(),k},c.change_node_file_name=function(a,b,d,e){var f=c.url+"/node/"+a,g=jQuery.Deferred(),h=new FormData;h.append("file_name",b),jQuery.ajax(f,{contentType:!1,processData:!1,data:h,success:function(a){d(a),g.resolve()},error:function(a,b){e&&e(b),g.resolve()},headers:c.auth_header,type:"PUT"})}}return c});