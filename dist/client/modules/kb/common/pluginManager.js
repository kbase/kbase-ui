define(["bluebird"],function(a){"use strict";function b(b){function c(a,b){a.forEach(function(a){m[a]=b})}function d(a,b){return b&&b.forEach(function(b){a.push(b)}),a}function e(b,c){return a["try"](function(){var a,d=b.match(/(.*?)(:?(s)|($))$/);if(d){if(a=d[1],!k.hasService(a))throw{name:"MissingService",message:'The requested service "'+a+'" was not registered in the plugin manager',suggestion:"This is a web app configuration issue, not a user error"};var e=k.getService(a);return e.pluginHandler?e.pluginHandler(c):void 0}})}function f(b,c){return new a(function(f,g){var h={},i={},j=b.directory,k=[];c.source.styles&&c.source.styles.forEach(function(a){a.file&&k.push("css!"+j+"/resources/css/"+a.file)}),c.source.modules.forEach(function(a){var b=a.file,c=b.match(/^(.+?)(?:(?:\.js$)|(?:$))/);if(c){b=c[1];var d=j+"/modules/"+b;if(h[a.module]=d,a.css){var e=a.module+"_css";h[e]=d,i[a.module]={deps:["css!"+e]}}}}),require.config({paths:h,shim:i}),define("kb_plugin_"+c["package"].name,[],function(){return{plugin:{path:"/"+j+"/resources",modulePath:"/"+j+"/resources",fullPath:l+"/"+j+"/resources"}}}),c.install?require(k,function(){var b=[];Object.keys(c.install).forEach(function(a){var f=c.install[a],g=e(a,f);d(b,[g])}),a.all(b).then(function(a){f()})["catch"](function(a){console.log("ERROR"),console.log(a),g(a)})}):(console.log("No installation?"),f())})}function g(b){var c=0;return new a(function(d,e){function f(b){String(c);c+=1,(void 0===b||0===b.length)&&d("DONE");var g=b[0],h=b.slice(1);a["try"](function(){return new a(function(a,b,c){g(a,b,c)})}).then(function(a){return f(h)})["catch"](function(a){e(a)})}f(b)})}function h(b){var c;return c="string"==typeof b?{name:b,directory:"plugins/"+b}:b,new a(function(a,b){require(["yaml!"+c.directory+"/config.yml"],function(d){f(c,d).then(function(){a(c)})["catch"](function(a){b(a)})})})}function i(b){var c=b.map(function(a){return h(a)});return a.all(c)}function j(a){var b=a.map(function(a){return function(b,c,d){i(a).then(function(){b()})["catch"](function(a){c(a)})}});return g(b)}var k=b.runtime,l=b.moduleBase||"/modules",m={};return{installPlugins:i,installPluginSets:j,registerService:c}}return{make:function(a){return b(a)}}});