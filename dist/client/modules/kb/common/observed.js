define(["./utils","./asyncQueue","bluebird"],function(a,b,c){"use strict";function d(){function d(b,c){var d=a.getProp(k,b),e=[];return l[b]&&(l[b].forEach(function(a){m.addItem({onRun:function(a,b,c){return function(){try{a(b,c)}catch(d){}}}(a.onSet,c,d&&d.value)}),a.oneTime||e.push(a)}),l[b]=e),a.setProp(k,b,{status:"set",value:c,time:new Date}),this}function e(b,c){var d=a.getProp(k,b),e=c(d.value),f=[];return l[b]&&(l[b].forEach(function(a){m.addItem({onRun:function(a,b,c){return function(){try{a(b,c)}catch(d){}}}(a.onSet,e,d&&d.value)}),a.oneTime||f.push(a)}),l[b]=f),a.setProp(k,b,{status:"set",value:e,time:new Date}),this}function f(b,c){var d=a.getProp(k,b);return void 0!==d&&"set"===d.status?d.value:c}function g(b){return a.hasProp(k,b)}function h(a,b){return i(a,b)}function i(b,c){"function"==typeof c&&(c={onSet:c});var d=a.getProp(k,b);if(d)if(c.hear){if(c.hear(d.value),c.oneTime)return}else switch(d.status){case"set":c.onSet(d.value);break;case"error":c.onError(d.error);break;default:throw"Invalid status: "+d.status}void 0===l[b]&&(l[b]=[]),l[b].push(c)}function j(b,d){var e=new c(function(c,d){if(a.hasProp(k,b)){var e=a.getProp(k,b);"error"===e.status?d(e.error):c(e.value)}else i(b,{oneTime:!0,addedAt:(new Date).getTime(),onSet:function(a){c(a)},onError:function(a){d(a)}})});return d?e.timeout(d):e}var k={},l={},m=b.make();return{setItem:d,modifyItem:e,getItem:f,listen:h,listenForItem:i,whenItem:j,hasItem:g}}return{make:function(a){return d(a)}}});