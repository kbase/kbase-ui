define(["jquery","bluebird","./cookie","./logger"],function(a,b,c,d){"use strict";function e(d){function e(){return A}function f(a){var b,c,d,e,f=a.split("|"),g={};for(b=0;b<f.length;b+=1)c=f[b].split("="),d=c[0],e=c[1],g[d]=e;return g}function g(a){var b=a.tokenObject.expiry;if(!b)return!1;if(b=parseInt(b,10),isNaN(b))return!1;var c=new Date(1e3*b),d=c-new Date;return 0>=d?!0:!1}function h(a){return void 0===a&&(a=a),a&&a.sessionId&&a.username&&a.token&&a.tokenObject?g(a)?!1:!0:!1}function i(){var a="";return a+="un="+y.username,a+="|kbase_sessionid="+y.sessionId,a+="|user_id="+y.username,a+="|token="+y.token.replace(/=/g,"EQUALSSIGN").replace(/\|/g,"PIPESIGN")}function j(){if(y){var a=i();c.setItem(C,a,E,"/"),D&&D.forEach(function(b){c.setItem(b,a,E,"/")});var b=m();b.success=1}}function k(){return o(p()),y}function l(){return k(),y?m():null}function m(){return y?{un:y.username,user_id:y.username,name:y.realname,token:y.token,kbase_sessionid:y.sessionId}:null}function n(){c.removeItem(C,"/"),D&&D.forEach(function(a){c.removeItem(a,"/")}),y=null}function o(a){y=h(a)?a:null}function p(){var a=c.getItem(C);if(!a)return null;var b=f(a);if(!(b.kbase_sessionid&&b.un&&b.user_id&&b.token))return n(),null;b.token=b.token.replace(/PIPESIGN/g,"|").replace(/EQUALSSIGN/g,"=");var d={username:b.user_id,token:b.token,tokenObject:f(b.token),sessionId:b.kbase_sessionid};return h(d)?d:null}function q(a){if(!(a.kbase_sessionid&&a.user_id&&a.token))return n(),null;var b={username:a.user_id,realname:a.name,token:a.token,tokenObject:f(a.token),sessionId:a.kbase_sessionid};return h(b)?b:null}function r(c){return new b(function(b,d){if(!c.username||0===c.username.length)return void d("Username is empty: It is required for login");if(!c.password||0===c.password.length)return void d("Password is empty: It is required for login");var e={user_id:c.username,password:c.password,fields:"un,token,user_id,kbase_sessionid,name",status:1};a.support.cors=!0,a.ajax({type:"POST",url:F,data:e,dataType:"json",crossDomain:!0,xhrFields:{withCredentials:!0},beforeSend:function(a){a.withCredentials=!0},success:function(a,e,f){a.kbase_sessionid?(o(q(a)),c.disableCookie||j(),b(m())):d(a.error_msg)},error:function(a,b,c){var e=b,f="The login attempt failed: Username &amp; Password combination are incorrect";a.status&&401===a.status?e=f:a.responseJSON&&(a.responseJSON.error_msg&&(e=a.responseJSON.error_msg),"LoginFailure: Authentication failed."===e&&(e=f)),"error"===e&&(e="Internal Error: Error connecting to the login server"),y=null,z={message:e},d(e)}})})}function s(){return new b(function(a){n(),a()})}function t(){return y&&y.token?!0:!1}function u(){return y?y.username:void 0}function v(){return y?y.realname:void 0}function w(){return y?y.sessionId:void 0}function x(){return y?y.token:void 0}var y,z,A="0.2.0",B=d||{},C=B.cookieName,D=B.extraCookieNames,E=(B.useLocalStorage,B.cookieMaxAge||36e3),F=B.loginUrl;return{getVersion:e,login:r,logout:s,getUsername:u,getRealname:v,getSessionId:w,getAuthToken:x,isLoggedIn:t,importFromCookie:p,setSession:o,getKbaseSession:l}}return{make:function(a){return e(a)}}});