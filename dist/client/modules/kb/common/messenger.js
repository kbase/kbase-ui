define(["bluebird","./asyncQueue","./lang"],function(a,b,c){function d(d){function e(){return m+=1,"sub_"+m}function f(a){throw new Error(a)}function g(a){var b=a.chan||a.channel||"default",c=a.msg||a.message||f("Message is required for a sub"),d=l[b];d||(d={messages:{}},l[b]=d);var g=d.messages[c];g||(g={listeners:[],byId:{}},d.messages[c]=g);var h=e();return a.subId=h,g.byId[h]=a,g.listeners.push(a),{chan:b,msg:c,id:h}}function h(a){var b=l[a.chan];if(!b)return!1;var c=b.messages[a.msg];if(!c)return!1;var d=c.byId[a.id];return d?(delete c.byId[a.id],c.listeners=c.listeners.filter(function(b){return b.subId===a.id?!1:!0}),!0):!1}function i(){return[a.resolve()]}function j(a){var b=a.chan||a.channel,d=a.msg||a.message,e=l[b];if(e){var f=e.messages[d];f&&f.listeners.forEach(function(b){n.addItem({onRun:function(){try{b.handler(a.data)}catch(e){throw new c.UIError({type:"RuntimeError",reason:"MessageHandlerError",message:"Exception running message "+d+", sub "+m,data:e,suggestion:"This is an application error, not your fault"})}}})})}}function k(b){var d=b.chan||b.channel,e=b.msg||b.message,f=l[d];if(!f&&b.propogate)return i();var g=f.messages[e];if(!g&&b.propogate)return i();var h=g.listeners;return a.all(h.map(function(d){return new a(function(a,f){n.addItem({onRun:function(){try{a(d.handler(b.data))}catch(g){f(new c.UIError({type:"RuntimeError",reason:"MessageHandlerError",message:"Exception running message "+e+", sub "+m,data:g,suggestion:"This is an application error, not your fault"}))}},onError:function(a){f(a)}})})}).map(function(a){return a.reflect()}))}var l={},m=0,n=b.make();return{receive:g,unreceive:h,send:j,sendPromise:k}}return{make:function(a){return d(a)}}});