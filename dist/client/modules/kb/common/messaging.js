define([],function(){"use strict";var a=Object.create({});a.version="0.0.2";var b=function(){var a=0;return{current:function(){return a},next:function(){return a+=1,"oid_"+a}}}(),c=Object.create({},{id:{value:null,writable:!0},broadcast:{value:!1,writable:!0},init:{value:function(a){return a&&(this.id=a.id,this.from=a.from,this.to=a.to,this.data=a.data,this.broadcast=a.broadcast,this.oid=b.next()),this}}});a.Message=c;var d=Object.create({},{init:{value:function(){return this.targets={},this.listeners=[],this}},addTarget:{value:function(a){return a.id&&(this.targets[a.id]||(this.targets[a.id]=a)),this.listeners.push(a),this}},removeTarget:{value:function(){}},clearTargets:{value:function(){this.targets=[]}},getTargets:{value:function(){return this.targets}}});a.MessageHandler=d;var e=Object.create({},{sendRate:{value:60,writable:!0},lastMessageTime:{value:null,writable:!0},messageProcessedCount:{value:0,writable:!0},timer:{value:null,writable:!0},init:{value:function(a){return this.messages=[],this.app=a.app,this}},addMessage:{value:function(a){return this.messages.unshift(a),this.ensureTimer(),this}},handleError:{value:function(a,b,c,d){alert("Error is "+a+" for message: "+b.id+", target "+c+", fun "+d)}},processMessage:{value:function(a){var b=this.app.getMessageHandler(a.id);if(b)if(a.broadcast){var c,d,e,f=this;for(c=0;c<b.listeners.length;c+=1)if(d=b.listeners[c],d&&(e=!0),d.filter&&e&&(e=!1,d.filter.from&&(e=d.filter.from===a.from?!0:!1),d.filter.to&&(e=d.filter.to===a.to?!0:!1),d.filter.source&&(e=d.filter.source===a.source?!0:!1)),e)try{d.receive(a)}catch(g){f.handleError(g,a,c,d.receive)}finally{f.lastMessageTime=(new Date).getTime(),f.messageProcessedCount+=1}}else{var h=a.to,d=b.targets[h];if(!d)return;if(d.receive)try{d.receive(a)}catch(g){this.handleError(g,a,h,d.receive)}finally{this.lastMessageTime=(new Date).getTime(),this.messageProcessedCount++}}return this}},processQueue:{value:function(){if(this.sendRate)this.messages.length>0&&this.processMessage(this.messages.pop()),this.checkTimer();else{for(;this.messages.length>0;)this.processMessage(this.messages.pop());this.checkTimer()}}},getMessages:{value:function(){return this.messages}},clearQueue:{value:function(){return this.messages=[],this}},cancelTimer:{value:function(){return this.timer&&(window.clearTimeout(this.timer),delete this.timer),this}},startTimer:{value:function(a){var b;return b=this.sendRate?this.sendRate/1e3:0,this.timer=window.setTimeout(a,b),this}},isTimer:{value:function(){return this.timer?!0:!1}},ensureTimer:{value:function(){if(this.messages.length>0){if(!this.isTimer()){var a=this;this.startTimer(function(){a.handleMessageTimer()})}}else this.cancelTimer();return this}},checkTimer:{value:function(){if(this.messages.length>0){this.cancelTimer();var a=this;this.startTimer(function(){a.handleMessageTimer()})}else this.cancelTimer();return this}},handleMessageTimer:{value:function(){return this.processQueue(),this}}});a.MessageQueue=e;var f=Object.create({},{init:{value:function(a){return void 0===a&&(a={}),this.messageQueue=Object.create(e).init({app:this,timerInterval:a.interval}),this.messageHandlers={},this}},start:{value:function(){return this}},stop:{value:function(){return this}},setMessageQueue:{value:function(a){this.messageQueue=a}},on:{value:function(a,b){var c=this.messageHandlers[a];if(c||(c=Object.create(d,{id:{value:a}}).init(),this.messageHandlers[a]=c),!b)throw new Error("No message handler supplied");if("function"==typeof b)b={receive:b};else if(!b.receive)throw new Error("Missing message handler configuration");c.addTarget(b)}},getMessageHandler:{value:function(a){return this.messageHandlers[a]}},broadcast:{value:function(a,b,d){var e;"string"==typeof a?e=Object.create(c).init({id:a,from:d,broadcast:!0,data:b}):(e=a,e.broadcast=!0),this.messageQueue.addMessage(e)}},send:{value:function(a,b,d){var e;e="string"==typeof a?Object.create(c).init({id:a,from:d,to:b}):a,this.messageQueue.addMessage(e)}}});return a.MessageManager=f,a});