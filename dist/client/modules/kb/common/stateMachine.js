define(["./utils","./asyncQueue","bluebird"],function(a,b,c){"use strict";var d=Object.create({},{version:{value:"0.0.2",writable:!1},init:{value:function(a){return this.state={},this.listeners={},this.queue=Object.create(b).init(),this}},setItem:{value:function(b,c){var d=a.getProp(this.state,b);if(this.listeners[b]){var e=[];this.listeners[b].forEach(function(a){this.queue.addItem({onRun:function(a,b,c,d){return function(){try{a(b,c,d)}catch(e){}}}(a.onSet,c,d&&d.value,this)}),a.oneTime||e.push(a)}.bind(this)),this.listeners[b]=e}return a.setProp(this.state,b,{status:"set",value:c,time:new Date}),this}},getItem:{value:function(b,c){var d=a.getProp(this.state,b);return void 0!==d&&"set"===d.status?d.value:c}},hasItem:{value:function(b){return a.hasProp(this.state,b)}},setError:{value:function(b,c){if(this.listeners[b]){var d=[];this.listeners[b].forEach(function(a){this.queue.addItem({onRun:function(a,b){return function(){try{a(b)}catch(c){}}}(a.onError,c,this)}),a.oneTime||d.push(a)}.bind(this)),this.listeners[b]=d}a.setProp(this.state,b,{status:"error",error:c,time:new Date})}},hasError:{value:function(b){var c=a.getProp(this.state,b);return c&&"error"===c.status?!0:!1}},delItem:{value:function(b){a.hasProp(this.state,b)&&a.deleteProp(this.state,b)}},listen:{value:function(a,b){return this.listenForItem(a,b)}},listenForItem:{value:function(b,c){"function"==typeof c&&(c={onSet:c});var d=a.getProp(this.state,b);if(d)if(c.hear){if(c.hear(d.value),c.oneTime)return}else switch(d.status){case"set":c.onSet(d.value);break;case"error":c.onError(d.error);break;default:throw"Invalid status: "+d.status}return void 0===this.listeners[b]&&(this.listeners[b]=[]),this.listeners[b].push(c),this}},whenItem:{value:function(b,d){var e=new c(function(c,d){if(a.hasProp(this.state,b)){var e=a.getProp(this.state,b);"error"===e.status?d(e.error):c(e.value)}else this.listenForItem(b,{oneTime:!0,addedAt:(new Date).getTime(),onSet:function(a){c(a)},onError:function(a){d(a)}})}.bind(this));return d?e.timeout(d):e}}});return d});