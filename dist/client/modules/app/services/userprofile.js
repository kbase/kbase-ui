define(["promise","kb/common/observed","kb/service/userProfile","kb/common/lang"],function(a,b,c,d){"use strict";function e(e){function f(){return a["try"](function(){var a=l.getService("session").getUsername();if(a)return Object.create(c).init({username:a,runtime:l}).loadProfile();throw new d.UIError({type:"RuntimeError",reason:"UsernameMissingFromSession",message:"The username was not found in the session."})})}function g(){return l.getService("session").onChange(function(a){a?f().then(function(a){return m.setItem("userprofile",a),null})["catch"](function(a){console.log("ERROR starting profile app service"),console.log(a)}):m.setItem("userprofile",null)}),!0}function h(){return a["try"](function(){m.setItem("userprofile",null)})}function i(){var a=m.getItem("userprofile");return a?a.getProp("user.realname"):void 0}function j(a,b){m.listen("userprofile",{onSet:function(b){a(b)},onError:function(a){console.log("ERROR in user profile service"),console.log(a),b&&b(a)}})}function k(){return m.whenItem("userprofile")}var l=e.runtime,m=b.make();return{start:g,stop:h,onChange:j,whenChange:k,getRealname:i}}return{make:function(a){return e(a)}}});