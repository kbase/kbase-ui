define(["bluebird","kb/common/router","kb/common/lang"],function(a,b,c){function d(d){function e(){var a=j.findCurrentRoute();if(a||i.send("app","route-not-found"),a.route.authorization&&!i.getService("session").isLoggedIn()){var b={};return a.request.path&&(b.nextrequest=JSON.stringify(a.request)),void i.send("app","navigate",{path:"login",params:b})}var c={routeHandler:a};a.route.redirect?i.send("app","route-redirect",c):a.route.widget?i.send("app","route-widget",c):a.route.handler&&i.send("app","route-handler",c)}function f(b){return a["try"](function(){if(b.widget)return j.addRoute(b),!0;if(b.redirectHandler)return j.addRoute(b),!0;throw new c.UIError({type:"ConfiguratonError",name:"RouterConfigurationError",source:"installRoute",message:"invalid route",suggestion:"Fix the plugin which specified this route.",data:b})})}function g(a){return a?a.map(function(a){return f(a)}):void 0}function h(a){return g(a)}var i=d.runtime,j=b.make(d);return i.recv("app","do-route",function(){e()}),i.recv("app","new-route",function(a){a.routeHandler.route.redirect?send("app","route-redirect",a):a.routeHandler.route.widget?send("app","route-widget",a):a.routeHandler.route.handler&&send("app","route-handler",a)}),i.recv("app","route-redirect",function(a){i.send("app","navigate",{path:a.routeHandler.route.redirect.path,params:a.routeHandler.route.redirect.params})}),i.recv("app","navigate",function(a){j.navigateTo(a)}),i.recv("app","redirect",function(a){j.redirectTo(a.url,a.new_window)}),window.addEventListener("hashchange",function(a){e()}),{pluginHandler:h}}return{make:function(a){return d(a)}}});