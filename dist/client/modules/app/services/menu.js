define(["bluebird","kb/common/observed"],function(a,b){"use strict";function c(c){function d(a){a=a||{};var b={authenticated:{main:[],developer:[],help:[]},unauthenticated:{main:[],developer:[],help:[]}};Object.keys(a).forEach(function(c){Object.keys(a[c]).forEach(function(d){b[c][d]=a[c][d]})}),m.setItem("menus",b)}function e(){var a={authenticated:{main:[],developer:[],help:[]},unauthenticated:{main:[],developer:[],help:[]}};m.setItem("menus",a)}function f(a,b){m.modifyItem("menuItems",function(c){return c[a]=b,c})}function g(a,b){var c,d,e,f=m.getItem("menuItems"),g=f[b];if(!g)throw{type:"InvalidKey",reason:"MenuItemNotFound",message:"The menu item key provided, "+b+", is not registered"};"object"==typeof a?(c=a.name,d=a.section,e=a.position||"bottom"):(c=a,d="main",e="bottom"),m.modifyItem("menus",function(a){return"top"===e?a[c][d].push(f[b]):a[c][d].unshift(f[b]),a})}function h(){var a,b=m.getItem("menus");return a=n.getService("session").isLoggedIn()?b.authenticated:b.unauthenticated}function i(b){return b?a["try"](function(){b.forEach(function(a){f(a.name,a.definition)})}):void 0}function j(a){m.listen("menu",{onSet:function(b){a(h())}})}function k(){n.recv("session","loggedin",function(){m.setItem("menu",m.getItem("menus").authenticated)}),n.recv("session","loggedout",function(){m.setItem("menu",m.getItem("menus").unauthenticated)}),Object.keys(c.menus).forEach(function(a){Object.keys(c.menus[a]).forEach(function(b){c.menus[a][b].forEach(function(c){g({name:a,section:b,position:"bottom"},c)})})})}function l(){}var m=b.make(),n=c.runtime;return m.setItem("menuItems",{divider:{type:"divider"}}),m.setItem("menu",[]),e(),{getCurrentMenu:h,pluginHandler:i,onChange:j,setMenus:d,addMenuItem:f,addToMenu:g,start:k,stop:l}}return{make:function(a){return c(a)}}});