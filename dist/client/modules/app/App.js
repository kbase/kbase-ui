define(["kb/common/pluginManager","kb/common/dom","kb/common/messenger","kb/widget/widgetMount","kb/common/props","kb/common/asyncQueue","kb/common/appServiceManager","yaml!config/config.yml"],function(a,b,c,d,e,f,g,h){"use strict";function i(i){function j(a,b){return A.getItem(a,b)}function k(a){return A.hasItem(a)}function l(a,b,c){return m({channel:a,message:b,handler:c})}function m(a){return B.receive(a)}function n(a){o(a)}function o(a){return B.unreceive(a)}function p(a,b,c){return q({channel:a,message:b,data:c})}function q(a){return B.send(a)}function r(a,b,c){return B.sendPromise({channel:a,message:b,data:c})}function s(a){return console.log("installing plugins"),console.log(a),x.installPlugins(a)}function t(a){if(y=b.qs(a),!y)throw new Error("Cannot set root node for selector "+a)}function u(a,b){if(!y)throw new Error("Cannot set root widget without a root node");return C||(C=d.make({node:y,runtime:b})),C.mountWidget(a)}function v(a,b,c){if(!a[b])throw{name:"UndefinedMethod",message:'The requested method "'+b+'" does not exist on this object',suggestion:"This is a developer problem, not your fault"};return a[b].apply(a,c)}function w(){return E.addService("session",{runtime:F,cookieName:"kbase_session",extraCookieNames:["kbase_narr_session"],loginUrl:h.services.login.url,cookieMaxAge:h.ui.constants.session_max_age}),E.addService("heartbeat",{runtime:F,interval:500}),E.addService("route",{runtime:F,notFoundRoute:{redirect:{path:"message/notfound"}},defaultRoute:{redirect:{path:"dashboard"}}}),E.addService("menu",{runtime:F,menus:i.menus}),E.addService("widget",{runtime:F}),E.addService("service",{runtime:F}),E.addService("data",{runtime:F}),E.addService("type",{runtime:F}),E.addService("userprofile",{runtime:F}),x=a.make({runtime:F}),l("session","loggedout",function(){p("app","navigate","goodbye")}),l("ui","render",function(a){D.addItem({onRun:function(){a.node?a.node.innerHTML=a.content:(console.log("ERROR"),console.log("Invalid node for ui/render"))}})}),console.log("CONFIG"),console.log(z),E.loadServices().then(function(){return console.log("Services loaded"),s(z.plugins)}).then(function(){return console.log("Root widget mounted"),E.startServices()}).then(function(){return console.log("Plugins installed"),u("root",F)}).then(function(){return console.log("Services started."),E.getService("session").isLoggedIn()?p("session","loggedin"):p("session","loggedout"),p("app","do-route"),F})}var x,y,z=i,A=e.make({data:h}),B=c.make();t(z.nodes.root.selector);var C,D=f.make(),E=g.make(),F={getConfig:j,config:j,hasConfig:k,installPlugins:s,send:p,sendp:r,recv:l,drop:n,snd:q,rcv:m,urcv:o,addService:function(){return v(E,"addService",arguments)},loadService:function(){return v(E,"loadService",arguments)},getService:function(){return v(E,"getService",arguments)},service:function(){return v(E,"getService",arguments)},hasService:function(){return v(E,"hasService",arguments)},dumpServices:function(){return v(E,"dumpServices",arguments)}};return{begin:w}}var j="0.0.1";return{run:function(a){var b=i(a);return b.begin()},version:function(){return j}}});