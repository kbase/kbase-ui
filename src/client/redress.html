<!DOCTYPE html>
<html style="height: 100%; ">
<head>
    <title>UI Redressing Test</title>
</head>
<body style="margin: 0; padding: 0; height: 100%; width: 100%; display: flex; flex-direction: column; font-family: monospace; font-size: 16px;">
    <!--
        A simple page to test a url for "ui redressing" or "clickjacking" vulnerability.
        UI redressing is a technique for embedding a web page in an iframe provided on 
        a different web site, and using a mostly-transparent overlay with strategically 
        placed ui elements which "re-dress" the underlying web page's ui. The redress ui 
        can then be designed to trick a user to clicking or inputting, allowing the attacking
        site to capture this information. 
        Imagine this on a login page, which allows an attacking site to place a "fake" username
        and password input on top of what otherwise looks identical (since it is!) to the 
        authentic, original site. The attacking site can then simply record the username and password.
        This specific case is not a vulnerability for kbase, since all authentication is through
        third parties.
        However, there may be other "tricks" an attacking site could play on a user.

        This tool can be used to inspect any kbase site, as well as third party sites, simply by 
        entering the url into the input.

        When the page loads it will attempt to display the current site by using the origin. At KBase 
        this should always display kbase-ui. This should work, because our the security headers
        restrict iframe embedding to the current origin, allowing us to embed ourself!

        If a site does not display, or something weird happens with navigating it (some sites are
        partially protected from embedding in an iframe), check the browser console for error
        messages generated by the browser. Each browser will have different messages, but will 
        indicate the reason the page did not load.
    -->
    <iframe id="iframe" src="about:blank"
        style="box-sizing: border-box; margin: 0; padding: 0; flex: 1 1 0; border: 3px solid blue"></iframe>
    <div id="panel"
        style="flex: 0 0 auto; display: flex; flex-direction: row; align-items: center; background-color: rgba(200, 200, 200, 0.2); border: 3px solid green; padding: 1em;">
        <span style="text-decoration: underline; margin-right: 1em;">UI REDRESSING TEST</span>
        url:<input id="urlinput" style="width: 20em; font-size: 100%; font-family: monospace;">
        <button id="loadbutton" style="font-size: 100%; font-family: monospace;"
            onclick="() => {console.log('here'); kbase.loadurl();}">Load</button>
        <span id="message" style="margin-left: 0.5em; font-weight: bold; color: blue;">Loading...</span>
    </div>
    <script>
            // Stash the component references.
            const urlInput = document.getElementById('urlinput');
            const messageElement = document.getElementById('message');
            const iframe = document.getElementById('iframe');

            const say = (message, inColor) => {
                messageElement.innerText = message;
                messageElement.style.color = inColor;
            }

            // track state

            // Handle the Load button being clicked.
            const loadurl = (e) => {
                const url = new URL(urlInput.value);
                say(`loading url "${url}"`, 'orange');
                iframe.src = url;
            };
            const loadButton = document.getElementById("loadbutton");
            loadButton.addEventListener('click', loadurl);

            // Handle the "Enter" key being pressed in the input.
            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadurl();
                }
            });

            // Handle the iframe being loaded
            const oniframeload = () => {
                say(`loaded url "${iframe.getAttribute('src')}", check console...`, 'green');
            }
            iframe.addEventListener('load', oniframeload);

            // Load the initial url - the root url of the current host, the origin.
            // This should work, as the CSP header fields explicitly allow only the origin.
            // Other domains may or may not work.
            urlInput.value = document.location.origin;
            loadurl();
    </script>
</body>
</html>
